# IM 消息进入系统后的联动流程梳理

基于当前代码实现（`ImController` → `ConversationTaskCoordinator` 等），IM 消息进入系统后触发的主要联动包含：
- 会话创建/复用与消息落库（Conversation + Message）。
- 领域事件记录（`domain_events`）与 Outbox 事件持久化（`outbox_events`）。
- 需求识别 → 需求创建 → 高优先级任务创建。
- AI 情绪分析（两处：Coordinator 内部生成回复时一次；Controller 组装响应时一次）。
- 知识库检索与推荐（Controller 侧）。
- 任务关联查询（Controller 侧）。
- 自动回复建议生成与人工复核触发（通过 WebSocket + 事件推送联动前端）。
- 问题解决事件触发异步质检（当问题判定已解决时）。

以下为完整的时序图与服务调用链路图（Mermaid）。

## 时序图（IM 入站处理）

**中文备注**
- 入口：外部 IM 消息通过 `/api/im/incoming-message` 入站。
- 核心编排：`ImController` 调用 `ConversationTaskCoordinator` 完成会话创建/复用、需求识别、任务创建与回复建议生成。
- 数据落库：对话与消息落在 `conversations/messages`，事件溯源写入 `domain_events`，同时写入 `outbox_events` 保障最终一致性。
- AI 联动：情绪分析在 Coordinator 内部（生成回复）与 Controller 组装响应各执行一次。
- 结果返回：包含情绪、需求、知识推荐、工单关联与回复建议。

```mermaid
sequenceDiagram
  autonumber
  actor IM as 外部IM/客户
  participant API as Fastify API (/api/im/incoming-message)
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant OR as Orchestrator Agent
  participant AA as AssistantAgent
  participant EA as EngineerAgent
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant EB as EventBus(内存)
  participant OB as OutboxEventBus
  participant RDS as RequirementDetectorService
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant LLM as LLMClient/外部AI
  participant SKU as SearchKnowledgeUseCase
  participant TKB as TaxKB/本地KnowledgeRepo

  IM->>API: POST /api/im/incoming-message
  API->>IMC: handleIncomingMessage()

  IMC->>CTC: processCustomerMessage()
  CTC->>OR: route(message, context)
  OR->>AA: 处理常规咨询/澄清
  OR->>EA: 处理技术故障/复杂问题
  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: 查询 Conversation + Messages
  alt 无活跃会话
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: 保存 Conversation + Message
    CR->>DB: 写入 domain_events
    CR->>OB: 写入 outbox_events
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else 有活跃会话
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: 保存 Message
    CR->>DB: 写入 domain_events
    CR->>OB: 写入 outbox_events
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt 需求置信度 > 0.7
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated...)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    else medium/low
      CTC-->>IMC: recommendedTasks (待人工确认)
    end
  end

  CTC->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  CTC->>AIS: generateReply(...) (LLM 或降级模板)

  CTC-->>IMC: ProcessingResult(agentSuggestion)

  IMC->>CR: findById(conversationId)
  CR->>DB: 拉取最近消息用于情绪分析
  IMC->>AIS: analyzeSentiment(content, last5Messages)
  AIS->>LLM: analyzeSentiment()

  IMC->>SKU: execute(query)
  SKU->>TKB: 关键词/语义/QA检索

  IMC->>TR: findByFilters(conversationId)
  TR->>DB: 拉取关联 Task

  IMC-->>API: 组装 response (sentiment/requirements/knowledge/tasks/suggestion)
  API-->>IM: 200 OK + 分析结果
```

## 服务调用链路图（含事件与异步链路）

**中文备注**
- 展示 IM 入站后的核心服务编排与事件链路（同步 + 异步）。
- 主链路：IM → API → Controller → Coordinator → UseCase → Repository → DB。
- 事件链路：领域事件进入 `domain_events`，同时进入 `outbox_events`，由 `OutboxProcessor` 异步投递。
- 异步链路用于触发质检/告警等非阻塞流程；与会话是否关闭无关，可由“问题解决事件”驱动。

```mermaid
graph TD
  IM[External IM Customer] --> API[Fastify API incoming message]
  API --> IMC[ImController]
  IMC --> CTC[ConversationTaskCoordinator]
  CTC --> OR[Orchestrator Agent]
  OR --> AA[AssistantAgent]
  OR --> EA[EngineerAgent]

  CTC --> CCU[CreateConversationUseCase]
  CTC --> SMU[SendMessageUseCase]
  CCU --> CR[ConversationRepository]
  SMU --> CR
  CR --> DB[PostgreSQL]
  CR --> DE[domain events]
  CR --> OB[outbox events]
  CCU --> EB[EventBus]
  SMU --> EB

  CTC --> RDS[RequirementDetectorService]
  CTC --> CRU[CreateRequirementUseCase]
  CRU --> RR[RequirementRepository]
  RR --> DB
  CRU --> EB
  CTC --> CTU[CreateTaskUseCase]
  CTU --> TR[TaskRepository]
  TR --> DB

  AA --> AIS[AiService]
  EA --> AIS
  AIS --> LLM[LLMClient External AI]
  IMC --> AIS

  IMC --> SKU[SearchKnowledgeUseCase]
  SKU --> TKB[TaxKB KnowledgeRepository]

  IMC --> TR

  OP[OutboxProcessor] --> EB
  EB --> PRH[ProblemResolvedHandler]
  PRH --> AGS[AgentScope Inspect API]
```

## 关键联动点说明（与代码对应）

1. **消息入站与对话复用/创建**
   - `ImController.handleIncomingMessage` → `ConversationTaskCoordinator.processCustomerMessage`。
   - `CreateConversationUseCase` / `SendMessageUseCase` 会调用 `ConversationRepository.save`，同步写入：
     - `conversations` + `messages`（对话与消息）  
     - `domain_events`（事件溯源）
     - `outbox_events`（Outbox 最终一致性）

2. **需求识别与任务联动**
   - `RequirementDetectorService.detect` → `CreateRequirementUseCase.execute` → `RequirementRepository.save`
   - 高优先级需求触发 `CreateTaskUseCase.execute` → `TaskRepository.save`

3. **AI 联动（情绪 + 回复建议）**
   - `ConversationTaskCoordinator.generateAgentReply` 内部调用 `AiService.analyzeSentiment` 与 LLM 生成回复建议。
   - `ImController` 在返回前再次调用 `AiService.analyzeSentiment` 生成响应里的情绪字段。

4. **知识库与任务关联**
   - `SearchKnowledgeUseCase` 组合 TaxKB + 本地知识库检索。
   - `TaskRepository.findByFilters` 关联当前对话的任务列表。

5. **事件与异步链路**
   - “问题解决事件”触发质检（由大模型判定已解决后产生）。
   - 处理器通过 `AgentScope /api/agents/inspect` 触发质检（异步，不阻塞主流程）。

---

## Agent 支持能力补充（来自 PRD）

**说明**
- 下述能力为 Agent PRD 中“当前实现/已接入工具”的摘要，用于补齐 IM 入站链路的 Agent 支持面。
- 规划能力不纳入当前链路，避免与现状不一致。

**能力对照表（中文）**

| Agent | 已实现能力（当前可用） | 规划能力（待补齐） |
|---|---|---|
| Orchestrator Agent | 规则/启发式路由决策；执行模式选择；人工介入触发；`analyzeConversation` / `getCustomerProfile` / `searchKnowledge` | 意图识别、路由决策、紧急情况检测、会话上下文获取、升级到人工（`classifyIntent` / `routeToAgent` / `detectEmergency` / `getConversationContext` / `escalateToHuman`） |
| AssistantAgent | 情绪/意图分析；知识推荐；回复建议；`analyzeConversation` / `getCustomerProfile` / `searchKnowledge` | 生成回复、提取需求、风险评估、推荐下一步动作（`generateReply` / `extractRequirement` / `assessRisk` / `recommendNextAction`） |
| EngineerAgent | 技术知识检索；工单创建；`searchKnowledge` / `createTask` | 故障诊断、问题分类、日志分析、方案推荐、解决时长评估、技术工单创建、历史工单检索、系统状态查询（`diagnoseFault` / `classifyIssue` / `analyzeLogs` / `recommendSolution` / `estimateResolutionTime` / `createTechnicalTicket` / `searchTickets` / `getSystemStatus`） |
| InspectorAgent | 对话质检评分与改进建议输出（基于文本） | 会话质检、合规检查、违规检测、质检报告生成、团队对比分析（`inspectConversation` / `checkCompliance` / `detectViolations` / `generateQualityReport` / `compareTeamPerformance`） |

1. **Orchestrator Agent（路由编排）**
   - 当前实现位置：`agentscope-service/src/router/orchestrator_agent.py`
   - 作用：基于规则/启发式进行执行模式与路由决策（`simple/parallel/agent_supervised/human_first`）。
   - 已接入工具：`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`。
   - 与本链路关系：负责“意图/场景 → 路由到 Assistant/Engineer”的编排入口。
   - 规划能力备注（中文说明）：意图识别、路由决策、紧急情况检测、会话上下文获取、升级到人工（`classifyIntent` / `routeToAgent` / `detectEmergency` / `getConversationContext` / `escalateToHuman`）。

2. **AssistantAgent（对话辅助）**
   - 当前实现位置：`agentscope-service/src/agents/assistant_agent.py`
   - 已接入工具：`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`。
   - 与本链路关系：提供情绪/意图分析、知识推荐与回复建议（人机协同）。
   - 规划能力备注（中文说明）：生成回复、提取需求、风险评估、推荐下一步动作（`generateReply` / `extractRequirement` / `assessRisk` / `recommendNextAction`）。

3. **EngineerAgent（故障诊断）**
   - 当前实现位置：`agentscope-service/src/agents/engineer_agent.py`
   - 已接入工具：`searchKnowledge` / `createTask`。
   - 与本链路关系：技术故障场景生成诊断建议，并辅助创建工单。
   - 规划能力备注（中文说明）：故障诊断、问题分类、日志分析、方案推荐、解决时长评估、技术工单创建、历史工单检索、系统状态查询（`diagnoseFault` / `classifyIssue` / `analyzeLogs` / `recommendSolution` / `estimateResolutionTime` / `createTechnicalTicket` / `searchTickets` / `getSystemStatus`）。

4. **InspectorAgent（质检评分）**
   - 当前实现位置：`agentscope-service/src/agents/inspector_agent.py`
   - 已实现能力：基于对话文本输出质检评分与改进建议（当前无持久化报表链路）。
   - 与本链路关系：由“问题解决事件”异步触发质检，不依赖会话关闭。
   - 规划能力备注（中文说明）：会话质检、合规检查、违规检测、质检报告生成、团队对比分析（`inspectConversation` / `checkCompliance` / `detectViolations` / `generateQualityReport` / `compareTeamPerformance`）。

---

如需把这两张图拆分为“业务时序图 / 技术时序图”，或补充 WebSocket/IM 回执链路，我可以继续细化。

---

# 业务时序图（面向产品/流程，IM 方式）

**说明**
- 以 IM 对话为载体，不存在“关闭会话”的业务逻辑。
- 采用人机协同：Agent 辅助售后工程师服务客户，不涉及传统坐席/转接逻辑。
- 以“问题发现 → 工单驱动 → 工单结束视为问题解决”的方式闭环。
- 一个 IM 对话内可并行处理多个问题（多个工单），并支持各自状态流转。

```mermaid
sequenceDiagram
  autonumber
  actor U as 客户
  participant IM as 外部IM渠道
  participant API as 后端API
  participant OR as Orchestrator Agent
  participant AA as AssistantAgent
  participant EA as EngineerAgent
  participant KB as 知识库
  participant CS as 售后工程师
  participant TS as 工单系统

  U->>IM: 发送消息(可能包含多个问题)
  IM->>API: IM消息入站
  API->>OR: 路由决策(意图/场景/紧急度)
  OR->>AA: 常规咨询/澄清
  OR->>EA: 技术故障/复杂问题
  AA->>KB: 检索知识推荐
  EA->>KB: 检索技术知识
  AA-->>CS: 需要人工复核(可选)
  EA-->>CS: 需要人工复核(可选)

  alt 路由到 AssistantAgent
    AA->>TS: 创建工单(必要时/并行)
  else 路由到 EngineerAgent
    EA->>TS: 创建工单(必要时/并行)
  end

  CS-->>IM: 售后答复(基于建议/知识)
  IM-->>U: 客户收到回复

  loop 工单驱动处理
    CS->>TS: 更新工单状态(处理中/待客户/已解决)
    TS-->>CS: 状态变更回执
  end

  Note over TS,IM: 工单结束视为该问题解决
  Note over IM,API: 同一对话中可并行处理多个问题\n每个问题对应独立工单与状态流转
```

# 技术时序图（系统实现细节）

**说明**
- 关注真实代码路径：Controller → Coordinator → UseCase → Repository。
- 体现事件溯源与 Outbox 的“双写”机制，便于排查一致性问题。
- 展示 AI/知识库/任务等外部/内部依赖的调用顺序。

## 技术时序图 A：消息入站核心链路

**中文备注**
- 该链路展示“入站消息 → 会话创建/复用 → Orchestrator 路由 → 专业 Agent 处理 → 响应返回”。
- `ConversationRepository.save` 同步写入 `domain_events` 与 `outbox_events`，确保事件可追溯与最终一致性。
- AI 情绪分析与回复建议由 AssistantAgent / EngineerAgent 生成，Controller 侧仅负责补充响应字段。

```mermaid
sequenceDiagram
  autonumber
  actor IM as 外部IM/客户
  participant API as Fastify API
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant DE as domain_events
  participant OB as outbox_events
  participant EB as EventBus(内存)
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant LLM as LLMClient/外部AI
  participant SKU as SearchKnowledgeUseCase
  participant KB as TaxKB/KnowledgeRepository

  IM->>API: POST /api/im/incoming-message
  API->>IMC: handleIncomingMessage()
  IMC->>CTC: processCustomerMessage()

  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: 查找会话
  alt 新会话
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: 保存 Conversation + Message
    CR->>DE: 写入事件溯源
    CR->>OB: 写入 Outbox
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else 复用会话
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: 保存 Message
    CR->>DE: 写入事件溯源
    CR->>OB: 写入 Outbox
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt 需求成立
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated...)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    end
  end

  AA->>AIS: analyzeSentiment(userMessage, history)
  EA->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  AA->>AIS: generateReply(...)
  EA->>AIS: generateReply(...)

  IMC->>AIS: analyzeSentiment(content, last5Messages)
  IMC->>SKU: execute(query)
  SKU->>KB: 查询知识库
  IMC->>TR: findByFilters(conversationId)
  IMC-->>API: 组装响应
  API-->>IM: 返回结果
```

**说明**
- 覆盖“消息入站到响应”的主链路，重点在：对话创建/复用、消息持久化、事件发布、AI/知识库/任务联动。
- 适合定位 IM 入站问题（如消息未落库、任务未创建、知识未推荐等）。

## 技术时序图 B：IM 对话内“问题生命周期 + 质检”链路（异步）

**中文备注**
- 不存在“关闭会话”，所有问题在同一 IM 对话内流转。
- 大模型判断“问题提出/已解决”，驱动问题状态管理与质检触发。
- 质检为异步，不阻塞问题处理或工单流转。

```mermaid
sequenceDiagram
  autonumber
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant AIS as AiService/LLMClient
  participant TS as 工单系统
  participant EB as EventBus(内存)
  participant OB as outbox_events
  participant OP as OutboxProcessor
  participant AGS as AgentScope /api/agents/inspect

  IMC->>CTC: processCustomerMessage()
  CTC->>AIS: LLM 判断“是否提出问题”
  alt 判断为新问题
    CTC->>TS: 辅助人工创建工单(问题实例)
    TS-->>CTC: 工单创建结果
    CTC-->>IMC: 记录问题为“处理中”
  else 非问题/闲聊
    CTC-->>IMC: 不创建工单
  end

  CTC->>AIS: LLM 判断“是否已解决”
  alt 判断为已解决
    CTC->>TS: 更新工单状态为已解决/已完成
    CTC->>EB: 发布质检事件(ProblemResolved)
    CTC->>OB: 写入 Outbox
    OP->>OB: 轮询待投递事件
    OP->>EB: publish(ProblemResolved)
    EB->>AGS: 触发质检 /api/agents/inspect
  else 未解决
    CTC-->>IMC: 问题状态保持处理中/待客户
  end
```

**说明**
- IM 对话内“问题状态”与“工单状态”保持一致，用于并行问题管理。
- LLM 负责判定“新问题/已解决”，售后工程师可辅助确认与修正。
- 质检在问题解决后触发，避免影响 IM 对话的实时响应。

---

# 问题状态机（IM 对话内）

**状态说明**
- `new`: 大模型识别到新问题，待确认/待创建工单
- `in_progress`: 已创建工单，处理中
- `waiting_customer`: 等待客户补充信息
- `resolved`: 大模型判定已解决，待质检
- `reopened`: 客户反馈未解决或新问题复开

```mermaid
stateDiagram-v2
  [*] --> new: LLM识别新问题
  new --> in_progress: 售后工程师确认/创建工单
  in_progress --> waiting_customer: 请求客户补充
  waiting_customer --> in_progress: 客户补充后继续处理
  in_progress --> resolved: LLM判定已解决/工单完成
  resolved --> reopened: 客户反馈未解决
  reopened --> in_progress: 重新处理/补充工单
```

**中文备注**
- 状态与工单保持一致，便于在同一 IM 对话中并行管理多个问题。
- “已解决”并不关闭会话，仅用于标记问题生命周期结束。

---

# 问题并行管理示意图（同一 IM 对话）

**说明**
- 同一对话内可同时存在多个问题实例，每个问题独立状态流转。
- IM 对话是“承载容器”，问题与工单是“并行单元”。

```mermaid
graph TD
  IM[IM 对话] --> P1[问题 A<br/>状态: in_progress]
  IM --> P2[问题 B<br/>状态: waiting_customer]
  IM --> P3[问题 C<br/>状态: resolved]

  P1 --> T1[工单 A]
  P2 --> T2[工单 B]
  P3 --> T3[工单 C]
```

**中文备注**
- 每个问题与工单一一对应，状态同步；问题解决不影响对话持续。
- LLM 负责判定“新问题/已解决”，售后工程师可修正与复开。

# IM 回执 / WebSocket 联动（已实现）

**说明**
- 已支持 IM 回执状态更新与 WebSocket 实时通知。
- 复核请求通过 Outbox + EventBridge 推送到 AgentScope，再由 WebSocket 下发到前端。

**中文备注**
- 该链路已作为“人机协同关键路径”落地。
- 复核审核结果回写后可触发工单创建与状态刷新。

```mermaid
sequenceDiagram
  autonumber
  participant FE as 售后工作台
  participant WS as WebSocket/通知服务
  participant API as Fastify API
  participant CTC as ConversationTaskCoordinator

  CTC-->>WS: emit("agent:review_request", suggestion)
  WS-->>FE: 推送复核任务
  FE->>API: 人工审核/确认创建任务
  API-->>FE: 更新会话状态/任务列表

  Note over API,FE: 如接入IM回执/送达状态
  FE->>API: 回执状态更新(送达/已读)
  API-->>FE: 更新消息状态
```

# 外部依赖与配置开关标注

1. **LLM/AI 能力**
   - 入口：`AiService` -> `LLMClient`
   - 开关：`LLMClient.isEnabled()`；外部 AI 服务通过 `config.ai.serviceUrl`。
   - 影响路径：情绪分析、回复建议生成、对话总结。

2. **知识库检索**
   - 入口：`SearchKnowledgeUseCase`
   - 开关：`TaxKBAdapter.isEnabled()`（默认 true）
   - 影响路径：IM 入站后的知识推荐。

3. **AgentScope 质检**
   - 入口：问题解决事件处理器（ProblemResolvedEventHandler）
   - 配置：`config.agentscope.serviceUrl` + `config.agentscope.timeout`
   - 触发：问题判定已解决后异步调用 `/api/agents/inspect`

4. **Outbox 异步投递**
   - 入口：`ConversationRepository.save` -> `OutboxEventBus.publishInTransaction`
   - 处理器：`OutboxProcessor`（定时轮询 outbox_events）
   - 触发链路：EventBus -> 订阅者（用于“问题解决事件”触发质检）

---

# 需求识别子链路（技术细分）

**说明**
- 聚焦“文本 → 需求 → 任务”的联动，适合排查需求识别与自动建单问题。
- 低置信度或非紧急需求只会推荐，不会自动创建任务。

**中文备注**
- 需求识别为“并行问题管理”的入口，建议在此处打点统计识别准确率与误报率。
- 高优先级任务自动创建；中低优先级建议由售后工程师确认。

```mermaid
sequenceDiagram
  autonumber
  participant CTC as ConversationTaskCoordinator
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant DB as PostgreSQL
  participant EB as EventBus
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository

  CTC->>RDS: detect(content)
  alt 需求成立(置信度>0.7)
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    else medium/low
      CTC-->>CTC: recommendedTasks(人工确认)
    end
  else 无需求
    CTC-->>CTC: 跳过建单
  end
```

# 知识库检索子链路（技术细分）

**说明**
- 聚焦“关键词/意图 → 知识检索 → 推荐列表”。
- TaxKB 可关闭；本地知识库会作为兜底。

**中文备注**
- 若未启用 TaxKB，返回结果来自本地知识库。
- 推荐列表会做相关性筛选与排序，避免低相关内容干扰回复。

```mermaid
sequenceDiagram
  autonumber
  participant IMC as ImController
  participant AIS as AiService/LLMClient
  participant SKU as SearchKnowledgeUseCase
  participant TKB as TaxKB/KnowledgeRepository

  IMC->>AIS: extractIntent(content) (可选)
  IMC->>SKU: execute(query)
  SKU->>TKB: keyword/semantic/qa 搜索
  TKB-->>SKU: 返回候选知识
  SKU-->>IMC: 合并去重+排序
  IMC-->>IMC: 过滤低相关性
```

# 人工复核子链路（技术细分，已实现）

**说明**
- 已通过 ReviewRequest + Outbox + WebSocket 完成实时推送。
- 复核提交后可自动创建任务并回写状态。

**中文备注**
- 该链路为“人机协同关键点”，已在 WebSocket/事件层统一治理与监控。
- 复核动作会回写任务状态与建议处理结果。

```mermaid
sequenceDiagram
  autonumber
  participant CTC as ConversationTaskCoordinator
  participant WS as WebSocket/通知服务
  participant FE as 售后前端
  participant API as Fastify API

  CTC-->>WS: emit("agent:review_request", suggestion)
  WS-->>FE: 推送复核任务
  FE->>API: 确认/驳回建议，创建任务
  API-->>FE: 返回最新任务/状态
```
