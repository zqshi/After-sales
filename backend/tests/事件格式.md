# IM 消息进入系统后的联动流程梳理

基于当前代码实现（`ImController` → `ConversationTaskCoordinator` 等），IM 消息进入系统后触发的主要联动包含：
- 会话创建/复用与消息落库（Conversation + Message）。
- 领域事件记录（`domain_events`）与 Outbox 事件持久化（`outbox_events`）。
- 需求识别 → 需求创建 → 高优先级任务创建。
- AI 情绪分析（两处：Coordinator 内部生成回复时一次；Controller 组装响应时一次）。
- 知识库检索与推荐（Controller 侧 + Coordinator 生成回复时）。
- 任务关联查询（Controller 侧）。
- 自动回复建议生成与人工复核触发（创建 ReviewRequest，推送渠道依赖外部 AgentScope/前端实现；本仓库未见 WebSocket 推送实现）。
- 问题解决事件触发异步质检（当问题判定已解决时）。

以下为完整的时序图与服务调用链路图（Mermaid）。

## 时序图（IM 入站处理）

**中文备注**
- 入口：外部 IM 消息通过 `/api/im/incoming-message` 入站。
- 核心编排：`ImController` 调用 `ConversationTaskCoordinator` 完成会话创建/复用、需求识别、任务创建与回复建议生成。
- 数据落库：对话与消息落在 `conversations/messages`，事件溯源写入 `domain_events`，同时写入 `outbox_events` 保障最终一致性。
- AI 联动：情绪分析在 Coordinator 内部（生成回复）与 Controller 组装响应各执行一次。
- 结果返回：包含情绪、需求、知识推荐、工单关联与回复建议。
- AgentScope 调用：回复建议通过 `/api/chat/message` 获取（AgentScope 服务内完成 Orchestrator/Assistant/Engineer 流转）。

```mermaid
sequenceDiagram
  autonumber
  actor IM as 外部IM/客户
  participant API as Fastify API (/api/im/incoming-message)
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant AGS as AgentScope Service (Orchestrator/Assistant/Engineer)
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant EB as EventBus(内存)
  participant OB as OutboxEventBus
  participant RDS as RequirementDetectorService
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant LLM as LLMClient/外部AI
  participant SKU as SearchKnowledgeUseCase
  participant TKB as TaxKB/本地KnowledgeRepo

  IM->>API: POST /api/im/incoming-message
  API->>IMC: handleIncomingMessage()

  IMC->>CTC: processCustomerMessage()
  CTC->>AGS: /api/chat/message 生成回复建议
  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: 查询 Conversation + Messages
  alt 无活跃会话
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: 保存 Conversation + Message
    CR->>DB: 写入 domain_events
    CR->>OB: 写入 outbox_events
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else 有活跃会话
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: 保存 Message
    CR->>DB: 写入 domain_events
    CR->>OB: 写入 outbox_events
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt 需求置信度 > 0.7
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated...)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    else medium/low
      CTC-->>IMC: recommendedTasks (待人工确认)
    end
  end

  CTC->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  CTC->>AIS: generateReply(...) (AgentScope 或 LLM/不可用时提示客服侧处理)

  CTC-->>IMC: ProcessingResult(agentSuggestion)

  IMC->>CR: findById(conversationId)
  CR->>DB: 拉取最近消息用于情绪分析
  IMC->>AIS: analyzeSentiment(content, last5Messages)
  AIS->>LLM: analyzeSentiment()

  IMC->>SKU: execute(query)
  SKU->>TKB: 关键词/语义/QA检索

  IMC->>TR: findByFilters(conversationId)
  TR->>DB: 拉取关联 Task

  IMC-->>API: 组装 response (sentiment/requirements/knowledge/tasks/suggestion)
  API-->>IM: 200 OK + 分析结果
```

## 服务调用链路图（含事件与异步链路）

**中文备注**
- 展示 IM 入站后的核心服务编排与事件链路（同步 + 异步）。
- 主链路：IM → API → Controller → Coordinator → UseCase → Repository → DB。
- 事件链路：领域事件进入 `domain_events`，同时进入 `outbox_events`，由 `OutboxProcessor` 异步投递（仅 `config.outbox.enabled` 为 true 时）。
- 异步链路用于触发质检/告警等非阻塞流程；与会话是否关闭无关，可由“问题解决事件”驱动。

```mermaid
graph TD
  IM[External IM Customer] --> API[Fastify API incoming message]
  API --> IMC[ImController]
  IMC --> CTC[ConversationTaskCoordinator]
  CTC --> AGS["AgentScope Service (Orchestrator/Assistant/Engineer)"]

  CTC --> CCU[CreateConversationUseCase]
  CTC --> SMU[SendMessageUseCase]
  CCU --> CR[ConversationRepository]
  SMU --> CR
  CR --> DB[PostgreSQL]
  CR --> DE["domain events"]
  CR --> OB["outbox events"]
  CCU --> EB[EventBus]
  SMU --> EB

  CTC --> RDS[RequirementDetectorService]
  CTC --> CRU[CreateRequirementUseCase]
  CRU --> RR[RequirementRepository]
  RR --> DB
  CRU --> EB
  CTC --> CTU[CreateTaskUseCase]
  CTU --> TR[TaskRepository]
  TR --> DB

  AGS --> AIS[AiService]
  AIS --> LLM["LLMClient External AI"]
  IMC --> AIS

  IMC --> SKU[SearchKnowledgeUseCase]
  SKU --> TKB[TaxKB KnowledgeRepository]

  IMC --> TR

  OP[OutboxProcessor] --> EB
  EB --> PRH[ProblemResolvedHandler]
  PRH --> AGSI["AgentScope Inspect API"]
```

## 关键联动点说明（与代码对应）

1. **消息入站与对话复用/创建**
   - `ImController.handleIncomingMessage` → `ConversationTaskCoordinator.processCustomerMessage`。
   - `CreateConversationUseCase` / `SendMessageUseCase` 会调用 `ConversationRepository.save`，同步写入：
     - `conversations` + `messages`（对话与消息）  
     - `domain_events`（事件溯源）
     - `outbox_events`（Outbox 最终一致性）

2. **需求识别与任务联动**
   - `RequirementDetectorService.detect` → `CreateRequirementUseCase.execute` → `RequirementRepository.save`
   - 高优先级需求触发 `CreateTaskUseCase.execute` → `TaskRepository.save`

3. **AI 联动（情绪 + 回复建议）**
   - `ConversationTaskCoordinator.generateAgentReply` 内部调用 `AiService.analyzeSentiment`，优先走 AgentScope 生成回复建议，失败时提示客服侧处理并进行重试。
   - `ImController` 在返回前再次调用 `AiService.analyzeSentiment` 生成响应里的情绪字段。

4. **知识库与任务关联**
   - `SearchKnowledgeUseCase` 组合 TaxKB + 本地知识库检索（Controller 侧用于推荐）。
   - Coordinator 生成回复建议时也会查询知识库（用于回复构造）。
   - `TaskRepository.findByFilters` 关联当前对话的任务列表。

5. **事件与异步链路**
   - “问题解决事件”由 Problem 状态更新触发（`ProblemResolved` 领域事件）。
   - OutboxProcessor 仅在 `config.outbox.enabled` 开启时启动，负责轮询并投递事件到内存 EventBus。
   - 处理器通过 `AgentScope /api/agents/inspect` 触发质检（异步，不阻塞主流程）。

---

## AgentScope 支持能力补充（全量更新，基于现有代码）

**说明**
- 下述能力以“当前代码是否可用/是否默认启用/是否缺口”为基准汇总，覆盖 AgentScope（外部服务）与本仓库 Workflow/MCP 接入情况。
- 启动方式统一为 Docker Compose，默认启用 Workflow 与 MCP 自动注册（见下方“默认启用状态”）。
- 默认链路仍以 `ConversationTaskCoordinator -> AgentScope(/api/chat/message) -> LLM/降级` 为主；Workflow 规划能力默认开启（`WORKFLOW_ENGINE_ENABLED=true` 且 `WORKFLOW_ENGINE_MODE=full`），如需关闭需显式配置。
- AgentScope 的 ReActAgent 工具注册已默认启用（可通过 `AGENTSCOPE_MCP_ENABLED=false` 关闭），Agent 内部仍保留 `BackendMCPClient` 手工调用兜底路径。

**能力对照表（中文）**

| Agent | 已实现能力（默认可用） | 规划能力（代码存在/可用，需在Workflow/Agent侧编排启用） |
|---|---|---|
| Orchestrator Agent | 规则/启发式路由决策；执行模式选择；人工介入触发；`analyzeConversation` / `getCustomerProfile` / `searchKnowledge` / `getConversationContext` | `classifyIntent` / `routeToAgent` / `detectEmergency` / `getConversationContext` / `escalateToHuman` 已在 MCP 工具与 Workflow 动作中提供（需要在 Workflow/Agent 侧编排调用） |
| AssistantAgent | 情绪/意图分析、知识推荐、回复建议（AgentScope 侧完成；本仓库接收结果） | `generateReply` / `extractRequirement` / `assessRisk` / `recommendNextAction` 已提供 MCP 工具与工作流动作支持（需编排调用） |
| EngineerAgent | 知识检索、工单创建（`searchKnowledge` / `createTask` / `createTechnicalTicket`） | `diagnoseFault` / `classifyIssue` / `analyzeLogs` / `recommendSolution` / `estimateResolutionTime` / `searchTickets` / `getSystemStatus` 已提供 MCP 工具与工作流动作支持（需编排调用） |
| InspectorAgent | 质检评分、改进建议输出（AgentScope 侧生成），并通过 `saveQualityReport` / `createSurvey` 落库 | `inspectConversation` / `checkCompliance` / `detectViolations` / `generateQualityReport` / `compareTeamPerformance` 已提供 MCP 工具与工作流动作支持（需编排调用） |

**AgentScope MCP 工具清单（本仓库提供给 AgentScope）**
- Conversation：`createConversation` / `sendMessage` / `getConversation` / `getConversationHistory` / `getConversationContext` / `closeConversation`
- Customer：`getCustomerProfile` / `getCustomerHistory` / `updateRiskLevel` / `addServiceRecord`
- Knowledge：`searchKnowledge` / `uploadDocument` / `getKnowledgeDetail`
- Requirement：`detectRequirement` / `createRequirement`
- Task：`createTask` / `createTechnicalTicket` / `updateTaskStatus` / `searchTickets`
- AI：`analyzeConversation` / `recommendKnowledge` / `saveQualityReport` / `createSurvey` / `getSystemStatus` / `classifyIntent` / `extractRequirement` / `assessRisk` / `recommendNextAction` / `analyzeLogs` / `classifyIssue` / `recommendSolution` / `estimateResolutionTime` / `checkCompliance` / `detectViolations` / `compareTeamPerformance` / `inspectConversation` / `generateQualityReport`
- MCP 接口：`/mcp`（tools/list, tools/call），`/mcp/tools`（工具列表）
- 工具实现文件：
  - Conversation：`backend/src/infrastructure/agentscope/tools/ConversationTools.ts`
  - Customer：`backend/src/infrastructure/agentscope/tools/CustomerTools.ts`
  - Knowledge：`backend/src/infrastructure/agentscope/tools/KnowledgeTools.ts`
  - Requirement：`backend/src/infrastructure/agentscope/tools/RequirementTools.ts`
  - Task：`backend/src/infrastructure/agentscope/tools/TaskTools.ts`
  - AI：`backend/src/infrastructure/agentscope/tools/AITools.ts`
- 注册入口：`backend/src/infrastructure/agentscope/MCPServer.ts`、`backend/src/infrastructure/agentscope/AgentScopeGateway.ts`
- 参考：ReAct/Workflow 入口（用于规划能力的代码落点）
  - AgentScope ReAct Agents：`agentscope-service/src/agents/assistant_agent.py`、`agentscope-service/src/agents/engineer_agent.py`、`agentscope-service/src/agents/inspector_agent.py`
  - Orchestrator 路由与模式：`agentscope-service/src/router/orchestrator_agent.py`
  - Workflow 入口：`backend/src/application/services/ConversationTaskCoordinator.ts`
  - Workflow 执行器：`backend/src/infrastructure/workflow/executors/ActionStepExecutor.ts`
- Workflow 定义：`workflows/customer_service.yaml`

**默认启用状态（关键配置与影响）**
- Workflow 规划能力默认开启：`WORKFLOW_ENGINE_ENABLED=true` 且 `WORKFLOW_ENGINE_MODE=full`（可显式设置为 `false` / `analysis_only` 以关闭或降级）。
- Workflow 动作能力：内置动作已覆盖意图识别、上下文获取、升级人工、故障诊断、质检等（详见 `ActionStepExecutor`），可按需扩展自定义动作。
- AgentScope ReAct 自动工具调用默认开启：`AGENTSCOPE_MCP_ENABLED=true`。
- Docker Compose 启动时默认注入上述配置（见 `docker-compose.yml`）。

**模型/LLM 统一配置（DeepSeek）**
- 所有依赖大模型的调用统一使用 DeepSeek，配置由环境变量注入：
  - 后端：`AI_SERVICE_PROVIDER=deepseek`、`AI_SERVICE_URL`、`AI_SERVICE_API_KEY`、`AI_MODEL=deepseek-v3.1`
  - AgentScope：读取 `AI_SERVICE_URL` / `AI_SERVICE_API_KEY`，并使用 `deepseek-v3.1`
- Docker Compose 已为后端与 AgentScope 注入上述变量，默认即走 DeepSeek。

**MCP 工具说明（定义与调用场景）**

| 工具 | 定义 | 调用场景 |
|---|---|---|
| createConversation | 创建新的对话 | 新客户入站且无活跃会话 |
| sendMessage | 发送消息到对话 | 系统/坐席向客户发送消息 |
| getConversation | 获取对话详情 | 获取对话元信息与消息 |
| getConversationHistory | 获取对话历史消息 | 质检/Agent 需要完整对话上下文 |
| closeConversation | 关闭对话 | 业务允许关闭场景 |
| getCustomerProfile | 获取客户画像 | 路由/风险评估/个性化回复 |
| getCustomerHistory | 获取客户历史对话列表 | 风险评估/背景补全 |
| updateRiskLevel | 更新客户风险等级 | 风险指标变化后刷新画像 |
| addServiceRecord | 添加服务记录 | 人工处理后沉淀服务记录 |
| searchKnowledge | 知识库检索 | 回复建议/故障排查 |
| uploadDocument | 上传文档到知识库 | 知识更新/运维资料入库 |
| getKnowledgeDetail | 获取知识条目详情 | 展示或引用知识详情 |
| detectRequirement | 需求识别 | 入站消息需求检测 |
| createRequirement | 创建需求 | 需求成立后落库 |
| createTask | 创建任务/工单 | 高优先级需求或故障需建单 |
| createTechnicalTicket | 创建技术工单 | 工程师故障诊断后建单 |
| updateTaskStatus | 更新任务状态 | 工单流转 |
| searchTickets | 检索历史工单 | EngineerAgent 故障诊断参考 |
| classifyIntent | 意图识别 | 路由决策与意图理解 |
| extractRequirement | 提取需求 | AssistantAgent 需求结构化 |
| assessRisk | 风险评估 | 投诉/紧急场景判断 |
| recommendNextAction | 推荐下一步动作 | 自动回复或升级人工 |
| analyzeLogs | 日志分析 | 故障诊断与根因排查 |
| classifyIssue | 问题分类 | 故障/投诉/咨询识别 |
| recommendSolution | 方案推荐 | 工程师故障处理建议 |
| estimateResolutionTime | 解决时长评估 | 给出预计修复时间 |
| analyzeConversation | 情绪/质量分析 | 情绪、质检或风险评估 |
| inspectConversation | 会话质检 | InspectorAgent 质检评估 |
| generateQualityReport | 生成质检报告 | 质检报告生成（不落库） |
| recommendKnowledge | 推荐知识 | 自动回复建议辅助 |
| saveQualityReport | 保存质检报告 | InspectorAgent 质检输出落库 |
| createSurvey | 创建回访问卷 | 质检建议回访时触发 |
| getSystemStatus | 获取系统状态与服务可用性 | 诊断/自检/告警 |
| checkCompliance | 合规检查 | 质检合规性评估 |
| detectViolations | 违规检测 | 合规风险识别 |
| compareTeamPerformance | 团队对比分析 | 团队质量趋势对比 |

**工具缺口清单**
- MCP 工具已补齐；是否启用取决于 `AGENTSCOPE_MCP_ENABLED` 与 Workflow/Agent 编排配置

**工具落地位置（已实现）**
- Conversation 历史：`backend/src/infrastructure/agentscope/tools/ConversationTools.ts`
- Customer 历史：`backend/src/infrastructure/agentscope/tools/CustomerTools.ts`
- 质检报告/回访：`backend/src/infrastructure/agentscope/tools/AITools.ts`
- 工单检索/系统状态：`backend/src/infrastructure/agentscope/tools/TaskTools.ts`、`backend/src/infrastructure/agentscope/tools/AITools.ts`
- 注册入口：`backend/src/infrastructure/agentscope/MCPServer.ts`

1. **Orchestrator Agent（路由编排）**
   - 当前实现位置：`agentscope-service/src/router/orchestrator_agent.py`
   - 作用：基于规则/启发式进行执行模式与路由决策（`simple/parallel/agent_supervised/human_first`）。
   - 已接入工具：`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`（Agent 内手工调用 MCP）。
   - 与本链路关系：位于 AgentScope 外部服务中，本仓库通过 `/api/chat/message` 调用触发。
   - 规划能力备注（中文说明）：`classifyIntent/getConversationContext/escalateToHuman` 已在 `ActionStepExecutor` 与 MCP 工具侧实现，`customer_service_workflow` 已接入这些动作。

2. **AssistantAgent（对话辅助）**
   - 当前实现位置：`agentscope-service/src/agents/assistant_agent.py`
   - 已接入工具：`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`（手工调用 MCP）。
   - 与本链路关系：位于 AgentScope 外部服务中，本仓库仅接收回复建议结果。
   - 规划能力备注（中文说明）：`generateReply/extractRequirement/assessRisk/recommendNextAction` 依赖模型输出；ReAct 自动工具调用未启用时，能力偏“提示词级”而非硬性编排。

3. **EngineerAgent（故障诊断）**
   - 当前实现位置：`agentscope-service/src/agents/engineer_agent.py`
   - 已接入工具：`searchKnowledge` / `createTask` / `searchTickets`（手工调用 MCP）。
   - 与本链路关系：位于 AgentScope 外部服务中，本仓库未直接实现诊断流程。
   - 规划能力备注（中文说明）：`getSystemStatus/classifyIssue/analyzeLogs/recommendSolution/estimateResolutionTime/createTechnicalTicket` 已在 MCP 工具与 Workflow 执行器中实现，但当前 Agent 侧未编排调用，Workflow 也未接入这些动作。

4. **InspectorAgent（质检评分）**
   - 当前实现位置：`agentscope-service/src/agents/inspector_agent.py`
   - 已实现能力：基于对话文本输出质检评分与改进建议（支持 `saveQualityReport` / `createSurvey`）。
   - 与本链路关系：由“问题解决事件”异步触发质检，不依赖会话关闭。
   - 规划能力备注（中文说明）：`checkCompliance/detectViolations/compareTeamPerformance` 已在 MCP 工具与 Workflow 执行器中实现，但默认链路未接入，Agent 侧也未显式编排调用。

**完备性检查**
- 规划动作与 MCP 工具已补齐，默认 Workflow 已开启且 `customer_service_workflow` 已接入关键规划动作；是否生效取决于运行配置与 Agent 侧编排调用。

---

以下为“业务时序图 / 技术时序图”的拆分版本，已按当前实现补充关键接口与配置说明。

---

# 业务时序图（面向产品/流程，IM 方式）

**说明**
- 以 IM 对话为载体，不存在“关闭会话”的业务逻辑。
- 采用人机协同：Agent 辅助售后工程师服务客户，不涉及传统坐席/转接逻辑。
- 以“问题发现 → 工单驱动 → 工单结束视为问题解决”的方式闭环。
- 一个 IM 对话内可并行处理多个问题（多个工单），并支持各自状态流转。

```mermaid
sequenceDiagram
  autonumber
  actor U as 客户
  participant IM as 外部IM渠道
  participant API as 后端API
  participant AGS as AgentScope Service (Orchestrator/Assistant/Engineer)
  participant KB as 知识库
  participant CS as 售后工程师
  participant TS as 工单系统

  U->>IM: 发送消息(可能包含多个问题)
  IM->>API: IM消息入站
  API->>AGS: 调用外部 AgentScope 生成建议
  AGS->>KB: 检索知识推荐(外部服务内部)
  AGS-->>CS: 需要人工复核(可选)

  AGS->>TS: 创建工单(必要时/并行)

  CS-->>IM: 售后答复(基于建议/知识)
  IM-->>U: 客户收到回复

  loop 工单驱动处理
    CS->>TS: 更新工单状态(处理中/待客户/已解决)
    TS-->>CS: 状态变更回执
  end

  Note over TS,IM: 工单结束视为该问题解决
  Note over IM,API: 同一对话中可并行处理多个问题\n每个问题对应独立工单与状态流转
```

# 技术时序图（系统实现细节）

**说明**
- 关注真实代码路径：Controller → Coordinator → UseCase → Repository。
- 体现事件溯源与 Outbox 的“双写”机制，便于排查一致性问题。
- 展示 AI/知识库/任务等外部/内部依赖的调用顺序。

## 技术时序图 A：消息入站核心链路

**中文备注**
- 该链路展示“入站消息 → 会话创建/复用 → 调用 AgentScope 生成建议 → 响应返回”。
- `ConversationRepository.save` 同步写入 `domain_events` 与 `outbox_events`，确保事件可追溯与最终一致性。
- AI 情绪分析与回复建议由 Coordinator 触发（优先 AgentScope，失败时提示客服侧处理并重试），Controller 侧补充响应字段。
- 关键接口：`/api/im/incoming-message`（入站）、`/api/chat/message`（AgentScope）、`/api/agents/inspect`（质检）。
- 关键配置：`config.agentscope.serviceUrl`、`config.agentscope.timeout`、`config.outbox.enabled`。
- 源码入口（本仓库）：`backend/src/presentation/http/routes/imRoutes.ts`、`backend/src/presentation/http/controllers/ImController.ts`、`backend/src/application/services/ConversationTaskCoordinator.ts`、`backend/src/application/use-cases/CreateConversationUseCase.ts`、`backend/src/application/use-cases/SendMessageUseCase.ts`、`backend/src/application/use-cases/requirement/CreateRequirementUseCase.ts`、`backend/src/application/use-cases/task/CreateTaskUseCase.ts`、`backend/src/application/use-cases/knowledge/SearchKnowledgeUseCase.ts`、`backend/src/infrastructure/repositories/ConversationRepository.ts`

```mermaid
sequenceDiagram
  autonumber
  actor IM as 外部IM/客户
  participant API as Fastify API
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant DE as domain_events
  participant OB as outbox_events
  participant EB as EventBus(内存)
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant AGS as AgentScope /api/chat/message
  participant LLM as LLMClient/外部AI
  participant SKU as SearchKnowledgeUseCase
  participant KB as TaxKB/KnowledgeRepository

  IM->>API: POST /api/im/incoming-message
  API->>IMC: handleIncomingMessage()
  IMC->>CTC: processCustomerMessage()

  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: 查找会话
  alt 新会话
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: 保存 Conversation + Message
    CR->>DE: 写入事件溯源
    CR->>OB: 写入 Outbox
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else 复用会话
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: 保存 Message
    CR->>DE: 写入事件溯源
    CR->>OB: 写入 Outbox
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt 需求成立
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated...)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    end
  end

  CTC->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  CTC->>AGS: 生成回复建议
  AGS-->>CTC: 回复建议/置信度

  IMC->>AIS: analyzeSentiment(content, last5Messages)
  IMC->>SKU: execute(query)
  SKU->>KB: 查询知识库
  IMC->>TR: findByFilters(conversationId)
  IMC-->>API: 组装响应
  API-->>IM: 返回结果
```

**说明**
- 覆盖“消息入站到响应”的主链路，重点在：对话创建/复用、消息持久化、事件发布、AI/知识库/任务联动。
- 适合定位 IM 入站问题（如消息未落库、任务未创建、知识未推荐等）。

## 技术时序图 B：IM 对话内“问题生命周期 + 质检”链路（异步）

**中文备注**
- 不存在“关闭会话”，所有问题在同一 IM 对话内流转。
- 大模型判断“问题提出/已解决”，驱动问题状态管理与质检触发。
- 质检为异步，不阻塞问题处理或工单流转。
- 质检入口：`/api/agents/inspect`，由 `ProblemResolved` 事件触发。
- 源码入口（本仓库）：`backend/src/application/services/ConversationTaskCoordinator.ts`、`backend/src/application/use-cases/problem/CreateProblemUseCase.ts`、`backend/src/application/use-cases/problem/UpdateProblemStatusUseCase.ts`、`backend/src/infrastructure/repositories/ProblemRepository.ts`、`backend/src/infrastructure/events/OutboxProcessor.ts`、`backend/src/application/event-handlers/ProblemResolvedEventHandler.ts`

```mermaid
sequenceDiagram
  autonumber
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant AIS as AiService/LLMClient
  participant CPU as CreateProblemUseCase
  participant UPS as UpdateProblemStatusUseCase
  participant PR as ProblemRepository
  participant DE as domain_events
  participant OB as outbox_events
  participant OP as OutboxProcessor
  participant EB as EventBus(内存)
  participant PRH as ProblemResolvedEventHandler
  participant AGS as AgentScope /api/agents/inspect

  IMC->>CTC: processCustomerMessage()
  CTC->>AIS: LLM 判断“是否提出问题”
  alt 判断为新问题
    CTC->>CPU: execute(CreateProblem)
    CPU->>PR: save(problem)
    PR->>DE: 写入 Problem 事件
    PR->>OB: 写入 Outbox
  else 非问题/闲聊
    CTC-->>IMC: 不创建问题
  end

  CTC->>AIS: LLM 判断“是否已解决”
  alt 判断为已解决
    CTC->>UPS: execute(UpdateProblemStatus resolved)
    UPS->>PR: save(problem)
    PR->>DE: 写入 ProblemResolved
    PR->>OB: 写入 Outbox
    OP->>OB: 轮询待投递事件
    OP->>EB: publish(ProblemResolved)
    EB->>PRH: handle(ProblemResolved)
    PRH->>AGS: 触发质检 /api/agents/inspect
  else 未解决
    CTC-->>IMC: 问题状态保持处理中/待客户
  end
```

**说明**
- IM 对话内“问题状态”与“工单状态”保持一致，用于并行问题管理。
- LLM 负责判定“新问题/已解决”，售后工程师可辅助确认与修正。
- 质检在问题解决后触发，避免影响 IM 对话的实时响应。

---

# 问题状态机（IM 对话内）

**状态说明**
- `new`: 大模型识别到新问题，待确认/待创建工单
- `in_progress`: 已创建工单，处理中
- `waiting_customer`: 等待客户补充信息
- `resolved`: 大模型判定已解决，待质检
- `reopened`: 客户反馈未解决或新问题复开

```mermaid
stateDiagram-v2
  [*] --> new: LLM识别新问题
  new --> in_progress: 售后工程师确认/创建工单
  in_progress --> waiting_customer: 请求客户补充
  waiting_customer --> in_progress: 客户补充后继续处理
  in_progress --> resolved: LLM判定已解决/工单完成
  resolved --> reopened: 客户反馈未解决
  reopened --> in_progress: 重新处理/补充工单
```

**中文备注**
- 状态与工单保持一致，便于在同一 IM 对话中并行管理多个问题。
- “已解决”并不关闭会话，仅用于标记问题生命周期结束。

---

# 问题并行管理示意图（同一 IM 对话）

**说明**
- 同一对话内可同时存在多个问题实例，每个问题独立状态流转。
- IM 对话是“承载容器”，问题与工单是“并行单元”。

```mermaid
flowchart TD
  IM[IM 对话] --> P1[问题 A<br/>状态: in_progress]
  IM --> P2[问题 B<br/>状态: waiting_customer]
  IM --> P3[问题 C<br/>状态: resolved]

  P1 --> T1[工单 A]
  P2 --> T2[工单 B]
  P3 --> T3[工单 C]
```

**中文备注**
- 每个问题与工单一一对应，状态同步；问题解决不影响对话持续。
- LLM 负责判定“新问题/已解决”，售后工程师可修正与复开。

# IM 回执 / WebSocket 联动（待接入）

**说明**
- 当前代码仅创建 ReviewRequest 并写入 Outbox，未发现 WebSocket 实时推送实现。
- 如需实时通知，可通过 Outbox + EventBridge 推送到 AgentScope，再由前端/通知服务下发。
- 相关配置：`config.agentscope.events`（事件桥接路径与超时）。

**中文备注**
- 该链路为“人机协同关键路径”的规划示意。
- 复核审核结果回写后可触发工单创建与状态刷新（需外部服务/前端联动）。

```mermaid
sequenceDiagram
  autonumber
  participant FE as 售后工作台
  participant WS as WebSocket/通知服务
  participant API as Fastify API
  participant CTC as ConversationTaskCoordinator

  Note over CTC,WS: 该链路为规划示意，当前仓库未实现 WS 推送
  CTC-->>WS: emit("agent:review_request", suggestion)
  WS-->>FE: 推送复核任务
  FE->>API: 人工审核/确认创建任务
  API-->>FE: 更新会话状态/任务列表

  Note over API,FE: 如接入IM回执/送达状态
  FE->>API: 回执状态更新(送达/已读)
  API-->>FE: 更新消息状态
```

# 外部依赖与配置开关标注

1. **LLM/AI 能力**
   - 入口：`AiService` -> `LLMClient`
   - 开关：`LLMClient.isEnabled()`；外部 AI 服务通过 `config.ai.serviceUrl`。
   - 影响路径：情绪分析、回复建议生成、对话总结。

2. **知识库检索**
   - 入口：`SearchKnowledgeUseCase`
   - 开关：`TaxKBAdapter.isEnabled()`（默认 true）
   - 影响路径：IM 入站后的知识推荐。

3. **AgentScope 质检**
   - 入口：问题解决事件处理器（ProblemResolvedEventHandler）
   - 配置：`config.agentscope.serviceUrl` + `config.agentscope.timeout`
   - 触发：问题判定已解决后异步调用 `/api/agents/inspect`
   - 持久化：质检结果写入 `quality_reports`（conversationId/problemId/score/report）
   - 查询：`GET /quality/:conversationId` 优先读取 `quality_reports`
   - 列表：`GET /quality/:conversationId/reports`（会话内历史）
   - 全量：`GET /quality/reports`（最近质检记录）

4. **Outbox 异步投递**
   - 入口：`ConversationRepository.save` -> `OutboxEventBus.publishInTransaction`
   - 处理器：`OutboxProcessor`（定时轮询 outbox_events，仅 `config.outbox.enabled` 为 true 时启动）
   - 触发链路：EventBus -> 订阅者（用于“问题解决事件”触发质检）

5. **AgentScope MCP 工具**
   - 入口：`/mcp`（tools/list, tools/call）、`/mcp/tools`（工具列表）
   - 依赖：`AgentScopeGateway` + `MCPServer` 注册工具集
   - 影响路径：AgentScope 调用本仓库的 Conversation/Customer/Knowledge/Requirement/Task/AI 工具

6. **AgentScope 事件桥接**
   - 入口：`EventBridge`（将内存 EventBus 事件转发至 AgentScope）
   - 配置：`config.agentscope.events.nodeToAgentPath`、`config.agentscope.events.agentToNodePath`、`config.agentscope.events.outboundTimeoutMs`
   - 影响路径：Outbox → EventBus → AgentScope（事件上报/回流）

7. **Workflow/ReAct Loop**
   - 入口：`WorkflowEngine` + `ActionStepExecutor`
   - 配置：`config.workflow.*`（enabled/mode/workflowsDir/timeout/parallel/logging）
   - 影响路径：IM 入站生成建议、并行分析与人工复核链路
   - 输出：建议中包含 ReAct trace（thought/action/observation），用于可解释与复核依据

---

# AgentScope 事件桥接子链路（技术细分）

**说明**
- 展示 EventBus 事件向 AgentScope 上报与回流的桥接过程。
- 入口由 `EventBridge` 注册，路径由 `config.agentscope.events` 控制。

```mermaid
sequenceDiagram
  autonumber
  participant EB as EventBus(内存)
  participant BR as EventBridge
  participant AGS as AgentScope Service
  participant API as Fastify API (agentscope/events)

  EB->>BR: publish(domainEvent)
  BR->>AGS: POST nodeToAgentPath (event payload)

  AGS-->>API: POST agentToNodePath (event inbound)
  API->>BR: publishInboundEvent()
  BR->>EB: publish(bridge event)
```

# 需求识别子链路（技术细分）

**说明**
- 聚焦“文本 → 需求 → 任务”的联动，适合排查需求识别与自动建单问题。
- 低置信度或非紧急需求只会推荐，不会自动创建任务。

**中文备注**
- 需求识别为“并行问题管理”的入口，建议在此处打点统计识别准确率与误报率。
- 高优先级任务自动创建；中低优先级建议由售后工程师确认。

```mermaid
sequenceDiagram
  autonumber
  participant CTC as ConversationTaskCoordinator
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant DB as PostgreSQL
  participant EB as EventBus
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository

  CTC->>RDS: detect(content)
  alt 需求成立(置信度>0.7)
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    else medium/low
      CTC-->>CTC: recommendedTasks(人工确认)
    end
  else 无需求
    CTC-->>CTC: 跳过建单
  end
```

# 知识库检索子链路（技术细分）

**说明**
- 聚焦“关键词/意图 → 知识检索 → 推荐列表”。
- TaxKB 可关闭；本地知识库作为唯一来源，若知识库不可用需提示客服侧处理。

**中文备注**
- 若未启用 TaxKB，返回结果来自本地知识库。
- 推荐列表会做相关性筛选与排序，避免低相关内容干扰回复。

```mermaid
sequenceDiagram
  autonumber
  participant IMC as ImController
  participant AIS as AiService/LLMClient
  participant SKU as SearchKnowledgeUseCase
  participant TKB as TaxKB/KnowledgeRepository

  IMC->>AIS: extractIntent(content) (可选)
  IMC->>SKU: execute(query)
  SKU->>TKB: keyword/semantic/qa 搜索
  TKB-->>SKU: 返回候选知识
  SKU-->>IMC: 合并去重+排序
  IMC-->>IMC: 过滤低相关性
```

# 人工复核子链路（技术细分，待接入）

**说明**
- 当前仓库已创建 ReviewRequest（由 Workflow human_in_loop 触发），并可通过 `/im/reviews/submit` 回写以继续流程。
- 提供 SSE 订阅：`/im/reviews/stream`（事件类型 review），查询接口：`/im/reviews/pending`。
- 未接入 WebSocket 推送与前端通知。
- 复核提交后自动创建任务/回写状态需由前端或外部服务联动完成。

**中文备注**
- 该链路为“人机协同关键点”，当前以 ReviewRequest + 人工回写为主。
- 复核动作需配合外部服务/前端才能回写任务状态与建议处理结果。

```mermaid
sequenceDiagram
  autonumber
  participant CTC as ConversationTaskCoordinator
  participant WS as WebSocket/通知服务
  participant FE as 售后前端
  participant API as Fastify API

  Note over CTC,WS: 该链路为规划示意，当前仓库未实现 WS 推送
  CTC-->>WS: emit("agent:review_request", suggestion)
  WS-->>FE: 推送复核任务
  FE->>API: 确认/驳回建议，创建任务
  API-->>FE: 返回最新任务/状态
```

---

# 投产落地计划（ReAct Loop）

**目标**
- 以 ReAct Loop 实现“可解释、可回溯、可控”的 Agent 辅助能力，服务于人工客服场景。
- 保障入站链路稳定、可观测、可回退，并具备灰度与降级策略。

**阶段与验收**
1. **阶段 0：文档与链路一致化**
   - 内容：校准文档与当前实现，明确“已实现/待接入”与真实链路。
   - 验收：文档与代码一致，关键链路都有准确描述。

2. **阶段 1：WorkflowEngine 接入主链路**
   - 内容：IM 入站触发 `customer_service_workflow`；提供触发数据（message、conversation、history、profile）。
   - 验收：`/api/im/incoming-message` 触发 workflow 且能产出结构化结果（建议/置信度/风险/下一步动作）。

3. **阶段 2：ActionStepExecutor 实际化**
   - 内容：`classify/send_message/create_task/create_requirement/close_conversation` 对接真实 UseCase 或服务。
   - 验收：workflow 执行可落库并触发 EventBus/Outbox；人工复核写入 ReviewRequest。

4. **阶段 3：ParallelStepExecutor 真执行**
   - 内容：并行子步骤走真实执行路径与错误策略；输出可用于回复建议。
   - 验收：并行步骤可输出有效结果，且失败不阻断主链路（可配置）。

5. **阶段 4：ReAct Loop（规划能力补齐）**
   - 内容：Orchestrator/Assistant/Engineer ReAct Loop；输出“建议/置信度/风险/行动项”（代码已有雏形与 workflow 入口，但默认未启用，且部分 MCP 工具未接通）。
   - 验收：低置信度触发人工复核；建议可解释、可回溯。仍需补齐工具与配置。

6. **阶段 5：人工复核闭环**
   - 内容：ReviewRequest → 通知 → 决策回写；支持修改建议与创建任务。
   - 验收：复核全链路可跑通；超时策略可控（auto_approve）。

7. **阶段 6：质检闭环**
   - 内容：ProblemResolved → 质检 → 质检结果落库与可视化。
   - 验收：质检结果可追踪并关联对话/任务。

**灰度与降级**
- 统一开关：启用 Workflow/ReAct Loop 时，失败自动降级为原有 Coordinator 逻辑。
- 分阶段启用：先只读建议，再逐步放开自动动作（建单/回复）。

---

# 流程阶段与服务可用性管控（落地清单）

**目标**
- 确保各阶段关键服务“可用即用、不可用可降级、缺口有补齐路径”。
- 将“阶段 → 依赖服务 → 可用性检查 → 降级策略 → 补齐项”闭环化。

## 阶段清单与服务依赖

1. **阶段 0：文档与链路一致化**
   - 依赖服务：无（文档一致性）
   - 可用性检查：关键链路描述与真实实现一致；规划能力现状标注为“已有雏形/默认未启用/工具缺口”
   - 降级策略：不适用
   - 补齐项：补齐规划能力落点与工具缺口（本文件已补充）

2. **阶段 1：WorkflowEngine 接入主链路**
   - 依赖服务：WorkflowEngine（`WORKFLOW_ENGINE_ENABLED=true`）、workflows YAML
   - 可用性检查：`customer_service_workflow` 能执行并输出 `suggested_reply`
   - 降级策略：Workflow 失败自动降级到 Coordinator/AgentScope/LLM
   - 补齐项：完善 workflow 执行器对关键 action 的真实落地（非 dry-run）

3. **阶段 2：ActionStepExecutor 实际化**
   - 依赖服务：UseCase/Repository（Conversation/Requirement/Task/AI）
   - 可用性检查：`create_requirement`/`send_message` 等动作可落库与回写
   - 降级策略：缺依赖时返回 dry-run 并记录 trace
   - 补齐项：补齐 MCP 工具缺口与动作执行路径

4. **阶段 3：ParallelStepExecutor 真执行**
   - 依赖服务：并行步骤执行器、超时/错误策略
   - 可用性检查：并行步骤可返回有效结果且可观测
   - 降级策略：单步失败不阻断主链路
   - 补齐项：完善错误归因与指标埋点

5. **阶段 4：ReAct Loop（规划能力补齐）**
   - 依赖服务：AgentScope ReActAgent + MCP 工具
   - 可用性检查：结构化输出可用、低置信度可触发人工复核
   - 降级策略：AgentScope 不可用 → Workflow/LLM
   - 补齐项：MCP 工具能力全量接通

6. **阶段 5：人工复核闭环**
   - 依赖服务：ReviewRequest/SSE/回写接口
   - 可用性检查：ReviewRequest 可创建/查询/回写
   - 降级策略：超时 auto_approve 或人工优先
   - 补齐项：通知侧（WebSocket/前端）落地

7. **阶段 6：质检闭环**
   - 依赖服务：质检报告存储、质检触发器、回访/改进任务
   - 可用性检查：`ProblemResolved` 可触发质检并落库
   - 降级策略：质检失败不阻塞主链路
   - 补齐项：质检报告/回访工具完善与可视化

## 服务可用性检查（建议最小保障项）

- **核心 API**：`/api/im/incoming-message` 入站可处理；响应包含建议/情绪/任务等字段
- **DB 与事件**：`conversations/messages/domain_events/outbox_events` 可写；OutboxProcessor 可跑通
- **AgentScope**：`/api/chat/message` 可返回建议；不可用时提示客服侧处理并记录失败原因
- **Workflow**：`customer_service_workflow` 可执行；失败自动回落并提示客服侧处理
- **AI 服务**：情绪分析与回复生成可用；不可用时提示客服侧处理并在前端标记异常
- **知识库**：`searchKnowledge` 可返回结果；不可用时提示客服侧处理
- **Review**：ReviewRequest 创建/回写可用；不可用时走 auto_approve
- **质检**：质量报告可落库；不可用时记录失败并重试

## 不可用服务完善（已补齐方向）

- MCP 工具缺口已补齐并注册到 MCP Server（对话历史/客户历史/质检报告/回访/工单检索/系统状态）。
- 质检回访支持已落地到 `surveys` 表（新增 SurveyRepository 与迁移）。

---

# 失败提示规范（面向用户体感）

**原则**
- 不返回兜底模板、示意文本或虚假数据。
- 失败时给出明确、礼貌、可执行的提示，并走人工/重试路径。

**建议提示文案（示例，面向客服侧）**
- AI 分析/回复不可用：  
  “智能分析不可用，请人工处理当前会话并记录异常。”
- AgentScope 服务不可用：  
  “Agent 服务不可用，请人工处理并稍后重试。”
- 知识库检索不可用：  
  “知识库检索不可用，请人工补充答复。”
- Workflow 执行失败：  
  “Workflow 执行失败，请人工处理并记录失败原因。”

**用户侧提示原则（对外话术）**
- 用户侧不暴露系统/模型异常，不出现“智能/模型/服务不可用”等表述。
- 统一使用业务型提示，例如：  
  “已收到您的问题，我们会尽快回复。”  
  “问题已记录，稍后给您反馈。”
