<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能售后工作台</title>

  <!-- 关键CSS内联 - 防止样式闪现 -->
  <style>
    /* 预设基础样式，防止FOUC */
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background-color: #f8fafc;
      opacity: 0;
      transition: opacity 0.2s ease-in;
    }
    body.loaded {
      opacity: 1;
    }
    .hidden {
      display: none !important;
    }
    /* AI辅助面板基础样式 */
    #ai-assistant-panel {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }
    #ai-assistant-panel.hidden {
      display: none;
    }
  </style>

  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet"></noscript>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>

  <!-- 统一样式入口 - 模块化CSS架构 -->
  <link rel="preload" href="assets/css/app.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="assets/css/app.css">
  </noscript>

  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E40AF',
            'primary-light': '#3B82F6',
            'primary-dark': '#1E3A8A',
            secondary: '#64748B',
            success: '#10B981',
            warning: '#F59E0B',
            error: '#EF4444',
            info: '#3B82F6',
            'bg-light': '#F8FAFC',
            'bg-white': '#FFFFFF',
            'text-primary': '#1E293B',
            'text-secondary': '#64748B',
            'text-muted': '#94A3B8',
            'border-color': '#E2E8F0',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            sm: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
            md: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
            lg: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
          }
        }
      }
    }
  </script>

  <!-- 运行时配置（可选，用于覆盖默认API地址） -->
  <script src="runtime-config.js"></script>
  <!-- API配置 -->
  <script>
    // 全局配置对象 - 用于配置API地址和用户信息
    const runtimeConfig = window.RUNTIME_CONFIG || {};
    const defaultOrigin = window.location.origin;
    window.config = {
      apiBaseUrl: runtimeConfig.apiBaseUrl || `${defaultOrigin}/api/v1`,  // 后端API基础地址
      authToken: null,  // 认证令牌（登录后设置）
      userId: 'agent-001',  // 当前用户ID（示例）
      analysisContext: '',  // AI分析上下文
      agentScopeUrl: runtimeConfig.agentScopeUrl || defaultOrigin, // AgentScope 服务地址
      agentScopeWebSocketUrl: runtimeConfig.agentScopeWebSocketUrl || '' // WebSocket暂未实现，留空禁用
    };
  </script>
</head>

<body class="bg-bg-light font-sans text-text-primary flex flex-col h-screen">
  <header class="global-header flex items-center justify-between px-4 sm:px-6 h-14 bg-white border-b border-gray-200">
    <div class="flex items-center gap-3">
      <img src="assets/images/logo.svg" alt="智能售后" class="h-8 w-8" width="32" height="32" decoding="async">
      <span class="text-lg font-semibold text-primary">智能售后工作台</span>
    </div>

    <!-- 用户信息区域 -->
    <div class="relative">
      <button id="user-menu-button" class="flex items-center gap-2 hover:bg-gray-50 rounded-lg px-3 py-1.5 transition-colors">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-semibold text-sm">王</div>
        <div class="text-left">
          <div class="text-sm font-medium text-gray-900">王工程师</div>
          <div class="text-xs text-green-500 flex items-center">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
            在线
          </div>
        </div>
        <i class="fa fa-chevron-down text-gray-400 text-xs"></i>
      </button>

      <!-- 用户菜单浮层 -->
      <div id="user-menu-dropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
        <button id="logout-button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
          <i class="fa fa-sign-out text-gray-400"></i>
          <span>退出</span>
        </button>
      </div>
    </div>
  </header>
  <div class="app-container flex flex-1 min-h-0 overflow-hidden">
    <!-- Dock导航栏 -->
    <div class="dock-nav w-16 bg-white border-r border-gray-200 flex flex-col items-center py-4 gap-3 h-full">
      <div class="dock-item">
        <button class="dock-btn dock-active" data-dock-tab="messages" title="消息">
          <i class="fa fa-comments text-gray-500 text-lg"></i>
          <span>消息</span>
        </button>
        <div class="dock-submenu">
          <button class="dock-submenu-item" data-dock-parent="messages" data-dock-subtab="dialog">对话</button>
          <button class="dock-submenu-item" data-dock-parent="messages" data-dock-subtab="tasks">任务</button>
        </div>
      </div>
      <div class="dock-item">
        <button class="dock-btn" data-dock-tab="knowledge" title="知识">
          <i class="fa fa-book text-gray-500 text-lg"></i>
          <span>知识</span>
        </button>
        <div class="dock-submenu">
          <button class="dock-submenu-item" data-dock-parent="knowledge" data-dock-subtab="knowledge-management">知识管理</button>
          <button class="dock-submenu-item" data-dock-parent="knowledge" data-dock-subtab="knowledge-application">知识应用</button>
        </div>
      </div>
      <button class="dock-btn" data-dock-tab="tools" title="工具">
        <i class="fa fa-th-large text-gray-500 text-lg"></i>
        <span>工具</span>
      </button>
      <button class="dock-btn" data-dock-tab="reports" title="报表">
        <i class="fa fa-bar-chart text-gray-500 text-lg"></i>
        <span>报表</span>
      </button>
    </div>
    <!-- 左侧导航栏 -->
    <div class="sidebar left-sidebar w-96 bg-white border-r border-gray-200 flex flex-col h-full">
      <div>
        <div class="grid grid-cols-2 gap-2"></div>
      </div>

      <div class="tab-content active flex flex-col flex-1" id="dialog-tab" data-tab-group="sidebar">
        <div class="p-4 flex flex-col gap-3 bg-white">
          <!-- 搜索栏 -->
          <div class="relative">
            <input id="conversation-search-input" type="text" placeholder="搜索客户或对话..."
              class="w-full pl-10 pr-4 py-1.5 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm placeholder:text-xs">
            <i class="fa fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
          </div>

          <!-- 筛选面板 -->
          <div class="space-y-2 mb-[0px]">
            <div class="flex flex-wrap gap-2">
              <button id="filter-status-all" class="px-3 py-1 bg-primary text-white rounded-full text-sm flex items-center" data-status="all">
                <span>全部</span>
                <span
                  class="ml-1 bg-white text-primary rounded-full w-5 h-5 flex items-center justify-center text-xs" data-count="all">8</span>
              </button>
              <button id="filter-status-pending" class="px-3 py-1 bg-white border border-gray-300 rounded-full text-sm flex items-center" data-status="pending">
                <span>待处理</span>
                <span
                  class="ml-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" data-count="pending">3</span>
              </button>
              <button id="filter-status-active" class="px-3 py-1 bg-white border border-gray-300 rounded-full text-sm" data-status="active">进行中</button>
            </div>

            <!-- 高级筛选 -->
            <div class="flex flex-wrap gap-2">
              <div class="relative">
                <select id="filter-channel"
                  class="appearance-none bg-white border border-gray-300 rounded-lg text-sm px-3 py-1.5 pr-8 focus:outline-none focus:ring-1 focus:ring-primary">
                  <option value="">渠道</option>
                  <option value="feishu">飞书</option>
                  <option value="qq">企业QQ</option>
                  <option value="wechat">微信</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <i class="fa fa-chevron-down text-xs"></i>
                </div>
              </div>

              <div class="relative">
                <select id="filter-urgency"
                  class="appearance-none bg-white border border-gray-300 rounded-lg text-sm px-3 py-1.5 pr-8 focus:outline-none focus:ring-1 focus:ring-primary">
                  <option value="">紧急度</option>
                  <option value="high">紧急</option>
                  <option value="normal">普通</option>
                  <option value="low">已解决</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <i class="fa fa-chevron-down text-xs"></i>
                </div>
              </div>

              <div class="relative">
                <select id="filter-sla"
                  class="appearance-none bg-white border border-gray-300 rounded-lg text-sm px-3 py-1.5 pr-8 focus:outline-none focus:ring-1 focus:ring-primary">
                  <option value="">客户等级</option>
                  <option value="vip">VIP</option>
                  <option value="ka0">KA0</option>
                  <option value="ka1">KA1</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                  <i class="fa fa-chevron-down text-xs"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 对话列表 -->
        <div class="conversation-list flex-1 overflow-y-auto px-3 pb-3 pt-0">
          <!-- 对话项将由JavaScript动态生成 -->
        </div>

      </div>

      <div class="tab-content hidden flex flex-col flex-1" id="tasks-tab" data-tab-group="sidebar">
        <div class="task-pane flex-1 overflow-y-auto p-3 space-y-3">
          <div class="task-card bg-white border border-gray-200 rounded-lg p-3 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold text-gray-800">任务列表</div>
                <p class="text-xs text-gray-500 mt-1">可通过对话对任务进行增删改操作</p>
              </div>
            </div>
            <div id="sidebar-tasks-list" class="mt-3 space-y-2">
              <div class="task-list-item" data-task-id="task-001">
                <div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-800">云服务器连接公告</span>
                    <span
                      class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200">高</span>
                  </div>
                  <p class="text-xs text-gray-600">生成公告并回访受影响用户</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="task-delete-btn text-xs text-red-600 hover:text-red-700">删除</button>
                </div>
              </div>
              <div class="task-list-item" data-task-id="task-002">
                <div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-800">账单核验指引</span>
                    <span
                      class="text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-200">中</span>
                  </div>
                  <p class="text-xs text-gray-600">推送账单核验指南并收集反馈</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="task-delete-btn text-xs text-red-600 hover:text-red-700">删除</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- 中间对话区 -->
    <div class="main-content flex-1 flex flex-col h-full bg-white">
      <div class="tab-content active chat-panel flex-1 flex flex-col h-full" id="workspace-dialog-tab" data-tab-group="workspace">
        <div class="chat-header px-4 py-2 border-b border-gray-200 flex items-center glass-effect sticky top-0 z-10">
          <div class="flex-1 min-w-0 flex flex-col gap-2">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 min-w-0">
                <h2 id="chat-header-title" class="text-base font-semibold truncate">小米保障群</h2>
                <span id="chat-header-sla" class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">VIP</span>
                <span id="agent-status-pill" class="agent-status-pill agent-status-offline">Agent 未连接</span>
              </div>
              <div class="flex shrink-0">
                <button class="flex items-center px-3 py-2 bg-primary text-white rounded-full text-xs hover:bg-primary-dark transition-colors" onclick="openFullAnalysisPanel()">
                  <i class="fa fa-columns mr-2"></i>
                  <span>分析面板</span>
                </button>
              </div>
            </div>
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div id="chat-header-summary" class="min-w-0 text-sm text-gray-500 truncate">
                <span>智能摘要：</span>
                <span>客户反馈云服务器无法连接，影响业务运营，需要紧急处理。</span>
              </div>
              <div id="chat-mode-control" class="chat-mode-control flex items-center gap-2 flex-wrap shrink-0">
                <button data-chat-mode="agent_auto" class="chat-mode-pill active">Agent自动</button>
                <button data-chat-mode="agent_supervised" class="chat-mode-pill">Agent监督</button>
                <button data-chat-mode="human_first" class="chat-mode-pill">人工优先</button>
              </div>
            </div>
          </div>
        </div>

        <div id="escalation-banner" class="escalation-banner hidden">
          <span class="escalation-text">Agent建议人工介入中...</span>
          <button type="button" class="escalation-action">立即交付人工</button>
        </div>

        <!-- 消息区域 -->
        <div class="chat-messages flex-1 overflow-y-auto p-4 space-y-4" id="chat-messages">
          <!-- 只读聚合提示 -->
          <div class="flex justify-center">
            <span
              class="text-xs text-amber-700 bg-amber-50 border border-amber-200 px-3 py-1 rounded-full">当前为只读聚合模式：仅展示各渠道消息与内部建议，无法直接回发到外部IM</span>
          </div>

          <!-- 时间分隔线 -->
          <div class="flex justify-center">
            <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">今天 10:30</span>
          </div>

          <!-- 客户消息 -->
          <div class="message customer-message flex" data-history-label="云服务器连通性异常">
            <div
              class="avatar w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold">
              张
            </div>

            <div class="ml-2 max-w-[70%]">
              <div class="message-bubble bg-blue-100 p-3 message-bubble-customer">
                <p>我的服务器无法连接，目前有影响业务，赶快看下。</p>
              </div>

              <div class="message-meta flex justify-between items-center mt-1">
                <span class="text-xs text-gray-500">10:30</span>
                <span class="emotion-urgent text-xs px-2 py-0.5 rounded-full">⚠️ 急切</span>
              </div>
            </div>
          </div>

          <!-- 工程师消息 -->
          <div class="message engineer-message flex justify-end">
            <div class="mr-2 max-w-[70%]">
              <div class="message-bubble bg-primary text-white p-3 message-bubble-engineer">
                <p>您好，请提供具体的服务器实例ID或IP，我们高优排查该问题。</p>
              </div>

              <div class="message-meta flex justify-end mt-1">
                <span class="text-xs text-gray-500">10:32</span>
              </div>
            </div>

            <div
              class="avatar w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white font-semibold">
              王
            </div>
          </div>

          <!-- 客户消息 -->
          <div class="message customer-message flex">
            <div
              class="avatar w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold">
              张
            </div>

            <div class="ml-2 max-w-[70%]">
              <div class="message-bubble bg-blue-100 p-3 message-bubble-customer">
                <p>服务器实例为test123，ip是192.168.10.2。</p>
              </div>

              <div class="message-meta flex justify-between items-center mt-1">
                <span class="text-xs text-gray-500">10:35</span>
                <span class="emotion-neutral text-xs px-2 py-0.5 rounded-full">🙂 稍缓</span>
              </div>
            </div>
          </div>

          <!-- 工程师消息 -->
          <div class="message engineer-message flex justify-end">
            <div class="mr-2 max-w-[70%]">
              <div class="message-bubble bg-primary text-white p-3 message-bubble-engineer">
                <p>收到，我们高优排查该问题，有进展第一时间同步。</p>
              </div>

              <div class="message-meta flex justify-end mt-1">
                <span class="text-xs text-gray-500">10:35</span>
              </div>
            </div>

            <div
              class="avatar w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white font-semibold">
              王
            </div>
          </div>

          <!-- 客户消息 -->
          <div class="message customer-message flex">
            <div
              class="avatar w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-semibold">
              张
            </div>

            <div class="ml-2 max-w-[70%]">
              <div class="message-bubble bg-blue-100 p-3 message-bubble-customer">
                <p>麻烦尽快同步排查进展，业务现在受影响。</p>
              </div>

              <div class="message-meta flex justify-between items-center mt-1">
                <span class="text-xs text-gray-500">10:36</span>
                <span class="emotion-negative text-xs px-2 py-0.5 rounded-full">⚠️ 急切</span>
              </div>
            </div>
          </div>

          <!-- AI辅助信息 -->
          <div class="ai-assistant p-4">
            <div class="problem-identification mb-3 p-2 bg-yellow-50 border-l-4 border-yellow-400 rounded">
              <strong>待解决问题：</strong>云服务器无法连接，业务受影响（P2）
            </div>

            <div class="reply-suggestions mb-3">
              <h4 class="text-sm font-medium text-gray-700 mb-2">AI回复建议（内部参考，不会自动发送）：</h4>
              <div class="suggestion-card" data-id="sug-001">
                <div class="flex items-start">
                  <div
                    class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                    <i class="fa fa-book"></i>
                  </div>

                  <div class="ml-2 flex-1">
                    <p class="text-xs text-gray-500">参考知识库：<a href="#"
                        class="text-primary hover:underline">云服务器无法连接排查手册</a></p>
                    <p class="text-sm mt-1">
                      您好，请提供具体的服务器实例ID或IP，我们高优排查该问题。</p>
                  </div>
                </div>

                <div class="flex justify-end mt-2">
                  <button class="adopt-btn text-xs px-3 py-1 bg-primary text-white rounded hover:bg-primary-dark"
                    onclick="adoptSuggestion('sug-001')">填入草稿（内部）</button>
                </div>
              </div>

              <div class="suggestion-card" data-id="sug-002">
                <div class="flex items-start">
                  <div
                    class="flex-shrink-0 w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                    <i class="fa fa-history"></i>
                  </div>

                  <div class="ml-2 flex-1">
                    <p class="text-xs text-gray-500">参考历史案例：<a href="#"
                        class="text-primary hover:underline">07-15云服务器连通性问题解决方案</a></p>
                    <p class="text-sm mt-1">
                      收到，我们高优排查该问题，有进展第一时间同步。</p>
                  </div>
                </div>

                <div class="flex justify-end mt-2">
                  <button class="adopt-btn text-xs px-3 py-1 bg-primary text-white rounded hover:bg-primary-dark"
                    onclick="adoptSuggestion('sug-002')">填入草稿（内部）</button>
                </div>
              </div>
            </div>

            <div class="solution-steps">
              <details class="text-sm">
                <summary class="font-medium cursor-pointer">解决步骤</summary>
                <div class="mt-2 space-y-3">
                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <h5 class="text-sm font-medium">标准处理流程</h5>
                    <ol class="list-decimal pl-5 mt-1 space-y-1 text-sm">
                      <li>确认实例状态与网络连通性</li>
                      <li>检查安全组/路由/网关配置</li>
                      <li>排查宿主机与网络设备告警</li>
                      <li>执行修复或切换线路</li>
                      <li>验证业务访问恢复情况</li>
                    </ol>
                  </div>

                  <div class="bg-white border border-gray-200 rounded-lg p-3">
                    <h5 class="text-sm font-medium">历史相似问题解决方案</h5>
                    <div class="mt-2 space-y-2">
                      <div class="flex items-start">
                        <div
                          class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs">
                          <i class="fa fa-link"></i>
                        </div>

                        <div class="ml-2">
                          <p class="text-xs"><a href="#" class="text-primary hover:underline">认证服务故障应急处理流程</a></p>
                          <p class="text-xs text-gray-600 mt-0.5">上次使用：2023-06-10，解决时间：12分钟</p>
                        </div>
                      </div>

                      <div class="flex items-start">
                        <div
                          class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-xs">
                          <i class="fa fa-link"></i>
                        </div>

                        <div class="ml-2">
                          <p class="text-xs"><a href="#" class="text-primary hover:underline">多用户同时登录失败问题排查</a></p>
                          <p class="text-xs text-gray-600 mt-0.5">上次使用：2023-05-22，解决时间：18分钟</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>

        <!-- 输入区域 -->
        <div class="chat-input p-4 border-t border-gray-200">
          <!-- 低置信度警告 -->
          <div id="low-confidence-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3 rounded">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fa fa-exclamation-triangle text-yellow-400"></i>
              </div>

              <div class="ml-3">
                <p class="text-sm text-yellow-700">外部IM渠道暂未打通，以下内容仅为内部建议；如需告知客户请在对应IM手动发送</p>
              </div>
            </div>
          </div>

          <!-- 快捷功能 -->
          <div class="mb-3 flex flex-nowrap gap-2 overflow-x-auto">
            <button class="px-3 py-1.5 text-xs bg-primary text-white rounded-full hover:bg-primary-dark transition-colors shadow-sm" onclick="openTicketManagementPanel()">工单管理</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openAiReplyPanel()">回复建议</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openClarifyPanel()">问题澄清</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openRequirementPanel()">需求检测</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openAiSolutionPanel()">AI解决方案</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openAssistCheckMock()">辅助排查</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openTicketMock()">创建工单</button>
            <button class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-full hover:border-primary hover:text-primary" onclick="openFaultReportMock()">生成故障报告</button>
          </div>

          <!-- 输入框 -->
          <div class="relative">
            <textarea id="message-input"
              class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
              rows="3" placeholder="输入内部备注或回复草稿（不会自动发送到IM）"></textarea>
            <div class="absolute bottom-3 left-3 flex space-x-2">
              <button id="emoji-button" class="text-gray-500 hover:text-primary" title="表情">
                <i class="fa fa-smile-o"></i>
              </button>
              <button class="text-gray-500 hover:text-primary" title="附件">
                <i class="fa fa-paperclip"></i>
              </button>
              <button class="text-gray-500 hover:text-primary" title="提及">
                <i class="fa fa-at"></i>
              </button>
              <!-- 话术优化图标 -->
              <button id="optimize-button" class="text-gray-500 hover:text-primary" title="话术优化"
                onclick="optimizeMessage()">
                <i class="fa fa-magic"></i>
              </button>
            </div>

            <div class="absolute bottom-3 right-3">
              <button id="send-button"
                class="px-3 h-9 flex items-center justify-center space-x-2 bg-primary text-white rounded-full hover:bg-primary-dark transition-colors text-xs font-medium"
                onclick="sendMessage()">
                <i class="fa fa-sticky-note"></i>
                <span>记录内部备注</span>
              </button>
            </div>
          </div>

          <!-- 表情选择面板 -->
          <div id="emoji-panel" class="hidden mt-2 bg-white border border-gray-200 rounded-lg p-3 shadow-md">
            <div class="grid grid-cols-8 gap-2">
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('😊')">😊</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('😢')">😢</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('👍')">👍</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('👎')">👎</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('🙏')">🙏</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('🔥')">🔥</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('💡')">💡</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('⚠️')">⚠️</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('✅')">✅</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('❌')">❌</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('⏰')">⏰</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('📞')">📞</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('📧')">📧</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('💻')">💻</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('🔧')">🔧</span>
              <span class="emoji-item text-xl cursor-pointer hover:bg-gray-100 rounded p-1"
                onclick="insertEmoji('🔄')">🔄</span>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content hidden flex flex-col flex-1 min-h-0" id="workspace-knowledge-tab" data-tab-group="workspace">
        <div class="border-b border-gray-200 bg-white sticky top-0 z-10">
          <div class="p-4 flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-xs text-gray-500 uppercase tracking-wide">知识管理</div>
              <h2 class="text-lg font-semibold text-gray-900">知识库总览</h2>
            </div>
          </div>
          <div class="px-4 pb-2 flex items-center gap-6">
            <button id="knowledge-tab-doc"
              class="pb-2 text-sm font-semibold text-primary border-b-2 border-primary">文档库</button>
            <button id="knowledge-tab-faq"
              class="pb-2 text-sm font-semibold text-gray-500 border-b-2 border-transparent">FAQ</button>
          </div>
        </div>
        <div id="knowledge-panel" class="flex-1 overflow-y-auto p-4 bg-bg-light">
          <div class="knowledge-page bg-white border border-gray-200 rounded-xl p-4 flex flex-col lg:flex-row gap-4 min-h-0">
            <aside class="w-full lg:w-72 border border-gray-200 rounded-xl bg-gray-50 p-3 flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold text-gray-800">知识分类</div>
                <span class="text-[11px] text-gray-400">目录树</span>
              </div>
              <div class="relative">
                <input id="knowledge-tree-search" type="text" placeholder="搜索分类..."
                  class="w-full pl-9 pr-3 py-2 text-xs rounded-lg border border-gray-200 focus:outline-none focus:ring-1 focus:ring-primary">
                <i class="fa fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
              </div>
              <div id="knowledge-tree" class="flex-1 overflow-y-auto rounded-lg border border-gray-200 bg-white">
              </div>
            </aside>

            <section class="knowledge-content flex-1 flex flex-col gap-4 min-h-0">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="text-xs text-gray-500" id="knowledge-breadcrumb">全部分类</div>
              </div>

              <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex-1">
                  <div id="knowledge-doc-search-wrap" class="relative">
                    <input id="knowledge-doc-search" type="text" placeholder="搜索文档标题..."
                      class="w-full pl-9 pr-3 py-2 text-xs rounded-lg border border-gray-200 focus:outline-none focus:ring-1 focus:ring-primary">
                    <i class="fa fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                  </div>
                  <div id="knowledge-faq-search-wrap" class="relative hidden">
                    <input id="knowledge-faq-search" type="text" placeholder="搜索FAQ问题..."
                      class="w-full pl-9 pr-3 py-2 text-xs rounded-lg border border-gray-200 focus:outline-none focus:ring-1 focus:ring-primary">
                    <i class="fa fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="knowledge-add-btn"
                    class="px-3 py-2 text-xs rounded-lg bg-primary text-white hover:bg-primary-dark">上传文档</button>
                  <button id="knowledge-faq-add-btn"
                    class="px-3 py-2 text-xs rounded-lg bg-primary text-white hover:bg-primary-dark hidden">新增FAQ</button>
                </div>
              </div>

              <div id="knowledge-doc-section" class="flex flex-col gap-3 min-h-0">
                <div id="knowledge-doc-panel" class="knowledge-table border border-gray-200 rounded-xl overflow-hidden">
                  <div class="knowledge-table-header">
                    <div>文档信息</div>
                    <div>分类</div>
                    <div>状态</div>
                    <div>更新时间</div>
                    <div class="text-right">操作</div>
                  </div>
                  <div id="knowledge-doc-list" class="knowledge-table-body"></div>
                </div>
                <div id="knowledge-empty-state" class="hidden border border-dashed border-gray-200 rounded-xl p-6 text-center text-sm text-gray-500">
                  暂无文档，请先上传知识文档。
                  <button id="knowledge-empty-add" class="ml-2 text-primary hover:underline">立即上传</button>
                </div>
              </div>

              <div id="knowledge-faq-section" class="hidden flex flex-col gap-3 min-h-0">
                <div id="knowledge-faq-panel" class="border border-gray-200 rounded-xl overflow-hidden">
                  <div class="grid grid-cols-5 gap-2 px-4 py-3 text-xs text-gray-500 bg-gray-50 border-b border-gray-200">
                    <div class="col-span-2">问题与答案</div>
                    <div>状态</div>
                    <div>更新时间</div>
                    <div class="text-right">操作</div>
                  </div>
                  <div id="knowledge-faq-list" class="divide-y divide-gray-100"></div>
                </div>
                <div id="knowledge-faq-empty-state" class="hidden border border-dashed border-gray-200 rounded-xl p-6 text-center text-sm text-gray-500">
                  暂无FAQ，请先创建常见问题。
                  <button id="knowledge-faq-empty-add" class="ml-2 text-primary hover:underline">立即新增</button>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>

      <div class="tab-content hidden flex flex-col flex-1 min-h-0" id="workspace-knowledge-application-tab" data-tab-group="workspace">
        <div class="p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-xs text-gray-500 uppercase tracking-wide">知识应用</div>
              <h2 class="text-lg font-semibold text-gray-900">场景检索与落地</h2>
            </div>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto bg-white">
          <div id="knowledge-application" class="knowledge-application max-w-4xl mx-auto py-12 px-6 flex flex-col gap-8">

            <!-- 顶部标题区 -->
            <div class="knowledge-app-header text-center">
              <h3 class="text-3xl font-semibold text-gray-900 mb-3">以客户为中心</h3>
              <p class="text-sm text-gray-500 max-w-2xl mx-auto">输入客户问题关键词，AI将为您匹配最相关的知识库内容与解决方案</p>
            </div>

            <!-- 搜索框 -->
            <div class="knowledge-app-search w-full mx-auto">
              <div class="relative flex items-center gap-2">
                <div class="flex-1 relative">
                  <input id="knowledge-app-search-input" type="text"
                    placeholder="描述客户问题，例如：无法登录、系统报错、账单异常..."
                    class="w-full border-2 border-gray-300 rounded-full pl-12 pr-12 py-3.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all shadow-sm hover:shadow-md">
                  <i class="fa fa-search absolute left-4 top-4 text-gray-400"></i>
                  <button id="knowledge-app-clear-input" class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa fa-times-circle text-lg"></i>
                  </button>
                </div>
                <button id="knowledge-app-search-btn"
                  class="px-6 py-3.5 text-sm rounded-full bg-primary text-white hover:bg-primary-dark transition-colors shadow-sm hover:shadow-md font-medium">
                  检索
                </button>
              </div>
            </div>

            <!-- 场景问题快捷入口 -->
            <div id="knowledge-app-shortcuts" class="w-full mx-auto">
              <div class="flex items-center gap-2 mb-4">
                <i class="fa fa-bolt text-amber-500 text-sm"></i>
                <span class="text-sm font-medium text-gray-700">场景问题</span>
                <div class="relative inline-block">
                  <i class="fa fa-question-circle text-gray-400 text-sm cursor-help knowledge-tooltip-trigger"></i>
                  <div class="knowledge-tooltip hidden absolute left-0 top-full mt-2 z-50 whitespace-nowrap">
                    <div class="bg-gray-800 text-white text-xs rounded-lg py-2 px-3 shadow-lg">
                      Agent根据近30天常见问题自行总结
                      <div class="absolute -top-1 left-4 w-2 h-2 bg-gray-800 transform rotate-45"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button class="knowledge-shortcut-btn" data-keyword="登录失败">
                  <i class="fa fa-sign-in text-blue-600"></i>
                  <span>登录问题</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="账号锁定">
                  <i class="fa fa-lock text-amber-600"></i>
                  <span>账号锁定</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="系统报错">
                  <i class="fa fa-exclamation-triangle text-red-600"></i>
                  <span>系统报错</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="账单异常">
                  <i class="fa fa-file-text-o text-green-600"></i>
                  <span>账单问题</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="权限申请">
                  <i class="fa fa-user-plus text-purple-600"></i>
                  <span>权限申请</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="数据同步">
                  <i class="fa fa-refresh text-cyan-600"></i>
                  <span>数据同步</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="性能优化">
                  <i class="fa fa-dashboard text-indigo-600"></i>
                  <span>性能问题</span>
                </button>
                <button class="knowledge-shortcut-btn" data-keyword="配置变更">
                  <i class="fa fa-cog text-gray-600"></i>
                  <span>配置变更</span>
                </button>
              </div>
            </div>

            <!-- 搜索结果区域 -->
            <div id="knowledge-app-results" class="knowledge-app-results hidden w-full">
              <div class="mb-4">
                <div class="flex items-center justify-between">
                  <span id="knowledge-app-count" class="text-sm text-gray-600"></span>
                </div>
              </div>
              <div class="knowledge-app-layout">
                <div id="knowledge-app-list" class="space-y-3"></div>
                <div id="knowledge-app-detail" class="knowledge-app-detail hidden border border-gray-200 rounded-xl bg-white shadow-sm p-4">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <h4 id="knowledge-app-detail-title" class="text-base font-semibold text-gray-900">知识预览</h4>
                      <p id="knowledge-app-detail-category" class="text-xs text-gray-500 mt-1">分类：-</p>
                    </div>
                    <button id="knowledge-app-detail-copy" type="button" class="px-3 py-1.5 text-xs rounded-full border border-gray-200 text-gray-600 hover:border-primary hover:text-primary transition-colors">
                      复制内容
                    </button>
                  </div>
                  <div id="knowledge-app-detail-updated" class="mt-1 text-[11px] text-gray-400">更新于：-</div>
                  <div id="knowledge-app-detail-summary" class="mt-3 text-sm text-gray-600">点击“查看详情”在右侧查看知识摘要。</div>
                  <div id="knowledge-app-detail-content" class="mt-3 text-sm text-gray-600 whitespace-pre-line max-h-[220px] overflow-y-auto border border-dashed border-gray-200 rounded-lg p-3 bg-gray-50">
                    系统会在此展示知识内容，便于快速理解与复制。
                  </div>
                  <div id="knowledge-app-detail-tags" class="mt-3 flex flex-wrap gap-2"></div>
                </div>
              </div>
            </div>

            <!-- 空状态提示 -->
            <div id="knowledge-app-empty" class="hidden text-center py-8">
              <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3">
                <i class="fa fa-search text-gray-400 text-2xl"></i>
              </div>
              <p class="text-sm text-gray-500">未找到匹配的知识内容</p>
              <p class="text-xs text-gray-400 mt-1">请尝试调整关键词或使用更通用的描述</p>
            </div>

            <!-- 使用提示 -->
            <div id="knowledge-app-tips" class="w-full mx-auto">
              <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-100 rounded-xl p-4">
                <div class="flex items-start gap-3">
                  <i class="fa fa-info-circle text-blue-600 mt-0.5"></i>
                  <div class="flex-1 text-xs text-gray-600 space-y-1">
                    <p><strong class="text-gray-700">使用技巧：</strong></p>
                    <ul class="list-disc list-inside space-y-0.5 ml-2">
                      <li>输入客户描述的问题关键词即可快速检索</li>
                      <li>支持模糊匹配，系统会自动联想相关知识</li>
                      <li>点击场景问题可快速查看对应解决方案</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content hidden flex flex-col flex-1 min-h-0" id="workspace-tools-tab" data-tab-group="workspace">
        <div class="p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-xs text-gray-500 uppercase tracking-wide">工具中心</div>
              <h2 class="text-lg font-semibold text-gray-900">常用工具与快捷动作</h2>
            </div>
            <span class="text-xs text-gray-500">集中处理系统巡检、诊断与工单协作</span>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-5 bg-bg-light">
          <div class="panel-card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-gray-800">系统工具</h3>
              <span class="text-xs text-gray-500">一键执行</span>
            </div>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <button class="bg-blue-50 hover:bg-blue-100 p-4 rounded-lg flex flex-col items-center justify-center transition-colors" data-click="tool" data-label="服务状态监控">
                <i class="fa fa-server text-blue-600 text-2xl mb-2"></i>
                <span class="text-xs">服务状态监控</span>
              </button>
              <button class="bg-green-50 hover:bg-green-100 p-4 rounded-lg flex flex-col items-center justify-center transition-colors" data-click="tool" data-label="数据库管理">
                <i class="fa fa-database text-green-600 text-2xl mb-2"></i>
                <span class="text-xs">数据库管理</span>
              </button>
              <button class="bg-purple-50 hover:bg-purple-100 p-4 rounded-lg flex flex-col items-center justify-center transition-colors" data-click="tool" data-label="用户权限管理">
                <i class="fa fa-user-plus text-purple-600 text-2xl mb-2"></i>
                <span class="text-xs">用户权限管理</span>
              </button>
              <button class="bg-orange-50 hover:bg-orange-100 p-4 rounded-lg flex flex-col items-center justify-center transition-colors" data-click="tool" data-label="数据备份">
                <i class="fa fa-database text-orange-600 text-2xl mb-2"></i>
                <span class="text-xs">数据备份</span>
              </button>
              <button class="bg-red-50 hover:bg-red-100 p-4 rounded-lg flex flex-col items-center justify-center transition-colors" data-click="tool" data-label="错误日志分析">
                <i class="fa fa-bug text-red-600 text-2xl mb-2"></i>
                <span class="text-xs">错误日志分析</span>
              </button>
              <button class="bg-indigo-50 hover:bg-indigo-100 p-4 rounded-lg flex flex-col items-center justify-center transition-colors" data-click="tool" data-label="系统配置">
                <i class="fa fa-cogs text-indigo-600 text-2xl mb-2"></i>
                <span class="text-xs">系统配置</span>
              </button>
            </div>
          </div>
          <div class="panel-card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-gray-800">快捷动作</h3>
              <span class="text-xs text-gray-500">跨系统联动</span>
            </div>
            <div class="grid md:grid-cols-2 gap-2">
              <button class="w-full flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg text-xs hover:border-primary hover:text-primary" data-click="quick" data-label="发送系统通知">
                <span>发送系统通知</span>
                <i class="fa fa-paper-plane-o"></i>
              </button>
              <button class="w-full flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg text-xs hover:border-primary hover:text-primary" data-click="quick" data-label="创建事件工单">
                <span>创建事件工单</span>
                <i class="fa fa-plus-square-o"></i>
              </button>
              <button class="w-full flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg text-xs hover:border-primary hover:text-primary" data-click="quick" data-label="升级问题">
                <span>升级问题</span>
                <i class="fa fa-arrow-up"></i>
              </button>
              <button class="w-full flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg text-xs hover:border-primary hover:text-primary" data-click="quick" data-label="生成报告">
                <span>生成报告</span>
                <i class="fa fa-file-text-o"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content hidden flex flex-col flex-1 min-h-0" id="workspace-reports-tab" data-tab-group="workspace">
        <div class="p-4 border-b border-gray-200 bg-white sticky top-0 z-10">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div class="text-xs text-gray-500 uppercase tracking-wide">报表中心</div>
              <h2 class="text-lg font-semibold text-gray-900">核心指标总览</h2>
            </div>
            <span class="text-xs text-gray-500">支持按周期查看核心数据</span>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-5 bg-bg-light">
          <div class="grid gap-3 md:grid-cols-2">
            <div class="panel-card">
              <div class="text-sm font-semibold text-gray-800">领导班子 · 效率报表</div>
              <div class="mt-3 grid grid-cols-3 gap-2 text-sm text-gray-800">
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">今日对话</div>
                  <div class="text-base font-semibold text-primary">156 次</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">平均响应</div>
                  <div class="text-base font-semibold text-emerald-600">1.8 分钟</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">解决率</div>
                  <div class="text-base font-semibold text-amber-600">85%</div>
                </div>
              </div>
            </div>
            <div class="panel-card">
              <div class="text-sm font-semibold text-gray-800">响应时效统计</div>
              <div class="mt-3 grid grid-cols-3 gap-2 text-sm text-gray-800">
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">平均响应</div>
                  <div class="text-base font-semibold text-primary">1.8 分钟</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">最快响应</div>
                  <div class="text-base font-semibold text-emerald-600">30 秒</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">最慢响应</div>
                  <div class="text-base font-semibold text-amber-600">5 分钟</div>
                </div>
              </div>
            </div>
            <div class="panel-card">
              <div class="text-sm font-semibold text-gray-800">客户满意度指标</div>
              <div class="mt-3 grid grid-cols-3 gap-2 text-sm text-gray-800">
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">平均满意度</div>
                  <div class="text-base font-semibold text-primary">4.5/5.0</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">5星占比</div>
                  <div class="text-base font-semibold text-emerald-600">75%</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">差评数</div>
                  <div class="text-base font-semibold text-amber-600">3 次</div>
                </div>
              </div>
            </div>
            <div class="panel-card">
              <div class="text-sm font-semibold text-gray-800">开单情况统计</div>
              <div class="mt-3 grid grid-cols-3 gap-2 text-sm text-gray-800">
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">完成订单</div>
                  <div class="text-base font-semibold text-primary">120 单</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">完成率</div>
                  <div class="text-base font-semibold text-emerald-600">85%</div>
                </div>
                <div class="stat-tile">
                  <div class="text-[11px] text-gray-500">待处理</div>
                  <div class="text-base font-semibold text-amber-600">18 单</div>
                </div>
              </div>
            </div>
          </div>
          <div class="panel-card">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold text-gray-800">近7天趋势</div>
              <div class="text-xs text-gray-500">响应时效与满意度</div>
            </div>
            <div class="mt-3 h-64">
              <canvas id="reportsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- 任务工作区：对齐对话逻辑，左侧任务 / 中间指令对话 / 右侧预览 -->
      <div class="tab-content hidden task-main flex-1 overflow-hidden" id="workspace-tasks-tab"
        data-tab-group="workspace">
        <div class="task-workspace flex flex-col h-full">
          <div class="flex flex-1 min-h-0">
            <!-- 中间对话/质量区域 -->
            <main class="flex-1 min-h-0 overflow-y-auto bg-white" id="task-detail-wrapper">
              <div id="task-quality-overview" class="bg-white">
                <div
                  class="chat-header px-4 py-2 border-b border-t border-gray-200 flex items-center glass-effect sticky top-0 z-10">
                  <div class="flex-1 min-w-0 flex flex-col gap-2">
                    <div class="flex items-center justify-between gap-3">
                      <div class="flex items-center gap-2 min-w-0">
                        <h2 class="text-base font-semibold truncate">质量检测分析</h2>
                      </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-2">
                      <div class="min-w-0 text-sm text-gray-500 truncate">质检专员可对群聊会话进行多维度质检</div>
                    </div>
                  </div>
                  <div class="flex flex-wrap gap-2 shrink-0">
                    <button id="start-task-conversation"
                      class="px-3 py-1.5 text-xs min-w-[120px] bg-primary text-white rounded-lg hover:bg-primary-dark">对话驱动任务</button>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  <div class="flex items-center justify-between gap-2">
                    <div>
                      <h3 class="text-sm font-semibold text-gray-800"></h3>
                    </div>
                    <div class="flex items-center gap-2 text-[11px] text-gray-500">
                    </div>
                  </div>

                  <div class="grid md:grid-cols-3 gap-3">
                    <div class="stat-tile">
                      <div class="text-[11px] text-gray-500">平均质检得分</div>
                      <div class="text-xl font-semibold text-primary">89 分</div>
                      <p class="text-[11px] text-gray-500 mt-1">近7天 · 覆盖 12 个客户</p>
                    </div>
                    <div class="stat-tile">
                      <div class="text-[11px] text-gray-500">高紧急会话</div>
                      <div class="text-xl font-semibold text-amber-600">3 条</div>
                      <p class="text-[11px] text-gray-500 mt-1">需优先处理并派发任务</p>
                    </div>
                    <div class="stat-tile">
                      <div class="text-[11px] text-gray-500">自动派发指令</div>
                      <div class="text-xl font-semibold text-emerald-600">6 次</div>
                      <p class="text-[11px] text-gray-500 mt-1">系统Agent自动落地</p>
                    </div>
                  </div>

                  <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-4">
                    <div class="flex flex-wrap items-center justify-between gap-3">
                      <div>
                        <h4 class="text-sm font-medium text-gray-800">客户质量状态列表</h4>
                        <p class="text-[11px] text-gray-500 mt-1">按客户等级筛选、选择时间或搜索群聊进行质检分析。</p>
                      </div>
                      <div class="flex flex-wrap items-center gap-2">
                        <select class="text-xs border border-gray-200 rounded-lg px-2 py-1 bg-white">
                          <option>全部客户等级</option>
                          <option>VIP</option>
                          <option>KA1</option>
                          <option>KA0</option>
                          <option>普通</option>
                        </select>
                        <select class="text-xs border border-gray-200 rounded-lg px-2 py-1 bg-white">
                          <option>最近7天</option>
                          <option>最近30天</option>
                          <option>最近90天</option>
                          <option>自定义时间</option>
                        </select>
                        <div class="relative">
                          <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                          <input
                            class="pl-8 pr-3 py-1.5 text-xs border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary"
                            placeholder="搜索群聊/客户/对话ID">
                        </div>
                      </div>
                    </div>

                    <div>
                      <div class="flex items-center justify-between"></div>
                      <div class="mt-3 space-y-3">
                        <div class="customer-row flex items-center justify-between text-sm">
                          <div class="flex items-start gap-3">
                            <div
                              class="w-9 h-9 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-semibold">
                              张</div>
                            <div>
                              <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-800">小米保障群 · conv-001</span>
                                <span
                                  class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-200">高紧急</span>
                              </div>
                              <p class="text-xs text-gray-600 mt-1">云服务器连接异常影响业务，需补充实例ID/IP并按 P2 优先级推进。</p>
                            </div>
                          </div>
                          <div class="flex items-center gap-3">
                            <div class="text-xs text-gray-500">质检 92 分 · 待公告</div>
                            <div class="flex items-center gap-2">
                              <button class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                                data-open-qc data-conv-id="conv-001">对话质检</button>
                              <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary-dark"
                                onclick="openAnalysisPanelClassic()">客户详情</button>
                            </div>
                          </div>
                        </div>
                        <div class="customer-row flex items-center justify-between text-sm">
                          <div class="flex items-start gap-3">
                            <div
                              class="w-9 h-9 rounded-full bg-green-100 flex items-center justify-center text-green-700 font-semibold">
                              李</div>
                            <div>
                              <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-800">恒星数据 · conv-002</span>
                                <span
                                  class="text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-200">处理中</span>
                              </div>
                              <p class="text-xs text-gray-600 mt-1">账单核验问题待确认，已派发账单指引，等待客户反馈。</p>
                            </div>
                          </div>
                          <div class="flex items-center gap-3">
                            <div class="text-xs text-gray-500">质检 86 分 · 账单核验</div>
                            <div class="flex items-center gap-2">
                              <button class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                                data-open-qc data-conv-id="conv-002">对话质检</button>
                              <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary-dark"
                                onclick="openAnalysisPanelClassic()">客户详情</button>
                            </div>
                          </div>
                        </div>
                        <div class="customer-row flex items-center justify-between text-sm">
                          <div class="flex items-start gap-3">
                            <div
                              class="w-9 h-9 rounded-full bg-purple-100 flex items-center justify-center text-purple-700 font-semibold">
                              王</div>
                            <div>
                              <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-800">万象互动 · conv-003</span>
                                <span
                                  class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 border border-gray-200">已解决</span>
                              </div>
                              <p class="text-xs text-gray-600 mt-1">功能体验反馈已处理，待回访确认满意度并收集改进建议。</p>
                            </div>
                          </div>
                          <div class="flex items-center gap-3">
                            <div class="text-xs text-gray-500">质检 90 分 · 待回访</div>
                            <div class="flex items-center gap-2">
                              <button class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                                data-open-qc data-conv-id="conv-003">对话质检</button>
                              <button class="text-xs px-2 py-1 bg-primary text-white rounded hover:bg-primary-dark"
                                onclick="openAnalysisPanelClassic()">客户详情</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <div id="task-conversation-area" class="hidden h-full flex flex-col bg-white border-t border-gray-200">
                <div
                  class="chat-header px-4 py-2 border-b border-gray-200 flex items-center glass-effect sticky top-0 z-10">
                  <div class="flex-1 min-w-0 flex flex-col gap-2">
                    <div class="flex items-center justify-between gap-3">
                      <div class="flex items-center gap-2 min-w-0 flex-wrap">
                        <span class="text-base font-semibold text-gray-900 truncate">对话驱动任务</span>
                      </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-2">
                      <div class="min-w-0 text-sm text-gray-500">指令驱动，Agent协同完成任务</div>
                    </div>
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <button id="back-to-quality"
                      class="px-3 py-1.5 text-xs min-w-[120px] bg-white text-gray-700 rounded-lg border border-gray-200 hover:bg-gray-100">返回质检概览</button>
                  </div>
                </div>

                <div id="task-agent-log" class="flex-1 overflow-y-auto p-4 space-y-3">
                </div>

                <div class="p-4 border-t border-gray-200 bg-gray-50">
                  <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                      <input id="task-agent-command-input"
                        class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary"
                        placeholder="用自然语言下发指令：例“生成登录公告并每天巡检认证服务”">
                      <button id="task-agent-send"
                        class="px-3 py-2 text-xs bg-primary text-white rounded-lg hover:bg-primary-dark">派发给Agent</button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button
                        class="px-3 py-1.5 text-xs rounded-full bg-white border border-gray-200 hover:border-primary hover:text-primary task-agent-chip"
                        data-command="对conv-001生成公告，给受影响客户群发">公告生成</button>
                      <button
                        class="px-3 py-1.5 text-xs rounded-full bg-white border border-gray-200 hover:border-primary hover:text-primary task-agent-chip"
                        data-command="请每日 9:00 巡检认证服务并生成质检任务">每日巡检</button>
                      <button
                        class="px-3 py-1.5 text-xs rounded-full bg-white border border-gray-200 hover:border-primary hover:text-primary task-agent-chip"
                        data-command="把账单核验指引变成长期任务，标记优先级中等">长期化</button>
                    </div>
                  </div>
                </div>
              </div>
            </main>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧抽屉遮罩 -->
    <div id="right-sidebar-overlay" class="hidden fixed inset-0 bg-black/20 z-30" onclick="toggleRightSidebar(false)">
    </div>

    <!-- 右侧信息栏（抽屉） -->
    <div id="right-sidebar"
      class="sidebar right-sidebar analysis-drawer w-full sm:w-[360px] lg:w-[380px] max-w-none bg-white flex flex-col h-full fixed top-0 right-0 transform translate-x-full transition-transform duration-300 z-40 shadow-2xl">
      <div id="right-drawer-resizer" class="drawer-resizer" title="拖拽调整宽度"></div>
      <div id="analysis-panel" class="analysis-panel flex flex-col h-full">

      <!-- 顶部概要与操作 -->
      <div class="analysis-header flex items-start justify-between gap-4 border-b border-gray-200 p-4">
        <div>
          <div class="flex flex-wrap items-center gap-2">
              <h3 class="text-lg font-semibold" id="analysis-case-title">小米保障群 · 云服务器无法连接</h3>
            <span class="analysis-chip chip-urgent" id="analysis-urgency-chip">高紧急</span>
            <span class="analysis-chip chip-sla" id="analysis-sla-chip">VIP</span>
            <span class="analysis-chip chip-impact" id="analysis-impact-chip">业务受阻</span>
          </div>
          <p class="text-sm text-gray-600 mt-2 w-full" id="analysis-case-summary">
            智能摘要：云服务器连接异常影响业务，已请求补充实例ID/IP并按 P2 优先级推进。</p>
        </div>
        <div class="flex flex-shrink-0 items-center gap-2">
          <button
            class="px-3 py-2 text-xs bg-primary text-white rounded-full hover:bg-primary-dark flex items-center gap-2"
            onclick="toggleRightSidebar(false)">
            <i class="fa fa-compress"></i> 收起
          </button>
        </div>
      </div>

      <div class="analysis-body flex flex-col flex-1 overflow-hidden min-h-0">
        <div class="analysis-main flex flex-col h-full min-h-0">
          <div id="analysis-classic" class="flex-1 overflow-y-auto">
            <div class="tabs flex border-b border-gray-200 items-center px-4">
              <div class="flex-1 grid grid-cols-2 gap-2">
                <button class="tab-btn py-3 text-center text-sm font-medium tab-active" data-tab="customer" data-tab-group="analysis">客户信息</button>
                <button class="tab-btn py-3 text-center text-sm font-medium" data-tab="history" data-tab-group="analysis">历史对话记录</button>
              </div>
            </div>

            <div class="tab-panels flex-1 overflow-y-auto p-4 min-h-0">
              <div class="tab-content active space-y-4" id="customer-tab" data-tab-group="analysis">
                <div class="panel-card">
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex items-start gap-3">
                      <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-primary font-semibold">张</div>
                      <div>
                        <div class="text-base font-semibold" id="customer-name">张三</div>
                        <div class="text-sm text-gray-600" id="customer-title">ABC科技有限公司 | 技术总监</div>
                        <div class="mt-2 flex flex-wrap gap-2 text-xs" id="customer-tags"></div>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-[11px] text-gray-500" id="customer-updated-at">数据刷新：--</div>
                      <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-600 text-[11px] inline-flex items-center gap-1">
                        <i class="fa fa-plug text-xs"></i> 画像平台对接中
                      </span>
                    </div>
                  </div>
                  <div class="mt-3 grid sm:grid-cols-3 gap-3 text-sm">
                    <div class="flex items-center gap-2">
                      <i class="fa fa-phone text-gray-500 w-4"></i><span id="customer-phone">138****5678</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fa fa-envelope text-gray-500 w-4"></i><span id="customer-email">zhang@abc-tech.com</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fa fa-wechat text-gray-500 w-4"></i><span id="customer-wechat">ZhangSan_WX</span>
                    </div>
                  </div>
                  <div class="mt-4 flex items-center justify-between text-xs text-gray-500">
                    <span>合同周期：<span id="contract-range">-</span></span>
                    <span class="text-[11px] px-2 py-0.5 bg-blue-50 text-blue-700 rounded-full">画像新鲜度需校验</span>
                  </div>
                  <div class="grid grid-cols-2 gap-2 mt-4 text-sm">
                    <div class="stat-tile">
                      <p class="text-[11px] text-gray-500">年度合同金额</p>
                      <p class="text-base font-semibold text-primary" id="customer-contract-amount">¥128,000</p>
                    </div>
                    <div class="stat-tile">
                      <p class="text-[11px] text-gray-500">客户满意度</p>
                      <p class="text-base font-semibold text-green-600" id="customer-satisfaction">4.5/5.0</p>
                    </div>
                    <div class="stat-tile">
                      <p class="text-[11px] text-gray-500">合作时长</p>
                      <p class="text-base font-semibold text-purple-600" id="customer-duration">2年3个月</p>
                    </div>
                    <div class="stat-tile">
                      <p class="text-[11px] text-gray-500">客户等级/到期</p>
                      <p class="text-sm font-semibold flex items-center gap-2">
                        <span id="customer-sla">VIP</span>
                        <span class="text-[11px] px-2 py-0.5 rounded-full bg-green-100 text-green-800" id="customer-sla-status">有效</span>
                      </p>
                      <p class="text-[11px] text-gray-500 mt-1">到期：<span id="customer-expire">2023-12-31</span></p>
                    </div>
                  </div>
                  <div class="mt-3 text-sm">
                    <div class="font-medium">已购产品：</div>
                    <ul class="list-disc pl-5 mt-1 text-xs space-y-1" id="customer-products"></ul>
                  </div>
                </div>

                <div class="grid gap-4 lg:grid-cols-2">
                  <div class="panel-card">
                    <div class="flex items-center justify-between">
                      <h4 class="text-sm font-medium text-gray-700">群公告</h4>
                      <span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-700">最新</span>
                    </div>
                    <p class="mt-2 text-xs text-gray-600 leading-relaxed">云服务器连接异常，已启动高优排查。请提供实例ID/IP以便加速定位。</p>
                  </div>
                  <div class="panel-card">
                    <div class="flex items-center justify-between">
                      <h4 class="text-sm font-medium text-gray-700">群备注</h4>
                      <span class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">内部</span>
                    </div>
                    <p class="mt-2 text-xs text-gray-600 leading-relaxed">客户为云服务器核心业务群聊，需同步排查进展并保持每 10 分钟更新节奏。</p>
                  </div>
                </div>

                <div class="panel-card">
                  <div class="flex items-center justify-between gap-2">
                    <h4 class="text-sm font-medium text-gray-700">当前客情摘要</h4>
                    <button class="text-xs text-primary hover:underline" onclick="document.querySelector('[data-tab=&quot;history&quot;][data-tab-group=&quot;analysis&quot;]').click()">查看历史对话</button>
                  </div>
                  <p class="mt-2 text-sm text-gray-700 leading-relaxed">客户反馈云服务器无法连接，业务受影响；当前情绪急切，需要快速给出排查进展。</p>
                  <div class="mt-3 flex flex-wrap gap-2 text-[11px]">
                    <span class="px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-100">客情状态：紧急</span>
                    <span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-100">情绪：急切</span>
                    <span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">建议：15分钟内同步进展</span>
                  </div>
                </div>
              </div>

              <div class="tab-content hidden space-y-4" id="history-tab" data-tab-group="analysis">
                <div class="panel-card space-y-3" id="conversation-section">
                  <div class="flex justify-between items-center">
                    <div>
                      <h3 class="text-sm font-medium text-gray-700">历史对话记录（时间线）</h3>
                      <p class="text-xs text-gray-500 mt-1">仅展示沟通上下文，支持定位到当前对话。</p>
                    </div>
                    <select class="text-xs border border-gray-300 rounded px-2 py-1">
                      <option>最近30天</option>
                      <option>最近90天</option>
                      <option>全部</option>
                    </select>
                  </div>
                  <div id="conversation-timeline" class="history-timeline space-y-4"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="qc-lean-container" class="hidden flex-1 overflow-y-auto qc-panel qc-lean-body">
            <div class="p-4 border-b border-gray-200 bg-white">
              <div class="qc-header-grid">
                <div class="qc-header-main">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">对话质检 · 群聊会话</div>
                  <div class="flex flex-wrap items-center gap-2 mt-1">
                    <h3 id="qc-title" class="text-base font-semibold text-gray-900">对话质检报告</h3>
                    <span id="qc-urgency" class="qc-chip qc-chip-urgent">高紧急</span>
                    <span id="qc-channel" class="qc-chip qc-chip-soft">渠道</span>
                    <span id="qc-time" class="qc-chip qc-chip-ghost">最近更新</span>
                  </div>
                  <p id="qc-summary" class="text-sm text-gray-600 mt-2">质检摘要</p>
                  <div id="qc-tags" class="mt-2 flex flex-wrap gap-2 text-[11px]"></div>
                </div>
                <div class="qc-header-meta">
                  <div class="text-[11px] text-gray-500">质检时间</div>
                  <div id="qc-updated-at" class="text-xs text-gray-700 font-semibold">刚刚</div>
                </div>
              </div>
            </div>

            <div class="qc-action-bar">
              <div class="flex flex-wrap items-center gap-2">
                <button class="qc-filter-btn active" data-qc-mode="mixed">综合视图</button>
                <button class="qc-filter-btn" data-qc-mode="analysis">质检分析</button>
                <button class="qc-filter-btn" data-qc-mode="conversation">对话复盘</button>
              </div>
              <div class="flex flex-wrap items-center gap-2">
                <button class="qc-action-btn primary">生成质检报告</button>
                <button class="qc-action-btn">推送优化建议</button>
                <button class="qc-action-btn">服务回访</button>
                <button class="qc-action-btn">标记复盘任务</button>
              </div>
            </div>

            <div class="qc-lean-grid">
              <div id="qc-analysis-wrap" class="qc-analysis-grid">
                <div class="qc-dim-card qc-dim-card--full">
                  <div class="text-xs text-gray-500">质检维度</div>
                  <div class="qc-dim-grid mt-3">
                    <div class="qc-dim-card compact">
                      <div class="text-xs text-gray-500">响应时效</div>
                      <div class="text-lg font-semibold text-gray-900 mt-1" id="qc-satisfaction-score">--</div>
                      <div class="qc-dim-bar"><div id="qc-satisfaction-bar"></div></div>
                      <div class="qc-dim-label" id="qc-satisfaction-label">--</div>
                    </div>
                    <div class="qc-dim-card compact">
                      <div class="text-xs text-gray-500">情感态度</div>
                      <div class="text-lg font-semibold text-gray-900 mt-1" id="qc-emotion-score">--</div>
                      <div class="qc-dim-bar"><div id="qc-emotion-bar"></div></div>
                      <div class="qc-dim-label" id="qc-emotion-label">--</div>
                    </div>
                    <div class="qc-dim-card compact">
                      <div class="text-xs text-gray-500">回复质量</div>
                      <div class="text-lg font-semibold text-gray-900 mt-1" id="qc-quality-score">--</div>
                      <div class="qc-dim-bar"><div id="qc-quality-bar"></div></div>
                      <div class="qc-dim-label" id="qc-quality-label">--</div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="qc-thread-wrap" class="space-y-4">
                <div class="qc-thread-card qc-thread-card--fill">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-gray-800" id="qc-thread-title">对话节选</h4>
                    <span class="text-[11px] text-gray-500">关键节点</span>
                  </div>
                  <div id="qc-thread" class="qc-thread-list mt-3 space-y-2"></div>
                </div>
                <div class="qc-dim-card compact">
                  <div class="text-xs text-gray-500">快速评分</div>
                  <div class="mt-3 space-y-3 text-xs text-gray-600">
                    <div>
                      <div class="flex items-center justify-between">
                        <span>响应时效</span>
                        <span class="font-semibold text-gray-800" id="qc-satisfaction-score-compact">--</span>
                      </div>
                      <div class="qc-dim-bar"><div id="qc-satisfaction-bar-compact"></div></div>
                      <div class="qc-dim-label" id="qc-satisfaction-label-compact">--</div>
                    </div>
                    <div>
                      <div class="flex items-center justify-between">
                        <span>情感态度</span>
                        <span class="font-semibold text-gray-800" id="qc-emotion-score-compact">--</span>
                      </div>
                      <div class="qc-dim-bar"><div id="qc-emotion-bar-compact"></div></div>
                      <div class="qc-dim-label" id="qc-emotion-label-compact">--</div>
                    </div>
                    <div>
                      <div class="flex items-center justify-between">
                        <span>回复质量</span>
                        <span class="font-semibold text-gray-800" id="qc-quality-score-compact">--</span>
                      </div>
                      <div class="qc-dim-bar"><div id="qc-quality-bar-compact"></div></div>
                      <div class="qc-dim-label" id="qc-quality-label-compact">--</div>
                    </div>
                  </div>
                </div>
                <div class="qc-insights-card">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-gray-800">分析洞察</h4>
                    <span class="text-[11px] text-gray-500">客户/用户沟通质量</span>
                  </div>
                  <div id="qc-insights-list" class="mt-3 space-y-2"></div>
                </div>
                <div class="qc-insights-card">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-gray-800">后续优化建议</h4>
                    <span class="text-[11px] text-gray-500">可执行动作</span>
                  </div>
                  <div class="mt-2 text-sm text-gray-700" id="qc-action-tip">建议：补充回访</div>
                  <div class="mt-3 flex flex-wrap gap-2 text-[11px] text-gray-500">
                    <span class="qc-chip qc-chip-ghost">补偿口径统一</span>
                    <span class="qc-chip qc-chip-ghost">进展同步节奏</span>
                    <span class="qc-chip qc-chip-ghost">情绪安抚话术</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <div id="ai-assistant-drawer" class="ai-assistant-drawer hidden flex flex-col h-full">
        <div class="ai-assistant-header flex items-start justify-between gap-4 border-b border-gray-200 p-4">
          <div>
            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">AI辅助面板</div>
            <div class="flex flex-wrap items-center gap-2">
              <h3 id="ai-assistant-title" class="text-lg font-semibold text-gray-900">智能建议中心</h3>
              <span id="ai-assistant-badge" class="analysis-chip chip-info">待选择</span>
            </div>
            <p id="ai-assistant-desc" class="text-sm text-gray-600 mt-2 w-full">点击下方快捷功能展示回复话术或解决步骤。</p>
          </div>
          <div class="flex flex-shrink-0 items-center gap-2">
            <button class="px-3 py-2 text-xs bg-primary text-white rounded-full hover:bg-primary-dark flex items-center gap-2" onclick="toggleRightSidebar(false)">
              <i class="fa fa-compress"></i> 收起
            </button>
          </div>
        </div>
        <div class="ai-assistant-body flex flex-col flex-1 overflow-hidden min-h-0 p-4">
          <div id="ai-assistant-panel" class="ai-assistant-panel panel-card">
            <div class="p-4 space-y-4">
              <div id="ai-panel-reply" class="space-y-3 ai-panel-stack reply-section">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-gray-700 flex items-center">
                    <span class="mr-2">💬</span>
                    <span>回复建议</span>
                  </h4>
                  <span class="text-[11px] text-gray-500">根据当前会话自动生成</span>
                </div>
                <div class="ai-panel-card ai-panel-card--compact bg-slate-50 border border-slate-200">
                  <div class="flex items-center justify-between gap-3">
                    <p class="text-xs text-gray-600">信息获取不清晰，需要做问题澄清</p>
                    <button class="ai-panel-chip" data-action="clarify">问题澄清</button>
                  </div>
                </div>
                <div id="ai-reply-list" class="space-y-3">
                  <div class="ai-panel-card">
                    <div>
                      <div class="text-xs text-gray-400 mb-1">方案 A · 稳定情绪</div>
                      <p class="text-sm text-gray-700">非常抱歉给您带来不便。我们已确认认证服务异常，技术团队正在紧急修复，预计 15 分钟内恢复。期间请保持账号不变，我们会同步最新进展。</p>
                      <div class="mt-3 flex justify-end">
                        <button class="ai-reply-adopt text-xs px-3 py-1 bg-primary text-white rounded-full hover:bg-primary-dark" data-suggestion="非常抱歉给您带来不便。我们已确认认证服务异常，技术团队正在紧急修复，预计 15 分钟内恢复。期间请保持账号不变，我们会同步最新进展。">采纳</button>
                      </div>
                    </div>
                  </div>
                  <div class="ai-panel-card">
                    <div>
                      <div class="text-xs text-gray-400 mb-1">方案 B · 明确排查</div>
                      <p class="text-sm text-gray-700">我们正在排查登录失败原因，当前优先检查认证与网关服务状态。请问是否有新增账号或密码重置操作？如有相关截图也欢迎补充。</p>
                      <div class="mt-3 flex justify-end">
                        <button class="ai-reply-adopt text-xs px-3 py-1 bg-primary text-white rounded-full hover:bg-primary-dark" data-suggestion="我们正在排查登录失败原因，当前优先检查认证与网关服务状态。请问是否有新增账号或密码重置操作？如有相关截图也欢迎补充。">采纳</button>
                      </div>
                    </div>
                  </div>
                  <div class="ai-panel-card">
                    <div>
                      <div class="text-xs text-gray-400 mb-1">方案 C · 安抚 + 补偿口径</div>
                      <p class="text-sm text-gray-700">我们已启动应急响应并安排专人跟进，预计很快恢复。为避免影响您业务，我们将优先处理该问题，并在恢复后提供补偿方案建议。</p>
                      <div class="mt-3 flex justify-end">
                        <button class="ai-reply-adopt text-xs px-3 py-1 bg-primary text-white rounded-full hover:bg-primary-dark" data-suggestion="我们已启动应急响应并安排专人跟进，预计很快恢复。为避免影响您业务，我们将优先处理该问题，并在恢复后提供补偿方案建议。">采纳</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="ai-panel-solution" class="hidden space-y-4 ai-panel-stack solution-section">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-gray-700 flex items-center">
                    <span class="mr-2">🧭</span>
                    <span>排查建议解决步骤</span>
                  </h4>
                  <span class="text-[11px] text-gray-500">仅提供建议</span>
                </div>
                <div class="ai-panel-card ai-panel-card--compact">
                  <ol id="ai-solution-steps" class="list-decimal pl-5 space-y-2 text-sm text-gray-700">
                  </ol>
                </div>
                <div>
                  <h5 class="text-xs font-semibold text-gray-500 uppercase tracking-wide">参考资料</h5>
                  <div id="ai-solution-references" class="mt-2 space-y-2">
                  </div>
                </div>
              </div>
              <div id="ai-panel-sentiment" class="hidden space-y-3 ai-panel-stack sentiment-section">
                <div class="ai-panel-card">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-semibold text-gray-700 flex items-center">
                      <span class="mr-2">😊</span>
                      <span>情绪分析</span>
                    </h4>
                    <span class="text-[11px] text-gray-500">实时更新</span>
                  </div>
                  <div id="ai-sentiment-content" class="text-sm text-gray-600 mt-2"></div>
                </div>
              </div>
              <div id="ai-panel-reference" class="hidden space-y-3 ai-panel-stack reference-section">
                <div class="ai-panel-card ai-panel-card--compact">
                  <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">参考资料</div>
                  <div class="grid gap-4 lg:grid-cols-2 mt-2">
                    <div id="ai-panel-knowledge" class="hidden">
                      <div class="text-sm font-semibold text-gray-700">知识库文档</div>
                      <div id="ai-knowledge-content" class="mt-2 space-y-2"></div>
                    </div>
                    <div id="ai-panel-tasks" class="hidden">
                      <div class="text-sm font-semibold text-gray-700">相似工单</div>
                      <div id="ai-tasks-content" class="mt-2 space-y-2"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="ai-panel-action" class="hidden space-y-3 ai-panel-stack">
                <div id="ai-action-content" class="space-y-3">
                </div>
              </div>
              <div id="ai-panel-clarify" class="hidden space-y-3 ai-panel-stack">
                <div id="ai-clarify-content" class="space-y-3">
                </div>
              </div>
              <div id="ai-panel-requirements" class="hidden space-y-3 ai-panel-stack">
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <div>
                    <h4 class="text-sm font-semibold text-gray-700">需求检测</h4>
                    <p class="text-xs text-gray-500 mt-1">从对话中提取需求并形成卡片</p>
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="requirements-refresh" class="text-xs px-2 py-1 rounded-lg border border-gray-200 hover:border-primary">刷新</button>
                    <button id="requirements-rescan" class="text-xs px-2 py-1 rounded-lg bg-primary text-white hover:bg-primary-dark">扫描当前对话</button>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="stat-tile">
                    <div class="text-[11px] text-gray-500">需求总量</div>
                    <div class="text-base font-semibold text-primary" id="req-total-count">0</div>
                  </div>
                  <div class="stat-tile">
                    <div class="text-[11px] text-gray-500">待处理</div>
                    <div class="text-base font-semibold text-amber-600" id="req-pending-count">0</div>
                  </div>
                  <div class="stat-tile">
                    <div class="text-[11px] text-gray-500">已完成</div>
                    <div class="text-base font-semibold text-emerald-600" id="req-done-count">0</div>
                  </div>
                  <div class="stat-tile">
                    <div class="text-[11px] text-gray-500">未创建卡片</div>
                    <div class="text-base font-semibold text-red-600" id="req-uncreated-count">0</div>
                  </div>
                </div>
                <div class="grid gap-3">
                  <div class="panel-card">
                    <div class="flex items-center justify-between mb-2">
                      <div class="text-xs text-gray-500">已处理需求</div>
                      <select id="requirement-status-filter" class="text-xs border border-gray-200 rounded px-2 py-1">
                        <option>全部状态</option>
                        <option>待处理</option>
                        <option>处理中</option>
                        <option>已完成</option>
                        <option>已拒绝</option>
                      </select>
                    </div>
                    <div id="processed-requirements-list" class="space-y-2"></div>
                  </div>
                </div>
                <div class="panel-card">
                  <div class="text-xs text-gray-500 mb-2">未创建卡片需求</div>
                  <div id="unprocessed-requirements-list" class="space-y-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧面板操作弹窗 -->
    <div id="action-modal-overlay" class="hidden fixed inset-0 bg-black/40 z-50 flex items-center justify-center px-4">
      <div id="action-modal"
        class="w-full max-w-2xl bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200">
          <h3 id="action-modal-title" class="text-sm font-semibold text-gray-800"></h3>
          <button class="text-gray-500 hover:text-primary" onclick="closeActionModal()">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div id="action-modal-body" class="p-4 text-sm text-gray-700 leading-relaxed"></div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200">
          <button class="px-3 py-2 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100"
            onclick="closeActionModal()">关闭</button>
          <button id="action-modal-primary"
            class="hidden px-3 py-2 text-xs rounded-lg bg-primary text-white hover:bg-primary-dark"></button>
        </div>
      </div>
    </div>

    <!-- 知识库详情弹窗 -->
    <div id="knowledge-detail-modal" class="hidden fixed inset-0 bg-black/40 z-[120] flex items-center justify-center px-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <div class="flex items-center gap-3">
            <h3 id="knowledge-detail-title" class="text-base font-semibold text-gray-900">知识详情</h3>
            <span id="knowledge-detail-status" class="text-[11px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-600"></span>
          </div>
          <button id="knowledge-detail-close" class="text-gray-500 hover:text-primary">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="p-4 space-y-3 text-sm text-gray-700">
          <div class="grid md:grid-cols-2 gap-3 text-xs text-gray-500">
            <div>分类：<span id="knowledge-detail-category" class="text-gray-700"></span></div>
            <div>标签：<span id="knowledge-detail-tags" class="text-gray-700"></span></div>
            <div>负责人：<span id="knowledge-detail-owner" class="text-gray-700"></span></div>
            <div>来源：<span id="knowledge-detail-source" class="text-gray-700"></span></div>
            <div>创建时间：<span id="knowledge-detail-created" class="text-gray-700"></span></div>
            <div>更新时间：<span id="knowledge-detail-updated" class="text-gray-700"></span></div>
          </div>
          <div>
            <div class="text-xs text-gray-500">摘要</div>
            <div id="knowledge-detail-summary" class="mt-1 text-sm text-gray-700"></div>
          </div>
          <div>
            <div class="text-xs text-gray-500">内容</div>
            <div id="knowledge-detail-content" class="mt-1 text-sm text-gray-700 whitespace-pre-line"></div>
          </div>
        </div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200">
          <button id="knowledge-detail-dismiss" class="px-3 py-2 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">关闭</button>
        </div>
      </div>
    </div>

    <!-- 知识新增弹窗 -->
    <div id="knowledge-add-modal" class="hidden fixed inset-0 bg-black/40 z-[120] flex items-center justify-center px-4">
      <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 class="text-base font-semibold text-gray-900">新增知识文档</h3>
          <button id="knowledge-add-close" class="text-gray-500 hover:text-primary">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="p-4 space-y-4 text-sm text-gray-700">
          <div>
            <label class="text-xs text-gray-500">文档标题</label>
            <input id="knowledge-add-title" type="text" readonly class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-gray-50 text-gray-600 cursor-not-allowed" placeholder="上传后自动生成">
          </div>
          <div>
            <label class="text-xs text-gray-500">分类</label>
            <select id="knowledge-add-category" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
              <option value="">请选择分类</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-500">上传文件</label>
            <div id="knowledge-add-dropzone" class="mt-2 border border-dashed border-gray-300 rounded-lg px-4 py-5 text-center text-xs text-gray-500 bg-gray-50 hover:bg-gray-100 cursor-pointer">
              <div class="text-sm text-gray-600">拖拽文件到此处上传</div>
              <div class="mt-1 text-xs text-gray-400">或点击选择文件（支持多选）</div>
            </div>
            <input id="knowledge-add-files" type="file" multiple class="hidden">
            <div id="knowledge-add-file-list" class="mt-2 space-y-2 text-xs text-gray-600"></div>
          </div>
          <div class="flex items-center gap-2 text-xs text-gray-600">
            <input id="knowledge-faq-mining-toggle" type="checkbox" class="rounded">
            <label for="knowledge-faq-mining-toggle">生成FAQ建议</label>
          </div>
          <div id="knowledge-faq-mining-settings" class="hidden">
            <label class="text-xs text-gray-500">FAQ生成数量</label>
            <input id="knowledge-faq-mining-count" type="number" min="1" max="20" value="5" class="mt-1 w-24 border border-gray-200 rounded-lg px-2 py-1 text-sm">
          </div>
          <div id="knowledge-add-error" class="text-xs text-red-600"></div>
        </div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200">
          <button id="knowledge-add-cancel" class="px-3 py-2 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">取消</button>
          <button id="knowledge-add-submit" class="px-3 py-2 text-xs rounded-lg bg-primary text-white hover:bg-primary-dark">提交</button>
        </div>
      </div>
    </div>

    <!-- 知识删除确认 -->
    <div id="knowledge-delete-modal" class="hidden fixed inset-0 bg-black/40 z-[140] flex items-center justify-center px-4">
      <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200">
          <h3 class="text-sm font-semibold text-gray-900">删除确认</h3>
        </div>
        <div class="p-4 text-sm text-gray-700">
          <div id="knowledge-delete-message"></div>
        </div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200">
          <button id="knowledge-delete-cancel" class="px-3 py-2 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">取消</button>
          <button id="knowledge-delete-confirm" class="px-3 py-2 text-xs rounded-lg bg-red-600 text-white hover:bg-red-700">确认删除</button>
        </div>
      </div>
    </div>

    <!-- FAQ 编辑弹窗 -->
    <div id="knowledge-faq-modal" class="hidden fixed inset-0 bg-black/40 z-[130] flex items-center justify-center px-4">
      <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
          <h3 id="knowledge-faq-modal-title" class="text-base font-semibold text-gray-900">FAQ详情</h3>
          <button id="knowledge-faq-close" class="text-gray-500 hover:text-primary">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <div class="p-4 space-y-4 text-sm text-gray-700">
          <div id="knowledge-faq-status-wrap">
            <label class="text-xs text-gray-500">状态</label>
            <select id="knowledge-faq-status" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
              <option value="active">active</option>
              <option value="archived">archived</option>
              <option value="deprecated">deprecated</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-500">问题</label>
            <input id="knowledge-faq-question" type="text" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
          </div>
          <div>
            <label class="text-xs text-gray-500">答案</label>
            <textarea id="knowledge-faq-answer" rows="4" class="mt-1 w-full border border-gray-200 rounded-lg px-3 py-2 text-sm"></textarea>
          </div>
          <div id="knowledge-faq-error" class="text-xs text-red-600"></div>
          <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
            <div class="flex items-center justify-between">
              <div class="text-xs text-gray-500">相似问题建议</div>
              <button id="knowledge-faq-detect" class="text-xs text-primary hover:underline">检测</button>
            </div>
            <div id="knowledge-faq-detect-results" class="mt-2 space-y-2 text-xs text-gray-600"></div>
            <div class="mt-3 flex items-center gap-2">
              <input id="knowledge-faq-similar-input" type="text" class="flex-1 border border-gray-200 rounded-lg px-2 py-1 text-xs" placeholder="添加相似问题">
              <button id="knowledge-faq-similar-add" class="px-2 py-1 text-xs rounded-lg border border-gray-200">添加</button>
              <button id="knowledge-faq-similar-generate" class="px-2 py-1 text-xs rounded-lg border border-gray-200">生成</button>
            </div>
            <div id="knowledge-faq-similar-list" class="mt-2 flex flex-wrap gap-2 text-[11px] text-gray-600"></div>
          </div>
        </div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200">
          <button id="knowledge-faq-cancel" class="px-3 py-2 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">取消</button>
          <button id="knowledge-faq-save" class="px-3 py-2 text-xs rounded-lg bg-primary text-white hover:bg-primary-dark">保存</button>
        </div>
      </div>
    </div>

    <!-- FAQ 删除确认 -->
    <div id="knowledge-faq-delete-modal" class="hidden fixed inset-0 bg-black/40 z-[130] flex items-center justify-center px-4">
      <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-200">
          <h3 class="text-sm font-semibold text-gray-900">删除FAQ</h3>
        </div>
        <div class="p-4 text-sm text-gray-700">
          <div id="knowledge-faq-delete-message"></div>
        </div>
        <div class="flex justify-end gap-2 px-4 py-3 border-t border-gray-200">
          <button id="knowledge-faq-delete-cancel" class="px-3 py-2 text-xs rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">取消</button>
          <button id="knowledge-faq-delete-confirm" class="px-3 py-2 text-xs rounded-lg bg-red-600 text-white hover:bg-red-700">确认删除</button>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script type="module" src="assets/js/main.js"></script>

    <!-- 用户菜单功能 -->
    <script>
      // 用户菜单下拉功能
      document.addEventListener('DOMContentLoaded', function() {
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const logoutButton = document.getElementById('logout-button');

        // 切换下拉菜单显示/隐藏
        userMenuButton.addEventListener('click', function(e) {
          e.stopPropagation();
          userMenuDropdown.classList.toggle('hidden');
        });

        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', function(e) {
          if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
            userMenuDropdown.classList.add('hidden');
          }
        });

        // 退出登录功能
        logoutButton.addEventListener('click', function() {
          // 清除可能存在的认证信息
          if (window.config) {
            window.config.authToken = null;
          }
          localStorage.removeItem('authToken');
          sessionStorage.clear();

          // 跳转到登录页
          window.location.href = 'index.html';
        });

      });
    </script>

</body>

</html>
