# PRD编写指南

> **文档版本**: v1.0
> **适用项目**: 智能售后工作台
> **更新日期**: 2025-12-29

---

## 目录

1. [PRD格式选择](#1-prd格式选择)
2. [Agent PRD编写指南](#2-agent-prd编写指南)
3. [功能PRD编写指南](#3-功能prd编写指南)
4. [混合PRD编写指南](#4-混合prd编写指南)
5. [编写规范与最佳实践](#5-编写规范与最佳实践)
6. [常见问题与解决方案](#6-常见问题与解决方案)

---

## 1. PRD格式选择

### 1.1 决策树

```
┌──────────────────────────────┐
│   功能需求分析               │
└─────────────┬────────────────┘
              │
         是否涉及LLM/Agent?
              │
      ┌───────┴───────┐
     是                否
      │                │
      ▼                ▼
 是否需要UI配合?   ┌─────────┐
      │            │功能PRD  │
 ┌────┴────┐       └─────────┘
是          否
 │           │
 ▼           ▼
混合PRD    Agent PRD
```

### 1.2 格式选择判断标准

| 判断标准 | Agent PRD | 功能PRD | 混合PRD |
|---------|-----------|---------|---------|
| **是否调用LLM** | ✅ 是 | ❌ 否 | ✅ 是 |
| **是否有AI推理** | ✅ 是 | ❌ 否 | ✅ 是 |
| **是否需要UI配合** | ❌ 否 | ✅ 是 | ✅ 是 |
| **主要交互方式** | 对话/工具调用 | UI交互 | 对话+UI |
| **核心定义单位** | 意图/工具/场景 | 功能点/页面 | 两者结合 |

### 1.3 示例判断

#### 示例1：对话模式与人工介入（6.2）
- **涉及Agent**：✅ 是（AssistantAgent判定模式、Orchestrator路由）
- **涉及AI推理**：✅ 是（置信度评估、模式判定）
- **需要UI配合**：✅ 是（三种模式切换按钮、状态展示）
- **结论**：**混合PRD**

#### 示例2：AI方案推荐（6.11）
- **涉及Agent**：✅ 是（EngineerAgent生成方案）
- **涉及AI推理**：✅ 是（分析、推荐、评估）
- **需要UI配合**：❌ 否（仅通过API返回结果，前端只是简单展示）
- **结论**：**Agent PRD**

#### 示例3：客户信息展示（6.6）
- **涉及Agent**：❌ 否
- **涉及AI推理**：❌ 否
- **需要UI配合**：✅ 是（客户档案卡片、信息展示）
- **结论**：**功能PRD**

#### 示例4：知识库（6.8）
- **涉及Agent**：✅ 是（EngineerAgent语义检索、知识沉淀）
- **涉及AI推理**：✅ 是（语义匹配、知识提取）
- **需要UI配合**：✅ 是（搜索面板、知识卡片、知识图谱）
- **结论**：**混合PRD**

---

## 2. Agent PRD编写指南

### 2.1 结构要求（11章）

```markdown
# Agent PRD: [Agent名称]

## 1. Agent Profile
## 2. 提示词变更记录
## 3. 工具清单
## 4. 沉淀Skills
## 5. 业务场景
## 6. 人机协作边界
## 7. 非功能需求
## 8. 验收场景
## 9. 降级策略
## 10. 监控指标
## 11. 示例对话
```

### 2.2 各章节编写要点

#### 第1章：Agent Profile

**必须包含**：
- **Agent Name**: Agent的唯一标识（AssistantAgent/EngineerAgent/InspectorAgent）
- **Role**: 一句话角色定位（如"情感分析 + 需求提取 + 回复生成"）
- **Personality**: 性格特征（友好、专业、简洁）
- **Capabilities**: 核心能力列表（MCP工具名称）

**示例**：
```markdown
## 1. Agent Profile

- **Agent Name**: AssistantAgent
- **Role**: 情感分析 + 需求提取 + 回复生成
- **Personality**: 友好、专业、简洁
- **Capabilities**:
  - analyzeConversation (MCP)
  - getCustomerProfile (MCP)
  - searchKnowledge (MCP)
  - generateReply (MCP)
```

#### 第2章：提示词变更记录

**必须包含**：
- 每个版本的Prompt变更
- 使用diff格式展示修改
- 说明变更原因

**示例**：
```markdown
## 2. 提示词变更记录

| 版本 | 变更内容 | 变更原因 | 日期 |
|-----|---------|---------|------|
| v0.1 | 初始Prompt | 首次创建 | 2025-01-01 |
| v0.5 | 增加渠道识别 | 支持企业微信 | 2025-03-01 |

### v0.5 Prompt Diff

\```diff
你是专业的售后客服助手。

核心职责:
1. 分析客户情感（正面/中性/负面）
+ 2. 识别消息渠道（飞书/企业微信/Web）
+ 3. 根据渠道调整回复格式
\```
```

#### 第3章：工具清单

**必须包含**：
- 工具名称
- 功能描述（从用户视角）
- 输入参数（类型、说明、约束）
- 输出格式
- 调用方式（MCP/REST API）

**示例**：
```markdown
## 3. 工具清单

### 3.1 analyzeConversation

**功能描述**: 分析对话的情感、意图、优先级

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| conversationId | string | 是 | 对话ID | UUID格式 |
| includeHistory | boolean | 否 | 是否包含历史消息 | 默认false |

**输出格式**:
\```json
{
  "sentiment": "negative",  // positive/neutral/negative
  "score": 0.65,            // 0-1
  "priority": "urgent",     // normal/high/urgent
  "intent": "complaint",    // inquiry/complaint/requirement
  "confidence": 0.85        // 0-1
}
\```

**调用方式**: MCP

**特性**:
- 自动识别VIP客户，提升优先级
- 置信度<0.7时推送人工审核
- 支持多语言（中/英/日）

**注意事项**:
- 历史消息最多分析最近10条
- 超时30秒自动降级到关键词匹配
```

#### 第4章：沉淀Skills

**说明**：仅用于迭代版本（提炼上一版本已验证的功能）

**示例**：
```markdown
## 4. 沉淀Skills

### 4.1 sentiment_analysis_skill

**适用场景**: 客户发送消息后，自动分析情感

**触发条件**: MessageSentEvent

**标准流程**:
1. 调用analyzeConversation获取情感分析
2. 如果sentiment=negative且score<0.5，标记为高风险
3. 推送实时通知到客服
4. 记录到对话历史

**质量门禁**:
- 情感分析准确率>90%
- 响应时间<3秒

**回滚策略**:
- 如果LLM超时，使用关键词匹配（"烂"、"差"→negative）
- 如果关键词匹配也失败，默认neutral

**可观测性**:
- 记录每次调用的置信度分布
- 监控降级触发次数
```

#### 第5章：业务场景

**必须包含**：
- 场景名称和触发条件
- 处理流程（时序图）
- 对话示例（真实多轮）
- 预期输出
- 异常分支

**示例**：
```markdown
## 5. 业务场景

### 场景1：常规咨询（置信度>0.9）

**触发条件**: 客户发送咨询类消息，情感为neutral或positive

**处理流程**:
\```mermaid
sequenceDiagram
    Customer->>AssistantAgent: "如何开发票？"
    AssistantAgent->>MCP: analyzeConversation()
    MCP-->>AssistantAgent: {sentiment: neutral, intent: inquiry}
    AssistantAgent->>MCP: searchKnowledge("开发票")
    MCP-->>AssistantAgent: [知识条目列表]
    AssistantAgent->>MCP: generateReply()
    MCP-->>AssistantAgent: {reply, confidence: 0.92}
    AssistantAgent->>Frontend: 推送回复建议
\```

**对话示例**:
\```
客户: "如何开发票？"

AssistantAgent分析:
{
  "sentiment": "neutral",
  "intent": "inquiry",
  "confidence": 0.92
}

建议回复:
"您好！开发票流程如下：
1. 进入【我的订单】
2. 点击【申请发票】
3. 填写发票信息
4. 提交审核（1-3个工作日）

如有其他问题，欢迎随时咨询！"
\```

**预期输出**:
- 回复置信度>0.9
- 自动填入输入框
- 客服可直接发送或微调

**异常分支**:
- 如果知识库无匹配结果 → 推荐联系财务部
- 如果置信度<0.9 → 推送人工确认
```

#### 第6章：人机协作边界

**必须包含**：
- Agent主导场景（可自动处理）
- 人工主导场景（必须人工介入）
- 协作模式（Agent辅助，人工决策）

**示例**：
```markdown
## 6. 人机协作边界

### 6.1 Agent主导场景（自动化率90%）

**适用条件**:
- 简单咨询（常见问题）
- 情感分析置信度>0.9
- 非VIP客户
- 非高风险对话

**Agent行为**:
1. 自动分析情感和意图
2. 生成回复建议
3. **v0.8后**：置信度>0.9自动发送（无需人工审核）

### 6.2 人工主导场景（自动化率0%）

**适用条件**:
- VIP客户
- 高风险客户（riskLevel=high）
- 负面情绪且分数<0.5
- 复杂/非标问题
- 涉及退款/赔偿

**Agent行为**:
1. 提供情感分析结果
2. 推荐相关知识库
3. 展示历史案例
4. **永远需要人工确认，不自动发送**

### 6.3 协作模式（Agent辅助，人工决策）

**适用条件**:
- 中等复杂度问题
- 置信度0.7-0.9

**Agent行为**:
1. 生成3+种回复方案
2. 标注每个方案的置信度
3. 人工选择或组合方案
4. 人工确认后发送
```

#### 第7章：非功能需求

**必须包含**：
- 响应时间
- 准确率
- 可用性
- 成本约束

**示例**：
```markdown
## 7. 非功能需求

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **响应时间** | <3秒（P95） | Prometheus监控LLM调用时长 |
| **情感分析准确率** | >90% | 人工抽检100条/周，对比标注 |
| **意图识别准确率** | >85% | 同上 |
| **系统可用性** | >99.9% | Prometheus监控，降级策略保障 |
| **LLM调用成本** | <¥5000/月 | DeepSeek优先，缓存高频问题 |
| **Token消耗** | <100k tokens/天 | 监控每次调用的token数 |
```

#### 第8章：验收场景

**必须包含**：
- 场景ID
- 场景描述
- 输入
- 预期输出
- 验收标准
- 优先级

**示例**：
```markdown
## 8. 验收场景

| 场景ID | 场景描述 | 优先级 |
|--------|---------|--------|
| AC-01 | 常规咨询-高置信度 | P0 |
| AC-02 | 负面情绪识别 | P0 |
| AC-03 | VIP客户自动升级 | P0 |
| AC-04 | 降级到关键词匹配 | P1 |

### AC-01: 常规咨询-高置信度

**输入**:
\```
客户消息: "如何开发票？"
```

**预期输出**:
\```json
{
  "sentiment": "neutral",
  "intent": "inquiry",
  "confidence": 0.92,
  "suggested_reply": "您好！开发票流程如下：..."
}
\```

**验收标准**:
- ✅ sentiment识别正确（neutral）
- ✅ intent识别为inquiry
- ✅ confidence>0.9
- ✅ suggested_reply包含开发票流程
- ✅ 响应时间<3秒

---

### AC-02: 负面情绪识别

**输入**:
\```
客户消息: "你们系统太烂了，一直报错！"
\```

**预期输出**:
\```json
{
  "sentiment": "negative",
  "score": 0.25,
  "priority": "urgent",
  "needHumanReview": true
}
\```

**验收标准**:
- ✅ sentiment识别为negative
- ✅ score<0.5
- ✅ priority自动升级为urgent
- ✅ needHumanReview=true（推送人工）
```

#### 第9章：降级策略

**必须包含**：
- 主路径（正常流程）
- 降级层级（1级/2级/3级）
- 触发条件
- 降级行为

**示例**：
```markdown
## 9. 降级策略

### 9.1 降级层级

\```
主路径: LLM分析 (DeepSeek v3.1)
  ↓ 超时30秒/调用失败
降级1: 关键词匹配算法
  ↓ 无匹配结果
降级2: 默认规则引擎
  ↓ 保底值
降级3: 人工介入
\```

### 9.2 情感分析降级

**主路径**: LLM分析
- **触发条件**: 正常情况
- **行为**: 调用DeepSeek API，输入客户消息
- **输出**: {sentiment, score, confidence}

**降级1**: 关键词匹配
- **触发条件**: LLM超时30秒 或 API错误
- **行为**: 匹配关键词库
  - "烂"、"差"、"垃圾" → negative
  - "好"、"谢谢"、"赞" → positive
  - 其他 → neutral
- **输出**: {sentiment, score: 0.6, confidence: 0.5}

**降级2**: 默认规则
- **触发条件**: 关键词库无匹配
- **行为**: 默认为neutral
- **输出**: {sentiment: "neutral", score: 0.5, confidence: 0.3}

**降级3**: 人工介入
- **触发条件**: 置信度<0.5 或 VIP客户
- **行为**: 推送人工审核，暂不自动回复
```

#### 第10章：监控指标

**必须包含**：
- 调用量指标
- 性能指标
- 准确率指标
- 成本指标

**示例**：
```markdown
## 10. 监控指标

### 10.1 核心指标

| 指标名称 | 指标定义 | 监控工具 | 告警阈值 |
|---------|---------|---------|---------|
| **LLM调用次数** | 每小时调用量 | Prometheus | >1000次/小时 |
| **LLM调用成功率** | 成功调用/总调用 | Prometheus | <95% |
| **平均响应时间** | P95响应时长 | Prometheus | >5秒 |
| **置信度分布** | 各置信度区间占比 | Grafana | <0.7占比>20% |
| **降级触发次数** | 降级到关键词匹配次数 | Prometheus | >100次/小时 |
| **Token消耗** | 每日总Token | Prometheus | >100k tokens/天 |
| **成本** | 每日LLM调用费用 | 自定义脚本 | >¥200/天 |

### 10.2 Prometheus指标定义

\```promql
# LLM调用总次数
llm_calls_total{agent="AssistantAgent", model="deepseek-v3.1"}

# LLM调用失败次数
llm_calls_failed{agent="AssistantAgent", error_type="timeout"}

# LLM响应时间（直方图）
llm_response_duration_seconds{agent="AssistantAgent"}

# 置信度分布
llm_confidence_score{agent="AssistantAgent", bucket="0.9-1.0"}
\```

### 10.3 Grafana仪表板

**面板1**: LLM调用量趋势（折线图）
**面板2**: 置信度分布（饼图）
**面板3**: 响应时间P50/P95/P99（折线图）
**面板4**: 降级触发次数（柱状图）
**面板5**: 每日成本（面积图）
```

#### 第11章：示例对话

**必须包含**：
- 真实的多轮对话
- Agent的思考过程
- 工具调用链路
- 最终输出

**示例**：
```markdown
## 11. 示例对话

### 示例1：常规咨询

**对话背景**: 客户咨询开发票流程

\```
【客户】如何开发票？

【AssistantAgent思考过程】
1. 调用analyzeConversation()
   → 输出: {sentiment: "neutral", intent: "inquiry", confidence: 0.92}

2. 调用searchKnowledge("开发票")
   → 输出: [知识条目#123: 开发票流程]

3. 调用generateReply()
   → 输出: {reply: "您好！开发票流程如下：...", confidence: 0.92}

【AssistantAgent输出】
{
  "sentiment": "neutral",
  "intent": "inquiry",
  "suggested_reply": "您好！开发票流程如下：\n1. 进入【我的订单】\n2. 点击【申请发票】\n3. 填写发票信息\n4. 提交审核（1-3个工作日）\n\n如有其他问题，欢迎随时咨询！",
  "confidence": 0.92,
  "needHumanReview": false
}

【前端展示】
回复建议（置信度92%）[采纳] [修改] [拒绝]
您好！开发票流程如下：...

【客服操作】
点击【采纳】→ 自动填入输入框 → 确认发送
\```

---

### 示例2：负面情绪-人工介入

**对话背景**: 客户投诉系统故障

\```
【客户】你们系统太烂了，一直报错，影响我工作了！

【AssistantAgent思考过程】
1. 调用analyzeConversation()
   → 输出: {sentiment: "negative", score: 0.25, priority: "urgent"}

2. 判断: score < 0.5 → 推送人工审核

3. 调用getCustomerProfile()
   → 输出: {name: "张三", isVIP: true, riskLevel: "high"}

4. 判断: isVIP=true → 切换为"人工优先"模式

【AssistantAgent输出】
{
  "sentiment": "negative",
  "score": 0.25,
  "priority": "urgent",
  "needHumanReview": true,
  "escalateReason": "负面情绪 + VIP客户",
  "suggested_actions": [
    "立即分配高级客服",
    "查看系统故障记录",
    "准备补偿方案"
  ]
}

【前端展示】
🔴 高优先级 - VIP客户 - 负面情绪
建议：立即人工介入

【客服操作】
看到提示 → 切换为人工优先模式 → 自由编辑回复 → 发送
\```
```

### 2.3 编写检查清单

在提交Agent PRD前，请确认：

- [ ] Agent Profile包含4个必填项（Name/Role/Personality/Capabilities）
- [ ] 提示词变更记录使用diff格式
- [ ] 工具清单包含输入/输出/调用方式
- [ ] 业务场景至少3个（正常/异常/边界）
- [ ] 对话示例至少2个（简单/复杂）
- [ ] 人机协作边界明确（Agent主导/人工主导/协作）
- [ ] 非功能需求有具体数值目标
- [ ] 验收场景覆盖P0功能
- [ ] 降级策略至少2层
- [ ] 监控指标包含成本指标

---

## 3. 功能PRD编写指南

### 3.1 结构要求

```markdown
# 功能PRD: [功能名称]

## 1. 功能概述
## 2. 功能需求
## 3. UI设计
## 4. 交互流程
## 5. 接口定义
## 6. 数据模型
## 7. 验收标准
## 8. 非功能需求
```

### 3.2 各章节编写要点

#### 第1章：功能概述

**必须包含**：
- 功能定位（一句话描述）
- 目标用户
- 核心价值
- 优先级

**示例**：
```markdown
## 1. 功能概述

**功能定位**: 展示客户的基础档案、合同信息、健康度评分，帮助客服快速了解客户背景

**目标用户**: 一线客服、售后经理

**核心价值**:
- 减少重复询问客户信息，提升效率
- 通过健康度评分识别高风险客户
- SLA信息实时可见，避免超时

**优先级**: P0（核心功能）
```

#### 第2章：功能需求

**必须包含**：
- 用户故事（As a/I want/So that）
- 功能列表（表格形式）
- 详细规格说明

**示例**：
```markdown
## 2. 功能需求

### 2.1 用户故事

**US-01**: 作为一线客服，我希望看到客户的基础档案，以便快速了解客户背景
**US-02**: 作为售后经理，我希望看到客户的健康度评分，以便识别高风险客户
**US-03**: 作为一线客服，我希望看到SLA信息，以便避免服务超时

### 2.2 功能列表

| 功能项 | 描述 | 优先级 | 依赖 |
|-------|------|--------|------|
| 客户基础档案 | 展示姓名、公司、职位、联系方式 | P0 | 无 |
| 合同信息 | 展示合同金额、状态、到期时间 | P0 | 无 |
| SLA信息 | 展示服务等级、响应时间要求 | P0 | 无 |
| 健康度评分 | 展示健康度分数、风险等级 | P0 | HealthScoreCalculator |
| 已购产品清单 | 展示客户已购买的产品列表 | P1 | 无 |
| 最近互动记录 | 展示近7/30/90天的沟通记录 | P1 | 无 |

### 2.3 详细规格说明

#### 功能1：客户基础档案

**功能描述**: 在右侧面板展示客户的基础信息

**字段定义**:
| 字段名 | 类型 | 必填 | 说明 | 示例 |
|-------|------|------|------|------|
| customerId | string | 是 | 客户ID | "CUST-001" |
| name | string | 是 | 客户姓名 | "张三" |
| company | string | 否 | 公司名称 | "某某科技有限公司" |
| position | string | 否 | 职位 | "技术总监" |
| phone | string | 否 | 手机号 | "138****1234"（脱敏） |
| email | string | 否 | 邮箱 | "zhang***@example.com"（脱敏） |

**交互行为**:
1. 当切换对话时，自动加载对应客户的档案
2. 如果客户档案不存在，显示"暂无客户信息"
3. 点击"刷新"按钮，重新从CRM同步数据
4. 手机号和邮箱默认脱敏，点击"显示完整"按钮查看（需权限）

**边界条件**:
- 客户ID不存在：显示"客户不存在"
- 网络超时：显示"加载失败，请重试"
- 数据不完整：显示空值为"--"
```

#### 第3章：UI设计

**必须包含**：
- 页面布局（截图/线框图）
- 组件说明
- 样式规范

**示例**：
```markdown
## 3. UI设计

### 3.1 页面布局

\```
┌─────────────────────────────────────┐
│ 客户信息                              │
├─────────────────────────────────────┤
│ 📄 基础档案                           │
│   姓名: 张三                          │
│   公司: 某某科技有限公司                │
│   职位: 技术总监                       │
│   手机: 138****1234 [显示完整]         │
│                                      │
│ 💼 合同信息                           │
│   合同金额: ¥100,000                  │
│   合同状态: 🟢 有效                   │
│   到期时间: 2025-12-31                │
│   SLA等级: 金牌VIP                    │
│                                      │
│ 📊 健康度评分                         │
│   分数: 85/100 (🟢 健康)              │
│   风险等级: 低                        │
│   更新时间: 2025-12-29 10:00          │
│   [查看详情]                          │
│                                      │
│ 🛒 已购产品                           │
│   • ERP系统（标准版）                  │
│   • CRM系统（企业版）                  │
│                                      │
│ 🕒 最近互动 [7天] [30天] [90天]       │
│   • 2025-12-28: 咨询开发票问题         │
│   • 2025-12-25: 系统故障报修           │
└─────────────────────────────────────┘
\```

### 3.2 组件说明

**组件1**: 健康度评分卡片
- **样式**:
  - 分数>=80：绿色背景
  - 分数60-79：黄色背景
  - 分数<60：红色背景
- **交互**:
  - 点击"查看详情"展开健康度明细（合同金额权重、满意度权重等）

**组件2**: 最近互动时间筛选
- **样式**: Tab切换按钮组
- **交互**:
  - 默认显示7天
  - 点击30天/90天切换数据

### 3.3 样式规范

| 元素 | 样式 |
|-----|------|
| 标题字体 | 16px, 加粗, #1a1a1a |
| 正文字体 | 14px, 常规, #333333 |
| 标签（健康） | 12px, 绿色背景#d4edda, 绿色文字#155724 |
| 标签（风险） | 12px, 红色背景#f8d7da, 红色文字#721c24 |
| 卡片间距 | 16px |
| 内边距 | 12px |
```

#### 第4章：交互流程

**必须包含**：
- 主流程（流程图）
- 异常分支
- 状态机（如适用）

**示例**：
```markdown
## 4. 交互流程

### 4.1 主流程

\```mermaid
flowchart TD
    A[用户切换对话] --> B{客户档案存在?}
    B -->|是| C[加载客户档案]
    B -->|否| D[显示"暂无客户信息"]
    C --> E[渲染基础档案]
    E --> F[计算健康度评分]
    F --> G[加载最近互动]
    G --> H[展示完整客户信息]
    D --> I[提供"创建客户"按钮]
\```

### 4.2 异常分支

**异常1**: 网络超时
- **触发条件**: API调用超过10秒无响应
- **处理方式**: 显示"加载失败，请重试"，提供"重试"按钮

**异常2**: 权限不足
- **触发条件**: 用户无权查看完整手机号/邮箱
- **处理方式**: "显示完整"按钮置灰，hover提示"权限不足"

**异常3**: 数据不完整
- **触发条件**: 某些字段为空
- **处理方式**: 显示"--"，不影响其他信息展示
```

#### 第5章：接口定义

**必须包含**：
- API路径
- 请求方法
- 请求体
- 响应体
- 错误码

**示例**：
```markdown
## 5. 接口定义

### 5.1 获取客户档案

**接口路径**: `/api/customers/:customerId/profile`
**请求方法**: GET
**权限要求**: 需要登录，角色为客服或售后经理

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| customerId | string | 是 | 客户ID |

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 | 默认值 |
|-------|------|------|------|--------|
| includeInteractions | boolean | 否 | 是否包含最近互动 | true |
| interactionDays | number | 否 | 最近互动天数 | 7 |

**请求示例**:
\```bash
GET /api/customers/CUST-001/profile?includeInteractions=true&interactionDays=30
Authorization: Bearer <token>
\```

**响应体**（成功）:
\```json
{
  "success": true,
  "data": {
    "customerId": "CUST-001",
    "name": "张三",
    "company": "某某科技有限公司",
    "position": "技术总监",
    "phone": "138****1234",
    "email": "zhang***@example.com",
    "contract": {
      "amount": 100000,
      "status": "active",
      "expiryDate": "2025-12-31",
      "slaLevel": "金牌VIP"
    },
    "healthScore": {
      "score": 85,
      "riskLevel": "low",
      "updatedAt": "2025-12-29T10:00:00Z"
    },
    "products": [
      {"name": "ERP系统", "version": "标准版"},
      {"name": "CRM系统", "version": "企业版"}
    ],
    "interactions": [
      {
        "date": "2025-12-28",
        "type": "conversation",
        "summary": "咨询开发票问题"
      }
    ]
  }
}
\```

**响应体**（失败）:
\```json
{
  "success": false,
  "error": {
    "code": "CUSTOMER_NOT_FOUND",
    "message": "客户不存在"
  }
}
\```

**错误码**:
| 错误码 | HTTP状态码 | 说明 |
|-------|-----------|------|
| CUSTOMER_NOT_FOUND | 404 | 客户不存在 |
| UNAUTHORIZED | 401 | 未登录 |
| FORBIDDEN | 403 | 权限不足 |
| INTERNAL_ERROR | 500 | 服务器内部错误 |
```

#### 第6章：数据模型

**必须包含**：
- 实体定义（TypeScript接口）
- 字段说明
- 约束条件

**示例**：
```markdown
## 6. 数据模型

### 6.1 CustomerProfile实体

\```typescript
interface CustomerProfile {
  customerId: string;           // 客户ID，唯一标识
  name: string;                 // 姓名
  company?: string;             // 公司名称（可选）
  position?: string;            // 职位（可选）
  phone?: string;               // 手机号（脱敏）
  email?: string;               // 邮箱（脱敏）
  contract: ContractInfo;       // 合同信息
  healthScore: HealthScore;     // 健康度评分
  products: Product[];          // 已购产品列表
  interactions?: Interaction[]; // 最近互动（可选）
  createdAt: Date;              // 创建时间
  updatedAt: Date;              // 更新时间
}

interface ContractInfo {
  amount: number;               // 合同金额（元）
  status: 'active' | 'expired' | 'cancelled'; // 合同状态
  expiryDate: string;           // 到期时间（ISO 8601）
  slaLevel: '普通' | '银牌' | '金牌VIP' | '铂金VIP'; // SLA等级
}

interface HealthScore {
  score: number;                // 健康度分数（0-100）
  riskLevel: 'low' | 'medium' | 'high'; // 风险等级
  updatedAt: string;            // 更新时间（ISO 8601）
}

interface Product {
  name: string;                 // 产品名称
  version: string;              // 版本
}

interface Interaction {
  date: string;                 // 互动日期（YYYY-MM-DD）
  type: 'conversation' | 'service' | 'requirement'; // 互动类型
  summary: string;              // 摘要
}
\```

### 6.2 字段约束

| 字段 | 约束 |
|-----|------|
| customerId | 必填，唯一，格式：`CUST-\d{3,}` |
| name | 必填，长度1-50字符 |
| phone | 可选，格式：`\d{3}\*\*\*\*\d{4}`（脱敏） |
| email | 可选，格式：`\w+\*\*\*@\w+\.\w+`（脱敏） |
| contract.amount | 必填，>0 |
| healthScore.score | 必填，0-100 |
```

#### 第7章：验收标准

**必须包含**：
- 功能验收
- 性能验收
- 安全验收

**示例**：
```markdown
## 7. 验收标准

### 7.1 功能验收

| 验收项 | 验收标准 | 优先级 |
|-------|---------|--------|
| 客户档案展示 | 切换对话后，2秒内展示客户档案 | P0 |
| 健康度评分 | 分数计算正确，误差<5分 | P0 |
| 最近互动 | 支持7/30/90天筛选，数据准确 | P0 |
| 数据刷新 | 点击刷新后，3秒内更新数据 | P1 |
| 脱敏显示 | 默认脱敏，点击"显示完整"查看原始数据 | P1 |

### 7.2 性能验收

| 验收项 | 验收标准 |
|-------|---------|
| 首次加载时间 | <2秒（P95） |
| 数据刷新时间 | <3秒（P95） |
| 并发支持 | 100并发，响应时间<5秒 |

### 7.3 安全验收

| 验收项 | 验收标准 |
|-------|---------|
| 数据脱敏 | 手机号和邮箱默认脱敏 |
| 权限控制 | 非授权用户无法查看完整联系方式 |
| 数据加密 | HTTPS传输，敏感字段加密存储 |
```

#### 第8章：非功能需求

**必须包含**：
- 性能要求
- 可用性要求
- 安全要求
- 可扩展性要求

**示例**：
```markdown
## 8. 非功能需求

### 8.1 性能要求

| 指标 | 目标值 |
|-----|--------|
| API响应时间 | <2秒（P95） |
| 前端渲染时间 | <500ms |
| 并发支持 | 100并发 |
| 数据库查询 | <1秒 |

### 8.2 可用性要求

| 指标 | 目标值 |
|-----|--------|
| 系统可用性 | >99% |
| 错误率 | <1% |
| 数据一致性 | 100%（CRM同步） |

### 8.3 安全要求

- 数据传输：HTTPS加密
- 数据存储：敏感字段AES-256加密
- 权限控制：基于RBAC，细粒度到字段级
- 审计日志：记录所有查看完整联系方式的操作

### 8.4 可扩展性要求

- 支持对接多种CRM系统（Salesforce/HubSpot/自建CRM）
- 支持自定义字段扩展
- 支持多语言（中/英/日）
```

### 3.3 编写检查清单

在提交功能PRD前，请确认：

- [ ] 功能概述包含用户故事（As a/I want/So that）
- [ ] 功能列表使用表格形式，包含优先级和依赖
- [ ] UI设计包含页面布局（截图/线框图）
- [ ] 交互流程包含主流程和异常分支（流程图）
- [ ] 接口定义包含请求/响应/错误码
- [ ] 数据模型使用TypeScript接口定义
- [ ] 验收标准包含功能/性能/安全三个维度
- [ ] 非功能需求有具体数值目标

---

## 4. 混合PRD编写指南

### 4.1 结构要求

```markdown
# 混合PRD: [功能名称]

## 第1部分：Agent能力部分（Agent PRD格式）
### 1.1 Agent Profile
### 1.2 工具清单
### 1.3 业务场景
### 1.4 非功能需求

## 第2部分：功能部分（功能PRD格式）
### 2.1 功能需求
### 2.2 UI设计
### 2.3 接口定义
### 2.4 数据模型

## 第3部分：人机协作设计
### 3.1 Agent输出 → UI展示
### 3.2 UI操作 → Agent触发
### 3.3 数据流转

## 第4部分：验收标准
### 4.1 Agent能力验收
### 4.2 功能验收
### 4.3 集成验收
```

### 4.2 编写要点

#### 要点1：两部分保持一致

**Agent输出字段 = UI展示字段**

**示例（知识库模块）**：
```markdown
## 第1部分：Agent能力部分

### 1.2 工具清单

#### searchKnowledge

**输出格式**:
\```json
{
  "results": [
    {
      "id": "KB-001",
      "title": "开发票流程",
      "summary": "详细说明如何在系统中申请开票...",
      "type": "doc",
      "relevanceScore": 0.92,
      "updatedAt": "2025-12-01"
    }
  ]
}
\```

---

## 第2部分：功能部分

### 2.2 UI设计

**知识卡片展示**:
\```
┌─────────────────────────────────────┐
│ 📄 开发票流程                         │
│ 相关度: 92%                           │
│ 类型: 文档  更新: 2025-12-01          │
│                                      │
│ 详细说明如何在系统中申请开票...        │
│                                      │
│ [展开全文] [相关知识]                 │
└─────────────────────────────────────┘
\```

**字段映射**:
- `title` → 卡片标题
- `relevanceScore` → 相关度百分比
- `type` → 类型标签
- `updatedAt` → 更新时间
- `summary` → 摘要文本
```

#### 要点2：人机协作边界清晰

**明确：哪些决策由Agent做，哪些由人工做**

**示例（对话模式模块）**：
```markdown
## 第3部分：人机协作设计

### 3.1 Agent输出 → UI展示

**Agent决策**:
- AssistantAgent根据客户等级、情绪、对话复杂度，判定推荐模式
- 输出: `{recommendedMode: "agent_supervised", confidence: 0.85}`

**UI展示**:
- 默认选中推荐模式（Agent监督）
- 显示置信度：85%
- 允许客服手动切换模式

### 3.2 UI操作 → Agent触发

**用户操作**: 客服点击"切换为人工优先"

**Agent行为**:
1. 记录模式切换事件：`ModeChangedEvent`
2. 通知Orchestrator更新路由策略
3. AssistantAgent切换为"轻量分析"模式（仅提供参考信息）

### 3.3 数据流转

\```mermaid
sequenceDiagram
    Customer->>Backend: 发送消息
    Backend->>AssistantAgent: 分析情感和意图
    AssistantAgent-->>Backend: {sentiment, recommendedMode}
    Backend->>Frontend: 推送分析结果
    Frontend->>User: 展示推荐模式
    User->>Frontend: 手动切换模式
    Frontend->>Backend: 更新模式
    Backend->>Orchestrator: 更新路由策略
\```
```

### 4.3 编写检查清单

在提交混合PRD前，请确认：

- [ ] Agent部分包含Agent Profile、工具清单、业务场景
- [ ] 功能部分包含UI设计、接口定义、数据模型
- [ ] Agent输出字段与UI展示字段完全对应
- [ ] 明确了人机协作边界（Agent决策/人工决策）
- [ ] 包含Agent输出→UI展示的映射关系
- [ ] 包含UI操作→Agent触发的事件链路
- [ ] 数据流转用时序图清晰展示
- [ ] 验收标准同时覆盖Agent能力和功能交互

---

## 5. 编写规范与最佳实践

### 5.1 通用规范

#### 规范1：使用Markdown标准语法

- 标题层级：`#` (H1) → `##` (H2) → `###` (H3)，最多到H4
- 表格：使用Markdown表格，对齐列
- 代码块：使用\`\`\`语言标识符\`\`\`
- 流程图：使用Mermaid语法

#### 规范2：字段命名规范

- **API字段**：小驼峰（`camelCase`）
- **数据库字段**：蛇形（`snake_case`）
- **环境变量**：大写下划线（`UPPER_SNAKE_CASE`）
- **类名/接口名**：大驼峰（`PascalCase`）

#### 规范3：日期时间格式

- **日期**：YYYY-MM-DD（如2025-12-29）
- **时间**：HH:mm:ss（如10:30:00）
- **日期时间**：ISO 8601（如2025-12-29T10:30:00Z）

#### 规范4：数值单位

- **金额**：元（¥100,000）
- **时间**：秒/分钟/小时/天（<3秒、5分钟、24小时、7天）
- **百分比**：%（85%）
- **容量**：MB/GB（100MB、1GB）

### 5.2 最佳实践

#### 实践1：先写用户故事，再写功能需求

**不推荐**：
```markdown
## 功能需求
- 展示客户姓名
- 展示合同金额
- 展示健康度评分
```

**推荐**：
```markdown
## 用户故事
**US-01**: 作为一线客服，我希望看到客户的基础档案，以便快速了解客户背景

## 功能需求
基于US-01，需要展示：
- 客户姓名、公司、职位
- 合同金额、状态、到期时间
- 健康度评分、风险等级
```

#### 实践2：使用表格而非段落

**不推荐**：
```markdown
analyzeConversation工具用于分析对话情感，输入参数包括conversationId（必填，字符串类型）和includeHistory（可选，布尔类型），输出包括sentiment、score、priority等字段。
```

**推荐**：
```markdown
### analyzeConversation

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| includeHistory | boolean | 否 | 是否包含历史消息 |

**输出格式**:
| 字段名 | 类型 | 说明 |
|-------|------|------|
| sentiment | string | 情感（positive/neutral/negative） |
| score | number | 分数（0-1） |
| priority | string | 优先级（normal/high/urgent） |
```

#### 实践3：验收标准要可测试

**不推荐**：
```markdown
- 系统响应速度快
- 界面美观易用
- 功能稳定可靠
```

**推荐**：
```markdown
- API响应时间<2秒（P95）
- 前端首屏渲染时间<1秒
- 系统可用性>99%
- 错误率<1%
```

#### 实践4：异常分支要完整

**不推荐**：
```markdown
## 主流程
1. 用户输入查询关键词
2. 系统返回搜索结果
3. 用户查看结果
```

**推荐**：
```markdown
## 主流程
1. 用户输入查询关键词
2. 系统调用搜索API
3. 返回搜索结果
4. 用户查看结果

## 异常分支
- 关键词为空 → 提示"请输入关键词"
- 搜索结果为空 → 显示"暂无相关内容"
- 网络超时 → 显示"网络异常，请重试"
- API错误 → 显示"系统繁忙，请稍后再试"
```

#### 实践5：提示词设计遵循结构化原则

**不推荐**：
```
你是一个AI助手，帮助客服分析客户情感，然后生成回复建议。
```

**推荐**：
```markdown
你是专业的售后客服助手 AssistantAgent。

**核心职责**:
1. 分析客户情感（正面/中性/负面）
2. 识别对话意图（咨询/投诉/需求）
3. 生成回复建议（友好、专业、简洁）

**输出格式**（必须是JSON）:
\```json
{
  "sentiment": "neutral",
  "intent": "inquiry",
  "suggested_reply": "..."
}
\```

**示例**:
输入: "如何开发票？"
输出:
\```json
{
  "sentiment": "neutral",
  "intent": "inquiry",
  "suggested_reply": "您好！开发票流程如下：..."
}
\```

**边界**:
- 只处理售后相关咨询，不回答产品功能问题
- 遇到投诉必须推送人工审核
- VIP客户自动升级优先级
```

---

## 6. 常见问题与解决方案

### Q1: Agent PRD和功能PRD如何协同？

**问题**: 一个功能同时涉及Agent和UI，如何避免文档割裂？

**解决方案**: 使用混合PRD格式
- 第1部分：Agent能力部分（11章结构）
- 第2部分：功能部分（8章结构）
- 第3部分：人机协作设计（数据流转、字段映射）
- 第4部分：验收标准（集成验收）

**参考**：知识库模块PRD

---

### Q2: 提示词变更记录如何维护？

**问题**: 每个版本的Prompt都要记录吗？还是只记录最新版？

**解决方案**:
- **基线PRD（v1.0）**：记录最终版本的完整Prompt
- **增量PRD（v0.5/v0.8）**：只记录相对上一版本的diff

**示例**：
```markdown
## PRD-v0.5-Incremental.md

### AssistantAgent Prompt增强

**变更原因**: 支持企业微信渠道

**Prompt diff**:
\```diff
核心职责:
1. 分析客户情感
+ 2. 识别消息渠道（飞书/企业微信/Web）
+ 3. 根据渠道调整回复格式
\```
```

---

### Q3: 如何确定一个功能是P0还是P1？

**问题**: 优先级划分标准是什么？

**解决方案**: 使用RICE模型

| 因素 | 说明 | 权重 |
|-----|------|------|
| **Reach** | 影响用户数 | 30% |
| **Impact** | 对用户价值 | 40% |
| **Confidence** | 成功把握 | 20% |
| **Effort** | 开发成本 | 10% |

**分数计算**:
```
RICE分数 = (Reach × Impact × Confidence) / Effort
```

**优先级划分**:
- RICE分数>80：P0（核心功能，必须完成）
- RICE分数50-80：P1（重要功能，尽量完成）
- RICE分数<50：P2（次要功能，资源允许时完成）

---

### Q4: 验收场景写多少个合适？

**问题**: 是否要覆盖所有边界情况？

**解决方案**:
- **P0功能**：至少3个场景（正常/异常/边界）
- **P1功能**：至少2个场景（正常/异常）
- **P2功能**：至少1个场景（正常）

**示例**：
```markdown
## 验收场景

### P0功能：情感分析

- AC-01: 常规咨询（正常场景）
- AC-02: 负面情绪识别（异常场景）
- AC-03: 多轮对话情感变化（边界场景）

### P1功能：知识推荐

- AC-04: 高相关度推荐（正常场景）
- AC-05: 无匹配结果（异常场景）
```

---

### Q5: 增量PRD如何避免与基线PRD不一致？

**问题**: 多个版本迭代后，基线PRD可能过时

**解决方案**:
1. **增量PRD不修改基线PRD**，只记录diff
2. **定期同步**（每个大版本发布后）：将增量PRD合并到基线PRD
3. **版本标记**：基线PRD标注"最后同步版本：v0.8"

**维护流程**:
```
v0.1发布 → 编写基线PRD v1.0（假设最终形态）
v0.5发布 → 编写增量PRD v0.5（相对v0.1的diff）
v0.8发布 → 编写增量PRD v0.8（相对v0.5的diff）
v1.0发布 → 更新基线PRD v1.0（标注"已同步到v1.0"）
```

---

### Q6: 如何处理跨模块的功能？

**问题**: 一个功能涉及多个模块（如"知识沉淀"涉及AssistantAgent + 知识库 + 任务系统）

**解决方案**:
1. **主模块PRD**：在知识库模块PRD中详细描述
2. **关联模块PRD**：在AssistantAgent PRD中简要说明，引用知识库模块PRD

**示例**：
```markdown
## AssistantAgent PRD

### 3.2 extractKnowledge工具

**功能描述**: 从对话中提取知识点，沉淀到知识库

**详细规格**: 参见《混合PRD：知识库模块》第3.5节"知识自动沉淀"

**本Agent职责**:
- 分析对话，识别有价值的知识点
- 生成知识条目草稿
- 推送到知识库模块进行人工审核

**其他模块职责**:
- 知识库模块：存储知识条目、管理审核流程
- 任务模块：创建审核任务，分配给知识管理员
```

---

### Q7: 非功能需求的数值如何确定？

**问题**: 响应时间<3秒，这个"3秒"是怎么定的？

**解决方案**: 基于行业标准和竞品对比

| 指标 | 行业标准 | 竞品 | 本系统目标 |
|-----|---------|------|-----------|
| API响应时间 | <5秒 | Zendesk: <2秒 | <2秒（P95） |
| 首屏渲染时间 | <3秒 | Udesk: <1秒 | <1秒 |
| 系统可用性 | >99% | JIRA: 99.9% | >99% |

**参考来源**:
- Google标准：3秒加载完成
- 行业白皮书：《2024 SaaS系统性能基准》
- 竞品公开数据：官网性能承诺

---

### Q8: 如何保持文档的更新？

**问题**: PRD写完后就过时了，如何持续维护？

**解决方案**:
1. **版本控制**：PRD文档纳入Git管理
2. **变更日志**：每次修改记录在文档末尾
3. **定期Review**：每个Sprint结束后Review PRD，更新差异
4. **责任人**：指定文档Owner，负责维护

**变更日志示例**:
```markdown
---

## 变更历史

| 版本 | 日期 | 变更内容 | 变更人 |
|-----|------|---------|--------|
| v1.0 | 2025-12-29 | 初始版本 | Claude |
| v1.1 | 2025-01-15 | 新增企业微信IM集成 | 张三 |
| v1.2 | 2025-02-01 | 修正健康度评分算法 | 李四 |
```

---

## 7. 附录

### 7.1 参考资源

- **Agent PRD格式参考**：`docs/prd/【格式参考】Integrated_Product_Requirements_Document_V2_MVP_Refined.md`
- **功能PRD格式参考**：`docs/prd/【格式参考】Feature_product_requirements_document.md`
- **Agent PRD模板**：`docs/prd/4-templates/Agent_PRD_Template.md`
- **功能PRD模板**：`docs/prd/4-templates/Feature_PRD_Template.md`
- **混合PRD模板**：`docs/prd/4-templates/Hybrid_PRD_Template.md`

### 7.2 联系方式

如有疑问，请联系：
- **产品负责人**：XXX
- **技术负责人**：XXX
- **文档维护**：XXX

---

**文档结束**
