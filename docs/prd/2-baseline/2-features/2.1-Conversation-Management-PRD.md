## 2.1 对话管理功能

> **PRD格式**: Feature PRD (8章标准格式)
> **优先级**: P0 (核心功能)
> **所属版本**: v0.5+ (基础功能) → v0.8+ (智能增强)

---

### 第1章：功能概述

#### 1.1 功能定位

**对话管理**是智能售后工作台的核心功能模块，为客服人员提供统一的对话收发、管理、协作界面。

**核心价值**:
- ✅ 统一多渠道对话（飞书、企微、Web）
- ✅ 实时消息收发与状态同步
- ✅ 对话分组、筛选、搜索
- ✅ 对话协作（转派、协同、@提醒）
- ✅ 历史对话查询与导出

#### 1.2 目标用户

| 用户角色 | 使用场景 | 核心需求 |
|---------|---------|---------|
| **普通客服** | 日常对话接待 | 快速响应、知识引用、一键回复 |
| **资深客服** | 复杂问题处理 | 对话转派、协同诊断、历史查询 |
| **团队经理** | 团队协作管理 | 对话监控、团队协作、质量把控 |
| **质检专员** | 对话质量检查 | 对话查询、质检标记、问题追踪 |

#### 1.3 功能范围

**本期实现** (v0.5):
- ✅ 对话列表展示与状态管理
- ✅ 实时消息收发 (WebSocket)
- ✅ 对话筛选与搜索
- ✅ 对话标签与分组
- ✅ 基础对话操作（转派、关闭、置顶）

**下期规划** (v0.8):
- 🔄 智能对话分配
- 🔄 对话优先级排序
- 🔄 对话协同（多人协作）
- 🔄 快捷回复与话术库

**不包含**:
- ❌ Agent能力（由Agent模块负责）
- ❌ 质检功能（由质检模块负责）
- ❌ 知识管理（由知识库模块负责）

---

### 第2章：用户场景

#### 场景1: 客服接待新对话

**场景描述**: 客服小王早上9点上班，开始处理客户咨询

**用户旅程**:
```
1. 登录系统 → 进入对话列表
2. 看到待处理对话提示 (5个新对话)
3. 点击第一个对话 → 查看客户信息和历史记录
4. 阅读客户问题 → AI推荐知识卡片
5. 编写回复 → 引用知识 → 发送
6. 客户继续提问 → 多轮对话
7. 问题解决 → 标记对话为"已解决"
8. 处理下一个对话
```

**痛点与需求**:
- ❌ 对话太多找不到重点 → ✅ 需要优先级排序
- ❌ 客户信息不全 → ✅ 需要客户画像聚合展示
- ❌ 历史记录难找 → ✅ 需要时间线展示
- ❌ 重复回答相同问题 → ✅ 需要快捷回复

---

#### 场景2: 对话转派给专家

**场景描述**: 客服小李遇到复杂技术问题，需要转派给工程师

**用户旅程**:
```
1. 客服接待客户咨询技术故障
2. 初步诊断后发现超出能力范围
3. 点击【转派】按钮
4. 选择目标客服（工程师张三）
5. 填写转派说明："客户反馈E101错误，已确认驱动正常，疑似硬件问题"
6. 确认转派
7. 系统通知工程师张三
8. 张三接手对话，继续处理
```

**关键需求**:
- ✅ 转派时携带上下文信息
- ✅ 转派后原客服可跟踪进展
- ✅ 转派通知及时推送

---

#### 场景3: 查询历史对话

**场景描述**: 客服需要查询客户历史咨询记录

**用户旅程**:
```
1. 进入客户详情页
2. 查看"历史对话"tab
3. 看到按时间倒序的对话列表
4. 点击某次历史对话 → 查看完整记录
5. 发现上次咨询的问题相似
6. 引用上次的解决方案
7. 回复当前客户
```

**关键需求**:
- ✅ 历史对话快速检索
- ✅ 对话内容全文搜索
- ✅ 相似问题推荐

---

### 第3章：功能详细设计

#### 3.1 对话列表

##### 3.1.1 列表布局

```
┌──────────────────────────────────────────────────────────────────┐
│ 对话列表 (25)         🔍搜索  ▼筛选  ▼排序  [⚙️设置]              │
├──────────────────────────────────────────────────────────────────┤
│ ⭐ [紧急] 张三 (VIP) - 产品故障咨询              📍飞书  2分钟前  │
│    最后消息: "产品报错E101，很着急..."                           │
│    标签: [故障] [VIP] [待处理]                                   │
│                                                                  │
│ ☐ 李四 - 购买咨询                                 📍企微  5分钟前 │
│    最后消息: "请问有什么优惠活动吗?"                             │
│    标签: [咨询] [待处理]                                         │
│                                                                  │
│ ✅ 王五 - 安装指导                                📍Web  30分钟前│
│    最后消息: "好的，谢谢!"                                       │
│    标签: [已解决]                                                │
│                                                                  │
│ ... (显示20个对话)                                               │
│                                                                  │
│ [加载更多]                                                       │
└──────────────────────────────────────────────────────────────────┘
```

##### 3.1.2 对话状态

| 状态 | 图标 | 颜色 | 说明 | 优先级 |
|-----|------|------|------|--------|
| **待处理** | ☐ | 红色 | 新对话，尚未回复 | 最高 |
| **处理中** | ⏳ | 黄色 | 已回复，等待客户响应 | 高 |
| **已解决** | ✅ | 绿色 | 问题已解决，对话结束 | 低 |
| **已关闭** | 🔒 | 灰色 | 对话已关闭（无需处理） | 最低 |
| **已转派** | 🔄 | 蓝色 | 已转派给其他客服 | 中 |

##### 3.1.3 筛选条件

```yaml
筛选维度:
  状态筛选:
    - 待处理
    - 处理中
    - 已解决
    - 已关闭
    - 已转派

  渠道筛选:
    - 飞书
    - 企微
    - Web
    - 全部

  客户等级:
    - VIP
    - 普通
    - 全部

  负责人:
    - 我的对话
    - 团队对话
    - 全部对话

  时间范围:
    - 今天
    - 最近3天
    - 最近7天
    - 自定义时间

  标签筛选:
    - 故障
    - 咨询
    - 投诉
    - 退款
    - 其他
```

##### 3.1.4 排序规则

```yaml
排序选项:
  - 按优先级 (默认):
      规则: 紧急 > 待处理 > VIP > 处理中 > 已解决
      说明: 智能排序，优先显示重要对话

  - 按时间 (最新):
      规则: 最后消息时间倒序
      说明: 最新对话在最上面

  - 按时间 (最旧):
      规则: 最后消息时间正序
      说明: 最旧未处理对话在最上面

  - 按客户等级:
      规则: VIP > 普通
      说明: VIP客户优先
```

---

#### 3.2 对话详情

##### 3.2.1 界面布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ← 返回列表    客户: 张三 (VIP)    对话ID: conv-12345    📍飞书          │
├────────────────────────────────┬────────────────────────────────────────┤
│                                │ 👤 客户信息                             │
│ 💬 对话内容                     │ ┌────────────────────────────────────┐ │
│ ┌──────────────────────────┐   │ │ 姓名: 张三                          │ │
│ │ [客户] 10:00              │   │ │ 等级: VIP ⭐                       │ │
│ │ 你好，产品报错E101        │   │ │ 标签: [老客户] [硬件产品]          │ │
│ │                          │   │ │ 手机: 138****5678                  │ │
│ │ [AI推荐] 10:00            │   │ │ 邮箱: zhang***@example.com         │ │
│ │ 💡 相关知识:              │   │ │ 注册时间: 2024-01-15               │ │
│ │ • E101错误排查指南        │   │ │ 最近对话: 3天前                    │ │
│ │ [查看详情]                │   │ │ [查看详情]                          │ │
│ │                          │   │ └────────────────────────────────────┘ │
│ │ [客服] 10:01              │   │                                        │
│ │ 您好，E101错误通常是...   │   │ 📚 推荐知识                            │
│ │                          │   │ ┌────────────────────────────────────┐ │
│ │ [客户] 10:02              │   │ │ 1. E101错误排查指南                │ │
│ │ 按照步骤操作了还是不行    │   │ │    相关度: 95%                     │ │
│ │                          │   │ │    [查看] [引用]                    │ │
│ └──────────────────────────┘   │ │                                    │ │
│                                │ │ 2. 驱动安装步骤                     │ │
│ ✍️ 回复框:                      │ │    相关度: 88%                     │ │
│ ┌──────────────────────────┐   │ │    [查看] [引用]                    │ │
│ │ 输入回复...              │   │ └────────────────────────────────────┘ │
│ │                          │   │                                        │
│ │ [💡AI建议] [📚引用知识]    │   │ 🏷️ 对话标签                           │
│ └──────────────────────────┘   │ ┌────────────────────────────────────┐ │
│ [发送] [@提醒] [📎附件]         │ │ [故障] [E101] [VIP]                │ │
│                                │ │ [+添加标签]                         │ │
│ [转派] [标记已解决] [关闭]     │ └────────────────────────────────────┘ │
└────────────────────────────────┴────────────────────────────────────────┘
```

##### 3.2.2 消息类型

| 消息类型 | 发送方 | 展示样式 | 说明 |
|---------|--------|---------|------|
| **文本消息** | 客户/客服 | 左对齐(客户)/右对齐(客服) | 基础文本 |
| **图片消息** | 客户/客服 | 缩略图 | 支持点击放大 |
| **文件消息** | 客户/客服 | 文件卡片 | 显示文件名、大小 |
| **AI推荐卡片** | 系统 | 浅蓝色背景 | 知识推荐、回复建议 |
| **系统消息** | 系统 | 灰色居中 | 对话转派、状态变更 |

##### 3.2.3 快捷操作

```yaml
消息快捷操作:
  - 复制: 一键复制消息内容
  - 引用回复: 引用客户消息回复
  - 转发: 转发消息到其他对话
  - 删除: 撤回/删除消息 (仅客服消息)

对话快捷操作:
  - 置顶: 置顶对话到列表顶部
  - 标记已读: 批量标记已读
  - 添加标签: 快速添加标签
  - 导出: 导出对话记录
```

---

#### 3.3 对话操作

##### 3.3.1 转派对话

**功能描述**: 将对话转派给其他客服或团队

**操作流程**:
```
1. 点击【转派】按钮
2. 弹出转派对话框
3. 选择目标客服 (支持搜索)
4. 填写转派说明 (必填)
5. 确认转派
6. 系统通知目标客服
7. 原客服对话列表显示"已转派"状态
```

**UI设计**:
```
┌──────────────────────────────────────┐
│ 转派对话                              │
├──────────────────────────────────────┤
│ 转派给: [搜索客服/团队____________] ▼ │
│                                      │
│ 推荐:                                │
│ ○ 张三 (工程师) - 擅长故障诊断        │
│ ○ 李四 (资深客服) - 当前空闲          │
│ ○ 技术支持团队                        │
│                                      │
│ 转派说明: (必填)                      │
│ ┌──────────────────────────────────┐ │
│ │ 客户反馈E101错误，已确认驱动正常， │ │
│ │ 疑似硬件问题，需要工程师诊断。     │ │
│ └──────────────────────────────────┘ │
│                                      │
│ ☑ 转派后继续跟踪进展                  │
│                                      │
│ [确认转派] [取消]                     │
└──────────────────────────────────────┘
```

##### 3.3.2 标记对话状态

**状态流转**:
```
待处理 → 处理中 → 已解决
   ↓        ↓        ↓
  已转派   已关闭   已关闭
```

**操作方式**:
- **标记已解决**: 点击按钮 → 确认 → 状态变为"已解决"
- **关闭对话**: 点击按钮 → 填写关闭原因 → 确认
- **重新打开**: 已解决/已关闭对话可重新打开

##### 3.3.3 添加标签

**预设标签**:
```yaml
问题类型:
  - 故障
  - 咨询
  - 投诉
  - 退款
  - 安装指导

客户类型:
  - VIP
  - 老客户
  - 新客户

紧急程度:
  - 紧急
  - 重要
  - 普通
```

**自定义标签**:
- 支持团队管理员添加自定义标签
- 标签颜色可配置
- 标签支持搜索和筛选

---

#### 3.4 对话搜索

##### 3.4.1 搜索范围

```yaml
搜索维度:
  - 对话ID
  - 客户姓名
  - 客户手机号
  - 消息内容 (全文搜索)
  - 标签

搜索语法:
  - 关键词搜索: "退款"
  - 短语搜索: "产品报错E101"
  - 客户搜索: @张三
  - 标签搜索: #故障
  - 组合搜索: "退款 @张三 #VIP"
```

##### 3.4.2 搜索结果

```
┌──────────────────────────────────────────────────────────────┐
│ 搜索: "E101错误"                 共找到 15 个对话              │
├──────────────────────────────────────────────────────────────┤
│ conv-12345 | 张三 (VIP) | 2025-12-30 10:00                   │
│ 💬 "产品报错E101，按照说明操作了还是不行..."                  │
│ 标签: [故障] [VIP]  状态: 处理中  客服: 李四                  │
│ [查看详情]                                                    │
│                                                              │
│ conv-12340 | 王五 | 2025-12-29 15:30                         │
│ 💬 "E101错误怎么解决?已经试过重启了"                          │
│ 标签: [故障]  状态: 已解决  客服: 张三                        │
│ [查看详情]                                                    │
│                                                              │
│ ... (显示10个结果)                                            │
│                                                              │
│ [加载更多]                                                    │
└──────────────────────────────────────────────────────────────┘
```

---

### 第4章：交互设计

#### 4.1 实时消息推送

**技术方案**: WebSocket

**推送事件**:
```typescript
interface MessageEvent {
  type: "new_message" | "message_read" | "typing" | "status_change";
  conversationId: string;
  data: any;
}
```

**推送场景**:
- 新消息到达 → 对话列表更新 + 桌面通知
- 客户正在输入 → 显示"对方正在输入..."
- 对话状态变更 → 列表状态刷新
- 消息已读 → 显示已读标记

#### 4.2 桌面通知

**通知触发**:
- 新对话到达
- 被@提醒
- 紧急对话
- 对话转派给我

**通知内容**:
```
┌─────────────────────────────────┐
│ 智能售后工作台                   │
├─────────────────────────────────┤
│ 新对话: 张三 (VIP)              │
│ "产品报错E101，很着急..."        │
│                                 │
│ [查看对话] [稍后处理]            │
└─────────────────────────────────┘
```

#### 4.3 快捷键支持

| 快捷键 | 功能 | 说明 |
|-------|------|------|
| **Ctrl+Enter** | 发送消息 | 快速发送 |
| **Ctrl+K** | 打开知识搜索 | 快速引用知识 |
| **Ctrl+/** | 快捷回复 | 打开快捷回复列表 |
| **Ctrl+T** | 转派对话 | 快速转派 |
| **Ctrl+F** | 搜索对话 | 全局搜索 |
| **Esc** | 关闭弹窗 | 快速关闭 |

---

### 第5章：数据模型

#### 5.1 核心实体

```typescript
// 对话实体
interface Conversation {
  id: string;                    // 对话ID (UUID)
  customerId: string;            // 客户ID
  csrId: string;                 // 客服ID
  channel: "feishu" | "wechat" | "web"; // 渠道
  status: ConversationStatus;    // 状态
  priority: "urgent" | "high" | "normal" | "low"; // 优先级
  tags: string[];                // 标签
  satisfactionScore?: number;    // 满意度评分
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  lastMessageAt: Date;           // 最后消息时间
  resolvedAt?: Date;             // 解决时间
  closedAt?: Date;               // 关闭时间
}

// 对话状态
enum ConversationStatus {
  PENDING = "pending",           // 待处理
  IN_PROGRESS = "in_progress",   // 处理中
  RESOLVED = "resolved",         // 已解决
  CLOSED = "closed",             // 已关闭
  TRANSFERRED = "transferred"    // 已转派
}

// 消息实体
interface Message {
  id: string;                    // 消息ID
  conversationId: string;        // 对话ID
  sender: Sender;                // 发送方
  content: MessageContent;       // 消息内容
  sentAt: Date;                  // 发送时间
  readAt?: Date;                 // 读取时间
  metadata?: Record<string, any>; // 元数据
}

// 发送方
interface Sender {
  type: "customer" | "csr" | "agent" | "system";
  id: string;
  name: string;
}

// 消息内容
type MessageContent =
  | { type: "text"; text: string }
  | { type: "image"; url: string; thumbnail: string }
  | { type: "file"; url: string; filename: string; size: number }
  | { type: "card"; card: KnowledgeCard | ReplyCard };
```

#### 5.2 数据库表设计

```sql
-- 对话表
CREATE TABLE conversations (
  id UUID PRIMARY KEY,
  customer_id UUID NOT NULL REFERENCES customers(id),
  csr_id UUID REFERENCES users(id),
  channel VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  priority VARCHAR(20) DEFAULT 'normal',
  tags TEXT[],
  satisfaction_score DECIMAL(2,1),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  last_message_at TIMESTAMP,
  resolved_at TIMESTAMP,
  closed_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_conversations_csr ON conversations(csr_id);
CREATE INDEX idx_conversations_customer ON conversations(customer_id);
CREATE INDEX idx_conversations_status ON conversations(status);
CREATE INDEX idx_conversations_last_message ON conversations(last_message_at DESC);
CREATE INDEX idx_conversations_tags ON conversations USING GIN(tags);

-- 消息表
CREATE TABLE conversation_messages (
  id UUID PRIMARY KEY,
  conversation_id UUID NOT NULL REFERENCES conversations(id),
  sender_type VARCHAR(20) NOT NULL,
  sender_id UUID,
  content JSONB NOT NULL,
  sent_at TIMESTAMP NOT NULL DEFAULT NOW(),
  read_at TIMESTAMP,
  metadata JSONB
);

-- 索引
CREATE INDEX idx_messages_conversation ON conversation_messages(conversation_id, sent_at DESC);
CREATE INDEX idx_messages_sender ON conversation_messages(sender_type, sender_id);

-- 全文搜索索引
CREATE INDEX idx_messages_content_search ON conversation_messages
  USING GIN(to_tsvector('chinese', content->>'text'));
```

---

### 第6章：业务规则

#### 6.1 对话分配规则

```yaml
自动分配策略:
  - VIP客户: 分配给资深客服
  - 老客户: 优先分配给上次服务的客服
  - 新客户: 轮询分配
  - 紧急对话: 分配给空闲客服

人工分配:
  - 支持手动选择客服
  - 支持转派到团队
  - 支持批量分配
```

#### 6.2 对话超时规则

```yaml
超时检测:
  - 待处理超时: 对话创建后5分钟未回复 → 告警
  - 处理中超时: 客户消息后2分钟未回复 → 告警
  - 长时间未解决: 对话进行中超过30分钟未解决 → 建议转派

超时处理:
  - 发送通知给客服
  - 标记对话为"超时"
  - 自动提升优先级
```

#### 6.3 对话关闭规则

```yaml
自动关闭:
  - 已解决对话24小时内无新消息 → 自动关闭
  - 客户明确表示"不需要了" → 自动关闭

关闭前确认:
  - 系统发送确认消息: "您的问题已解决，如无其他问题，对话将在1小时后关闭"
  - 客户未回复 → 自动关闭
  - 客户回复 → 重新打开对话
```

---

### 第7章：非功能需求

#### 7.1 性能要求

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **对话列表加载** | <1秒 (100条) | 前端埋点 |
| **消息发送延迟** | <300ms | WebSocket监控 |
| **消息到达延迟** | <200ms | 端到端监控 |
| **搜索响应时间** | <1秒 | API监控 |
| **并发对话数** | 500 | 压测 |

#### 7.2 数据保留

```yaml
数据保留策略:
  - 对话记录: 保留180天
  - 消息内容: 保留180天
  - 附件文件: 保留90天 (OSS存储)
  - 系统日志: 保留30天

归档策略:
  - 超过180天的对话自动归档
  - 归档数据可按需恢复
  - 归档数据不占用在线存储
```

#### 7.3 安全要求

```yaml
权限控制:
  - 客服只能查看自己的对话
  - 团队经理可查看团队对话
  - 管理员可查看所有对话

数据脱敏:
  - 客户手机号脱敏显示
  - 客户身份证号脱敏显示
  - 敏感信息加密存储

审计日志:
  - 记录对话导出操作
  - 记录对话删除操作
  - 记录对话转派操作
```

---

### 第8章：验收标准

#### 8.1 功能验收

**对话列表**:
- [ ] 对话列表正常展示，支持分页
- [ ] 筛选功能正常，支持多维度筛选
- [ ] 排序功能正常，支持多种排序方式
- [ ] 搜索功能正常，支持全文搜索

**对话详情**:
- [ ] 消息实时收发，延迟<300ms
- [ ] 客户信息正常展示
- [ ] 知识推荐准确相关
- [ ] 快捷操作正常工作

**对话操作**:
- [ ] 转派功能正常，通知及时
- [ ] 状态变更正常，流转合理
- [ ] 标签添加正常，支持自定义
- [ ] 对话导出正常，格式正确

**消息类型**:
- [ ] 文本消息正常收发
- [ ] 图片消息正常上传和展示
- [ ] 文件消息正常上传和下载
- [ ] AI卡片正常展示

#### 8.2 性能验收

- [ ] 对话列表加载<1秒 (100条对话)
- [ ] 消息发送延迟<300ms (P95)
- [ ] 搜索响应<1秒 (P95)
- [ ] 支持500并发对话

#### 8.3 用户体验验收

- [ ] 操作流程顺畅，无卡顿
- [ ] 界面布局合理，信息清晰
- [ ] 快捷键正常工作
- [ ] 桌面通知及时推送

#### 8.4 业务验收

- [ ] 对话分配准确率>90%
- [ ] 超时检测准确率100%
- [ ] 对话关闭逻辑正确
- [ ] 数据归档正常

---

**文档结束**

**相关文档**:
- 对话模式与人工介入: `../4-hybrid-modules/Conversation-Mode-PRD.md`
- 客户管理功能: `./2.2-Customer-Management-PRD.md`
- 产品概述: `../1-overview/Product-Overview.md`
