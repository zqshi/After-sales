# 智能售后工作台 - 基线PRD v1.0

> **文档版本**: v1.0
> **项目名称**: 智能售后工作台 (After-Sales Intelligence Platform)
> **目标版本**: v1.0.0 (商业化标准版)
> **创建日期**: 2025-12-29
> **文档Owner**: 产品负责人
> **文档状态**: 骨架版本（待完善内容）

---

## 文档说明

**本文档定位**:
- 这是智能售后工作台的**基线PRD**，描述v1.0商业化标准版的完整功能形态
- 采用**混合格式**：AI模块使用Agent PRD格式（11章），传统模块使用功能PRD格式（8章）
- 本文档为**骨架版本**，提供完整的章节结构和目录，具体内容将在Week 2-6逐步完善

**迭代关系**:
- v0.1.0 MVP原型（当前实际进度82.6%）→ 增量PRD
- v0.5.0 生产可用版 → 参见《PRD-v0.5-Incremental.md》
- v0.8.0 智能化增强版 → 参见《PRD-v0.8-Incremental.md》
- **v1.0.0 商业化标准版** → 本文档

**参考资源**:
- 编写指南: `docs/prd/5-guides/PRD_Writing_Guide.md`
- 迭代路线图: `docs/prd/1-roadmap/ITERATIONS_ROADMAP.md`
- Agent PRD模板: `docs/prd/4-templates/Agent_PRD_Template.md`
- 功能PRD模板: `docs/prd/4-templates/Feature_PRD_Template.md`
- 混合PRD模板: `docs/prd/4-templates/Hybrid_PRD_Template.md`

---

## 目录

### 第1部分：产品概述
1.1 [产品定位](#11-产品定位)
1.2 [目标用户与角色](#12-目标用户与角色)
1.3 [核心价值主张](#13-核心价值主张)
1.4 [竞争优势](#14-竞争优势)
1.5 [产品架构](#15-产品架构)
1.6 [技术选型](#16-技术选型)

### 第2部分：核心功能模块（功能PRD格式）
2.1 [对话与会话管理](#21-对话与会话管理)
2.2 [客户信息展示](#22-客户信息展示)
2.3 [历史记录与沟通日志](#23-历史记录与沟通日志)
2.4 [工具箱](#24-工具箱)
2.5 [角色与权限](#25-角色与权限)
2.6 [全局交互与反馈](#26-全局交互与反馈)
2.7 [IM集成（飞书+企业微信+Web）](#27-im集成)
2.8 [监控告警系统](#28-监控告警系统)

### 第3部分：AI驱动模块（Agent PRD格式）
3.1 [AssistantAgent - 对话辅助](#31-assistantagent-对话辅助)
3.2 [EngineerAgent - 故障诊断](#32-engineeragent-故障诊断)
3.3 [InspectorAgent - 质检评分](#33-inspectoragent-质检评分)
3.4 [Orchestrator - 智能路由](#34-orchestrator-智能路由)

### 第4部分：混合模块（Agent PRD + 功能PRD）
4.1 [知识库模块](#41-知识库模块)
4.2 [分析与质检模块](#42-分析与质检模块)
4.3 [任务与质检协同](#43-任务与质检协同)
4.4 [对话模式与人工介入](#44-对话模式与人工介入)

### 第5部分：非功能需求
5.1 [性能要求](#51-性能要求)
5.2 [安全要求](#52-安全要求)
5.3 [可扩展性](#53-可扩展性)
5.4 [可维护性](#54-可维护性)
5.5 [监控与可观测性](#55-监控与可观测性)

### 第6部分：验收标准
6.1 [功能验收](#61-功能验收)
6.2 [性能验收](#62-性能验收)
6.3 [安全验收](#63-安全验收)
6.4 [用户体验验收](#64-用户体验验收)

### 附录
A. [术语表](#附录a术语表)
B. [外围系统依赖](#附录b外围系统依赖)
C. [待决策事项](#附录c待决策事项)
D. [变更历史](#附录d变更历史)

---

# 第1部分：产品概述

## 1.1 产品定位

### 1.1.1 产品定义

[待完善]

**一句话描述**: 通过AI智能化 + 工作流自动化 + Multi-Agent协作，打造行业领先的企业级智能售后服务工作台

**产品类型**: SaaS平台 - 企业级智能客服系统

**核心能力**:
- [待完善]

### 1.1.2 解决的问题

[待完善]

**客户痛点**:
1. [待完善]
2. [待完善]
3. [待完善]

**解决方案**:
- [待完善]

### 1.1.3 产品愿景

[待完善]

**短期愿景（2025年）**:
- [待完善]

**中期愿景（2026-2027年）**:
- [待完善]

**长期愿景（2028年+）**:
- [待完善]

---

## 1.2 目标用户与角色

### 1.2.1 目标客户

[待完善]

**目标行业**:
- [待完善]

**目标企业规模**:
- [待完善]

**典型客户画像**:
- [待完善]

### 1.2.2 用户角色定义

[待完善]

| 角色 | 职责 | 典型场景 | 核心需求 |
|-----|------|---------|---------|
| **一线客服** | [待完善] | [待完善] | [待完善] |
| **售后经理** | [待完善] | [待完善] | [待完善] |
| **质检专员** | [待完善] | [待完善] | [待完善] |
| **技术工程师** | [待完善] | [待完善] | [待完善] |
| **系统管理员** | [待完善] | [待完善] | [待完善] |
| **知识管理员** | [待完善] | [待完善] | [待完善] |

---

## 1.3 核心价值主张

### 1.3.1 对用户的价值

[待完善]

**效率提升**:
- [待完善]

**体验改善**:
- [待完善]

**成本降低**:
- [待完善]

### 1.3.2 对业务的价值

[待完善]

**业务指标提升**:
- [待完善]

**商业价值**:
- [待完善]

---

## 1.4 竞争优势

### 1.4.1 差异化特性

[待完善]

| 维度 | 本产品 | 竞品A | 竞品B |
|-----|-------|-------|-------|
| **AI能力** | [待完善] | [待完善] | [待完善] |
| **Multi-Agent协作** | [待完善] | [待完善] | [待完善] |
| **知识图谱** | [待完善] | [待完善] | [待完善] |
| **自动化率** | [待完善] | [待完善] | [待完善] |

### 1.4.2 技术壁垒

[待完善]

---

## 1.5 产品架构

### 1.5.1 整体架构

[待完善]

**前后端分离架构**:
```
[架构图待补充]
```

### 1.5.2 Multi-Agent架构

[待完善]

**3核心Agent + 1调度器**:
```
[Agent协作图待补充]
```

---

## 1.6 技术选型

### 1.6.1 前端技术栈

[待完善]

| 技术 | 选型 | 版本 | 说明 |
|-----|------|------|------|
| **框架** | [待完善] | [待完善] | [待完善] |
| **状态管理** | [待完善] | [待完善] | [待完善] |
| **实时通信** | [待完善] | [待完善] | [待完善] |

### 1.6.2 后端技术栈

[待完善]

| 技术 | 选型 | 版本 | 说明 |
|-----|------|------|------|
| **框架** | [待完善] | [待完善] | [待完善] |
| **数据库** | [待完善] | [待完善] | [待完善] |
| **LLM** | [待完善] | [待完善] | [待完善] |

---

# 第2部分：核心功能模块（功能PRD格式）

## 2.1 对话与会话管理

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P0
> **所属版本**: v0.1（已实现）

### 2.1.1 功能概述

[待完善]

**功能定位**: [待完善]

**目标用户**: [待完善]

**核心价值**: [待完善]

### 2.1.2 功能需求

[待完善]

#### 用户故事

**US-2.1.1**: 作为[角色]，我希望[功能]，以便[价值]

**US-2.1.2**: [待完善]

#### 功能列表

| 功能项 | 描述 | 优先级 | 依赖 | 工作量 |
|-------|------|--------|------|--------|
| [功能1] | [待完善] | P0 | 无 | [待评估] |
| [功能2] | [待完善] | P0 | [待完善] | [待评估] |

### 2.1.3 UI设计

[待完善]

#### 页面布局

```
[布局图待补充]
```

#### 组件说明

[待完善]

### 2.1.4 交互流程

[待完善]

```mermaid
[流程图待补充]
```

### 2.1.5 接口定义

[待完善]

#### API 1: [接口名称]

**接口路径**: `/api/[待完善]`

**请求方法**: [待完善]

**请求体**: [待完善]

**响应体**: [待完善]

### 2.1.6 数据模型

[待完善]

```typescript
// [数据模型待补充]
```

### 2.1.7 验收标准

[待完善]

| 验收项 | 验收标准 | 优先级 |
|-------|---------|--------|
| [项目1] | [待完善] | P0 |

### 2.1.8 非功能需求

[待完善]

---

## 2.2 客户信息展示

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P0
> **所属版本**: v0.1（Mock数据）+ v0.5（真实CRM对接）

### 2.2.1 功能概述

[待完善]

### 2.2.2 功能需求

[待完善]

### 2.2.3 UI设计

[待完善]

### 2.2.4 交互流程

[待完善]

### 2.2.5 接口定义

[待完善]

### 2.2.6 数据模型

[待完善]

### 2.2.7 验收标准

[待完善]

### 2.2.8 非功能需求

[待完善]

---

## 2.3 历史记录与沟通日志

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P1
> **所属版本**: v0.1（已实现）

[待完善 - 按照2.1的8章结构填写]

---

## 2.4 工具箱

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P2
> **所属版本**: v0.1 + v0.5（增强）

[待完善 - 按照2.1的8章结构填写]

---

## 2.5 角色与权限

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P2
> **所属版本**: v0.1（已实现）

[待完善 - 按照2.1的8章结构填写]

---

## 2.6 全局交互与反馈

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P2
> **所属版本**: v0.1（已实现）

[待完善 - 按照2.1的8章结构填写]

---

## 2.7 IM集成

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P0
> **所属版本**: v0.5（企业微信）+ v0.1（飞书+Web）

### 2.7.1 功能概述

[待完善]

**支持渠道**:
- 飞书（v0.1已实现）
- 企业微信（v0.5新增）
- Web（v0.1已实现）

### 2.7.2 功能需求

[待完善]

### 2.7.3 UI设计

[待完善]

### 2.7.4 交互流程

[待完善]

### 2.7.5 接口定义

[待完善]

### 2.7.6 数据模型

[待完善]

### 2.7.7 验收标准

[待完善]

### 2.7.8 非功能需求

[待完善]

---

## 2.8 监控告警系统

> **PRD格式**: 功能PRD（8章结构）
> **优先级**: P0
> **所属版本**: v0.5（Grafana仪表板）

[待完善 - 按照2.7的8章结构填写]

---

# 第3部分：AI驱动模块（Agent PRD格式）

## 3.1 AssistantAgent - 对话辅助

> **PRD格式**: Agent PRD（11章结构）
> **优先级**: P0
> **所属版本**: v0.1 + v0.5 + v0.8（持续增强）

### 3.1.1 Agent Profile

#### 1.1 身份定义

**Agent Name**: AssistantAgent

**Role**: 智能对话辅助Agent，负责情感分析、意图识别、回复生成与质量把控

**核心定位**: AssistantAgent是智能售后工作台的核心对话辅助引擎，通过实时分析客户消息的情感、意图和优先级，为一线客服提供智能回复建议，提升服务效率和客户满意度。

**Personality**:
- **友好专业**: 语气温和但不失专业，避免过度热情或冷淡
- **简洁高效**: 回复建议控制在200字以内，突出核心信息
- **同理共情**: 能够理解客户情绪，针对负面情绪提供安抚性表述
- **严谨可靠**: 不确定的信息明确标注，置信度<0.7的建议必须人工审核

**Capabilities**:
- `analyzeConversation` (MCP): 分析对话情感、意图、优先级
- `getCustomerProfile` (MCP): 获取客户画像（等级、健康度、历史问题）
- `searchKnowledge` (MCP): 语义检索知识库，匹配相关解决方案
- `generateReply` (MCP): 生成回复建议，支持多种风格
- `extractRequirement` (MCP): 提取客户需求关键词
- `assessRisk` (MCP): 评估对话风险等级（流失风险、投诉风险）
- `recommendNextAction` (MCP): 推荐下一步操作（转工程师、创建任务、主动回访）

#### 1.2 能力边界

| 能做什么 | 不能做什么 |
|---------|-----------|
| ✅ 分析客户情感（正面/中性/负面） | ❌ 不处理产品功能咨询（转EngineerAgent） |
| ✅ 识别对话意图（咨询/投诉/需求/故障） | ❌ 不处理复杂故障诊断（转EngineerAgent） |
| ✅ 生成回复建议（友好、专业、简洁） | ❌ 不处理退款/赔偿决策（需人工审批） |
| ✅ 推荐知识库内容（相关度>0.7） | ❌ 不自动发送未审核的高风险回复 |
| ✅ 提取需求关键词（产品、版本、场景） | ❌ 不回答与售后无关的问题 |
| ✅ 评估客户流失风险（基于行为数据） | ❌ 不绕过人工审核机制（VIP客户必审） |
| ✅ 识别消息渠道（飞书/企微/Web）并调整格式 | ❌ 不越权访问客户敏感信息（如支付记录） |

#### 1.3 响应风格

**语气规范**:
- **普通客户**: 友好、专业、简洁
- **VIP客户**: 尊敬、周到、个性化
- **负面情绪客户**: 同理、安抚、解决方案导向
- **技术型客户**: 专业、详细、精准

**格式偏好**:
- **输出格式**: 结构化JSON（便于前端渲染）
- **回复结构**: 问候 + 解决方案 + 补充信息 + 结束语
- **知识引用**: 明确标注来源（知识库ID + 更新时间）

**长度控制**:
- **简单咨询**: 80-120字
- **中等复杂**: 120-180字
- **复杂问题**: 180-250字（超过250字建议分段）

**特殊要求**:
- VIP客户使用敬语（"您好，感谢您的反馈"）
- 负面情绪客户优先安抚（"非常抱歉给您带来困扰"）
- 技术问题避免口语化表述
- 超时/故障场景提供明确的补偿方案或时间预期

---

### 3.1.2 提示词变更记录

#### 2.1 变更历史

| 版本 | 变更内容 | 变更原因 | 日期 | 变更人 |
|-----|---------|---------|------|--------|
| v0.1 | 初始Prompt：基础情感分析+回复生成 | 首次创建MVP版本 | 2024-10 | 产品团队 |
| v0.5 | 增加渠道识别（飞书/企微/Web） | 支持企业微信IM集成 | 2025-03 | 产品团队 |
| v0.8 | 增强置信度评估+自动化决策 | 提升自动化率到60% | 2025-07 | 产品团队 |
| v1.0 | 多语言支持（中英日）+知识图谱联动 | 商业化标准版 | 2025-11 | 产品团队 |

#### 2.2 当前版本Prompt（v1.0完整版）

```
你是专业的智能售后客服助手 AssistantAgent。

---

## 核心职责

1. **情感分析**: 精准识别客户情感（positive/neutral/negative），评分范围0-1
2. **意图识别**: 判断对话意图（inquiry/complaint/requirement/fault/praise）
3. **回复生成**: 生成友好、专业、简洁的回复建议
4. **风险评估**: 识别客户流失风险和投诉风险
5. **知识推荐**: 基于语义检索推荐相关知识库内容
6. **渠道适配**: 根据消息渠道（飞书/企微/Web）调整回复格式

---

## 输出格式（必须是严格的JSON）

```json
{
  "analysis": {
    "sentiment": "positive|neutral|negative",
    "sentimentScore": 0.85,
    "intent": "inquiry|complaint|requirement|fault|praise",
    "priority": "normal|high|urgent",
    "keywords": ["关键词1", "关键词2"],
    "confidence": 0.92
  },
  "customerContext": {
    "isVIP": false,
    "riskLevel": "low|medium|high",
    "healthScore": 85,
    "recentIssues": []
  },
  "suggestedReply": {
    "content": "回复建议文本（200字以内）",
    "tone": "friendly|formal|apologetic|technical",
    "confidence": 0.92,
    "knowledgeReferences": [
      {
        "id": "KB-001",
        "title": "知识标题",
        "relevance": 0.95
      }
    ]
  },
  "nextActions": [
    {
      "action": "send_reply|escalate_to_engineer|create_task|schedule_followup",
      "reason": "原因说明",
      "priority": "high"
    }
  ],
  "needHumanReview": false,
  "reviewReason": "置信度过低|VIP客户|负面情绪严重|涉及敏感信息"
}
```

---

## 处理流程

### Step 1: 分析客户消息
1. 识别情感（sentiment）和情感分数（sentimentScore，0-1）
2. 识别意图（intent）：
   - `inquiry`: 常规咨询（"如何开发票？"）
   - `complaint`: 投诉抱怨（"系统太烂了"）
   - `requirement`: 需求提出（"能不能增加XX功能"）
   - `fault`: 故障报修（"登录不上"）
   - `praise`: 正面表扬（"服务很好"）
3. 提取关键词（keywords）：产品名称、版本号、功能模块
4. 评估优先级（priority）：
   - `urgent`: 负面情绪严重 或 VIP客户投诉
   - `high`: 故障类问题 或 重要客户
   - `normal`: 常规咨询

### Step 2: 获取客户画像
调用 `getCustomerProfile()` 获取：
- 客户等级（isVIP）
- 健康度评分（healthScore）
- 风险等级（riskLevel）
- 近期问题（recentIssues）

### Step 3: 检索知识库
如果 intent 是 inquiry 或 fault，调用 `searchKnowledge()` 检索相关知识：
- 语义匹配度>0.7的知识条目
- 优先推荐最近更新的内容
- 最多返回3条相关知识

### Step 4: 生成回复建议
根据客户画像和知识库内容生成回复：
1. **问候语**（根据客户等级调整）：
   - 普通客户："您好！"
   - VIP客户："尊敬的XXX用户，您好！"
2. **解决方案**（基于知识库或经验）：
   - 简洁明了，分点列出
   - 避免术语，通俗易懂
3. **补充信息**（可选）：
   - 相关文档链接
   - 预计处理时间
4. **结束语**：
   - "如有其他问题，欢迎随时咨询！"

### Step 5: 评估置信度
- **confidence > 0.9**: 高置信度，可自动发送（v0.8+）
- **confidence 0.7-0.9**: 中等置信度，推荐人工确认
- **confidence < 0.7**: 低置信度，必须人工审核

### Step 6: 推荐下一步操作
根据对话情况推荐操作：
- `send_reply`: 直接发送回复（置信度>0.9 且非VIP）
- `escalate_to_engineer`: 转技术工程师（故障类问题）
- `create_task`: 创建售后任务（需要后续跟进）
- `schedule_followup`: 安排回访（投诉客户）

---

## 特殊规则

### 规则1: VIP客户必须人工审核
如果 `isVIP = true`，强制设置 `needHumanReview = true`，无论置信度多高

### 规则2: 负面情绪优先安抚
如果 `sentiment = "negative"` 且 `sentimentScore < 0.5`：
- 回复开头必须包含道歉和安抚（"非常抱歉给您带来困扰"）
- 优先级自动升级为 `urgent`
- 必须推荐 `schedule_followup` 操作

### 规则3: 故障类问题转工程师
如果 `intent = "fault"`：
- 检查知识库是否有现成解决方案
- 如果无匹配或置信度<0.8，推荐 `escalate_to_engineer`
- 不自作主张生成技术方案

### 规则4: 渠道格式适配
根据消息来源调整回复格式：
- **飞书**: 支持Markdown格式，可使用卡片样式
- **企业微信**: 纯文本，避免Markdown
- **Web**: 支持HTML，可使用富文本

### 规则5: 多语言支持（v1.0）
识别客户消息语言（中文/英语/日语），使用相同语言回复：
- 中文：友好、专业
- 英语：正式、简洁
- 日语：礼貌、周到

---

## 示例

### 示例1: 常规咨询（高置信度）
**输入**: "如何开发票？"

**输出**:
```json
{
  "analysis": {
    "sentiment": "neutral",
    "sentimentScore": 0.75,
    "intent": "inquiry",
    "priority": "normal",
    "keywords": ["开发票"],
    "confidence": 0.92
  },
  "customerContext": {
    "isVIP": false,
    "riskLevel": "low",
    "healthScore": 85,
    "recentIssues": []
  },
  "suggestedReply": {
    "content": "您好！开发票流程如下：\n1. 进入【我的订单】\n2. 点击【申请发票】\n3. 填写发票信息\n4. 提交审核（1-3个工作日）\n\n如有其他问题，欢迎随时咨询！",
    "tone": "friendly",
    "confidence": 0.92,
    "knowledgeReferences": [
      {"id": "KB-001", "title": "开发票流程", "relevance": 0.95}
    ]
  },
  "nextActions": [
    {"action": "send_reply", "reason": "高置信度常规咨询", "priority": "normal"}
  ],
  "needHumanReview": false,
  "reviewReason": null
}
```

### 示例2: 负面情绪（VIP客户）
**输入**: "你们系统太烂了，一直报错，影响我工作了！"

**输出**:
```json
{
  "analysis": {
    "sentiment": "negative",
    "sentimentScore": 0.25,
    "intent": "complaint",
    "priority": "urgent",
    "keywords": ["系统", "报错", "影响工作"],
    "confidence": 0.88
  },
  "customerContext": {
    "isVIP": true,
    "riskLevel": "high",
    "healthScore": 45,
    "recentIssues": ["登录超时", "数据加载慢"]
  },
  "suggestedReply": {
    "content": "尊敬的用户，您好！非常抱歉给您带来困扰。\n\n我们已收到您的反馈，系统报错问题我们会立即安排技术团队排查。为了更快解决问题，我已将您的情况升级至高优先级处理。\n\n预计2小时内会有工程师联系您，请保持联系方式畅通。再次为给您带来的不便深表歉意。",
    "tone": "apologetic",
    "confidence": 0.88,
    "knowledgeReferences": []
  },
  "nextActions": [
    {"action": "escalate_to_engineer", "reason": "VIP客户+系统故障", "priority": "urgent"},
    {"action": "schedule_followup", "reason": "负面情绪严重", "priority": "high"}
  ],
  "needHumanReview": true,
  "reviewReason": "VIP客户+负面情绪严重"
}
```

---

## 边界与限制

### 不处理的场景
1. **产品功能设计**: "为什么不支持XX功能？" → 转产品团队
2. **退款/赔偿决策**: "能赔偿我多少钱？" → 转人工审批
3. **法律/合规问题**: "这是不是违法？" → 转法务部门
4. **个人隐私查询**: "帮我查一下XX客户的信息" → 拒绝，提示权限不足

### 降级处理
- **LLM超时（>30秒）**: 降级到关键词匹配
- **API错误**: 返回默认安抚话术，标记需人工处理
- **知识库无结果**: 建议联系技术支持或查看帮助文档

---

**重要**: 始终保持专业、友好、准确的服务态度，遇到不确定的情况优先推送人工审核，不自作主张。
```

#### 2.3 版本Prompt Diff

> 本节仅在增量PRD中使用，基线PRD记录最终版本

**v0.5相对v0.1的变更**:
```diff
核心职责:
1. 情感分析
2. 意图识别
3. 回复生成
4. 风险评估
5. 知识推荐
+ 6. 渠道适配（新增飞书/企微/Web识别）

输出格式:
{
  "analysis": {...},
  "suggestedReply": {
-   "content": "回复文本",
+   "content": "回复文本",
+   "channel": "feishu|wechat|web",
+   "format": "markdown|plaintext|html"
  }
}

特殊规则:
+ 规则4: 渠道格式适配（新增）
```

**v0.8相对v0.5的变更**:
```diff
核心职责:
1. 情感分析
2. 意图识别
3. 回复生成
4. 风险评估
5. 知识推荐
6. 渠道适配
+ 7. 自动化决策（置信度>0.9自动发送）

处理流程:
Step 5: 评估置信度
- confidence > 0.9: 高置信度
+ - confidence > 0.9: 高置信度，可自动发送（v0.8+）
- confidence 0.7-0.9: 中等置信度，推荐人工确认
- confidence < 0.7: 低置信度，必须人工审核

+ Step 6: 推荐下一步操作（新增）
+ 根据对话情况推荐操作：
+ - send_reply: 直接发送回复（置信度>0.9 且非VIP）
+ - escalate_to_engineer: 转技术工程师
+ - create_task: 创建售后任务
+ - schedule_followup: 安排回访
```

**v1.0相对v0.8的变更**:
```diff
核心职责:
1. 情感分析
2. 意图识别
3. 回复生成
4. 风险评估
5. 知识推荐
6. 渠道适配
- 7. 自动化决策
+ 7. 自动化决策（提升到90%）
+ 8. 多语言支持（中英日）
+ 9. 知识图谱联动

特殊规则:
+ 规则5: 多语言支持（新增）
+ 识别客户消息语言（中文/英语/日语），使用相同语言回复

输出格式:
{
  "analysis": {...},
  "suggestedReply": {
    "content": "回复文本",
+   "language": "zh|en|ja",
    "knowledgeReferences": [
-     {"id": "KB-001", "title": "标题"}
+     {"id": "KB-001", "title": "标题", "relatedNodes": ["KB-002", "KB-003"]}
    ]
  }
}
```

---

### 3.1.3 工具清单

#### 工具1: analyzeConversation

**功能描述**: 分析对话的情感、意图、优先级和关键词，为后续决策提供数据支撑

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 | 默认值 |
|-------|------|------|------|------|--------|
| conversationId | string | 是 | 对话ID | UUID格式 | - |
| messageContent | string | 是 | 客户消息内容 | 长度1-2000字符 | - |
| includeHistory | boolean | 否 | 是否包含历史消息上下文 | - | false |
| historyLimit | number | 否 | 历史消息条数 | 1-10 | 5 |
| channel | string | 否 | 消息渠道 | feishu/wechat/web | web |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "sentiment": "positive|neutral|negative",
    "sentimentScore": 0.85,
    "intent": "inquiry|complaint|requirement|fault|praise",
    "priority": "normal|high|urgent",
    "keywords": ["关键词1", "关键词2"],
    "confidence": 0.92,
    "language": "zh|en|ja",
    "contextSummary": "对话上下文摘要"
  },
  "metadata": {
    "processingTime": 1.2,
    "model": "deepseek-v3.1",
    "tokenUsed": 850
  }
}
```

**字段说明**:
| 字段名 | 类型 | 说明 | 取值范围 |
|-------|------|------|---------|
| sentiment | string | 情感类别 | positive/neutral/negative |
| sentimentScore | number | 情感分数 | 0-1，越接近0越负面 |
| intent | string | 对话意图 | inquiry/complaint/requirement/fault/praise |
| priority | string | 优先级 | normal/high/urgent |
| keywords | array | 关键词列表 | 最多10个 |
| confidence | number | 分析置信度 | 0-1 |
| language | string | 消息语言 | zh/en/ja |

**调用方式**: MCP (Model Context Protocol)

**特性**:
- **智能上下文理解**: 支持多轮对话上下文分析，识别情感变化趋势
- **多语言识别**: 自动检测中英日三种语言，无需手动指定
- **置信度评估**: 每次分析返回置信度，<0.7时自动标记需人工审核
- **关键词提取**: 基于TF-IDF + NER（命名实体识别）提取业务关键词
- **实时降级**: LLM超时30秒自动降级到关键词匹配算法

**注意事项**:
- 历史消息最多分析最近10条，超过10条自动截取最新内容
- 超时30秒自动降级到关键词匹配（"烂"→negative，"好"→positive）
- VIP客户优先级自动提升一级（normal→high，high→urgent）
- 需要预先调用`getCustomerProfile()`获取客户等级信息

**调用示例**:
```json
// 请求
{
  "conversationId": "CONV-12345",
  "messageContent": "你们系统太烂了，一直报错！",
  "includeHistory": true,
  "historyLimit": 3,
  "channel": "wechat"
}

// 响应
{
  "success": true,
  "data": {
    "sentiment": "negative",
    "sentimentScore": 0.25,
    "intent": "complaint",
    "priority": "urgent",
    "keywords": ["系统", "报错"],
    "confidence": 0.88,
    "language": "zh",
    "contextSummary": "客户连续3次反馈系统故障问题，情绪逐渐恶化"
  },
  "metadata": {
    "processingTime": 1.8,
    "model": "deepseek-v3.1",
    "tokenUsed": 1250
  }
}
```

---

#### 工具2: getCustomerProfile

**功能描述**: 获取客户画像信息，包括等级、健康度、风险评估和历史问题，辅助个性化服务

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| customerId | string | 是 | 客户ID | CUST-格式 |
| includeHistory | boolean | 否 | 是否包含历史问题 | 默认true |
| historyDays | number | 否 | 历史问题天数范围 | 7/30/90，默认30 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "customerId": "CUST-001",
    "name": "张三",
    "company": "某某科技有限公司",
    "isVIP": true,
    "vipLevel": "gold",
    "healthScore": 45,
    "riskLevel": "high",
    "contractInfo": {
      "amount": 100000,
      "expiryDate": "2025-12-31",
      "slaLevel": "金牌VIP"
    },
    "recentIssues": [
      {
        "date": "2025-12-28",
        "type": "fault",
        "summary": "登录超时",
        "resolved": false
      }
    ],
    "communicationPreference": "formal",
    "updatedAt": "2025-12-29T10:00:00Z"
  }
}
```

**调用方式**: MCP

**特性**:
- **实时同步**: 每小时从CRM系统自动同步客户数据
- **缓存机制**: 客户画像缓存10分钟，减少API调用
- **脱敏处理**: 敏感信息（手机号、邮箱）自动脱敏
- **权限控制**: 非授权用户无法查看完整联系方式

---

#### 工具3: searchKnowledge

**功能描述**: 基于语义检索知识库，匹配相关解决方案和文档

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| query | string | 是 | 查询文本 | 长度1-200字符 |
| topK | number | 否 | 返回结果数量 | 1-10，默认3 |
| minRelevance | number | 否 | 最低相关度阈值 | 0-1，默认0.7 |
| language | string | 否 | 知识语言 | zh/en/ja，默认zh |
| includeRelatedNodes | boolean | 否 | 是否包含知识图谱关联节点（v1.0） | 默认false |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "id": "KB-001",
        "title": "开发票流程",
        "summary": "详细说明如何在系统中申请开票...",
        "type": "doc",
        "relevanceScore": 0.95,
        "updatedAt": "2025-12-01",
        "relatedNodes": ["KB-002", "KB-003"]
      }
    ],
    "totalCount": 15,
    "queryTime": 0.5
  }
}
```

**调用方式**: MCP

**特性**:
- **语义理解**: 基于向量检索，支持同义词和语义相似匹配
- **知识图谱联动**（v1.0）: 返回关联知识节点，形成知识链路
- **多语言支持**（v1.0）: 支持中英日三种语言知识检索
- **实时更新**: 知识库更新后5分钟内生效

---

#### 工具4: generateReply

**功能描述**: 基于分析结果和知识库内容生成回复建议

**分类**: Ingest（生成类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| analysisResult | object | 是 | analyzeConversation的输出 |
| customerProfile | object | 是 | getCustomerProfile的输出 |
| knowledgeResults | array | 否 | searchKnowledge的输出 |
| tone | string | 否 | 期望语气（friendly/formal/apologetic/technical） |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "content": "尊敬的用户，您好！开发票流程如下：...",
    "tone": "friendly",
    "confidence": 0.92,
    "length": 128,
    "knowledgeReferences": [
      {"id": "KB-001", "title": "开发票流程", "relevance": 0.95}
    ],
    "suggestedActions": ["send_reply"],
    "needHumanReview": false
  }
}
```

**调用方式**: MCP

**特性**:
- **个性化生成**: 根据客户等级调整语气（普通/VIP）
- **知识引用**: 明确标注引用来源，可追溯
- **长度控制**: 自动控制在200字以内（可配置）
- **多方案生成**（v0.8+）: 可生成多个回复备选方案

---

#### 工具5: extractRequirement

**功能描述**: 提取客户需求关键信息（产品、版本、场景、问题描述）

**分类**: Insight（洞察类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| messageContent | string | 是 | 客户消息内容 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "product": "ERP系统",
    "version": "v2.5",
    "module": "财务模块",
    "scenario": "开发票",
    "description": "客户希望了解如何在ERP系统v2.5的财务模块中开具增值税专用发票",
    "keywords": ["ERP", "财务模块", "开发票", "增值税专用发票"],
    "confidence": 0.88
  }
}
```

**调用方式**: MCP

**特性**:
- **实体识别**: 基于NER识别产品名称、版本号、功能模块
- **意图提取**: 识别客户的真实需求意图
- **结构化输出**: 标准化的需求字段便于后续处理

---

#### 工具6: assessRisk

**功能描述**: 评估对话风险等级（流失风险、投诉风险、满意度风险）

**分类**: Insight（洞察类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| customerProfile | object | 是 | 客户画像 |
| analysisResult | object | 是 | 情感分析结果 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "overallRisk": "high",
    "churnRisk": 0.75,
    "complaintRisk": 0.85,
    "satisfactionRisk": 0.65,
    "factors": [
      "连续3次负面反馈",
      "健康度评分低于50",
      "VIP客户且合同即将到期"
    ],
    "recommendations": [
      "立即升级至高优先级处理",
      "安排专人回访",
      "提供补偿方案"
    ]
  }
}
```

**调用方式**: MCP

**特性**:
- **多维度评估**: 综合情感、历史、健康度等多维度数据
- **预测模型**（v0.8+）: 基于历史数据预测客户流失概率
- **风险预警**: 高风险客户自动触发告警通知

---

#### 工具7: recommendNextAction

**功能描述**: 基于对话分析推荐下一步操作（发送回复/转工程师/创建任务/安排回访）

**分类**: Insight（洞察类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| analysisResult | object | 是 | 情感分析结果 |
| replyConfidence | number | 是 | 回复建议置信度 |
| riskAssessment | object | 是 | 风险评估结果 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "primaryAction": {
      "action": "escalate_to_engineer",
      "reason": "VIP客户+系统故障+置信度不足",
      "priority": "urgent",
      "estimatedTime": "2小时内响应"
    },
    "secondaryActions": [
      {
        "action": "schedule_followup",
        "reason": "负面情绪严重，需要后续关怀",
        "priority": "high",
        "dueDate": "2025-12-30"
      }
    ]
  }
}
```

**调用方式**: MCP

**特性**:
- **智能决策**: 综合多个维度自动推荐最优操作
- **优先级排序**: 多个推荐操作按优先级排序
- **可解释性**: 明确说明推荐理由，便于人工判断

---

### 3.1.4 沉淀Skills

> 仅用于迭代版本（提炼上一版本已验证的功能）

#### 4.1 sentiment_analysis_skill

**适用场景**: 客户发送消息后，自动分析情感和意图，为后续决策提供依据

**触发条件**: `MessageSentEvent`（客户发送消息事件）

**标准流程**:
1. 调用`analyzeConversation()`获取情感分析结果
2. 如果`sentiment=negative`且`sentimentScore<0.5`，标记为高风险
3. 推送实时通知到客服工作台
4. 记录分析结果到对话历史
5. 触发`assessRisk()`评估客户流失风险

**质量门禁**:
- 情感分析准确率>90%（基于人工抽检100条/周）
- 响应时间<3秒（P95）
- 置信度<0.7时自动标记需人工审核

**回滚策略**:
- **LLM超时**: 降级到关键词匹配（"烂"、"差"→negative）
- **关键词无匹配**: 默认为neutral，confidence=0.3
- **API错误**: 返回默认值，标记需人工处理

**可观测性**:
- 记录每次调用的置信度分布（Prometheus histogram）
- 监控降级触发次数（>100次/小时告警）
- 统计情感分类分布（positive/neutral/negative占比）

---

#### 4.2 reply_generation_skill

**适用场景**: 基于情感分析和知识库检索，自动生成回复建议

**触发条件**: `AnalysisCompletedEvent`（情感分析完成事件）

**标准流程**:
1. 调用`getCustomerProfile()`获取客户等级
2. 如果`intent=inquiry`或`fault`，调用`searchKnowledge()`检索知识
3. 调用`generateReply()`生成回复建议
4. 评估置信度：
   - confidence>0.9：高置信度，可自动发送（v0.8+，非VIP）
   - confidence 0.7-0.9：推荐人工确认
   - confidence<0.7：必须人工审核
5. 推送回复建议到客服输入框

**质量门禁**:
- 回复采纳率>70%（客服点击【采纳】的比例）
- 置信度>0.9的回复误发率<0.1%
- 生成时间<5秒（P95）

**回滚策略**:
- **知识库无结果**: 生成通用话术（"正在为您查询，请稍候"）
- **LLM超时**: 返回默认安抚话术
- **VIP客户**: 强制人工审核，不自动发送

**可观测性**:
- 统计回复采纳率/修改率/拒绝率
- 监控自动发送成功率（v0.8+）
- 记录知识库命中率

---

#### 4.3 risk_monitoring_skill

**适用场景**: 持续监控客户对话风险，及时预警流失和投诉风险

**触发条件**: `ConversationUpdatedEvent`（对话更新事件）

**标准流程**:
1. 调用`assessRisk()`评估风险等级
2. 如果`overallRisk=high`：
   - 推送告警通知到售后经理
   - 自动创建高优先级任务
   - 建议安排专人回访
3. 更新客户健康度评分
4. 记录风险变化趋势

**质量门禁**:
- 流失预测准确率>75%（v0.8+）
- 风险评估响应时间<2秒
- 高风险客户识别召回率>85%

**回滚策略**:
- **模型不可用**: 基于规则引擎（连续3次负面+健康度<50→高风险）
- **数据不完整**: 降低置信度，标记"数据不足"

**可观测性**:
- 监控每日高风险客户数量
- 统计风险预警命中率
- 跟踪高风险客户后续转化情况

---

### 3.1.5 业务场景

#### 场景1: 常规咨询（高置信度自动化）

**场景描述**: 客户咨询常见问题（如"如何开发票"），系统自动分析并生成回复建议，置信度>0.9可直接发送

**触发条件**: 客户发送咨询类消息，且非VIP客户

**前置条件**:
- 知识库包含相关内容
- 客户等级为普通用户
- 对话模式为"Agent监督"

**处理流程**:
```mermaid
sequenceDiagram
    Customer->>Frontend: 发送消息"如何开发票？"
    Frontend->>Backend: POST /api/conversations/:id/messages
    Backend->>AssistantAgent: 触发MessageSentEvent
    AssistantAgent->>MCP: analyzeConversation()
    MCP-->>AssistantAgent: {sentiment:neutral, intent:inquiry, confidence:0.92}
    AssistantAgent->>MCP: searchKnowledge("开发票")
    MCP-->>AssistantAgent: [KB-001: 开发票流程, relevance:0.95]
    AssistantAgent->>MCP: generateReply()
    MCP-->>AssistantAgent: {content:"您好！开发票流程如下...", confidence:0.92}
    AssistantAgent->>Frontend: 推送回复建议（WebSocket）
    Frontend->>User: 展示回复建议
    User->>Frontend: 点击【采纳】
    Frontend->>Backend: 确认发送
    Backend->>Customer: 发送回复
```

**对话示例**:
```
【客户】如何开发票？

【AssistantAgent思考过程】
1. 调用analyzeConversation()
   → 输出: {
       sentiment: "neutral",
       sentimentScore: 0.75,
       intent: "inquiry",
       priority: "normal",
       keywords: ["开发票"],
       confidence: 0.92
     }

2. 调用getCustomerProfile()
   → 输出: {isVIP: false, healthScore: 85, riskLevel: "low"}

3. 调用searchKnowledge("开发票")
   → 输出: [
       {id: "KB-001", title: "开发票流程", relevance: 0.95}
     ]

4. 调用generateReply()
   → 输出: {
       content: "您好！开发票流程如下：\n1. 进入【我的订单】\n2. 点击【申请发票】\n3. 填写发票信息\n4. 提交审核（1-3个工作日）\n\n如有其他问题，欢迎随时咨询！",
       tone: "friendly",
       confidence: 0.92,
       needHumanReview: false
     }

【前端展示】
┌─────────────────────────────────────┐
│ AI辅助面板                           │
├─────────────────────────────────────┤
│ 💬 回复建议（置信度92%）              │
│                                      │
│ 您好！开发票流程如下：                │
│ 1. 进入【我的订单】                   │
│ 2. 点击【申请发票】                   │
│ 3. 填写发票信息                       │
│ 4. 提交审核（1-3个工作日）             │
│                                      │
│ 如有其他问题，欢迎随时咨询！           │
│                                      │
│ 📚 参考：KB-001 开发票流程             │
│                                      │
│ [采纳] [修改] [拒绝]                 │
└─────────────────────────────────────┘

【客服操作】
点击【采纳】→ 自动填入输入框 → 点击【发送】
```

**预期输出**:
- 情感识别正确：neutral
- 意图识别正确：inquiry
- 知识库命中：KB-001（相关度0.95）
- 回复建议质量高：客服直接采纳
- 客户满意：问题解决，无后续追问

**异常分支**:
| 异常情况 | 处理方式 |
|---------|---------|
| 知识库无匹配结果 | 生成通用话术："正在为您查询相关信息，请稍候" |
| 置信度<0.9 | 推送回复建议，但需客服确认后发送 |
| LLM超时（>30秒） | 降级到关键词匹配，返回简化回复 |

**成功标准**:
- ✅ 情感分析准确率>90%
- ✅ 意图识别准确率>85%
- ✅ 知识库相关度>0.7
- ✅ 回复采纳率>70%
- ✅ 响应时间<3秒（P95）

---

#### 场景2: 负面情绪处理（VIP客户高优先级）

**场景描述**: VIP客户因系统故障投诉，情绪负面，系统识别高风险并立即升级处理

**触发条件**: 客户发送负面情绪消息，且客户等级为VIP

**处理流程**:
```mermaid
sequenceDiagram
    Customer->>Frontend: "你们系统太烂了，一直报错！"
    Frontend->>Backend: POST /api/conversations/:id/messages
    Backend->>AssistantAgent: 触发MessageSentEvent
    AssistantAgent->>MCP: analyzeConversation()
    MCP-->>AssistantAgent: {sentiment:negative, score:0.25, intent:complaint}
    AssistantAgent->>MCP: getCustomerProfile()
    MCP-->>AssistantAgent: {isVIP:true, riskLevel:high, healthScore:45}
    AssistantAgent->>MCP: assessRisk()
    MCP-->>AssistantAgent: {overallRisk:high, churnRisk:0.75}
    AssistantAgent->>MCP: generateReply(tone:apologetic)
    MCP-->>AssistantAgent: {content:"尊敬的用户，非常抱歉...", needHumanReview:true}
    AssistantAgent->>Backend: 创建高优先级告警
    Backend->>Manager: 推送告警通知（邮件+飞书）
    AssistantAgent->>Frontend: 推送回复建议（必须人工审核）
    Frontend->>User: 展示回复建议+🔴高风险提示
```

**对话示例**:
```
【客户】你们系统太烂了，一直报错，影响我工作了！

【AssistantAgent思考过程】
1. analyzeConversation()
   → {sentiment: "negative", sentimentScore: 0.25, intent: "complaint", priority: "urgent"}

2. getCustomerProfile()
   → {isVIP: true, vipLevel: "gold", riskLevel: "high", healthScore: 45}

3. 判断: isVIP=true → 强制needHumanReview=true

4. assessRisk()
   → {overallRisk: "high", churnRisk: 0.75, complaintRisk: 0.85}

5. generateReply(tone: "apologetic")
   → {content: "尊敬的用户，您好！非常抱歉给您带来困扰...", needHumanReview: true}

6. recommendNextAction()
   → {
       primaryAction: "escalate_to_engineer",
       secondaryAction: "schedule_followup"
     }

【前端展示】
┌─────────────────────────────────────┐
│ 🔴 高优先级 - VIP客户 - 负面情绪      │
├─────────────────────────────────────┤
│ 客户画像：                            │
│ • 等级：金牌VIP                       │
│ • 健康度：45/100 (🔴危险)             │
│ • 风险等级：高                        │
│ • 流失概率：75%                       │
│                                      │
│ 💬 回复建议（需人工审核）              │
│                                      │
│ 尊敬的用户，您好！非常抱歉给您带来     │
│ 困扰。我们已收到您的反馈，系统报错问题 │
│ 我们会立即安排技术团队排查...         │
│                                      │
│ 📋 推荐操作：                         │
│ 1. [紧急] 转技术工程师（2小时内响应）  │
│ 2. [重要] 安排专人回访（明日联系）     │
│                                      │
│ [采纳] [修改] [拒绝]                 │
└─────────────────────────────────────┘

【客服操作】
看到高风险提示 → 修改回复（添加具体补偿方案）→ 确认发送 → 立即联系技术工程师
```

**成功标准**:
- ✅ 负面情绪识别准确率>95%
- ✅ VIP客户100%标记需人工审核
- ✅ 高风险告警推送延迟<10秒
- ✅ 推荐操作准确性>90%

---

#### 场景3: 多轮对话上下文理解

**场景描述**: 客户多轮对话，系统需理解上下文，避免重复询问

**触发条件**: 客户在同一对话中连续发送3+条消息

**对话示例**:
```
【客户】第1轮：系统登录不上
【AssistantAgent】分析：intent=fault, priority=high
【客服】回复：请问您使用的是哪个版本？

【客户】第2轮：2.5版本
【AssistantAgent】提取上下文：product=ERP, version=v2.5, issue=登录失败
【客服】回复：请尝试清除浏览器缓存后重新登录

【客户】第3轮：还是不行
【AssistantAgent】上下文理解：
  - 前2轮问题：登录失败
  - 已尝试方案：清除缓存
  - 判断：基础方案无效，需升级到工程师
【推荐操作】escalate_to_engineer（原因：常规方案已无效）
```

**成功标准**:
- ✅ 上下文理解准确率>85%
- ✅ 避免重复询问已知信息
- ✅ 及时识别问题升级信号

---

### 3.1.6 人机协作边界

#### 6.1 Agent主导场景（高自动化）

**适用条件**:
- 简单咨询（常见问题，知识库有明确答案）
- 情感分析置信度>0.9
- 非VIP客户
- 对话风险等级=low
- 知识库相关度>0.8

**Agent行为**:
1. 自动分析情感和意图
2. 检索知识库，生成回复建议
3. **v0.1-v0.5**: 推送建议，需客服确认后发送
4. **v0.8**: 置信度>0.9自动发送（无需人工审核）
5. **v1.0**: 自动化率提升到90%

**自动化率目标**:
- **v0.1**: 0%（全部人工审核）
- **v0.5**: 0%（功能验证阶段）
- **v0.8**: 60%（置信度>0.9 且非VIP自动发送）
- **v1.0**: 90%（扩大自动发送范围）

**示例**:
```
场景：客户问"如何修改密码？"
→ 情感：neutral (0.82)
→ 意图：inquiry (0.95)
→ 客户：普通用户
→ 知识库：KB-015（修改密码流程，相关度0.92）
→ 置信度：0.93
→ v0.8行为：自动发送回复（无需人工确认）
→ v0.1/v0.5行为：推送建议，等待客服确认
```

---

#### 6.2 人工主导场景（低自动化）

**适用条件**:
- VIP客户（无论置信度多高）
- 高风险客户（riskLevel=high）
- 负面情绪且分数<0.5
- 复杂/非标问题（知识库相关度<0.7）
- 涉及退款/赔偿/法律问题
- 客户明确要求人工服务

**Agent行为**:
1. 提供情感分析结果（仅供参考）
2. 推荐相关知识库（辅助）
3. 展示历史案例（参考）
4. **永远需要人工确认，不自动发送**
5. 推荐下一步操作（如"转工程师"、"安排回访"）

**自动化率目标**:
- **所有版本**：0%（刻意保持人工）

**示例**:
```
场景：VIP客户投诉"系统故障导致订单丢失，要求赔偿"
→ 情感：negative (0.15)
→ 客户：金牌VIP
→ 风险：high（流失风险75%）
→ 涉及：赔偿决策
→ Agent行为：
   - 提供情感分析："负面情绪严重，流失风险高"
   - 推荐操作："立即转技术工程师+安排经理回访+准备补偿方案"
   - 生成安抚话术（供参考，必须人工审核）
→ 客服行为：
   - 查看Agent建议
   - 自主决策回复内容
   - 联系技术团队和售后经理
   - 发送经人工确认的回复
```

---

#### 6.3 协作模式（Agent辅助，人工决策）

**适用条件**:
- 中等复杂度问题
- 置信度0.7-0.9
- 普通客户但问题较复杂
- 需要多个方案组合

**Agent行为**:
1. 生成3+种回复方案（v0.8+）
2. 标注每个方案的置信度和适用场景
3. 人工选择或组合方案
4. 人工微调后确认发送

**决策流程**:
```
Agent生成建议 → 人工评估 → 人工选择/修改 → 确认发送 → Agent学习反馈
```

**示例**:
```
场景：客户问"如何批量导入数据？我有5000条记录"
→ 意图：inquiry + requirement
→ 复杂度：中等（涉及批量操作）
→ 置信度：0.75

Agent提供3个方案：
1. 标准方案：使用Excel导入功能（置信度0.75）
   - 适用：<1000条数据
   - 缺点：5000条可能超时

2. API方案：使用批量导入API（置信度0.65）
   - 适用：大批量数据
   - 缺点：需要技术对接

3. 人工协助方案：联系技术支持协助（置信度0.80）
   - 适用：不熟悉技术操作的客户
   - 优点：成功率高

客服决策：
- 先询问客户技术能力
- 如果客户有开发能力 → 推荐方案2
- 如果客户无技术背景 → 推荐方案3
```

---

### 3.1.7 非功能需求

#### 7.1 性能要求

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **Agent响应时间** | <3秒（P95） | Prometheus监控LLM调用时长 |
| **首Token时间** | <1秒 | 测量LLM首个token返回时间 |
| **简单任务完成时间** | <5秒 | 端到端测量（输入→输出） |
| **复杂任务完成时间** | <30秒 | 多工具调用场景（3+工具） |
| **并发处理能力** | 支持100+并发对话 | 压力测试验证 |

#### 7.2 质量指标

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **任务完成率** | >95% | 成功输出/总调用次数 |
| **意图识别准确率** | >85% | 人工抽检100条/周，对比标注 |
| **情感分析准确率** | >90% | 人工抽检（正负中性三分类） |
| **回复采纳率** | >70% | 客服点击【采纳】的比例 |
| **知识库相关度** | >0.7 | searchKnowledge返回的relevance |
| **用户满意度** | >4.5/5 | 客户对AI回复的评分 |

#### 7.3 成本约束

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **LLM调用成本** | <¥5000/月 | DeepSeek计费统计 |
| **Token消耗** | <100k tokens/天 | 监控每次调用的token数 |
| **平均单次调用成本** | <¥0.05/次 | 成本/调用次数 |
| **工具调用次数** | <1000次/小时 | MCP调用统计 |

**成本优化策略**:
- 优先使用DeepSeek（¥0.001/1k tokens），仅复杂场景使用GPT-4
- 缓存高频问题（如"如何开发票"），避免重复LLM调用
- 批量调用优化（合并多个请求）
- 设置月度预算告警（超¥4000告警）

#### 7.4 可用性要求

| 指标 | 目标值 | 说明 |
|-----|--------|------|
| **系统可用性** | >99.9% | 降级策略保障 |
| **降级触发率** | <5% | 降级到关键词匹配的比例 |
| **故障恢复时间** | <5分钟 | 从故障到恢复正常的时间 |
| **数据一致性** | 100% | Agent输出与数据库记录一致 |

**降级保障**:
- LLM故障自动降级到关键词匹配
- 关键词匹配失败降级到规则引擎
- 规则引擎无覆盖时人工介入

---

### 3.1.8 验收场景

#### 8.1 验收场景清单

| 场景ID | 场景描述 | 优先级 | 依赖 |
|--------|---------|--------|------|
| AC-01 | 常规咨询（高置信度自动化） | P0 | 无 |
| AC-02 | 负面情绪识别与处理（VIP客户） | P0 | AC-01 |
| AC-03 | 故障类问题转工程师 | P0 | AC-01 |
| AC-04 | 多轮对话上下文理解 | P0 | AC-01 |
| AC-05 | 降级到关键词匹配 | P1 | AC-01 |
| AC-06 | 知识库无结果处理 | P1 | AC-01 |
| AC-07 | 多语言支持（v1.0） | P1 | AC-01 |

---

#### AC-01: 常规咨询（高置信度自动化）

**场景描述**: 客户咨询常见问题（如"如何开发票"），系统自动分析并生成回复建议，置信度>0.9可直接发送（v0.8+）

**输入**:
```json
{
  "conversationId": "CONV-12345",
  "messageContent": "如何开发票？",
  "customerId": "CUST-001"
}
```

**预期Agent输出**:
```json
{
  "analysis": {
    "sentiment": "neutral",
    "sentimentScore": 0.75,
    "intent": "inquiry",
    "priority": "normal",
    "keywords": ["开发票"],
    "confidence": 0.92
  },
  "customerContext": {
    "isVIP": false,
    "riskLevel": "low",
    "healthScore": 85
  },
  "suggestedReply": {
    "content": "您好！开发票流程如下：\n1. 进入【我的订单】\n2. 点击【申请发票】\n3. 填写发票信息\n4. 提交审核（1-3个工作日）\n\n如有其他问题，欢迎随时咨询！",
    "tone": "friendly",
    "confidence": 0.92,
    "knowledgeReferences": [
      {"id": "KB-001", "title": "开发票流程", "relevance": 0.95}
    ]
  },
  "nextActions": [
    {"action": "send_reply", "reason": "高置信度常规咨询", "priority": "normal"}
  ],
  "needHumanReview": false
}
```

**验收标准**:
- ✅ sentiment识别为"neutral"
- ✅ intent识别为"inquiry"
- ✅ keywords包含"开发票"
- ✅ confidence>0.9
- ✅ knowledgeReferences相关度>0.7
- ✅ needHumanReview=false（非VIP客户）
- ✅ 响应时间<3秒

**测试数据**:
| 输入 | 预期intent | 预期sentiment | 预期confidence |
|-----|-----------|--------------|---------------|
| "如何开发票？" | inquiry | neutral | >0.9 |
| "修改密码的步骤是什么？" | inquiry | neutral | >0.9 |
| "怎么查看订单历史？" | inquiry | neutral | >0.9 |

---

#### AC-02: 负面情绪识别与处理（VIP客户）

**场景描述**: VIP客户因系统故障投诉，情绪负面，系统识别高风险并立即升级处理

**输入**:
```json
{
  "conversationId": "CONV-67890",
  "messageContent": "你们系统太烂了，一直报错，影响我工作了！",
  "customerId": "CUST-VIP-001"
}
```

**预期Agent输出**:
```json
{
  "analysis": {
    "sentiment": "negative",
    "sentimentScore": 0.25,
    "intent": "complaint",
    "priority": "urgent",
    "keywords": ["系统", "报错", "影响工作"],
    "confidence": 0.88
  },
  "customerContext": {
    "isVIP": true,
    "vipLevel": "gold",
    "riskLevel": "high",
    "healthScore": 45,
    "recentIssues": ["登录超时", "数据加载慢"]
  },
  "suggestedReply": {
    "content": "尊敬的用户，您好！非常抱歉给您带来困扰。\n\n我们已收到您的反馈，系统报错问题我们会立即安排技术团队排查。为了更快解决问题，我已将您的情况升级至高优先级处理。\n\n预计2小时内会有工程师联系您，请保持联系方式畅通。再次为给您带来的不便深表歉意。",
    "tone": "apologetic",
    "confidence": 0.88,
    "knowledgeReferences": []
  },
  "nextActions": [
    {"action": "escalate_to_engineer", "reason": "VIP客户+系统故障", "priority": "urgent"},
    {"action": "schedule_followup", "reason": "负面情绪严重", "priority": "high"}
  ],
  "needHumanReview": true,
  "reviewReason": "VIP客户+负面情绪严重"
}
```

**验收标准**:
- ✅ sentiment识别为"negative"
- ✅ sentimentScore<0.5
- ✅ intent识别为"complaint"
- ✅ priority自动升级为"urgent"
- ✅ isVIP=true时，needHumanReview强制为true
- ✅ nextActions包含"escalate_to_engineer"和"schedule_followup"
- ✅ 回复tone为"apologetic"
- ✅ 高优先级告警推送延迟<10秒

---

#### AC-03: 故障类问题转工程师

**场景描述**: 客户报告系统故障，知识库无法解决，Agent推荐转技术工程师

**输入**:
```json
{
  "conversationId": "CONV-11111",
  "messageContent": "系统登录不上，一直提示网络错误",
  "customerId": "CUST-002"
}
```

**预期Agent输出**:
```json
{
  "analysis": {
    "sentiment": "neutral",
    "sentimentScore": 0.65,
    "intent": "fault",
    "priority": "high",
    "keywords": ["登录", "网络错误"],
    "confidence": 0.82
  },
  "suggestedReply": {
    "content": "您好，了解到您遇到登录问题。请问：\n1. 您使用的是什么版本？\n2. 是否尝试过清除浏览器缓存？\n\n如果问题依然存在，我会立即为您安排技术工程师协助排查。",
    "tone": "technical",
    "confidence": 0.82,
    "knowledgeReferences": [
      {"id": "KB-015", "title": "登录故障排查", "relevance": 0.72}
    ]
  },
  "nextActions": [
    {"action": "escalate_to_engineer", "reason": "故障类问题且知识库置信度<0.8", "priority": "high"}
  ],
  "needHumanReview": false
}
```

**验收标准**:
- ✅ intent识别为"fault"
- ✅ priority为"high"
- ✅ 如果置信度<0.8，推荐"escalate_to_engineer"
- ✅ 不自作主张生成技术方案
- ✅ 优先询问客户情况

---

#### AC-04: 多轮对话上下文理解

**场景描述**: 客户多轮对话，系统需理解上下文，避免重复询问

**输入**（第3轮）:
```json
{
  "conversationId": "CONV-22222",
  "messageContent": "还是不行",
  "historyMessages": [
    {"role": "customer", "content": "系统登录不上"},
    {"role": "agent", "content": "请问您使用的是哪个版本？"},
    {"role": "customer", "content": "2.5版本"},
    {"role": "agent", "content": "请尝试清除浏览器缓存后重新登录"},
    {"role": "customer", "content": "还是不行"}
  ]
}
```

**预期Agent输出**:
```json
{
  "analysis": {
    "sentiment": "neutral",
    "sentimentScore": 0.60,
    "intent": "fault",
    "priority": "high",
    "contextSummary": "客户使用v2.5，清除缓存后仍无法登录，需升级到工程师"
  },
  "suggestedReply": {
    "content": "了解了，常规方案无法解决您的问题。我已将您的情况升级至技术团队，工程师会在30分钟内联系您，帮助您深入排查。",
    "confidence": 0.85
  },
  "nextActions": [
    {"action": "escalate_to_engineer", "reason": "常规方案已无效", "priority": "urgent"}
  ]
}
```

**验收标准**:
- ✅ 上下文理解准确率>85%
- ✅ 避免重复询问已知信息（版本号）
- ✅ 识别问题升级信号（"还是不行"）
- ✅ 及时推荐升级到工程师

---

#### AC-05: 降级到关键词匹配

**场景描述**: LLM超时30秒，自动降级到关键词匹配算法

**输入**:
```json
{
  "conversationId": "CONV-33333",
  "messageContent": "你们系统太烂了",
  "llmTimeout": true
}
```

**预期Agent输出**（降级后）:
```json
{
  "analysis": {
    "sentiment": "negative",
    "sentimentScore": 0.4,
    "intent": "complaint",
    "priority": "high",
    "confidence": 0.6,
    "fallbackLevel": 1,
    "fallbackReason": "LLM超时30秒"
  },
  "suggestedReply": {
    "content": "非常抱歉给您带来困扰，我们会立即处理您的反馈。",
    "confidence": 0.6
  },
  "needHumanReview": true,
  "reviewReason": "降级处理，置信度<0.7"
}
```

**验收标准**:
- ✅ LLM超时30秒触发降级
- ✅ fallbackLevel=1（关键词匹配）
- ✅ confidence降低到0.5-0.7
- ✅ needHumanReview=true
- ✅ 降级触发次数监控<100次/小时

---

#### AC-06: 知识库无结果处理

**场景描述**: 客户咨询问题，知识库无匹配结果

**输入**:
```json
{
  "conversationId": "CONV-44444",
  "messageContent": "你们支持XX新功能吗？",
  "knowledgeResults": []
}
```

**预期Agent输出**:
```json
{
  "analysis": {
    "sentiment": "neutral",
    "intent": "inquiry",
    "confidence": 0.75
  },
  "suggestedReply": {
    "content": "感谢您的咨询！关于XX新功能，我正在为您查询相关信息，请稍候。如需紧急处理，也可以直接联系我们的技术支持团队。",
    "confidence": 0.75
  },
  "nextActions": [
    {"action": "create_task", "reason": "知识库无结果，需人工跟进"}
  ]
}
```

**验收标准**:
- ✅ 不生成虚假信息
- ✅ 提供替代方案（联系技术支持）
- ✅ 创建任务供后续跟进

---

#### AC-07: 多语言支持（v1.0）

**场景描述**: 识别客户消息语言（英语），使用相同语言回复

**输入**:
```json
{
  "conversationId": "CONV-55555",
  "messageContent": "How to download the invoice?",
  "customerId": "CUST-EN-001"
}
```

**预期Agent输出**:
```json
{
  "analysis": {
    "sentiment": "neutral",
    "intent": "inquiry",
    "language": "en",
    "confidence": 0.90
  },
  "suggestedReply": {
    "content": "Hello! Here's how to download your invoice:\n1. Go to [My Orders]\n2. Click [Download Invoice]\n3. Select the order\n\nIf you have any questions, feel free to ask!",
    "language": "en",
    "confidence": 0.90
  }
}
```

**验收标准**:
- ✅ 正确识别language="en"
- ✅ 回复使用英语
- ✅ 多语言准确率>85%（中英日）

---

### 3.1.9 降级策略

#### 9.1 降级层级

```
主路径: LLM分析 (DeepSeek v3.1)
  ↓ [超时30秒 / API调用失败 / 错误率>10%]
降级1: 关键词匹配算法
  ↓ [无匹配关键词 / 置信度<0.5]
降级2: 规则引擎（基于历史模式）
  ↓ [规则无覆盖]
降级3: 人工介入（标记需人工处理）
```

---

#### 9.2 情感分析降级策略

**主路径: LLM情感分析**

- **触发条件**: 正常情况
- **行为**: 调用DeepSeek v3.1分析客户消息情感
- **输出**: `{sentiment: "positive/neutral/negative", sentimentScore: 0-1, confidence: 0.85+}`
- **处理时间**: <2秒

**降级1: 关键词匹配**

- **触发条件**:
  - LLM超时（>30秒）
  - API调用失败（返回5xx错误）
  - LLM连续10次错误率>10%
- **行为**:
  - 匹配负面关键词库：["烂", "差", "垃圾", "投诉", "退款"]
  - 匹配正面关键词库：["好", "满意", "谢谢", "赞"]
  - 未匹配则默认"neutral"
- **输出**: `{sentiment: "negative/positive/neutral", sentimentScore: 0.5, confidence: 0.6, fallbackLevel: 1}`
- **置信度**: 0.5-0.7
- **处理时间**: <100ms

**降级2: 规则引擎**

- **触发条件**: 关键词无匹配
- **行为**:
  - 规则1: 包含"？"→ neutral
  - 规则2: 消息长度>100字 → neutral
  - 规则3: 包含数字 → neutral（可能是咨询）
  - 默认: neutral
- **输出**: `{sentiment: "neutral", sentimentScore: 0.5, confidence: 0.3, fallbackLevel: 2}`
- **置信度**: 0.3-0.5

**降级3: 人工介入**

- **触发条件**: 规则引擎无法覆盖
- **行为**:
  - 标记`needHumanReview=true`
  - 推送告警："情感分析降级到人工"
  - 默认sentiment="neutral"（保守策略）
- **输出**: `{sentiment: "neutral", sentimentScore: 0.5, confidence: 0.0, fallbackLevel: 3, needHumanReview: true}`

---

#### 9.3 回复生成降级策略

**主路径: LLM回复生成**

- **触发条件**: 正常情况且置信度>0.7
- **行为**:
  - 调用DeepSeek v3.1生成个性化回复
  - 基于客户画像调整语气（VIP/普通/技术型）
  - 引用知识库内容
- **输出**: 结构化回复（问候+解决方案+补充+结束语）
- **处理时间**: <3秒

**降级1: 模板回复**

- **触发条件**:
  - LLM超时
  - 置信度<0.7
  - 知识库无结果
- **行为**:
  - 使用预定义模板库（10+通用模板）
  - 根据intent选择模板：
    - inquiry: "感谢咨询，我们会尽快为您查询..."
    - complaint: "非常抱歉给您带来困扰..."
    - fault: "已收到您的反馈，技术团队会立即处理..."
- **输出**: 模板文本（150字左右）
- **置信度**: 0.6
- **处理时间**: <50ms

**降级2: 默认安抚话术**

- **触发条件**: 模板库无匹配intent
- **行为**: 返回通用安抚话术
- **输出**: "感谢您的反馈，我们会尽快处理并回复您。"
- **置信度**: 0.3
- **标记**: needHumanReview=true

**降级3: 人工回复**

- **触发条件**: VIP客户 OR 负面情绪严重
- **行为**: 不自动生成，直接标记人工处理
- **输出**: null（无建议回复）
- **标记**: needHumanReview=true, reviewReason="VIP客户"

---

#### 9.4 知识检索降级策略

**主路径: 语义向量检索**

- **触发条件**: 正常情况
- **行为**:
  - 使用embedding模型将query转换为向量
  - 在向量数据库中检索（cosine相似度>0.7）
  - 返回top 3相关知识
- **输出**: `[{id, title, relevance: 0.7-1.0}]`
- **处理时间**: <1秒

**降级1: 关键词全文检索**

- **触发条件**:
  - embedding API超时
  - 向量数据库不可用
  - 语义检索无结果（相似度<0.7）
- **行为**:
  - 提取关键词（TF-IDF）
  - PostgreSQL全文检索（`to_tsvector`）
  - 返回匹配度>0.5的结果
- **输出**: `[{id, title, relevance: 0.5-0.7}]`
- **处理时间**: <500ms

**降级2: 标题模糊匹配**

- **触发条件**: 全文检索无结果
- **行为**:
  - 使用`LIKE %keyword%`模糊匹配标题
  - 返回部分匹配结果
- **输出**: `[{id, title, relevance: 0.3}]`

**降级3: 返回空结果**

- **触发条件**: 所有检索方式无结果
- **行为**: 返回空数组`[]`
- **后续处理**: Agent生成"知识库无结果"提示

---

#### 9.5 降级监控

| 监控指标 | 告警阈值 | 处理措施 |
|---------|---------|---------|
| **LLM超时率** | >5%（每小时） | 检查LLM服务状态，考虑增加超时时间到60秒 |
| **降级1触发率** | >10%（每小时） | 优化Prompt降低超时，扩容LLM服务 |
| **降级2触发率** | >5%（每小时） | 扩充关键词库，优化规则引擎 |
| **降级3触发率** | >2%（每小时） | 人工处理积压，检查系统故障 |
| **关键词匹配准确率** | <70% | 更新关键词库（每月维护） |
| **模板回复使用率** | >30% | 检查LLM服务质量 |

**告警通知**:
- 降级1触发>100次/小时 → Slack告警 + 邮件通知
- 降级3触发>50次/小时 → 紧急告警 + 电话通知

**降级恢复**:
- LLM服务恢复后自动切回主路径
- 每5分钟健康检查一次
- 连续3次成功后恢复正常

---

### 3.1.10 监控指标

#### 10.1 核心指标

| 指标名称 | 指标定义 | 监控工具 | 告警阈值 | 优先级 |
|---------|---------|---------|---------|--------|
| **LLM调用次数** | 每小时调用量 | Prometheus | >1000次/小时 | P1 |
| **LLM调用成功率** | 成功调用/总调用 | Prometheus | <95% | P0 |
| **平均响应时间** | P95响应时长 | Prometheus | >5秒 | P0 |
| **置信度分布** | 各置信度区间占比 | Grafana | <0.7占比>20% | P1 |
| **降级触发次数** | 降级到关键词匹配次数 | Prometheus | >100次/小时 | P0 |
| **Token消耗** | 每日总Token | Prometheus | >100k tokens/天 | P1 |
| **成本** | 每日LLM调用费用 | 自定义脚本 | >¥200/天 | P0 |
| **回复采纳率** | 客服采纳回复建议比例 | Prometheus | <60% | P1 |
| **人工审核率** | needHumanReview=true比例 | Prometheus | >40% | P2 |
| **情感识别准确率** | 人工抽检准确率 | 人工标注 | <85% | P0 |

---

#### 10.2 Prometheus指标定义

```promql
# ===== 调用次数 =====

# LLM调用总次数（按Agent、模型、结果分组）
assistant_agent_llm_calls_total{
  agent="AssistantAgent",
  model="deepseek-v3.1|gpt-4|claude-3.5",
  result="success|failure|timeout"
} counter

# 示例查询：每小时调用量
rate(assistant_agent_llm_calls_total{result="success"}[1h]) * 3600


# ===== 调用失败 =====

# LLM调用失败次数（按错误类型分组）
assistant_agent_llm_calls_failed{
  agent="AssistantAgent",
  error_type="timeout|api_error|rate_limit|invalid_response"
} counter

# 示例查询：失败率
rate(assistant_agent_llm_calls_failed[5m]) /
rate(assistant_agent_llm_calls_total[5m]) * 100


# ===== 响应时间 =====

# LLM响应时间（直方图，按工具分组）
assistant_agent_llm_response_duration_seconds{
  agent="AssistantAgent",
  tool="analyzeConversation|generateReply|searchKnowledge",
  le="0.5,1,2,3,5,10,30"  # bucket边界
} histogram

# 示例查询：P95响应时间
histogram_quantile(0.95,
  sum(rate(assistant_agent_llm_response_duration_seconds_bucket[5m]))
  by (le)
)

# 示例查询：平均响应时间
rate(assistant_agent_llm_response_duration_seconds_sum[5m]) /
rate(assistant_agent_llm_response_duration_seconds_count[5m])


# ===== 置信度分布 =====

# 置信度分布（按区间分组）
assistant_agent_confidence_score{
  agent="AssistantAgent",
  bucket="0.0-0.5|0.5-0.7|0.7-0.9|0.9-1.0"
} gauge

# 示例查询：低置信度占比
sum(assistant_agent_confidence_score{bucket="0.0-0.5"}) /
sum(assistant_agent_confidence_score) * 100


# ===== 降级触发 =====

# 降级触发次数（按降级层级分组）
assistant_agent_fallback_triggered{
  agent="AssistantAgent",
  fallback_level="1|2|3",
  reason="llm_timeout|api_error|no_match"
} counter

# 示例查询：降级1触发率
rate(assistant_agent_fallback_triggered{fallback_level="1"}[1h]) * 3600


# ===== Token消耗 =====

# Token消耗总量（按模型分组）
assistant_agent_tokens_used{
  agent="AssistantAgent",
  model="deepseek-v3.1|gpt-4",
  type="prompt|completion"
} counter

# 示例查询：每日Token消耗
sum(increase(assistant_agent_tokens_used[24h]))

# 示例查询：平均单次Token消耗
rate(assistant_agent_tokens_used_sum[5m]) /
rate(assistant_agent_llm_calls_total{result="success"}[5m])


# ===== 成本统计 =====

# LLM调用成本（人民币）
assistant_agent_cost_yuan{
  agent="AssistantAgent",
  model="deepseek-v3.1|gpt-4"
} counter

# 示例查询：每日成本
sum(increase(assistant_agent_cost_yuan[24h]))

# 示例查询：成本预测（按当前速率推算月成本）
sum(rate(assistant_agent_cost_yuan[1h])) * 730


# ===== 业务指标 =====

# 回复采纳次数
assistant_agent_reply_accepted{
  agent="AssistantAgent"
} counter

# 回复拒绝次数
assistant_agent_reply_rejected{
  agent="AssistantAgent"
} counter

# 示例查询：回复采纳率
rate(assistant_agent_reply_accepted[1h]) /
(rate(assistant_agent_reply_accepted[1h]) +
 rate(assistant_agent_reply_rejected[1h])) * 100


# 人工审核标记次数
assistant_agent_human_review_required{
  agent="AssistantAgent",
  reason="vip_customer|low_confidence|negative_emotion|fault"
} counter

# 示例查询：人工审核率
rate(assistant_agent_human_review_required[1h]) /
rate(assistant_agent_llm_calls_total{result="success"}[1h]) * 100


# ===== 意图和情感识别 =====

# 意图识别分布
assistant_agent_intent_detected{
  agent="AssistantAgent",
  intent="inquiry|complaint|requirement|fault|praise"
} counter

# 情感识别分布
assistant_agent_sentiment_detected{
  agent="AssistantAgent",
  sentiment="positive|neutral|negative"
} counter

# 示例查询：负面情绪占比
rate(assistant_agent_sentiment_detected{sentiment="negative"}[1h]) /
rate(assistant_agent_sentiment_detected[1h]) * 100
```

---

#### 10.3 Grafana仪表板

**仪表板名称**: AssistantAgent - 对话辅助监控

**刷新频率**: 30秒

---

**Row 1: 核心指标概览**

**面板1.1: LLM调用量趋势（折线图）**
- **X轴**: 时间（最近24小时）
- **Y轴**: 调用次数/小时
- **系列**:
  - 成功调用（绿色）
  - 失败调用（红色）
  - 超时调用（橙色）
- **查询**:
  ```promql
  # 成功
  rate(assistant_agent_llm_calls_total{result="success"}[5m]) * 3600

  # 失败
  rate(assistant_agent_llm_calls_total{result="failure"}[5m]) * 3600

  # 超时
  rate(assistant_agent_llm_calls_total{result="timeout"}[5m]) * 3600
  ```

**面板1.2: 成功率（Stat面板）**
- **显示值**: 百分比（大字体）
- **阈值**:
  - <90%: 红色
  - 90-95%: 橙色
  - >95%: 绿色
- **查询**:
  ```promql
  rate(assistant_agent_llm_calls_total{result="success"}[5m]) /
  rate(assistant_agent_llm_calls_total[5m]) * 100
  ```

**面板1.3: 平均响应时间（Gauge仪表盘）**
- **单位**: 秒
- **阈值**:
  - <2秒: 绿色
  - 2-5秒: 橙色
  - >5秒: 红色
- **查询**:
  ```promql
  rate(assistant_agent_llm_response_duration_seconds_sum[5m]) /
  rate(assistant_agent_llm_response_duration_seconds_count[5m])
  ```

**面板1.4: 每日成本（Stat面板）**
- **显示值**: ¥XXX.XX
- **阈值**:
  - <¥150: 绿色
  - ¥150-¥200: 橙色
  - >¥200: 红色
- **查询**:
  ```promql
  sum(increase(assistant_agent_cost_yuan[24h]))
  ```

---

**Row 2: 性能分析**

**面板2.1: 响应时间P50/P95/P99（折线图）**
- **X轴**: 时间
- **Y轴**: 响应时间（秒）
- **系列**:
  - P50（蓝色）
  - P95（橙色）
  - P99（红色）
- **查询**:
  ```promql
  # P50
  histogram_quantile(0.50, sum(rate(assistant_agent_llm_response_duration_seconds_bucket[5m])) by (le))

  # P95
  histogram_quantile(0.95, sum(rate(assistant_agent_llm_response_duration_seconds_bucket[5m])) by (le))

  # P99
  histogram_quantile(0.99, sum(rate(assistant_agent_llm_response_duration_seconds_bucket[5m])) by (le))
  ```

**面板2.2: 各工具响应时间对比（Bar chart）**
- **X轴**: 工具名称
- **Y轴**: 平均响应时间（秒）
- **查询**:
  ```promql
  avg by (tool) (
    rate(assistant_agent_llm_response_duration_seconds_sum[5m]) /
    rate(assistant_agent_llm_response_duration_seconds_count[5m])
  )
  ```

---

**Row 3: 置信度与质量**

**面板3.1: 置信度分布（饼图）**
- **系列**:
  - 0.9-1.0（高置信度，绿色）
  - 0.7-0.9（中等置信度，黄色）
  - 0.5-0.7（低置信度，橙色）
  - 0-0.5（极低置信度，红色）
- **查询**:
  ```promql
  sum by (bucket) (assistant_agent_confidence_score)
  ```

**面板3.2: 回复采纳率趋势（折线图）**
- **X轴**: 时间
- **Y轴**: 采纳率（百分比）
- **阈值线**: 70%（目标线，绿色虚线）
- **查询**:
  ```promql
  rate(assistant_agent_reply_accepted[5m]) /
  (rate(assistant_agent_reply_accepted[5m]) +
   rate(assistant_agent_reply_rejected[5m])) * 100
  ```

**面板3.3: 人工审核率（Stat面板）**
- **显示值**: 百分比
- **阈值**:
  - <30%: 绿色（自动化率高）
  - 30-50%: 橙色
  - >50%: 红色（自动化率低）
- **查询**:
  ```promql
  rate(assistant_agent_human_review_required[5m]) /
  rate(assistant_agent_llm_calls_total{result="success"}[5m]) * 100
  ```

---

**Row 4: 降级监控**

**面板4.1: 降级触发次数（柱状图）**
- **X轴**: 时间（小时）
- **Y轴**: 降级次数
- **系列**:
  - 降级1（关键词匹配，橙色）
  - 降级2（规则引擎，红色）
  - 降级3（人工介入，深红色）
- **查询**:
  ```promql
  sum by (fallback_level) (
    increase(assistant_agent_fallback_triggered[1h])
  )
  ```

**面板4.2: 降级原因分布（饼图）**
- **系列**:
  - LLM超时
  - API错误
  - 无匹配
- **查询**:
  ```promql
  sum by (reason) (
    increase(assistant_agent_fallback_triggered[24h])
  )
  ```

---

**Row 5: 成本与Token分析**

**面板5.1: 每日成本趋势（面积图）**
- **X轴**: 日期（最近30天）
- **Y轴**: 成本（人民币）
- **系列**:
  - DeepSeek成本（蓝色）
  - GPT-4成本（红色）
  - 总成本（黑色粗线）
- **阈值线**: ¥5000/月（告警线）
- **查询**:
  ```promql
  sum by (model) (increase(assistant_agent_cost_yuan[1d]))
  ```

**面板5.2: Token消耗趋势（折线图）**
- **X轴**: 时间
- **Y轴**: Token数/小时
- **系列**:
  - Prompt Tokens（蓝色）
  - Completion Tokens（绿色）
  - 总Token（黑色）
- **查询**:
  ```promql
  sum by (type) (
    rate(assistant_agent_tokens_used[5m]) * 3600
  )
  ```

**面板5.3: 平均单次Token消耗（Stat面板）**
- **显示值**: XXX tokens/次
- **查询**:
  ```promql
  rate(assistant_agent_tokens_used_sum[5m]) /
  rate(assistant_agent_llm_calls_total{result="success"}[5m])
  ```

---

**Row 6: 业务分析**

**面板6.1: 意图识别分布（饼图）**
- **系列**:
  - 咨询（inquiry，蓝色）
  - 投诉（complaint，红色）
  - 需求（requirement，绿色）
  - 故障（fault，橙色）
  - 表扬（praise，黄色）
- **查询**:
  ```promql
  sum by (intent) (
    increase(assistant_agent_intent_detected[24h])
  )
  ```

**面板6.2: 情感识别分布（柱状图）**
- **X轴**: 时间（小时）
- **Y轴**: 消息数量
- **系列**:
  - 正面（positive，绿色）
  - 中性（neutral，灰色）
  - 负面（negative，红色）
- **查询**:
  ```promql
  sum by (sentiment) (
    increase(assistant_agent_sentiment_detected[1h])
  )
  ```

**面板6.3: 负面情绪占比（Gauge仪表盘）**
- **单位**: 百分比
- **阈值**:
  - <10%: 绿色
  - 10-20%: 橙色
  - >20%: 红色
- **查询**:
  ```promql
  rate(assistant_agent_sentiment_detected{sentiment="negative"}[5m]) /
  rate(assistant_agent_sentiment_detected[5m]) * 100
  ```

---

#### 10.4 告警规则（Prometheus Alertmanager）

```yaml
groups:
  - name: AssistantAgent Alerts
    interval: 1m
    rules:
      # 告警1: LLM成功率低
      - alert: LLMSuccessRateLow
        expr: |
          rate(assistant_agent_llm_calls_total{result="success"}[5m]) /
          rate(assistant_agent_llm_calls_total[5m]) * 100 < 95
        for: 5m
        labels:
          severity: critical
          agent: AssistantAgent
        annotations:
          summary: "AssistantAgent LLM成功率低于95%"
          description: "当前成功率: {{ $value | humanizePercentage }}"

      # 告警2: 响应时间过长
      - alert: LLMResponseTimeSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(assistant_agent_llm_response_duration_seconds_bucket[5m]))
            by (le)
          ) > 5
        for: 10m
        labels:
          severity: warning
          agent: AssistantAgent
        annotations:
          summary: "AssistantAgent P95响应时间>5秒"
          description: "当前P95: {{ $value | humanizeDuration }}"

      # 告警3: 降级触发过多
      - alert: FallbackTooFrequent
        expr: |
          rate(assistant_agent_fallback_triggered{fallback_level="1"}[1h]) * 3600 > 100
        for: 5m
        labels:
          severity: warning
          agent: AssistantAgent
        annotations:
          summary: "AssistantAgent 降级1触发>100次/小时"
          description: "当前触发次数: {{ $value | humanize }}"

      # 告警4: 每日成本超预算
      - alert: DailyCostExceeded
        expr: |
          sum(increase(assistant_agent_cost_yuan[24h])) > 200
        for: 1h
        labels:
          severity: critical
          agent: AssistantAgent
        annotations:
          summary: "AssistantAgent 每日成本超过¥200"
          description: "当前成本: ¥{{ $value | humanize }}"

      # 告警5: Token消耗过高
      - alert: TokenUsageHigh
        expr: |
          sum(increase(assistant_agent_tokens_used[24h])) > 100000
        for: 1h
        labels:
          severity: warning
          agent: AssistantAgent
        annotations:
          summary: "AssistantAgent 每日Token消耗>100k"
          description: "当前消耗: {{ $value | humanize }} tokens"

      # 告警6: 回复采纳率低
      - alert: ReplyAdoptionRateLow
        expr: |
          rate(assistant_agent_reply_accepted[1h]) /
          (rate(assistant_agent_reply_accepted[1h]) +
           rate(assistant_agent_reply_rejected[1h])) * 100 < 60
        for: 2h
        labels:
          severity: warning
          agent: AssistantAgent
        annotations:
          summary: "AssistantAgent 回复采纳率<60%"
          description: "当前采纳率: {{ $value | humanizePercentage }}"
```

---

### 3.1.11 示例对话

#### 示例1: 常规咨询（高置信度自动回复）

**场景背景**: 普通客户咨询开发票流程，系统自动分析并生成回复建议

```
【客户】如何开发票？

【AssistantAgent思考过程】

Step 1: 调用analyzeConversation()
  → 输入: {
      conversationId: "CONV-12345",
      messageContent: "如何开发票？",
      channel: "web"
    }
  → 输出: {
      sentiment: "neutral",
      sentimentScore: 0.75,
      intent: "inquiry",
      priority: "normal",
      keywords: ["开发票"],
      confidence: 0.92
    }

Step 2: 调用getCustomerProfile()
  → 输入: {customerId: "CUST-001"}
  → 输出: {
      isVIP: false,
      healthScore: 85,
      riskLevel: "low",
      recentIssues: []
    }

Step 3: 判断 - 意图是inquiry，调用searchKnowledge()
  → 输入: {
      query: "开发票",
      topK: 3,
      minRelevance: 0.7
    }
  → 输出: {
      results: [
        {
          id: "KB-001",
          title: "开发票流程",
          relevance: 0.95,
          summary: "详细说明如何在系统中申请开票..."
        }
      ]
    }

Step 4: 调用generateReply()
  → 输入: {
      analysisResult: {...},
      customerProfile: {isVIP: false},
      knowledgeResults: [{id: "KB-001", ...}],
      tone: "friendly"
    }
  → 输出: {
      content: "您好！开发票流程如下：\n1. 进入【我的订单】\n2. 点击【申请发票】\n3. 填写发票信息\n4. 提交审核（1-3个工作日）\n\n如有其他问题，欢迎随时咨询！",
      tone: "friendly",
      confidence: 0.92
    }

Step 5: 调用recommendNextAction()
  → 判断: confidence=0.92 > 0.9 且 isVIP=false
  → 推荐: "send_reply"（v0.8+可自动发送）

【Agent最终输出】
{
  "analysis": {
    "sentiment": "neutral",
    "sentimentScore": 0.75,
    "intent": "inquiry",
    "priority": "normal",
    "keywords": ["开发票"],
    "confidence": 0.92
  },
  "customerContext": {
    "isVIP": false,
    "riskLevel": "low",
    "healthScore": 85
  },
  "suggestedReply": {
    "content": "您好！开发票流程如下：\n1. 进入【我的订单】\n2. 点击【申请发票】\n3. 填写发票信息\n4. 提交审核（1-3个工作日）\n\n如有其他问题，欢迎随时咨询！",
    "tone": "friendly",
    "confidence": 0.92,
    "knowledgeReferences": [
      {"id": "KB-001", "title": "开发票流程", "relevance": 0.95}
    ]
  },
  "nextActions": [
    {"action": "send_reply", "reason": "高置信度常规咨询", "priority": "normal"}
  ],
  "needHumanReview": false
}

【前端展示】
┌─────────────────────────────────────┐
│ AI辅助面板                           │
├─────────────────────────────────────┤
│ 💬 回复建议（置信度92%） ✅ 高置信度 │
│                                      │
│ 您好！开发票流程如下：                │
│ 1. 进入【我的订单】                   │
│ 2. 点击【申请发票】                   │
│ 3. 填写发票信息                       │
│ 4. 提交审核（1-3个工作日）             │
│                                      │
│ 如有其他问题，欢迎随时咨询！           │
│                                      │
│ 📚 参考：KB-001 开发票流程（相关度95%）│
│                                      │
│ 💡 推荐操作：直接发送                 │
│                                      │
│ [自动发送✨] [修改] [拒绝]            │
└─────────────────────────────────────┘

【客服操作】（v0.8+ Agent自动模式）
- v0.1/v0.5: 点击【采纳】→ 自动填入输入框 → 点击【发送】
- v0.8: 系统自动发送（置信度>0.9且非VIP）
- v1.0: 自动发送概率90%

【客户收到回复】（2秒内）
您好！开发票流程如下：
1. 进入【我的订单】
2. 点击【申请发票】
3. 填写发票信息
4. 提交审核（1-3个工作日）

如有其他问题，欢迎随时咨询！

【客户反馈】
满意（点击👍）

【Agent学习】
记录反馈: {
  "accepted": true,
  "confidence": 0.92,
  "knowledgeId": "KB-001"
}
→ 更新知识库相关度权重
```

**关键决策点**:
1. **为什么confidence=0.92**:
   - 情感分析明确（neutral，0.75分）
   - 意图识别准确（inquiry，关键词"开发票"匹配）
   - 知识库高度相关（KB-001，相关度0.95）
   - 生成回复结构完整（问候+步骤+结束语）

2. **为什么推荐自动发送**:
   - 置信度>0.9（超过阈值）
   - 非VIP客户（不需强制人工审核）
   - 风险等级low（无投诉/流失风险）
   - 常规咨询场景（知识库有明确答案）

---

#### 示例2: 负面情绪处理（VIP客户需人工审核）

**场景背景**: 金牌VIP客户因系统故障投诉，情绪负面，系统识别高风险并升级处理

```
【客户】你们系统太烂了，一直报错，影响我工作了！

【AssistantAgent思考过程】

Step 1: 调用analyzeConversation()
  → 输入: {messageContent: "你们系统太烂了，一直报错，影响我工作了！"}
  → 输出: {
      sentiment: "negative",
      sentimentScore: 0.25,  # 严重负面
      intent: "complaint",
      priority: "urgent",  # 自动升级
      keywords: ["系统", "报错", "影响工作"],
      confidence: 0.88
    }

Step 2: 调用getCustomerProfile()
  → 输入: {customerId: "CUST-VIP-001"}
  → 输出: {
      isVIP: true,
      vipLevel: "gold",  # 金牌VIP
      healthScore: 45,  # 健康度低（<50）
      riskLevel: "high",  # 高风险
      recentIssues: [
        "登录超时（2天前）",
        "数据加载慢（5天前）"
      ],
      contractInfo: {
        amount: 100000,
        expiryDate: "2025-12-31",
        slaLevel: "金牌VIP"
      }
    }

Step 3: 调用assessRisk()
  → 输入: {
      customerProfile: {isVIP: true, healthScore: 45},
      analysisResult: {sentiment: "negative", sentimentScore: 0.25}
    }
  → 输出: {
      overallRisk: "high",
      churnRisk: 0.75,  # 75%流失风险
      complaintRisk: 0.85,  # 85%投诉风险
      factors: [
        "连续3次负面反馈",
        "健康度评分低于50",
        "VIP客户且合同即将到期（<6个月）"
      ],
      recommendations: [
        "立即升级至高优先级处理",
        "安排专人回访",
        "提供补偿方案"
      ]
    }

Step 4: 调用searchKnowledge()
  → 输入: {query: "系统报错", topK: 3}
  → 输出: {results: []}  # 无具体解决方案（故障类问题）

Step 5: 调用generateReply(tone: "apologetic")
  → 输入: {
      customerProfile: {isVIP: true, vipLevel: "gold"},
      analysisResult: {sentiment: "negative"},
      knowledgeResults: [],
      tone: "apologetic"
    }
  → 输出: {
      content: "尊敬的用户，您好！非常抱歉给您带来困扰。\n\n我们已收到您的反馈，系统报错问题我们会立即安排技术团队排查。为了更快解决问题，我已将您的情况升级至高优先级处理。\n\n预计2小时内会有工程师联系您，请保持联系方式畅通。再次为给您带来的不便深表歉意。",
      tone: "apologetic",
      confidence: 0.88
    }

Step 6: 规则1触发 - VIP客户强制人工审核
  → isVIP=true
  → needHumanReview 强制设为 true

Step 7: 调用recommendNextAction()
  → 推荐: [
      "escalate_to_engineer"（紧急，VIP客户+系统故障）,
      "schedule_followup"（重要，负面情绪严重）
    ]

Step 8: 触发高优先级告警
  → 推送到Slack: "@售后经理 🔴 金牌VIP客户投诉（流失风险75%）"
  → 推送到邮件: "VIP客户紧急投诉预警"

【Agent最终输出】
{
  "analysis": {
    "sentiment": "negative",
    "sentimentScore": 0.25,
    "intent": "complaint",
    "priority": "urgent",
    "keywords": ["系统", "报错", "影响工作"],
    "confidence": 0.88
  },
  "customerContext": {
    "isVIP": true,
    "vipLevel": "gold",
    "riskLevel": "high",
    "healthScore": 45,
    "churnRisk": 0.75,
    "recentIssues": ["登录超时", "数据加载慢"]
  },
  "suggestedReply": {
    "content": "尊敬的用户，您好！非常抱歉给您带来困扰...",
    "tone": "apologetic",
    "confidence": 0.88,
    "knowledgeReferences": []
  },
  "nextActions": [
    {
      "action": "escalate_to_engineer",
      "reason": "VIP客户+系统故障",
      "priority": "urgent",
      "estimatedTime": "2小时内响应"
    },
    {
      "action": "schedule_followup",
      "reason": "负面情绪严重，需要后续关怀",
      "priority": "high",
      "dueDate": "2025-12-30"
    }
  ],
  "needHumanReview": true,
  "reviewReason": "VIP客户+负面情绪严重"
}

【前端展示】
┌─────────────────────────────────────┐
│ 🔴 高优先级 - 金牌VIP - 负面情绪      │
├─────────────────────────────────────┤
│ 客户画像：                            │
│ • 等级：金牌VIP（¥100,000合同）       │
│ • 健康度：45/100 (🔴危险)             │
│ • 风险等级：高                        │
│ • 流失概率：75% ⚠️                   │
│ • 近期问题：登录超时、数据加载慢       │
│                                      │
│ 💬 回复建议（需人工审核）              │
│                                      │
│ 尊敬的用户，您好！非常抱歉给您带来     │
│ 困扰。我们已收到您的反馈，系统报错问题 │
│ 我们会立即安排技术团队排查...         │
│                                      │
│ 📋 推荐操作：                         │
│ 1. [紧急] 转技术工程师（2小时内响应）  │
│ 2. [重要] 安排专人回访（明日联系）     │
│                                      │
│ ⚠️ 告警已发送至售后经理               │
│                                      │
│ [采纳] [修改] [拒绝]                 │
└─────────────────────────────────────┘

【客服操作】
1. 阅读Agent建议 + 客户画像
2. 修改回复，添加具体补偿方案：
   "为了表达我们的歉意，我们将为您免费延长3个月服务期限，并安排专属技术顾问全程跟进。"
3. 点击【发送】
4. 立即联系技术工程师张三（分配任务）
5. 在CRM中创建回访任务（明日9:00）

【后续自动化流程】
- Orchestrator自动将工单路由给EngineerAgent
- 创建Jira任务（优先级=P0）
- 2小时后自动发送进度通知
- 明日自动提醒客服回访

【客户收到回复】（5分钟内，经人工调整）
尊敬的用户，您好！非常抱歉给您带来困扰。

我们已收到您的反馈，系统报错问题我们会立即安排技术团队排查。为了更快解决问题，我已将您的情况升级至高优先级处理。

为了表达我们的歉意，我们将为您免费延长3个月服务期限，并安排专属技术顾问全程跟进。

预计2小时内会有工程师联系您，请保持联系方式畅通。再次为给您带来的不便深表歉意。

【工程师张三】（1.5小时后）
您好，我是技术工程师张三。关于您反馈的系统报错问题，我已经开始排查...
```

**关键决策点**:
1. **为什么needHumanReview=true**:
   - 规则1强制：isVIP=true → 必须人工审核
   - 负面情绪严重：sentimentScore=0.25（<0.5）
   - 高流失风险：churnRisk=75%
   - 涉及补偿决策（人工专属权限）

2. **为什么推荐"escalate_to_engineer"**:
   - 意图=complaint + 故障类关键词
   - 知识库无明确解决方案
   - VIP客户需要快速响应（SLA: 2小时）

3. **告警触发逻辑**:
   - VIP + negative + riskLevel=high → 自动告警
   - Slack推送@售后经理（实时）
   - 邮件通知（5分钟内）

---

#### 示例3: 多轮对话上下文理解（问题升级）

**场景背景**: 客户连续3轮对话反馈登录问题，常规方案无效，系统识别需升级工程师

```
【第1轮】
客户: "系统登录不上"

AssistantAgent分析:
  - intent: fault
  - priority: high
  - 回复建议: "请问您使用的是哪个版本？"

客服: （采纳回复）

【第2轮】
客户: "2.5版本"

AssistantAgent分析:
  - 上下文: 客户使用v2.5，遇到登录问题
  - extractRequirement()提取: {product: "ERP", version: "v2.5", issue: "登录失败"}
  - searchKnowledge("v2.5登录问题")
  - 回复建议: "请尝试清除浏览器缓存后重新登录"

客服: （采纳回复）

【第3轮】
客户: "还是不行"

【AssistantAgent思考过程】

Step 1: 调用analyzeConversation(includeHistory=true)
  → 输入: {
      messageContent: "还是不行",
      includeHistory: true,
      historyLimit: 5
    }
  → 输出: {
      sentiment: "neutral",
      sentimentScore: 0.60,  # 轻微负面（略低于neutral）
      intent: "fault",
      priority: "high",
      contextSummary: "客户使用v2.5，清除缓存后仍无法登录，常规方案已无效，需升级到工程师",
      confidence: 0.85
    }

Step 2: 分析历史对话模式
  → 识别: 连续3轮对话，都是登录问题
  → 已尝试方案: "清除缓存"
  → 问题状态: 未解决
  → 判断: 基础方案已无效，需要深度排查

Step 3: 调用recommendNextAction()
  → 判断: 常规方案失败 + 对话轮次>2
  → 推荐: "escalate_to_engineer"（原因：常规方案已无效）

【Agent最终输出】
{
  "analysis": {
    "sentiment": "neutral",
    "sentimentScore": 0.60,
    "intent": "fault",
    "priority": "high",
    "contextSummary": "客户使用v2.5，清除缓存后仍无法登录，需升级到工程师"
  },
  "suggestedReply": {
    "content": "了解了，常规方案无法解决您的问题。我已将您的情况升级至技术团队，工程师会在30分钟内联系您，帮助您深入排查。\n\n给您带来不便，非常抱歉。",
    "confidence": 0.85
  },
  "nextActions": [
    {
      "action": "escalate_to_engineer",
      "reason": "常规方案已无效，需要深度排查",
      "priority": "urgent"
    }
  ],
  "needHumanReview": false
}

【前端展示】
┌─────────────────────────────────────┐
│ ⚠️ 对话升级建议                      │
├─────────────────────────────────────┤
│ 📊 对话摘要：                         │
│ • 轮次：第3轮                         │
│ • 问题：v2.5登录失败                  │
│ • 已尝试：清除缓存                    │
│ • 状态：未解决                        │
│                                      │
│ 💬 回复建议（置信度85%）              │
│                                      │
│ 了解了，常规方案无法解决您的问题。     │
│ 我已将您的情况升级至技术团队，工程师会 │
│ 在30分钟内联系您，帮助您深入排查。    │
│                                      │
│ 📋 推荐操作：                         │
│ 1. [立即] 转技术工程师（30分钟内）     │
│                                      │
│ [采纳并转工程师] [仅采纳回复]         │
└─────────────────────────────────────┘

【客服操作】
点击【采纳并转工程师】
→ 自动发送回复
→ 自动创建工单并分配给EngineerAgent
→ 30分钟后自动提醒工程师跟进
```

**关键决策点**:
1. **为什么识别需要升级**:
   - 上下文分析：连续3轮对话，同一问题
   - 方案追踪：清除缓存方案已尝试，无效
   - 升级信号："还是不行"（明确的失败信号）

2. **为什么confidence=0.85（仍较高）**:
   - 虽然问题复杂，但升级决策明确
   - 上下文理解完整（产品、版本、问题、已尝试方案）
   - 推荐操作清晰（转工程师）

3. **避免重复询问**:
   - ❌ 不再问"使用哪个版本"（第2轮已知）
   - ❌ 不再问"尝试过清除缓存吗"（第2轮已建议）
   - ✅ 直接判断：常规方案无效 → 升级

---

## 3.2 EngineerAgent - 故障诊断

> **PRD格式**: Agent PRD（11章结构）
> **优先级**: P0
> **所属版本**: v0.1 + v0.8（增强）

### 3.2.1 Agent Profile

#### 1.1 身份定义

**Agent Name**: EngineerAgent

**Role**: 技术故障诊断专家Agent，负责技术问题分类、故障根因分析、解决方案推荐与技术工单管理

**核心定位**: EngineerAgent是智能售后工作台的技术诊断引擎，通过分析客户报告的技术问题、检索技术知识库、推理故障根因，为工程师提供精准的诊断建议和解决方案，提升技术支持效率和问题解决率。

**Personality**:
- **专业严谨**: 使用技术术语，避免模糊表述
- **逻辑清晰**: 诊断过程分步骤展示，便于理解
- **结果导向**: 快速定位问题，给出可执行方案
- **证据支撑**: 诊断结论基于日志、环境信息等证据

**Capabilities**:
- `diagnoseFault` (MCP): 故障诊断与根因分析
- `classifyIssue` (MCP): 技术问题分类（系统/功能/性能/配置）
- `searchTechnicalKB` (MCP): 技术知识库语义检索
- `analyzeLogs` (MCP): 日志模式识别与异常检测
- `recommendSolution` (MCP): 解决方案推荐与优先级排序
- `estimateResolutionTime` (MCP): 估算问题解决时间
- `createTechnicalTicket` (MCP): 创建技术工单并分配工程师

#### 1.2 能力边界

| 能做什么 | 不能做什么 |
|---------|-----------|
| ✅ 技术问题分类（系统/功能/性能/配置） | ❌ 不处理简单咨询（转AssistantAgent） |
| ✅ 故障根因分析（基于日志、环境信息） | ❌ 不直接修复代码（需人工工程师） |
| ✅ 解决方案推荐（从知识库、历史案例） | ❌ 不执行高风险操作（如数据删除） |
| ✅ 估算解决时间（基于历史数据） | ❌ 不替代人工决策（复杂故障需专家） |
| ✅ 创建技术工单并分配工程师 | ❌ 不处理需要定制开发的需求 |
| ✅ 识别常见故障模式（登录失败、超时、崩溃） | ❌ 不访问生产环境敏感数据 |
| ✅ 提供诊断报告（结构化输出） | ❌ 不绕过安全审核机制 |

#### 1.3 响应风格

**语气规范**:
- **技术工程师**: 专业、精准、使用标准技术术语
- **非技术客户**: 通俗易懂、避免术语、提供图文说明
- **紧急故障**: 快速定位、简洁方案、明确时间预期

**格式偏好**:
- **输出格式**: 结构化JSON（便于工单系统集成）
- **诊断结构**: 问题描述 → 根因分析 → 解决方案 → 预估时间
- **证据引用**: 明确标注日志片段、错误码、环境信息来源

**长度控制**:
- **简单故障**: 100-150字（常见问题，知识库有方案）
- **中等复杂**: 150-250字（需要多步骤排查）
- **复杂故障**: 250-500字（需要详细诊断报告）

**特殊要求**:
- 紧急故障（P0/P1）优先响应，<5分钟给出初步诊断
- 涉及数据丢失/安全漏洞的问题立即升级
- 技术术语附加通俗解释（面向非技术客户时）
- 解决方案提供风险评估（如"可能导致服务重启"）

---

### 3.2.2 提示词变更记录

#### 2.1 变更历史

| 版本 | 变更内容 | 变更原因 | 日期 | 变更人 |
|-----|---------|---------|------|--------|
| v0.1 | 初始Prompt：基础故障分类+解决方案推荐 | 首次创建MVP版本 | 2024-10 | 产品团队 |
| v0.5 | 增强日志分析能力+历史案例检索 | 提升诊断准确率 | 2025-03 | 产品团队 |
| v0.8 | 增加根因分析+自动工单创建 | 提升自动化率 | 2025-07 | 产品团队 |
| v1.0 | 性能问题诊断+预测性维护 | 商业化标准版 | 2025-11 | 产品团队 |

#### 2.2 当前版本Prompt（v1.0完整版）

```
你是专业的技术故障诊断专家 EngineerAgent。

---

## 核心职责

1. **问题分类**: 精准识别技术问题类型（system/function/performance/configuration）
2. **故障诊断**: 分析日志、环境信息，定位根因
3. **方案推荐**: 基于知识库和历史案例，提供可执行解决方案
4. **时间估算**: 根据问题复杂度和历史数据，估算解决时间
5. **工单管理**: 自动创建技术工单，分配合适工程师
6. **证据收集**: 提取关键日志片段、错误码、环境参数

---

## 输出格式（必须是严格的JSON）

```json
{
  "diagnosis": {
    "issueType": "system|function|performance|configuration",
    "severity": "P0|P1|P2|P3",
    "category": "具体分类（如login_failure/timeout/crash）",
    "rootCause": "根因分析（简洁描述）",
    "affectedComponents": ["组件1", "组件2"],
    "confidence": 0.85
  },
  "evidence": {
    "logs": [
      {
        "timestamp": "2025-12-29T10:00:00Z",
        "level": "ERROR",
        "message": "日志片段",
        "source": "服务名称"
      }
    ],
    "environment": {
      "version": "v2.5.3",
      "os": "Ubuntu 20.04",
      "browser": "Chrome 120"
    },
    "errorCodes": ["ERR_CONNECTION_TIMEOUT"]
  },
  "solutions": [
    {
      "title": "解决方案标题",
      "steps": ["步骤1", "步骤2", "步骤3"],
      "priority": "recommended|alternative",
      "estimatedTime": "30分钟",
      "riskLevel": "low|medium|high",
      "kbReference": "KB-T-001",
      "successRate": 0.92
    }
  ],
  "nextActions": [
    {
      "action": "execute_solution|escalate_to_expert|create_ticket|request_more_info",
      "reason": "原因说明",
      "assignee": "工程师姓名或团队"
    }
  ],
  "estimatedResolutionTime": "2小时",
  "needExpertReview": false,
  "reviewReason": "复杂故障|数据风险|安全问题"
}
```

---

## 处理流程

### Step 1: 问题分类
1. 识别问题类型（issueType）：
   - `system`: 系统级故障（登录失败、服务崩溃、数据库连接异常）
   - `function`: 功能异常（功能不工作、计算错误、流程中断）
   - `performance`: 性能问题（响应慢、超时、内存泄漏）
   - `configuration`: 配置错误（参数错误、权限不足、环境问题）

2. 评估严重性（severity）：
   - `P0`: 紧急（服务不可用、数据丢失、安全漏洞）
   - `P1`: 高（核心功能异常、大量用户受影响）
   - `P2`: 中（非核心功能异常、部分用户受影响）
   - `P3`: 低（体验问题、边缘情况）

3. 细分类别（category）：
   - 登录失败：`login_failure`
   - 超时：`timeout`
   - 崩溃：`crash`
   - 数据不一致：`data_inconsistency`
   - 权限错误：`permission_denied`

### Step 2: 证据收集
调用 `analyzeLogs()` 提取关键信息：
- 错误日志片段（ERROR/FATAL级别）
- 错误码（如HTTP 500、数据库错误码）
- 环境信息（版本、操作系统、浏览器）
- 用户操作路径（复现步骤）

### Step 3: 根因分析
基于证据推理故障根因：
1. **模式匹配**: 与历史故障模式对比
2. **依赖分析**: 检查相关组件状态
3. **时序分析**: 分析故障发生时间与系统变更
4. **概率推理**: 计算各可能根因的置信度

### Step 4: 检索知识库
调用 `searchTechnicalKB()` 检索相关解决方案：
- 语义匹配度>0.7的技术文档
- 历史相似案例（问题描述、解决方案、成功率）
- 最多返回3个推荐方案

### Step 5: 生成解决方案
根据知识库和根因分析生成方案：
1. **推荐方案**（priority=recommended）：
   - 成功率>90%
   - 风险低
   - 执行时间短
2. **备选方案**（priority=alternative）：
   - 适用于推荐方案失败的情况
   - 可能需要更多时间或权限

每个方案包含：
- 具体步骤（可执行）
- 预估时间
- 风险等级
- 知识库引用

### Step 6: 时间估算
调用 `estimateResolutionTime()` 基于：
- 问题复杂度
- 历史相似案例平均解决时间
- 当前工程师负载

### Step 7: 决策下一步
根据诊断结果决定操作：
- `execute_solution`: 方案明确，可执行（置信度>0.8）
- `escalate_to_expert`: 复杂故障，需专家介入
- `create_ticket`: 创建工单，分配工程师
- `request_more_info`: 信息不足，需要客户提供更多细节

---

## 特殊规则

### 规则1: 紧急故障快速响应
如果 `severity = "P0"`：
- 优先级自动提升
- 推送告警到技术负责人
- 估算时间缩短到最快方案
- 必须提供临时缓解方案（workaround）

### 规则2: 数据安全优先
如果涉及数据丢失、安全漏洞：
- 强制设置 `needExpertReview = true`
- 所有方案标注风险等级
- 推荐备份数据的步骤

### 规则3: 证据不足时主动询问
如果日志、环境信息缺失：
- 生成问题清单（checklist）
- 指导客户如何收集信息
- 不基于猜测给出方案

### 规则4: 历史案例优先
如果找到相似历史案例（相似度>0.85）：
- 直接引用成功方案
- 标注案例ID和成功率
- 附加当时的解决时间

### 规则5: 性能问题专项诊断（v1.0新增）
如果 `issueType = "performance"`：
- 分析性能瓶颈（CPU/内存/网络/数据库）
- 提供性能监控建议
- 推荐优化方案

---

## 示例

### 示例1: 登录失败（系统故障）
**输入**: "用户反馈无法登录，提示'网络连接超时'"

**输出**:
```json
{
  "diagnosis": {
    "issueType": "system",
    "severity": "P1",
    "category": "login_failure",
    "rootCause": "认证服务响应超时，疑似数据库连接池耗尽",
    "affectedComponents": ["AuthService", "DatabasePool"],
    "confidence": 0.85
  },
  "evidence": {
    "logs": [
      {
        "timestamp": "2025-12-29T09:58:23Z",
        "level": "ERROR",
        "message": "Connection timeout after 30s",
        "source": "auth-service"
      }
    ],
    "environment": {
      "version": "v2.5.3",
      "os": "Ubuntu 20.04"
    },
    "errorCodes": ["ERR_CONNECTION_TIMEOUT"]
  },
  "solutions": [
    {
      "title": "重启认证服务并扩容数据库连接池",
      "steps": [
        "1. 重启auth-service（docker restart auth-service）",
        "2. 修改database.yml，将max_connections从50提升到100",
        "3. 重启应用（docker-compose restart）",
        "4. 验证登录功能"
      ],
      "priority": "recommended",
      "estimatedTime": "15分钟",
      "riskLevel": "low",
      "kbReference": "KB-T-015",
      "successRate": 0.95
    }
  ],
  "nextActions": [
    {
      "action": "create_ticket",
      "reason": "需要运维权限执行重启",
      "assignee": "运维团队"
    }
  ],
  "estimatedResolutionTime": "30分钟",
  "needExpertReview": false
}
```

### 示例2: 性能问题（响应慢）
**输入**: "客户反馈系统打开很慢，加载超过10秒"

**输出**:
```json
{
  "diagnosis": {
    "issueType": "performance",
    "severity": "P2",
    "category": "slow_response",
    "rootCause": "数据库慢查询，缺少索引导致全表扫描",
    "affectedComponents": ["DatabaseQuery", "OrderService"],
    "confidence": 0.78
  },
  "evidence": {
    "logs": [
      {
        "timestamp": "2025-12-29T10:05:12Z",
        "level": "WARN",
        "message": "Slow query: SELECT * FROM orders WHERE customer_id = '123' (8.5s)",
        "source": "postgresql"
      }
    ]
  },
  "solutions": [
    {
      "title": "添加customer_id索引",
      "steps": [
        "1. 连接数据库：psql -U admin -d production",
        "2. 创建索引：CREATE INDEX idx_orders_customer_id ON orders(customer_id);",
        "3. 验证查询性能：EXPLAIN ANALYZE SELECT * FROM orders WHERE customer_id = '123';",
        "4. 清理查询缓存"
      ],
      "priority": "recommended",
      "estimatedTime": "10分钟",
      "riskLevel": "low",
      "kbReference": "KB-T-032",
      "successRate": 0.92
    }
  ],
  "nextActions": [
    {
      "action": "execute_solution",
      "reason": "方案成熟，风险低",
      "assignee": "DBA团队"
    }
  ],
  "estimatedResolutionTime": "20分钟",
  "needExpertReview": false
}
```

---

## 边界与限制

### 不处理的场景
1. **产品需求**: "能不能增加XX功能？" → 转产品团队
2. **简单咨询**: "如何修改密码？" → 转AssistantAgent
3. **定制开发**: "需要定制报表" → 转项目团队
4. **业务决策**: "是否升级到新版本？" → 转管理层

### 降级处理
- **日志缺失**: 指导客户收集日志，不基于猜测诊断
- **知识库无匹配**: 创建工单，分配高级工程师
- **复杂故障（置信度<0.6）**: 标记需专家审核
- **环境信息不足**: 生成信息收集清单

---

**重要**: 技术诊断需要证据支撑，遇到信息不足时主动询问，不基于猜测给出方案。复杂故障优先转专家，确保诊断质量。
```

#### 2.3 版本Prompt Diff

> 本节仅在增量PRD中使用，基线PRD记录最终版本

**v0.5相对v0.1的变更**:
```diff
核心职责:
1. 问题分类
2. 故障诊断
3. 方案推荐
4. 时间估算
+ 5. 日志分析能力增强（新增analyzeLogs工具）
+ 6. 历史案例检索（新增相似案例匹配）

输出格式:
{
  "diagnosis": {...},
+ "evidence": {
+   "logs": [...],
+   "environment": {...}
+ },
  "solutions": [...]
}
```

**v0.8相对v0.5的变更**:
```diff
核心职责:
1. 问题分类
2. 故障诊断
3. 方案推荐
4. 时间估算
5. 日志分析
6. 历史案例检索
+ 7. 根因分析（新增rootCause推理）
+ 8. 自动工单创建（新增createTechnicalTicket工具）

输出格式:
{
  "diagnosis": {
    "issueType": "...",
+   "rootCause": "根因分析",
+   "affectedComponents": ["组件列表"]
  }
}
```

**v1.0相对v0.8的变更**:
```diff
核心职责:
+ 9. 性能问题专项诊断（新增性能瓶颈分析）
+ 10. 预测性维护（识别潜在故障）

特殊规则:
+ 规则5: 性能问题专项诊断（新增）
+ 如果 issueType = "performance"，分析性能瓶颈
```

---

### 3.2.3 工具清单

#### 工具1: diagnoseFault

**功能描述**: 综合分析技术问题，定位故障根因，输出结构化诊断报告

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 | 默认值 |
|-------|------|------|------|------|--------|
| issueDescription | string | 是 | 问题描述 | 长度10-1000字符 | - |
| customerEnvironment | object | 否 | 环境信息 | 包含version/os/browser | - |
| logs | array | 否 | 日志片段 | 最多100行 | [] |
| reproSteps | array | 否 | 复现步骤 | 最多20步 | [] |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "diagnosis": {
      "issueType": "system|function|performance|configuration",
      "severity": "P0|P1|P2|P3",
      "category": "login_failure|timeout|crash|...",
      "rootCause": "根因分析描述",
      "affectedComponents": ["组件1", "组件2"],
      "confidence": 0.85
    },
    "evidence": {
      "keyLogs": ["关键日志片段"],
      "errorCodes": ["错误码列表"],
      "suspiciousPatterns": ["可疑模式"]
    }
  },
  "metadata": {
    "processingTime": 2.3,
    "model": "deepseek-v3.1",
    "similarCasesFound": 5
  }
}
```

**字段说明**:
| 字段名 | 类型 | 说明 | 取值范围 |
|-------|------|------|---------| | issueType | string | 问题类型 | system/function/performance/configuration |
| severity | string | 严重程度 | P0/P1/P2/P3 |
| category | string | 细分类别 | 具体故障分类 |
| rootCause | string | 根因分析 | 简洁描述 |
| confidence | number | 诊断置信度 | 0-1 |

**调用方式**: MCP (Model Context Protocol)

**特性**:
- **模式识别**: 自动识别常见故障模式（登录失败、超时、崩溃）
- **根因推理**: 基于日志和环境信息推理根本原因
- **置信度评估**: 每次诊断返回置信度，<0.6时自动标记需专家审核
- **历史案例匹配**: 检索相似历史故障，参考成功方案

**注意事项**:
- 日志最多分析最近100行，超过自动截取最关键部分
- 诊断超时30秒自动降级到规则引擎
- P0/P1故障优先级提升，<5分钟给出初步诊断

**调用示例**:
```json
// 请求
{
  "issueDescription": "用户无法登录，提示网络超时",
  "customerEnvironment": {
    "version": "v2.5.3",
    "os": "Ubuntu 20.04",
    "browser": "Chrome 120"
  },
  "logs": [
    "[2025-12-29 09:58:23] ERROR: Connection timeout after 30s"
  ]
}

// 响应
{
  "success": true,
  "data": {
    "diagnosis": {
      "issueType": "system",
      "severity": "P1",
      "category": "login_failure",
      "rootCause": "认证服务响应超时，疑似数据库连接池耗尽",
      "affectedComponents": ["AuthService", "DatabasePool"],
      "confidence": 0.85
    }
  }
}
```

---

#### 工具2: classifyIssue

**功能描述**: 快速分类技术问题类型和严重程度，用于问题分流和优先级排序

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| issueDescription | string | 是 | 问题描述 |
| customerProfile | object | 否 | 客户画像（VIP等级） |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "issueType": "system",
    "severity": "P1",
    "category": "login_failure",
    "suggestedTeam": "运维团队",
    "estimatedComplexity": "medium",
    "confidence": 0.88
  }
}
```

**调用方式**: MCP

**特性**:
- **快速分类**: <1秒返回分类结果
- **智能分流**: 推荐最适合的处理团队
- **复杂度评估**: 估算问题复杂度（simple/medium/complex）

---

#### 工具3: searchTechnicalKB

**功能描述**: 技术知识库语义检索，匹配相关解决方案和历史案例

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| query | string | 是 | 查询文本 | 长度10-200字符 |
| issueType | string | 否 | 问题类型过滤 | system/function/performance/configuration |
| topK | number | 否 | 返回结果数量 | 1-5，默认3 |
| minRelevance | number | 否 | 最低相关度 | 0-1，默认0.7 |
| includeHistoricalCases | boolean | 否 | 是否包含历史案例 | 默认true |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "technicalDocs": [
      {
        "id": "KB-T-015",
        "title": "认证服务超时排查",
        "solution": "重启auth-service并扩容连接池",
        "relevance": 0.92,
        "successRate": 0.95,
        "averageResolutionTime": "30分钟"
      }
    ],
    "historicalCases": [
      {
        "caseId": "CASE-12345",
        "similarity": 0.88,
        "resolvedBy": "张工程师",
        "resolutionTime": "25分钟",
        "solution": "..."
      }
    ]
  }
}
```

**调用方式**: MCP

**特性**:
- **语义理解**: 基于向量检索，支持同义词匹配
- **历史案例**: 检索相似历史故障，参考成功方案
- **成功率标注**: 每个方案附带历史成功率

---

#### 工具4: analyzeLogs

**功能描述**: 日志模式识别与异常检测，提取关键错误信息

**分类**: Query（查询类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| logs | array | 是 | 日志行数组 |
| maxLines | number | 否 | 最大分析行数（默认100） |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "keyFindings": [
      {
        "pattern": "Connection timeout",
        "occurrences": 15,
        "severity": "HIGH",
        "relatedComponents": ["AuthService"]
      }
    ],
    "errorCodes": ["ERR_CONNECTION_TIMEOUT"],
    "suspiciousTimestamps": ["2025-12-29T09:58:23Z"],
    "recommendation": "数据库连接池耗尽，建议扩容"
  }
}
```

**调用方式**: MCP

**特性**:
- **模式识别**: 自动识别异常日志模式
- **频率统计**: 统计错误出现频率
- **时序关联**: 关联时间戳，识别故障时间窗口

---

#### 工具5: recommendSolution

**功能描述**: 基于诊断结果和知识库，生成可执行解决方案

**分类**: Ingest（生成类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| diagnosisResult | object | 是 | diagnoseFault的输出 |
| kbResults | array | 是 | searchTechnicalKB的输出 |
| customerPriority | string | 否 | 客户优先级（VIP/normal） |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "recommendedSolution": {
      "title": "重启认证服务并扩容数据库连接池",
      "steps": [
        "1. 重启auth-service",
        "2. 修改database.yml，max_connections提升到100",
        "3. 重启应用",
        "4. 验证登录功能"
      ],
      "estimatedTime": "15分钟",
      "riskLevel": "low",
      "kbReference": "KB-T-015",
      "successRate": 0.95
    },
    "alternativeSolutions": [
      {
        "title": "备选方案...",
        "steps": [...],
        "estimatedTime": "30分钟",
        "riskLevel": "medium"
      }
    ]
  }
}
```

**调用方式**: MCP

**特性**:
- **风险评估**: 每个方案标注风险等级（low/medium/high）
- **时间估算**: 基于历史数据估算执行时间
- **多方案推荐**: 提供推荐方案+备选方案

---

#### 工具6: estimateResolutionTime

**功能描述**: 估算问题解决时间，基于历史数据和当前工程师负载

**分类**: Insight（洞察类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| issueType | string | 是 | 问题类型 |
| severity | string | 是 | 严重程度 |
| complexity | string | 是 | 复杂度 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "estimatedTime": "2小时",
    "confidence": 0.75,
    "basedOn": "15个相似历史案例",
    "factors": [
      "问题复杂度: medium",
      "团队负载: 3个待处理工单",
      "平均解决时间: 1.8小时"
    ]
  }
}
```

**调用方式**: MCP

---

#### 工具7: createTechnicalTicket

**功能描述**: 自动创建技术工单并分配合适工程师

**分类**: Ingest（生成类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| diagnosisResult | object | 是 | 诊断结果 |
| recommendedSolution | object | 是 | 推荐方案 |
| assignee | string | 否 | 指定工程师 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "ticketId": "TICKET-67890",
    "assignee": "张工程师",
    "priority": "P1",
    "estimatedResolutionTime": "2小时",
    "createdAt": "2025-12-29T10:00:00Z"
  }
}
```

**调用方式**: MCP

**特性**:
- **智能分配**: 根据工程师专长和负载自动分配
- **优先级继承**: 继承诊断结果的优先级
- **SLA跟踪**: 自动计算SLA截止时间

---

### 3.2.4 沉淀Skills

> 仅用于迭代版本（提炼上一版本已验证的功能）

#### 4.1 fault_diagnosis_skill

**适用场景**: 客户报告技术问题后，自动诊断并推荐解决方案

**触发条件**: `TechnicalIssuereportedEvent`（技术问题上报事件）

**标准流程**:
1. 调用`classifyIssue()`快速分类问题类型和严重性
2. 如果`severity=P0/P1`，立即推送告警到技术负责人
3. 调用`diagnoseFault()`进行深度诊断
4. 调用`searchTechnicalKB()`检索解决方案
5. 调用`recommendSolution()`生成可执行方案
6. 如果`confidence>0.8`，推荐方案；否则创建工单分配工程师

**质量门禁**:
- 诊断准确率>80%（基于工程师反馈）
- 响应时间<5秒（P95）
- 置信度<0.6时自动标记需专家审核

**回滚策略**:
- **LLM超时**: 降级到规则引擎（基于关键词匹配）
- **知识库无匹配**: 创建工单，分配高级工程师
- **日志缺失**: 指导客户收集日志，暂不诊断

**可观测性**:
- 记录每次诊断的置信度分布
- 监控诊断准确率（工程师反馈）
- 统计问题类型分布（system/function/performance/configuration）

---

#### 4.2 historical_case_matching_skill

**适用场景**: 基于历史案例推荐成功方案，提升解决效率

**触发条件**: `DiagnosisCompletedEvent`（诊断完成事件）

**标准流程**:
1. 调用`searchTechnicalKB(includeHistoricalCases=true)`检索相似案例
2. 如果找到相似度>0.85的案例，直接引用成功方案
3. 标注案例ID、成功率、解决时间
4. 如果无相似案例，基于知识库生成新方案

**质量门禁**:
- 相似案例匹配准确率>85%
- 案例推荐方案成功率>90%

**可观测性**:
- 统计历史案例命中率
- 跟踪案例推荐方案成功率

---

#### 4.3 auto_ticket_creation_skill

**适用场景**: 复杂故障自动创建工单并分配工程师

**触发条件**: `ComplexIssueDiagnosedEvent`（复杂问题诊断事件）

**标准流程**:
1. 如果`confidence<0.8` OR `severity=P0` OR `complexity=complex`
2. 调用`createTechnicalTicket()`创建工单
3. 根据问题类型智能分配工程师（系统→运维、性能→DBA）
4. 推送通知到工程师
5. 记录到工单系统

**质量门禁**:
- 工单自动分配准确率>85%
- 工单创建成功率>99%

**可观测性**:
- 统计自动工单创建率
- 跟踪工单解决率和平均解决时间

---

### 3.2.5 业务场景

#### 场景1: 登录失败诊断

**场景描述**: 客户报告无法登录，系统自动诊断并推荐解决方案

**触发条件**: 客户发送技术问题描述，包含"登录"、"无法登录"等关键词

**前置条件**:
- 客户提供问题描述
- 系统可访问日志（可选）
- 环境信息（版本、浏览器）

**处理流程**:
```mermaid
sequenceDiagram
    Customer->>Frontend: 报告问题"无法登录"
    Frontend->>Backend: POST /api/issues/diagnose
    Backend->>EngineerAgent: 触发TechnicalIssueReportedEvent
    EngineerAgent->>MCP: classifyIssue()
    MCP-->>EngineerAgent: {issueType: "system", severity: "P1"}
    EngineerAgent->>MCP: diagnoseFault()
    MCP-->>EngineerAgent: {rootCause: "认证服务超时"}
    EngineerAgent->>MCP: searchTechnicalKB("登录失败")
    MCP-->>EngineerAgent: [KB-T-015: 重启认证服务方案]
    EngineerAgent->>MCP: recommendSolution()
    MCP-->>EngineerAgent: {推荐方案+备选方案}
    EngineerAgent->>Backend: 诊断报告
    Backend-->>Frontend: 返回诊断结果
    Frontend->>Engineer: 展示诊断报告
    Engineer->>Frontend: 执行推荐方案
```

**对话示例**:
```
【客户】无法登录系统，提示"网络连接超时"

【EngineerAgent思考过程】

Step 1: 调用classifyIssue()
  → 输入: {issueDescription: "无法登录，提示网络超时"}
  → 输出: {
      issueType: "system",
      severity: "P1",
      category: "login_failure",
      confidence: 0.92
    }

Step 2: 判断 - severity=P1 → 推送告警到技术负责人

Step 3: 调用diagnoseFault()
  → 输入: {
      issueDescription: "无法登录，提示网络超时",
      logs: ["[ERROR] Connection timeout after 30s"]
    }
  → 输出: {
      rootCause: "认证服务响应超时，疑似数据库连接池耗尽",
      confidence: 0.85
    }

Step 4: 调用searchTechnicalKB("登录失败 超时")
  → 输出: [
      {
        id: "KB-T-015",
        title: "认证服务超时排查",
        successRate: 0.95
      }
    ]

Step 5: 调用recommendSolution()
  → 输出: {
      recommendedSolution: {
        title: "重启认证服务并扩容数据库连接池",
        steps: [
          "1. 重启auth-service",
          "2. 修改database.yml，max_connections提升到100",
          "3. 重启应用",
          "4. 验证登录功能"
        ],
        estimatedTime: "15分钟",
        riskLevel: "low",
        successRate: 0.95
      }
    }

【前端展示】
┌─────────────────────────────────────┐
│ 故障诊断报告                          │
├─────────────────────────────────────┤
│ 🔍 诊断结果：                         │
│ • 问题类型：系统故障（登录失败）       │
│ • 严重程度：P1（高优先级）            │
│ • 根本原因：认证服务响应超时          │
│ • 影响组件：AuthService, DatabasePool │
│ • 置信度：85%                        │
│                                      │
│ 💡 推荐方案：                         │
│ 重启认证服务并扩容数据库连接池         │
│ 1. 重启auth-service                  │
│ 2. 修改database.yml，max_connections │
│    提升到100                          │
│ 3. 重启应用                          │
│ 4. 验证登录功能                      │
│                                      │
│ ⏱️ 预估时间：15分钟                  │
│ ⚠️ 风险等级：低                      │
│ 📊 成功率：95%                       │
│ 📚 参考：KB-T-015                    │
│                                      │
│ [执行方案] [创建工单] [查看备选方案]  │
└─────────────────────────────────────┘

【工程师操作】
点击【执行方案】→ 按步骤执行 → 15分钟后验证 → 问题解决
```

**预期输出**:
- 问题类型识别正确：system / login_failure
- 根因分析合理：认证服务超时
- 推荐方案可执行：具体步骤清晰
- 时间估算准确：±5分钟误差

**异常分支**:
| 异常情况 | 处理方式 |
|---------|---------|
| 日志缺失 | 指导客户收集日志，暂不诊断 |
| 知识库无匹配 | 创建工单，分配高级工程师 |
| 置信度<0.6 | 标记需专家审核 |
| LLM超时 | 降级到规则引擎 |

**成功标准**:
- ✅ 诊断准确率>80%
- ✅ 方案推荐可执行性>90%
- ✅ 响应时间<5秒（P95）
- ✅ 工程师采纳率>70%

---

#### 场景2: 性能问题诊断

**场景描述**: 客户反馈系统响应慢，系统分析性能瓶颈并推荐优化方案

**对话示例**:
```
【客户】系统打开很慢，加载超过10秒

【EngineerAgent思考过程】

Step 1: classifyIssue()
  → {issueType: "performance", severity: "P2", category: "slow_response"}

Step 2: diagnoseFault() + analyzeLogs()
  → 分析慢查询日志
  → {rootCause: "数据库慢查询，缺少索引", confidence: 0.78}

Step 3: searchTechnicalKB("性能优化 慢查询")
  → {KB-T-032: 添加索引优化方案}

Step 4: recommendSolution()
  → {
      title: "添加customer_id索引",
      steps: [
        "1. 连接数据库",
        "2. 创建索引",
        "3. 验证查询性能"
      ],
      estimatedTime: "10分钟",
      riskLevel: "low"
    }

【前端展示】
🐌 性能问题诊断
• 根本原因：数据库慢查询（缺少索引）
• 慢查询SQL：SELECT * FROM orders WHERE customer_id = '123' (8.5s)
• 推荐方案：添加customer_id索引
• 预估优化后：查询时间<100ms
```

---

#### 场景3: 复杂故障升级

**场景描述**: 系统崩溃，日志复杂，自动创建工单分配高级工程师

**对话示例**:
```
【客户】整个系统崩溃了，所有用户都无法访问

【EngineerAgent思考过程】

Step 1: classifyIssue()
  → {issueType: "system", severity: "P0", category: "crash"}

Step 2: 判断 - severity=P0 → 立即推送紧急告警

Step 3: diagnoseFault()
  → 分析多个服务日志
  → {rootCause: "未知，需深度排查", confidence: 0.45}

Step 4: 判断 - confidence<0.6 → 创建工单，分配专家

Step 5: createTechnicalTicket()
  → {
      ticketId: "TICKET-12345",
      assignee: "高级架构师",
      priority: "P0",
      sla: "1小时内响应"
    }

【前端展示】
🚨 紧急故障 - 已自动升级
• 严重程度：P0（系统不可用）
• 诊断置信度：45%（需专家介入）
• 已创建工单：TICKET-12345
• 分配给：高级架构师
• SLA：1小时内响应
```

---

### 3.2.6 人机协作边界

#### 6.1 Agent主导场景（高自动化）

**适用条件**:
- 常见故障（login_failure/timeout/permission_denied）
- 知识库有明确方案（相关度>0.8）
- 诊断置信度>0.8
- 低风险操作（riskLevel=low）
- 非P0故障

**Agent行为**:
1. 自动诊断故障类型和根因
2. 检索知识库，匹配成功方案
3. 生成可执行解决方案
4. **v0.1-v0.5**: 推送建议，需工程师确认后执行
5. **v0.8**: 低风险方案可自动执行（需配置权限）
6. **v1.0**: 自动化率提升到70%（常见故障）

**自动化率目标**:
- **v0.1**: 0%（全部人工审核）
- **v0.5**: 30%（推荐方案，人工执行）
- **v0.8**: 70%（常见故障自动推荐+执行）
- **v1.0**: 85%（扩大自动化范围）

**示例**:
```
场景：客户报告"登录失败"
→ 诊断：认证服务超时
→ 置信度：0.92
→ 方案：重启auth-service
→ 风险：low
→ v0.8行为：自动推荐方案，工程师一键执行
→ v1.0行为：低风险自动执行，工程师监控
```

---

#### 6.2 人工主导场景（低自动化）

**适用条件**:
- P0故障（系统不可用）
- 复杂故障（置信度<0.6）
- 高风险操作（riskLevel=high，如数据删除）
- 涉及数据安全/隐私
- 需要定制开发
- 生产环境操作（需审批）

**Agent行为**:
1. 提供初步诊断结果（仅供参考）
2. 推荐相关知识库文档
3. 展示历史相似案例
4. **永远需要人工审核，不自动执行**
5. 创建工单，分配高级工程师

**自动化率目标**:
- **所有版本**: 0%（刻意保持人工）

**示例**:
```
场景：系统崩溃，影响所有用户
→ 严重程度：P0
→ 诊断：多个组件异常，根因未知
→ 置信度：0.45
→ Agent行为：
   - 提供初步诊断："可能是数据库主从同步失败"
   - 推荐文档：KB-T-099（数据库故障排查）
   - 创建P0工单，分配高级架构师
   - 推送紧急告警到技术负责人
→ 工程师行为：
   - 查看Agent诊断报告
   - 深度排查日志和监控
   - 人工决策解决方案
   - 执行修复并验证
```

---

#### 6.3 协作模式（Agent辅助，人工决策）

**适用条件**:
- 中等复杂度故障
- 诊断置信度0.6-0.8
- 中等风险操作（riskLevel=medium）
- 需要多个方案组合
- P1/P2故障

**Agent行为**:
1. 生成2-3种解决方案（推荐+备选）
2. 标注每个方案的风险、时间、成功率
3. 人工选择或组合方案
4. 人工执行并监控

**决策流程**:
```
Agent诊断 → 生成多方案 → 人工评估 → 人工选择 → 人工执行 → Agent学习反馈
```

**示例**:
```
场景：性能问题（慢查询）
→ 诊断：数据库缺少索引
→ 置信度：0.75

Agent提供3个方案：
1. 推荐方案：添加customer_id索引（风险低，10分钟）
   - 成功率：92%
   - 缺点：索引创建期间可能短暂锁表

2. 备选方案：缓存查询结果（风险中，30分钟）
   - 成功率：85%
   - 优点：不修改数据库结构
   - 缺点：缓存一致性问题

3. 长期方案：分库分表（风险高，2周）
   - 成功率：98%
   - 优点：彻底解决性能问题
   - 缺点：工程量大

工程师决策：
- 立即执行方案1（解决当前问题）
- 规划方案3（长期优化）
```

---

### 3.2.7 非功能需求

#### 7.1 性能要求

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **Agent响应时间** | <5秒（P95） | Prometheus监控LLM调用时长 |
| **诊断时间** | <3秒（简单故障） | diagnoseFault工具调用时长 |
| **工单创建时间** | <1秒 | createTechnicalTicket调用时长 |
| **知识库检索时间** | <2秒 | searchTechnicalKB调用时长 |
| **并发处理能力** | 支持50+并发诊断 | 压力测试验证 |

#### 7.2 质量指标

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **诊断准确率** | >80% | 工程师反馈对比（每周抽检50条） |
| **方案可执行性** | >90% | 方案是否可直接执行 |
| **问题分类准确率** | >85% | issueType/severity/category准确性 |
| **根因分析准确率** | >75% | 与工程师最终结论对比 |
| **方案推荐采纳率** | >70% | 工程师采纳Agent推荐方案的比例 |
| **工单自动分配准确率** | >85% | 分配工程师是否合适 |

#### 7.3 成本约束

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **LLM调用成本** | <¥3000/月 | DeepSeek计费统计 |
| **平均单次诊断成本** | <¥0.03/次 | 成本/诊断次数 |
| **Token消耗** | <80k tokens/天 | 监控每次调用的token数 |

**成本优化策略**:
- 优先使用规则引擎处理常见故障（缓存200+故障模式）
- LLM仅用于复杂诊断和根因分析
- 批量检索知识库，减少API调用

#### 7.4 可用性要求

| 指标 | 目标值 | 说明 |
|-----|--------|------|
| **系统可用性** | >99.9% | 降级策略保障 |
| **降级触发率** | <10% | 降级到规则引擎的比例 |
| **故障恢复时间** | <5分钟 | 从故障到恢复正常的时间 |

---

### 3.2.8 验收场景

#### 8.1 验收场景清单

| 场景ID | 场景描述 | 优先级 | 依赖 |
|--------|---------|--------|------|
| AC-01 | 登录失败诊断（系统故障） | P0 | 无 |
| AC-02 | 性能问题诊断（慢查询） | P0 | AC-01 |
| AC-03 | 复杂故障升级（置信度低） | P0 | AC-01 |
| AC-04 | 历史案例匹配 | P1 | AC-01 |
| AC-05 | 自动工单创建与分配 | P1 | AC-01 |
| AC-06 | 降级到规则引擎 | P1 | AC-01 |

---

#### AC-01: 登录失败诊断（系统故障）

**场景描述**: 客户报告无法登录，系统自动诊断并推荐解决方案

**输入**:
```json
{
  "issueDescription": "无法登录系统，提示网络连接超时",
  "customerEnvironment": {
    "version": "v2.5.3",
    "os": "Ubuntu 20.04",
    "browser": "Chrome 120"
  },
  "logs": [
    "[2025-12-29 09:58:23] ERROR: Connection timeout after 30s"
  ]
}
```

**预期Agent输出**:
```json
{
  "diagnosis": {
    "issueType": "system",
    "severity": "P1",
    "category": "login_failure",
    "rootCause": "认证服务响应超时，疑似数据库连接池耗尽",
    "affectedComponents": ["AuthService", "DatabasePool"],
    "confidence": 0.85
  },
  "solutions": [
    {
      "title": "重启认证服务并扩容数据库连接池",
      "steps": [
        "1. 重启auth-service（docker restart auth-service）",
        "2. 修改database.yml，将max_connections从50提升到100",
        "3. 重启应用（docker-compose restart）",
        "4. 验证登录功能"
      ],
      "estimatedTime": "15分钟",
      "riskLevel": "low",
      "kbReference": "KB-T-015",
      "successRate": 0.95
    }
  ],
  "estimatedResolutionTime": "30分钟"
}
```

**验收标准**:
- ✅ issueType识别为"system"
- ✅ severity识别为"P1"
- ✅ category识别为"login_failure"
- ✅ rootCause合理（认证服务超时）
- ✅ confidence>0.8
- ✅ solutions包含可执行步骤
- ✅ 响应时间<5秒

---

#### AC-02: 性能问题诊断（慢查询）

**输入**:
```json
{
  "issueDescription": "系统打开很慢，加载超过10秒",
  "logs": [
    "[2025-12-29 10:05:12] WARN: Slow query: SELECT * FROM orders WHERE customer_id = '123' (8.5s)"
  ]
}
```

**预期Agent输出**:
```json
{
  "diagnosis": {
    "issueType": "performance",
    "severity": "P2",
    "category": "slow_response",
    "rootCause": "数据库慢查询，缺少索引导致全表扫描",
    "affectedComponents": ["DatabaseQuery", "OrderService"],
    "confidence": 0.78
  },
  "solutions": [
    {
      "title": "添加customer_id索引",
      "steps": [
        "1. 连接数据库：psql -U admin -d production",
        "2. 创建索引：CREATE INDEX idx_orders_customer_id ON orders(customer_id);",
        "3. 验证查询性能：EXPLAIN ANALYZE ...",
        "4. 清理查询缓存"
      ],
      "estimatedTime": "10分钟",
      "riskLevel": "low",
      "kbReference": "KB-T-032",
      "successRate": 0.92
    }
  ]
}
```

**验收标准**:
- ✅ issueType识别为"performance"
- ✅ category识别为"slow_response"
- ✅ rootCause准确识别慢查询问题
- ✅ solutions提供索引优化方案
- ✅ 响应时间<5秒

---

#### AC-03: 复杂故障升级（置信度低）

**输入**:
```json
{
  "issueDescription": "整个系统崩溃，所有用户无法访问",
  "logs": ["多个服务的复杂错误日志..."]
}
```

**预期Agent输出**:
```json
{
  "diagnosis": {
    "issueType": "system",
    "severity": "P0",
    "category": "crash",
    "rootCause": "多个组件异常，需深度排查",
    "confidence": 0.45
  },
  "nextActions": [
    {
      "action": "create_ticket",
      "reason": "复杂故障，置信度<0.6",
      "assignee": "高级架构师"
    },
    {
      "action": "escalate_to_expert",
      "reason": "P0故障，需立即响应"
    }
  ],
  "needExpertReview": true,
  "reviewReason": "复杂故障+置信度低"
}
```

**验收标准**:
- ✅ severity识别为"P0"
- ✅ confidence<0.6时，needExpertReview=true
- ✅ nextActions包含"create_ticket"和"escalate_to_expert"
- ✅ 推送紧急告警到技术负责人

---

### 3.2.9 降级策略

#### 9.1 降级层级

```
主路径: LLM诊断 (DeepSeek v3.1)
  ↓ [超时30秒 / API调用失败 / 错误率>10%]
降级1: 规则引擎（基于故障模式库）
  ↓ [无匹配规则]
降级2: 关键词匹配
  ↓ [无匹配关键词]
降级3: 创建工单，人工诊断
```

---

#### 9.2 故障诊断降级策略

**主路径: LLM诊断**

- **触发条件**: 正常情况
- **行为**: 调用DeepSeek v3.1分析问题描述、日志、环境信息
- **输出**: `{issueType, severity, rootCause, confidence: 0.7+}`
- **处理时间**: <5秒

**降级1: 规则引擎**

- **触发条件**:
  - LLM超时（>30秒）
  - API调用失败（返回5xx错误）
  - LLM连续10次错误率>10%
- **行为**:
  - 匹配预定义故障模式库（200+常见故障）
  - 基于关键词+日志模式识别
  - 规则示例：
    - "Connection timeout" + "auth-service" → login_failure
    - "Slow query" + "SELECT" → performance/slow_response
    - "OutOfMemoryError" → system/crash
- **输出**: `{issueType, category, confidence: 0.5-0.7, fallbackLevel: 1}`
- **处理时间**: <500ms

**降级2: 关键词匹配**

- **触发条件**: 规则引擎无匹配
- **行为**:
  - 简单关键词匹配
  - "登录" → login_failure
  - "慢" OR "卡" → performance
  - "崩溃" → crash
- **输出**: `{issueType, confidence: 0.3-0.5, fallbackLevel: 2}`

**降级3: 创建工单**

- **触发条件**: 关键词无匹配
- **行为**:
  - 自动创建工单
  - 分配给默认技术团队
  - 标记"需人工诊断"
- **输出**: `{ticketId, fallbackLevel: 3, needExpertReview: true}`

---

#### 9.3 降级监控

| 监控指标 | 告警阈值 | 处理措施 |
|---------|---------|---------| | LLM超时率 | >5%（每小时） | 检查LLM服务状态，增加超时时间 |
| 降级1触发率 | >10%（每小时） | 优化Prompt，扩容LLM服务 |
| 降级2触发率 | >5%（每小时） | 扩充规则库 |
| 降级3触发率 | >2%（每小时） | 检查系统故障 |

---

### 3.2.10 监控指标

#### 10.1 核心指标

| 指标名称 | 指标定义 | 监控工具 | 告警阈值 |
|---------|---------|---------|---------|
| **诊断调用次数** | 每小时调用量 | Prometheus | >500次/小时 |
| **诊断成功率** | 成功诊断/总调用 | Prometheus | <80% |
| **平均诊断时间** | P95诊断时长 | Prometheus | >5秒 |
| **诊断准确率** | 工程师反馈准确 | 人工抽检 | <80% |
| **方案采纳率** | 采纳推荐方案比例 | Prometheus | <70% |
| **降级触发次数** | 降级到规则引擎次数 | Prometheus | >50次/小时 |
| **工单创建量** | 自动创建工单数 | Prometheus | >100个/天 |

#### 10.2 Prometheus指标定义

```promql
# 诊断调用总次数
engineer_agent_diagnosis_total{
  agent="EngineerAgent",
  result="success|failure|timeout"
} counter

# 诊断响应时间
engineer_agent_diagnosis_duration_seconds{
  agent="EngineerAgent",
  issueType="system|function|performance|configuration"
} histogram

# 诊断准确率（需人工标注）
engineer_agent_diagnosis_accuracy{
  agent="EngineerAgent",
  issueType="system|function|performance|configuration"
} gauge

# 方案采纳率
engineer_agent_solution_adopted{
  agent="EngineerAgent"
} counter

engineer_agent_solution_rejected{
  agent="EngineerAgent"
} counter

# 降级触发次数
engineer_agent_fallback_triggered{
  agent="EngineerAgent",
  fallback_level="1|2|3",
  reason="llm_timeout|api_error|no_match"
} counter

# 工单创建量
engineer_agent_tickets_created{
  agent="EngineerAgent",
  severity="P0|P1|P2|P3"
} counter
```

#### 10.3 Grafana仪表板

**仪表板名称**: EngineerAgent - 故障诊断监控

**Row 1: 核心指标概览**
- 面板1.1: 诊断调用量趋势（折线图）
- 面板1.2: 诊断成功率（Stat面板，>80%绿色）
- 面板1.3: 平均诊断时间（Gauge仪表盘，<5秒绿色）
- 面板1.4: 每日工单创建量（Stat面板）

**Row 2: 质量分析**
- 面板2.1: 诊断准确率（折线图，按问题类型分组）
- 面板2.2: 方案采纳率（折线图）
- 面板2.3: 问题类型分布（饼图：system/function/performance/configuration）

**Row 3: 降级监控**
- 面板3.1: 降级触发次数（柱状图）
- 面板3.2: 降级原因分布（饼图）

---

### 3.2.11 示例对话

#### 示例1: 登录失败（系统故障）

**对话背景**: 客户无法登录，系统自动诊断并推荐解决方案

```
【客户】无法登录系统，一直提示"网络连接超时"

【EngineerAgent思考过程】

Step 1: 调用classifyIssue()
  → 输入: {issueDescription: "无法登录，提示网络超时"}
  → 输出: {
      issueType: "system",
      severity: "P1",
      category: "login_failure",
      confidence: 0.92
    }

Step 2: 判断 - severity=P1 → 推送告警到技术负责人

Step 3: 调用diagnoseFault()
  → 输入: {
      issueDescription: "无法登录，提示网络超时",
      logs: ["[2025-12-29 09:58:23] ERROR: Connection timeout after 30s"],
      customerEnvironment: {version: "v2.5.3", os: "Ubuntu 20.04"}
    }
  → 输出: {
      rootCause: "认证服务响应超时，疑似数据库连接池耗尽",
      affectedComponents: ["AuthService", "DatabasePool"],
      confidence: 0.85
    }

Step 4: 调用searchTechnicalKB("登录失败 超时")
  → 输出: [
      {
        id: "KB-T-015",
        title: "认证服务超时排查",
        solution: "重启auth-service并扩容连接池",
        successRate: 0.95
      }
    ]

Step 5: 调用recommendSolution()
  → 输入: {
      diagnosisResult: {...},
      kbResults: [{KB-T-015}]
    }
  → 输出: {
      recommendedSolution: {
        title: "重启认证服务并扩容数据库连接池",
        steps: [
          "1. 重启auth-service（docker restart auth-service）",
          "2. 修改database.yml，将max_connections从50提升到100",
          "3. 重启应用（docker-compose restart）",
          "4. 验证登录功能"
        ],
        estimatedTime: "15分钟",
        riskLevel: "low",
        kbReference: "KB-T-015",
        successRate: 0.95
      }
    }

【前端展示】
┌─────────────────────────────────────┐
│ 🔍 故障诊断报告                      │
├─────────────────────────────────────┤
│ 问题类型：系统故障（登录失败）        │
│ 严重程度：P1（高优先级）              │
│ 影响组件：AuthService, DatabasePool  │
│                                      │
│ 🎯 根本原因：                        │
│ 认证服务响应超时，疑似数据库连接池    │
│ 耗尽（置信度85%）                    │
│                                      │
│ 💡 推荐方案：                        │
│ 重启认证服务并扩容数据库连接池        │
│                                      │
│ 📋 执行步骤：                        │
│ 1. 重启auth-service                  │
│    docker restart auth-service       │
│ 2. 修改database.yml                  │
│    max_connections: 50 → 100         │
│ 3. 重启应用                          │
│    docker-compose restart            │
│ 4. 验证登录功能                      │
│                                      │
│ ⏱️ 预估时间：15分钟                  │
│ ⚠️ 风险等级：低                      │
│ 📊 成功率：95%                       │
│ 📚 参考：KB-T-015                    │
│                                      │
│ [执行方案✨] [创建工单] [查看备选]    │
└─────────────────────────────────────┘

【工程师操作】
点击【执行方案】→ 按步骤执行 → 15分钟后验证 → 问题解决

【客户反馈】
问题已解决，可以正常登录了

【Agent学习】
记录成功案例: {
  "caseId": "CASE-12345",
  "issueType": "login_failure",
  "solution": "KB-T-015",
  "resolutionTime": "12分钟",
  "success": true
}
```

**关键决策点**:
1. **为什么confidence=0.85**:
   - 日志明确显示"Connection timeout"
   - 环境信息完整（version/os）
   - 知识库有高度相关方案（KB-T-015，相关度0.95）

2. **为什么推荐重启方案**:
   - 历史成功率95%（KB-T-015）
   - 风险低（服务重启，影响<1分钟）
   - 执行时间短（15分钟）

3. **为什么P1而不是P0**:
   - 虽然影响登录，但系统其他功能正常
   - 非全系统不可用
   - 可在1-2小时内解决

---

#### 示例2: 性能问题（慢查询）

```
【客户】系统打开很慢，加载超过10秒

【EngineerAgent思考过程】

Step 1: classifyIssue()
  → {issueType: "performance", severity: "P2", category: "slow_response"}

Step 2: analyzeLogs()
  → 分析日志，发现慢查询
  → {
      keyFindings: [
        {
          pattern: "Slow query",
          occurrences: 50,
          severity: "HIGH"
        }
      ]
    }

Step 3: diagnoseFault()
  → {
      rootCause: "数据库慢查询，缺少索引导致全表扫描",
      affectedComponents: ["DatabaseQuery", "OrderService"],
      confidence: 0.78
    }

Step 4: searchTechnicalKB("性能优化 慢查询 索引")
  → {KB-T-032: 添加索引优化方案}

Step 5: recommendSolution()
  → {
      title: "添加customer_id索引",
      steps: [
        "1. 连接数据库：psql -U admin -d production",
        "2. 创建索引：CREATE INDEX idx_orders_customer_id ON orders(customer_id);",
        "3. 验证查询性能",
        "4. 清理查询缓存"
      ],
      estimatedTime: "10分钟",
      riskLevel: "low",
      successRate: 0.92
    }

【前端展示】
🐌 性能问题诊断
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
根本原因：数据库慢查询（缺少索引）
慢查询SQL：SELECT * FROM orders WHERE customer_id = '123' (8.5s)
推荐方案：添加customer_id索引
预估优化后：查询时间<100ms

【工程师操作】
执行索引优化 → 验证性能提升 → 问题解决
```

---

## 3.3 InspectorAgent - 质检评分

> **PRD格式**: Agent PRD（11章结构）
> **优先级**: P0
> **所属版本**: v0.1 + v1.0（质检报告）

### 3.3.1 Agent Profile

#### 1.1 身份定义

**Agent Name**: InspectorAgent

**Role**: 智能质检评分Agent，负责对话质量评估、服务规范检查、质检报告生成与质量改进建议

**核心定位**: InspectorAgent是智能售后工作台的质量保障引擎，通过实时分析对话质量、检查服务规范遵守情况、自动生成质检评分和报告,帮助管理层监控服务质量，识别问题客服，提升整体服务水平。

**Personality**:
- **公正严谨**: 基于标准评分，不偏袒任何一方
- **细致专业**: 关注细节，识别微小的服务瑕疵
- **数据驱动**: 依据事实和数据，而非主观臆断
- **建设性**: 不仅指出问题，还提供改进建议

**Capabilities**:
- `inspectConversation` (MCP): 对话质量检查与评分
- `checkCompliance` (MCP): 服务规范合规性检查
- `scoreServiceQuality` (MCP): 服务质量综合评分
- `detectViolations` (MCP): 违规行为识别（辱骂、泄密、越权）
- `generateQualityReport` (MCP): 生成质检报告（周报/月报）
- `recommendImprovement` (MCP): 质量改进建议
- `compareTeamPerformance` (MCP): 团队质量对比分析

#### 1.2 能力边界

| 能做什么 | 不能做什么 |
|---------|-----------|
| ✅ 评估对话服务质量（响应速度、专业度、友好度） | ❌ 不处理客户投诉（转AssistantAgent） |
| ✅ 检查服务规范遵守情况（问候语、结束语、敬语） | ❌ 不直接惩罚客服（需人工决策） |
| ✅ 识别违规行为（辱骂、泄密、越权操作） | ❌ 不修改历史质检结果（保证审计追溯） |
| ✅ 生成质检报告（个人/团队/周报/月报） | ❌ 不绕过人工审核机制（严重违规必须人工确认） |
| ✅ 提供改进建议（话术优化、流程改进） | ❌ 不评估客户行为（仅评估客服） |
| ✅ 对比团队质量表现（排名、趋势分析） | ❌ 不访问客服个人隐私数据 |
| ✅ 识别高质量对话案例（供培训使用） | ❌ 不自动触发绩效考核（仅提供数据支持） |

#### 1.3 响应风格

**语气规范**:
- **质检报告**: 客观、专业、数据化
- **违规提示**: 严肃、明确、有依据
- **改进建议**: 建设性、可执行、具体化
- **团队对比**: 公正、鼓励性、不贬低

**格式偏好**:
- **输出格式**: 结构化JSON（便于系统集成）
- **评分结构**: 总分 + 维度分（响应速度/专业度/友好度/规范性/解决率）
- **违规记录**: 明确标注违规类型、证据片段、严重程度

**长度控制**:
- **单次质检**: 评分卡（50-80字）
- **质检报告**: 500-1000字（周报）、1500-2500字（月报）
- **改进建议**: 每条100-150字，最多5条

**特殊要求**:
- 严重违规（辱骂、泄密）必须标记`needHumanReview=true`
- 质检评分需要标注依据（引用对话片段）
- 质检报告生成前需要人工审核确认
- 质量改进建议需要可落地执行

---

### 3.3.2 提示词变更记录

#### 2.1 变更历史

| 版本 | 变更内容 | 变更原因 | 日期 | 变更人 |
|-----|---------|---------|------|--------|
| v0.1 | 初始Prompt：基础质检评分+规范检查 | 首次创建MVP版本 | 2024-10 | 产品团队 |
| v0.5 | 增强违规检测（辱骂、泄密、越权） | 提升风险管控能力 | 2025-03 | 产品团队 |
| v0.8 | 增加改进建议生成+团队对比分析 | 支持质量持续改进 | 2025-07 | 产品团队 |
| v1.0 | 质检报告自动化（周报/月报）+趋势分析 | 商业化标准版 | 2025-11 | 产品团队 |

#### 2.2 当前版本Prompt（v1.0完整版）

```
你是专业的服务质检专家 InspectorAgent。

---

## 核心职责

1. **对话质检**: 评估客服对话的服务质量（响应速度、专业度、友好度、规范性、解决率）
2. **规范检查**: 检查服务规范遵守情况（问候语、结束语、敬语使用、禁用词）
3. **违规识别**: 识别严重违规行为（辱骂客户、泄露信息、越权操作）
4. **质检评分**: 基于5个维度生成综合质检评分（0-100分）
5. **报告生成**: 自动生成质检报告（个人周报、团队月报）
6. **改进建议**: 提供具体、可执行的质量改进建议

---

## 输出格式（必须是严格的JSON）

```json
{
  "inspection": {
    "conversationId": "CONV-12345",
    "inspectorId": "InspectorAgent",
    "inspectedAt": "2025-12-29T10:00:00Z",
    "overallScore": 85,
    "scoreBreakdown": {
      "responseSpeed": 90,
      "professionalism": 85,
      "friendliness": 80,
      "compliance": 90,
      "resolutionRate": 75
    },
    "grade": "良好",
    "confidence": 0.92
  },
  "violations": [
    {
      "type": "terminology_violation",
      "severity": "low",
      "description": "未使用标准问候语",
      "evidence": "对话开头直接进入主题，缺少'您好'问候",
      "timestamp": "2025-12-29T10:01:23Z"
    }
  ],
  "highlights": [
    "响应速度快，30秒内首次回复",
    "专业术语使用准确",
    "积极主动提供解决方案"
  ],
  "improvements": [
    {
      "dimension": "friendliness",
      "issue": "语气略显生硬",
      "suggestion": "可以使用'非常理解您的心情'等共情话术",
      "priority": "medium"
    }
  ],
  "needHumanReview": false,
  "reviewReason": null
}
```

---

## 评分维度详解

### 维度1: 响应速度（responseSpeed，0-100分）

**评分标准**:
- **90-100分**: 首次响应<1分钟，后续响应<2分钟
- **70-89分**: 首次响应1-3分钟，后续响应2-5分钟
- **50-69分**: 首次响应3-5分钟，后续响应5-10分钟
- **<50分**: 首次响应>5分钟或后续响应>10分钟

**评分依据**:
- 客户发送消息时间戳 → 客服首次回复时间戳 = 首次响应时间
- 客户追问时间戳 → 客服回复时间戳 = 后续响应时间
- 计算平均响应时间

**特殊情况**:
- 客户消息在非工作时间（自动降低评分权重）
- 客户连续发送多条消息（以最后一条为准）

---

### 维度2: 专业度（professionalism，0-100分）

**评分标准**:
- **90-100分**: 术语准确、逻辑清晰、方案可行、知识扎实
- **70-89分**: 基本专业，偶有术语不准确
- **50-69分**: 专业性不足，方案可行性差
- **<50分**: 明显错误的专业判断

**评分依据**:
- 技术术语使用准确性（如"数据库连接池"vs"数据库连接"）
- 问题分析逻辑性（是否遗漏关键信息）
- 解决方案可行性（是否能实际解决问题）
- 知识库引用准确性

**扣分项**:
- 使用错误术语（-5分/次）
- 逻辑混乱（-10分）
- 方案不可行（-15分）
- 误导客户（-20分）

---

### 维度3: 友好度（friendliness，0-100分）

**评分标准**:
- **90-100分**: 热情、耐心、共情、尊重
- **70-89分**: 友好但不够热情
- **50-69分**: 态度一般，机械式回复
- **<50分**: 冷漠、不耐烦、生硬

**评分依据**:
- 是否使用礼貌用语（"您好"、"请"、"感谢"）
- 是否展现共情（"非常理解您的心情"）
- 是否耐心解答（客户重复询问时）
- 语气是否友好（避免生硬、命令式）

**加分项**:
- 主动安抚负面情绪客户（+5分）
- 超出预期的服务（+10分）
- 个性化关怀（+5分）

**扣分项**:
- 机械式回复（-5分）
- 不耐烦语气（-10分）
- 打断客户（-10分）

---

### 维度4: 规范性（compliance，0-100分）

**评分标准**:
- **90-100分**: 完全遵守服务规范
- **70-89分**: 偶有规范遗漏
- **50-69分**: 多处规范违反
- **<50分**: 严重违规

**服务规范清单**:
1. **问候语规范**:
   - 必须: 对话开始使用"您好"
   - VIP客户: "尊敬的XXX用户，您好"

2. **结束语规范**:
   - 必须: "如有其他问题，欢迎随时咨询"
   - 可选: "祝您生活愉快"

3. **敬语规范**:
   - 使用"您"而非"你"
   - 避免"亲"等过于随意的称呼

4. **禁用词规范**:
   - 禁止: "不知道"、"不清楚"、"不归我管"
   - 替代: "我帮您查询一下"、"我为您联系相关部门"

5. **信息安全规范**:
   - 不得要求客户提供密码
   - 不得泄露其他客户信息
   - 不得在非加密渠道传输敏感数据

**扣分项**:
- 缺少问候语（-5分）
- 缺少结束语（-3分）
- 使用禁用词（-10分/次）
- 信息安全违规（-30分，标记严重违规）

---

### 维度5: 解决率（resolutionRate，0-100分）

**评分标准**:
- **90-100分**: 问题彻底解决，客户满意
- **70-89分**: 问题基本解决，客户接受
- **50-69分**: 问题部分解决，客户仍有疑虑
- **<50分**: 问题未解决，客户不满

**评分依据**:
- 客户明确表示"好的"、"谢谢"、"解决了" → 90-100分
- 客户后续未追问，对话正常结束 → 70-89分
- 客户仍有疑虑，但接受方案 → 50-69分
- 客户明确不满意 → <50分

**特殊情况**:
- 问题需要转工程师（不扣分，标注"escalated"）
- 客户主动离开对话（按70分处理）
- 问题超出服务范围（按80分处理，标注"out_of_scope"）

---

## 综合评分计算

**公式**:
```
overallScore = (responseSpeed × 0.15) +
               (professionalism × 0.30) +
               (friendliness × 0.20) +
               (compliance × 0.25) +
               (resolutionRate × 0.10)
```

**权重说明**:
- 专业度（30%）：最重要，直接影响问题解决
- 规范性（25%）：体现服务标准化
- 友好度（20%）：影响客户满意度
- 响应速度（15%）：基础体验
- 解决率（10%）：结果导向

**等级划分**:
- **90-100分**: 优秀
- **80-89分**: 良好
- **70-79分**: 合格
- **60-69分**: 待改进
- **<60分**: 不合格

---

## 违规检测规则

### 类型1: terminology_violation（术语违规）

**定义**: 使用禁用词、不规范表述

**严重性**: low（轻度）

**检测逻辑**:
- 关键词匹配: ["不知道", "不清楚", "不归我管", "不关我事"]
- 缺失标准话术: 无问候语、无结束语

**处理方式**: 扣分，生成改进建议

---

### 类型2: tone_violation（语气违规）

**定义**: 不耐烦、生硬、命令式语气

**严重性**: medium（中度）

**检测逻辑**:
- 语气词识别: ["算了", "随便", "都说了", "你懂不懂"]
- 情感分析: 客服消息情感<0.3（负面）

**处理方式**: 扣分，标记需要培训

---

### 类型3: information_leakage（信息泄露）

**定义**: 泄露客户隐私、系统敏感信息

**严重性**: critical（严重）

**检测逻辑**:
- 敏感词匹配: ["密码", "身份证号", "银行卡号", "内部系统地址"]
- 客户信息泄露: 在对话中提及其他客户姓名、电话

**处理方式**:
- 立即标记`needHumanReview=true`
- 推送紧急告警到管理层
- overallScore强制降至<60分

---

### 类型4: abuse_language（辱骂客户）

**定义**: 使用辱骂性语言、侮辱客户

**严重性**: critical（严重）

**检测逻辑**:
- 辱骂词库匹配: [脏话、侮辱性词汇]
- 人工举报: 客户投诉

**处理方式**:
- 立即标记`needHumanReview=true`
- overallScore强制降至0分
- 推送紧急告警

---

### 类型5: unauthorized_operation（越权操作）

**定义**: 执行超出权限的操作（如私自退款、修改订单）

**严重性**: critical（严重）

**检测逻辑**:
- 操作日志审计: 退款操作无主管审批
- 权限检查: 操作超出角色权限

**处理方式**:
- 立即标记`needHumanReview=true`
- 推送紧急告警到管理层
- 触发安全审计流程

---

## 质检报告生成

### 报告类型1: 个人周报

**包含内容**:
```json
{
  "reportType": "individual_weekly",
  "agentId": "AGENT-001",
  "agentName": "张客服",
  "period": "2025-12-23 至 2025-12-29",
  "summary": {
    "totalConversations": 150,
    "inspectedConversations": 30,
    "averageScore": 85,
    "gradeDistribution": {
      "优秀": 10,
      "良好": 15,
      "合格": 4,
      "待改进": 1
    },
    "violationCount": 3,
    "improvementRate": "+5分（相比上周）"
  },
  "dimensionScores": {
    "responseSpeed": 90,
    "professionalism": 82,
    "friendliness": 85,
    "compliance": 88,
    "resolutionRate": 80
  },
  "strengths": [
    "响应速度快，平均首次响应<1分钟",
    "服务态度友好，客户满意度高"
  ],
  "weaknesses": [
    "专业度有待提升，术语使用偶有错误",
    "规范性不足，偶尔缺少结束语"
  ],
  "topIssues": [
    {
      "issue": "术语使用不准确",
      "frequency": 5,
      "example": "CONV-12345: 将'数据库连接池'说成'数据库连接'"
    }
  ],
  "recommendations": [
    "加强专业培训，学习常见技术术语",
    "使用质检模板，确保每次对话包含标准话术"
  ]
}
```

---

### 报告类型2: 团队月报

**包含内容**:
```json
{
  "reportType": "team_monthly",
  "teamName": "售后团队A",
  "period": "2025-12-01 至 2025-12-31",
  "summary": {
    "totalAgents": 10,
    "totalConversations": 3000,
    "inspectedConversations": 600,
    "teamAverageScore": 82,
    "month-over-month": "+3分"
  },
  "teamRanking": [
    {"rank": 1, "agentName": "张客服", "averageScore": 92},
    {"rank": 2, "agentName": "李客服", "averageScore": 88},
    {"rank": 3, "agentName": "王客服", "averageScore": 85}
  ],
  "dimensionTrends": {
    "responseSpeed": {"current": 88, "trend": "+2"},
    "professionalism": {"current": 80, "trend": "+5"},
    "friendliness": {"current": 85, "trend": "+1"},
    "compliance": {"current": 82, "trend": "-1"},
    "resolutionRate": {"current": 78, "trend": "+4"}
  },
  "topViolations": [
    {"type": "terminology_violation", "count": 25, "percentage": "4.2%"},
    {"type": "tone_violation", "count": 10, "percentage": "1.7%"}
  ],
  "bestPractices": [
    {
      "agentName": "张客服",
      "conversationId": "CONV-99999",
      "highlight": "VIP客户投诉处理，专业度95分，获客户高度评价"
    }
  ],
  "actionItems": [
    "针对规范性下降问题，开展服务规范培训",
    "推广张客服的VIP客户处理经验"
  ]
}
```

---

## 改进建议生成

**生成原则**:
1. **具体可执行**: 不说"提升专业度"，而说"学习XX技术术语"
2. **优先级排序**: 按影响大小排序（high/medium/low）
3. **数量控制**: 每次最多5条建议
4. **正面激励**: 先表扬优点，再提出改进

**示例**:
```json
{
  "improvements": [
    {
      "dimension": "professionalism",
      "issue": "术语使用不准确（5次错误）",
      "suggestion": "学习常见技术术语（提供术语表链接），每周复习3-5个",
      "priority": "high",
      "expectedImpact": "+10分"
    },
    {
      "dimension": "compliance",
      "issue": "偶尔缺少结束语（3次遗漏）",
      "suggestion": "使用质检模板，对话结束前检查是否包含标准结束语",
      "priority": "medium",
      "expectedImpact": "+5分"
    },
    {
      "dimension": "friendliness",
      "issue": "共情表达较少",
      "suggestion": "针对负面情绪客户，主动使用'非常理解您的心情'等共情话术",
      "priority": "medium",
      "expectedImpact": "+3分"
    }
  ]
}
```

---

## 特殊规则

### 规则1: 严重违规强制人工审核

如果检测到`critical`级别违规（信息泄露/辱骂客户/越权操作）：
- 强制设置 `needHumanReview = true`
- overallScore强制降至<60分
- 推送紧急告警到管理层
- 暂停该客服的自动质检（改为100%人工审核）

### 规则2: VIP客户对话优先质检

如果对话涉及VIP客户：
- 质检优先级提升（24小时内完成）
- 评分标准更严格（compliance权重提升到30%）
- 必须生成详细质检报告

### 规则3: 新人客服宽容评分

如果客服入职<3个月：
- 评分标准放宽（各维度+5分容错空间）
- 更多改进建议，减少扣分
- 标注"新人培养期"

### 规则4: 质检抽样策略

**抽样比例**:
- 新人客服: 100%质检（前3个月）
- 普通客服: 20%随机抽检
- 优秀客服（平均分>90）: 10%抽检
- 问题客服（平均分<70）: 50%抽检
- VIP客户对话: 100%质检
- 投诉对话: 100%质检

### 规则5: 质检结果申诉机制

客服可以对质检结果提出申诉：
- 申诉理由必须具体（如"客户要求使用'你'而非'您'"）
- 人工复核申诉
- 如果申诉成立，更新质检结果并标注"已申诉"

---

## 边界与限制

### 不处理的场景

1. **客户行为评估**: "这个客户是不是故意刁难？" → 仅评估客服，不评估客户
2. **绩效考核决策**: "是否应该辞退这个客服？" → 仅提供数据，不做人事决策
3. **历史质检结果修改**: "能不能修改上周的质检分数？" → 拒绝，保证审计追溯
4. **敏感信息访问**: "查一下这个客服的工资" → 拒绝，权限不足

### 降级处理

- **LLM超时（>30秒）**: 降级到规则引擎评分（基于关键词匹配）
- **API错误**: 返回默认评分80分，标记需人工复核
- **证据不足**: 降低置信度，标记"证据不足，建议人工复核"

---

**重要**: 质检评分需要客观公正，基于事实和数据，避免主观臆断。严重违规必须推送人工审核，确保质量安全。
```

#### 2.3 版本Prompt Diff

> 本节仅在增量PRD中使用，基线PRD记录最终版本

**v0.5相对v0.1的变更**:
```diff
核心职责:
1. 对话质检
2. 规范检查
3. 违规识别
4. 质检评分
+ 5. 严重违规检测增强（信息泄露/辱骂客户/越权操作）

违规类型:
+ information_leakage: 信息泄露（critical级别）
+ abuse_language: 辱骂客户（critical级别）
+ unauthorized_operation: 越权操作（critical级别）
```

**v0.8相对v0.5的变更**:
```diff
核心职责:
1. 对话质检
2. 规范检查
3. 违规识别
4. 质检评分
5. 严重违规检测
+ 6. 改进建议生成（具体可执行）
+ 7. 团队对比分析（排名、趋势）

输出格式:
{
  "inspection": {...},
+ "improvements": [
+   {
+     "dimension": "professionalism",
+     "issue": "术语使用不准确",
+     "suggestion": "学习常见技术术语",
+     "priority": "high"
+   }
+ ]
}
```

**v1.0相对v0.8的变更**:
```diff
核心职责:
+ 8. 质检报告自动化（个人周报、团队月报）
+ 9. 趋势分析（月度对比、同比环比）

报告类型:
+ individual_weekly: 个人周报
+ team_monthly: 团队月报

新增功能:
+ 质检趋势分析（月度改进率、同比环比）
+ 最佳实践识别（高分对话案例）
+ 行动计划生成（actionItems）
```

---

### 3.3.3 工具清单

#### 工具1: inspectConversation

**功能描述**: 综合评估对话质量，生成5维度评分、违规检测和改进建议

**分类**: Review（审核类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 | 默认值 |
|-------|------|------|------|------|--------|
| conversationId | string | 是 | 对话ID | UUID格式 | - |
| agentId | string | 是 | 客服ID | AGENT-格式 | - |
| includeEvidence | boolean | 否 | 是否包含评分依据 | - | true |
| strictMode | boolean | 否 | 是否严格模式（VIP客户） | - | false |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "inspection": {
      "conversationId": "CONV-12345",
      "inspectorId": "InspectorAgent",
      "inspectedAt": "2025-12-29T10:00:00Z",
      "overallScore": 85,
      "scoreBreakdown": {
        "responseSpeed": 90,
        "professionalism": 85,
        "friendliness": 80,
        "compliance": 90,
        "resolutionRate": 75
      },
      "grade": "良好",
      "confidence": 0.92
    },
    "violations": [
      {
        "type": "terminology_violation",
        "severity": "low",
        "description": "未使用标准问候语",
        "evidence": "对话开头直接进入主题",
        "timestamp": "2025-12-29T10:01:23Z"
      }
    ],
    "highlights": [
      "响应速度快，30秒内首次回复",
      "专业术语使用准确"
    ],
    "improvements": [
      {
        "dimension": "friendliness",
        "issue": "语气略显生硬",
        "suggestion": "可以使用'非常理解您的心情'等共情话术",
        "priority": "medium"
      }
    ],
    "needHumanReview": false
  },
  "metadata": {
    "processingTime": 2.8,
    "model": "deepseek-v3.1",
    "evidenceCount": 5
  }
}
```

**字段说明**:
| 字段名 | 类型 | 说明 | 取值范围 |
|-------|------|------|---------| | overallScore | number | 综合评分 | 0-100 |
| scoreBreakdown | object | 5维度分数 | 各维度0-100 |
| grade | string | 等级 | 优秀/良好/合格/待改进/不合格 |
| violations | array | 违规列表 | 最多10条 |
| highlights | array | 亮点列表 | 最多5条 |
| improvements | array | 改进建议 | 最多5条 |

**调用方式**: MCP (Model Context Protocol)

**特性**:
- **多维度评分**: 5个维度独立评分，加权计算总分
- **证据支撑**: 每个评分点标注依据（对话片段）
- **违规识别**: 自动检测5类违规行为
- **改进建议**: 生成具体可执行的改进建议
- **严格模式**: VIP客户开启严格模式（合规性权重提升）

**注意事项**:
- 严重违规（critical）自动标记needHumanReview=true
- 新人客服（<3个月）自动宽容评分（+5分容错）
- VIP客户对话开启strictMode（评分标准更严格）
- 质检结果不可修改（保证审计追溯）

**调用示例**:
```json
// 请求
{
  "conversationId": "CONV-12345",
  "agentId": "AGENT-001",
  "includeEvidence": true,
  "strictMode": false
}

// 响应
{
  "success": true,
  "data": {
    "inspection": {
      "overallScore": 85,
      "scoreBreakdown": {
        "responseSpeed": 90,
        "professionalism": 85,
        "friendliness": 80,
        "compliance": 90,
        "resolutionRate": 75
      },
      "grade": "良好",
      "confidence": 0.92
    },
    "violations": [
      {
        "type": "terminology_violation",
        "severity": "low",
        "description": "未使用标准问候语"
      }
    ]
  }
}
```

---

#### 工具2: checkCompliance

**功能描述**: 检查服务规范遵守情况（问候语、结束语、敬语、禁用词）

**分类**: Review（审核类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| checkRules | array | 否 | 指定检查规则 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "complianceScore": 90,
    "checkResults": [
      {
        "rule": "greeting_required",
        "passed": true,
        "evidence": "对话开头使用'您好'"
      },
      {
        "rule": "closing_required",
        "passed": false,
        "evidence": "缺少结束语",
        "penalty": -5
      }
    ],
    "totalViolations": 1,
    "overallCompliance": "良好"
  }
}
```

**调用方式**: MCP

**特性**:
- **规则引擎**: 基于预定义规则检查（5大类规范）
- **实时检测**: <1秒返回结果
- **扣分明细**: 每条违规明确扣分值

---

#### 工具3: scoreServiceQuality

**功能描述**: 服务质量综合评分（调用inspectConversation的简化版）

**分类**: Review（审核类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| agentId | string | 是 | 客服ID |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "overallScore": 85,
    "grade": "良好",
    "quickSummary": "响应快，专业度高，略显生硬"
  }
}
```

**调用方式**: MCP

---

#### 工具4: detectViolations

**功能描述**: 专项违规检测（信息泄露、辱骂、越权）

**分类**: Review（审核类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| conversationId | string | 是 | 对话ID |
| violationTypes | array | 否 | 指定检测类型 |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "criticalViolations": [
      {
        "type": "information_leakage",
        "severity": "critical",
        "description": "泄露客户手机号",
        "evidence": "提及了138****1234",
        "timestamp": "2025-12-29T10:05:12Z"
      }
    ],
    "needImmediateAction": true,
    "recommendedAction": "立即停止该客服服务，启动安全审计"
  }
}
```

**调用方式**: MCP

**特性**:
- **实时监控**: 严重违规实时推送告警
- **证据保全**: 记录违规片段，支持审计
- **自动处理**: critical违规自动触发应急流程

---

#### 工具5: generateQualityReport

**功能描述**: 生成质检报告（个人周报、团队月报）

**分类**: Maintain（维护类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| reportType | string | 是 | 报告类型 | individual_weekly/team_monthly |
| targetId | string | 是 | 目标ID（客服ID或团队ID） | - |
| startDate | string | 是 | 开始日期 | YYYY-MM-DD |
| endDate | string | 是 | 结束日期 | YYYY-MM-DD |
| includeComparison | boolean | 否 | 是否包含对比分析 | 默认true |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "reportType": "individual_weekly",
    "agentId": "AGENT-001",
    "agentName": "张客服",
    "period": "2025-12-23 至 2025-12-29",
    "summary": {
      "totalConversations": 150,
      "inspectedConversations": 30,
      "averageScore": 85,
      "gradeDistribution": {
        "优秀": 10,
        "良好": 15,
        "合格": 4,
        "待改进": 1
      },
      "improvementRate": "+5分（相比上周）"
    },
    "dimensionScores": {
      "responseSpeed": 90,
      "professionalism": 82,
      "friendliness": 85,
      "compliance": 88,
      "resolutionRate": 80
    },
    "strengths": [
      "响应速度快，平均首次响应<1分钟"
    ],
    "weaknesses": [
      "专业度有待提升，术语使用偶有错误"
    ],
    "recommendations": [
      "加强专业培训，学习常见技术术语"
    ]
  }
}
```

**调用方式**: MCP

**特性**:
- **多报告类型**: 个人周报、团队月报
- **趋势分析**: 月度对比、同比环比
- **自动生成**: 定时任务自动生成（每周一/每月1日）
- **人工审核**: 报告生成后需人工审核确认

---

#### 工具6: recommendImprovement

**功能描述**: 生成质量改进建议（基于历史质检数据）

**分类**: Insight（洞察类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| agentId | string | 是 | 客服ID |
| timeRange | string | 否 | 时间范围（默认最近30天） |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "improvements": [
      {
        "dimension": "professionalism",
        "issue": "术语使用不准确（5次错误）",
        "suggestion": "学习常见技术术语，每周复习3-5个",
        "priority": "high",
        "expectedImpact": "+10分"
      }
    ],
    "trainingRecommendations": [
      "参加技术术语培训课程",
      "阅读知识库高质量文档"
    ]
  }
}
```

**调用方式**: MCP

---

#### 工具7: compareTeamPerformance

**功能描述**: 团队质量对比分析（排名、趋势）

**分类**: Insight（洞察类）

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| teamId | string | 是 | 团队ID |
| period | string | 是 | 统计周期（week/month） |

**输出格式**:
```json
{
  "success": true,
  "data": {
    "teamRanking": [
      {"rank": 1, "agentName": "张客服", "averageScore": 92},
      {"rank": 2, "agentName": "李客服", "averageScore": 88}
    ],
    "teamAverageScore": 82,
    "topPerformers": ["张客服", "李客服"],
    "needImprovement": ["王客服"]
  }
}
```

**调用方式**: MCP

---

### 3.3.4 沉淀Skills

> 仅用于迭代版本（提炼上一版本已验证的功能）

#### 4.1 conversation_inspection_skill

**适用场景**: 对话结束后自动触发质检评分

**触发条件**: `ConversationEndedEvent`（对话结束事件）

**标准流程**:
1. 调用`inspectConversation()`对对话进行综合质检
2. 如果`overallScore<60`或存在`critical`违规，标记需人工审核
3. 推送质检结果到客服工作台（实时反馈）
4. 记录质检结果到数据库（供报告生成）
5. 如果检测到严重违规，推送告警到管理层

**质量门禁**:
- 质检准确率>90%（基于人工复核100条/周）
- 质检响应时间<3秒（P95）
- 误报率<5%（避免过度扣分）

**回滚策略**:
- **LLM超时**: 降级到规则引擎评分（基于关键词匹配）
- **API错误**: 返回默认评分80分，标记需人工复核
- **证据不足**: 降低置信度到0.5，标记"建议人工复核"

**可观测性**:
- 记录每次质检的评分分布（Prometheus histogram）
- 监控质检准确率（人工复核反馈）
- 统计违规类型分布（terminology/tone/leakage/abuse/unauthorized）

---

#### 4.2 violation_detection_skill

**适用场景**: 实时监控对话过程中的严重违规行为

**触发条件**: `MessageSentEvent`（客服发送消息事件）

**标准流程**:
1. 调用`detectViolations()`检测严重违规（信息泄露/辱骂/越权）
2. 如果检测到`critical`违规：
   - 立即推送告警到管理层（Slack + 邮件）
   - 标记该对话需100%人工复核
   - 触发安全审计流程
3. 记录违规证据（对话片段、时间戳）
4. 更新客服风险等级

**质量门禁**:
- 严重违规识别召回率>95%（不能漏报）
- 误报率<3%（避免误伤）
- 告警推送延迟<10秒

**回滚策略**:
- **模型不可用**: 基于敏感词库匹配（黑名单模式）
- **证据不足**: 标记"疑似违规，需人工确认"

**可观测性**:
- 监控每日严重违规数量
- 统计违规类型占比
- 跟踪误报率（人工复核反馈）

---

#### 4.3 quality_report_generation_skill

**适用场景**: 定期自动生成质检报告（个人周报、团队月报）

**触发条件**: `ScheduledEvent`（定时任务：每周一9:00、每月1日9:00）

**标准流程**:
1. 调用`generateQualityReport()`生成报告
2. 计算统计数据（平均分、等级分布、改进率）
3. 识别亮点和问题点
4. 生成改进建议
5. 人工审核报告（管理层确认）
6. 推送报告到客服邮箱 + 工作台

**质量门禁**:
- 报告生成成功率>99%
- 生成时间<5分钟（月报）
- 数据准确性100%

**回滚策略**:
- **数据不足**: 标记"数据不足，无法生成完整报告"
- **生成失败**: 降级到简化版报告（仅包含评分统计）

**可观测性**:
- 监控报告生成成功率
- 统计报告阅读率（客服查看次数）
- 跟踪改进建议采纳率

---

### 3.3.5 业务场景

#### 场景1: 常规对话质检（自动评分）

**场景描述**: 普通客服完成对话后，系统自动触发质检评分，生成5维度评分和改进建议

**触发条件**: 对话结束，且客服不是新人（入职>3个月），且不是VIP客户对话

**前置条件**:
- 对话已结束（状态=closed）
- 对话包含至少2轮消息
- 客服角色正常（非禁用）

**处理流程**:
```mermaid
sequenceDiagram
    System->>InspectorAgent: ConversationEndedEvent
    InspectorAgent->>MCP: inspectConversation()
    MCP-->>InspectorAgent: {overallScore: 85, violations: [...]}
    InspectorAgent->>Database: 保存质检结果
    InspectorAgent->>Frontend: WebSocket推送质检结果
    Frontend->>Agent: 展示质检卡片
```

**对话示例**:
```
【对话结束】
对话ID: CONV-12345
客服: 张客服
客户: 普通客户
对话时长: 5分钟
消息数: 8条

【InspectorAgent思考过程】

Step 1: 调用inspectConversation()
  → 输入: {
      conversationId: "CONV-12345",
      agentId: "AGENT-001",
      strictMode: false
    }

Step 2: 分析各维度
  - responseSpeed: 首次响应30秒，平均响应1分钟 → 90分
  - professionalism: 术语准确，方案可行 → 85分
  - friendliness: 礼貌但略显生硬 → 80分
  - compliance: 有问候语和结束语，但缺少共情 → 90分
  - resolutionRate: 客户表示"好的，谢谢" → 90分

Step 3: 计算综合评分
  overallScore = 90×0.15 + 85×0.30 + 80×0.20 + 90×0.25 + 90×0.10
              = 13.5 + 25.5 + 16 + 22.5 + 9
              = 86.5 → 87分

Step 4: 检测违规
  → 无严重违规
  → 发现1处轻微违规：未使用共情话术

Step 5: 生成改进建议
  → dimension: friendliness
  → suggestion: "针对客户'很着急'的表述，可以使用'非常理解您的心情'等共情话术"

【Agent输出】
{
  "inspection": {
    "conversationId": "CONV-12345",
    "overallScore": 87,
    "scoreBreakdown": {
      "responseSpeed": 90,
      "professionalism": 85,
      "friendliness": 80,
      "compliance": 90,
      "resolutionRate": 90
    },
    "grade": "良好",
    "confidence": 0.92
  },
  "violations": [
    {
      "type": "terminology_violation",
      "severity": "low",
      "description": "缺少共情话术",
      "evidence": "客户表示'很着急'时，未使用安抚性表述"
    }
  ],
  "highlights": [
    "响应速度快，30秒内首次回复",
    "专业术语使用准确",
    "问题解决及时"
  ],
  "improvements": [
    {
      "dimension": "friendliness",
      "issue": "共情表达较少",
      "suggestion": "针对客户负面情绪，主动使用'非常理解您的心情'等共情话术",
      "priority": "medium"
    }
  ],
  "needHumanReview": false
}

【前端展示】
┌─────────────────────────────────────┐
│ 质检结果 - CONV-12345                │
├─────────────────────────────────────┤
│ 综合评分：87分（良好）✅             │
│                                      │
│ 📊 维度评分：                        │
│ • 响应速度：90分 ⚡                  │
│ • 专业度：85分 📚                    │
│ • 友好度：80分 😊                    │
│ • 规范性：90分 ✓                     │
│ • 解决率：90分 ✔️                    │
│                                      │
│ 🌟 亮点：                            │
│ • 响应速度快，30秒内首次回复         │
│ • 专业术语使用准确                   │
│                                      │
│ ⚠️ 待改进：                          │
│ • 共情表达较少（-3分）               │
│   建议：使用'非常理解您的心情'等     │
│   共情话术                           │
│                                      │
│ [查看详情] [申诉]                    │
└─────────────────────────────────────┘

【客服操作】
查看质检结果 → 接受改进建议 → 下次对话改进
```

**预期输出**:
- 综合评分准确（±5分误差）
- 维度评分合理（各维度符合实际表现）
- 改进建议具体可执行
- 客服接受度>80%

**异常分支**:
| 异常情况 | 处理方式 |
|---------|---------|
| LLM超时 | 降级到规则引擎评分 |
| 对话过短（<2轮） | 标记"对话过短，无法准确评分" |
| 证据不足 | 降低置信度到0.6，建议人工复核 |

**成功标准**:
- ✅ 质检准确率>90%
- ✅ 响应时间<3秒（P95）
- ✅ 客服采纳率>70%

---

#### 场景2: 严重违规检测（信息泄露）

**场景描述**: 客服在对话中泄露客户敏感信息，系统实时检测并立即告警

**触发条件**: 客服发送消息，包含敏感词（身份证号、密码、其他客户信息）

**处理流程**:
```mermaid
sequenceDiagram
    Agent->>System: 发送消息"您的身份证号是..."
    System->>InspectorAgent: MessageSentEvent
    InspectorAgent->>MCP: detectViolations()
    MCP-->>InspectorAgent: {criticalViolations: [information_leakage]}
    InspectorAgent->>AlertService: 推送紧急告警
    AlertService->>Manager: Slack通知 + 邮件通知
    InspectorAgent->>System: 标记对话需100%人工审核
```

**对话示例**:
```
【客服发送消息】
"您好，您的身份证号是320XXX198X0X0XXXXX，请核对一下"

【InspectorAgent思考过程】

Step 1: 实时监控MessageSentEvent
  → 消息内容: "您好，您的身份证号是320XXX..."

Step 2: 调用detectViolations()
  → 敏感词匹配: 检测到"身份证号"
  → 格式识别: 检测到18位数字（身份证格式）
  → 判断: information_leakage（信息泄露）

Step 3: 评估严重性
  → severity: critical（严重）
  → 风险: 客户隐私泄露
  → 处理: 立即告警

Step 4: 推送告警
  → Slack: "@管理层 🔴 严重违规：客服AGENT-001泄露客户身份证号"
  → 邮件: "紧急：质检发现信息泄露违规"
  → 标记: 该对话需100%人工审核

【Agent输出】
{
  "criticalViolations": [
    {
      "type": "information_leakage",
      "severity": "critical",
      "description": "泄露客户身份证号",
      "evidence": "提及了完整身份证号320XXX198X0X0XXXXX",
      "timestamp": "2025-12-29T10:05:12Z",
      "agentId": "AGENT-001",
      "conversationId": "CONV-67890"
    }
  ],
  "needImmediateAction": true,
  "recommendedAction": "立即停止该客服服务，启动安全审计",
  "overallScore": 0,
  "needHumanReview": true
}

【前端展示】
┌─────────────────────────────────────┐
│ 🔴 严重违规告警                      │
├─────────────────────────────────────┤
│ 违规类型：信息泄露（critical）        │
│ 违规客服：张客服（AGENT-001）         │
│ 对话ID：CONV-67890                   │
│                                      │
│ 违规描述：                            │
│ 泄露客户身份证号                      │
│                                      │
│ 证据：                               │
│ "您的身份证号是320XXX198X0X0XXXXX"   │
│                                      │
│ 处理建议：                            │
│ 1. 立即停止该客服服务                 │
│ 2. 启动安全审计流程                   │
│ 3. 联系客户说明情况并道歉             │
│                                      │
│ [立即处理] [查看详情]                 │
└─────────────────────────────────────┘

【管理层操作】
收到告警 → 查看证据 → 确认违规 → 停止服务 → 安全审计 → 客户道歉
```

**成功标准**:
- ✅ 严重违规识别召回率>95%
- ✅ 告警推送延迟<10秒
- ✅ 误报率<3%

---

#### 场景3: 质检周报生成（个人周报）

**场景描述**: 每周一自动生成客服个人质检周报，包含评分统计、亮点问题、改进建议

**触发条件**: 定时任务（每周一9:00）

**对话示例**:
```
【定时任务触发】
时间: 2025-12-30 09:00
任务: 生成上周（12-23至12-29）个人质检周报

【InspectorAgent思考过程】

Step 1: 调用generateQualityReport()
  → reportType: individual_weekly
  → targetId: AGENT-001（张客服）
  → period: 2025-12-23 至 2025-12-29

Step 2: 统计数据
  → 总对话数: 150
  → 质检对话数: 30（随机抽检20%）
  → 平均分: 85（相比上周+5分）
  → 等级分布: 优秀10、良好15、合格4、待改进1

Step 3: 分析亮点和问题
  → 亮点: 响应速度快（平均<1分钟）、服务态度友好
  → 问题: 专业度不足（术语使用错误5次）、规范性待提升

Step 4: 生成改进建议
  → 建议1: 学习常见技术术语
  → 建议2: 使用质检模板确保标准话术

【报告内容】
{
  "reportType": "individual_weekly",
  "agentId": "AGENT-001",
  "agentName": "张客服",
  "period": "2025-12-23 至 2025-12-29",
  "summary": {
    "totalConversations": 150,
    "inspectedConversations": 30,
    "averageScore": 85,
    "gradeDistribution": {
      "优秀": 10,
      "良好": 15,
      "合格": 4,
      "待改进": 1
    },
    "improvementRate": "+5分（相比上周）"
  },
  "dimensionScores": {
    "responseSpeed": 90,
    "professionalism": 82,
    "friendliness": 85,
    "compliance": 88,
    "resolutionRate": 80
  },
  "strengths": [
    "响应速度快，平均首次响应<1分钟",
    "服务态度友好，客户满意度高"
  ],
  "weaknesses": [
    "专业度有待提升，术语使用偶有错误（5次）",
    "规范性不足，偶尔缺少结束语（3次）"
  ],
  "topIssues": [
    {
      "issue": "术语使用不准确",
      "frequency": 5,
      "example": "CONV-12345: 将'数据库连接池'说成'数据库连接'"
    }
  ],
  "recommendations": [
    "加强专业培训，学习常见技术术语（提供术语表链接）",
    "使用质检模板，确保每次对话包含标准话术"
  ]
}

【前端展示】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 质检周报（12月23日-12月29日）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

👤 客服：张客服（AGENT-001）

📈 整体表现：
• 平均分：85分（良好）↗️ +5分
• 质检对话：30/150（20%抽检）
• 等级分布：
  - 优秀：10次 (33%)
  - 良好：15次 (50%)
  - 合格：4次 (13%)
  - 待改进：1次 (3%)

📊 维度评分：
• 响应速度：90分 ⚡
• 专业度：82分 📚
• 友好度：85分 😊
• 规范性：88分 ✓
• 解决率：80分 ✔️

🌟 本周亮点：
• 响应速度快，平均首次响应<1分钟
• 服务态度友好，客户满意度高

⚠️ 待改进问题：
1. 专业度有待提升（5次术语错误）
   示例：CONV-12345 将"数据库连接池"
   说成"数据库连接"

2. 规范性不足（3次缺少结束语）

💡 改进建议：
1. 加强专业培训，学习常见技术术语
   [查看术语表]

2. 使用质检模板，确保标准话术
   [查看模板]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【客服操作】
阅读周报 → 查看改进建议 → 学习术语表 → 下周改进
```

**成功标准**:
- ✅ 报告生成成功率>99%
- ✅ 数据准确性100%
- ✅ 客服阅读率>80%

---

### 3.3.6 人机协作边界

#### 6.1 Agent主导场景（高自动化）

**适用条件**:
- 常规对话质检（非VIP客户、非投诉对话）
- 无严重违规（critical级别）
- 客服非新人（入职>3个月）
- 评分置信度>0.8

**Agent行为**:
1. 自动对对话进行5维度质检评分
2. 识别违规行为（轻度/中度）
3. 生成改进建议
4. **v0.1-v0.5**: 质检结果推送到客服工作台，需人工确认
5. **v0.8**: 质检结果自动保存，客服可申诉
6. **v1.0**: 自动生成质检报告（周报/月报），人工审核后发送

**自动化率目标**:
- **v0.1**: 100%自动质检（人工可查看结果）
- **v0.5**: 100%自动质检 + 人工抽检10%
- **v0.8**: 100%自动质检 + 自动报告生成
- **v1.0**: 100%自动质检 + 自动报告 + 趋势分析

**示例**:
```
场景：普通客服完成一次常规对话
→ 质检评分：85分
→ 置信度：0.92
→ 违规：无
→ Agent行为：自动保存质检结果，推送到客服工作台
→ 客服行为：查看结果，接受改进建议
```

---

#### 6.2 人工主导场景（低自动化）

**适用条件**:
- 严重违规（critical级别：信息泄露/辱骂/越权）
- VIP客户投诉对话
- 新人客服（入职<1个月）前10次对话
- 质检结果申诉
- 质检报告最终审核

**Agent行为**:
1. 提供初步质检评分（仅供参考）
2. 标注疑似违规行为（需人工确认）
3. 生成改进建议（辅助）
4. **永远需要人工确认，不自动保存**
5. 严重违规推送告警到管理层

**自动化率目标**:
- **所有版本**: 0%自动决策（刻意保持人工）

**示例**:
```
场景：客服泄露客户身份证号
→ 违规类型：information_leakage（critical）
→ Agent行为：
   - 实时检测并推送告警
   - 提供证据片段
   - 建议"立即停止服务，启动安全审计"
→ 管理层行为：
   - 查看证据
   - 人工确认违规
   - 决定处罚措施
   - 启动安全审计流程
```

---

#### 6.3 协作模式（Agent辅助，人工决策）

**适用条件**:
- 中度违规（tone_violation，语气生硬）
- 评分争议（客服申诉质检结果）
- 质检报告生成（Agent生成，人工审核）
- 改进建议执行（Agent建议，人工选择）

**Agent行为**:
1. 生成质检评分和依据
2. 提供多个改进建议（3-5条）
3. 人工选择采纳哪些建议
4. 人工调整评分（如有申诉）

**决策流程**:
```
Agent质检 → 人工审核 → 人工调整（可选）→ 确认保存
```

**示例**:
```
场景：客服质检评分为78分，客服提出申诉
→ Agent评分：78分
→ 申诉理由："客户要求使用'你'而非'您'，所以我改用了'你'"
→ Agent提供证据：对话中确实有客户说"别您您您的，叫我小李就行"
→ 人工复核：
   - 查看证据
   - 判断：申诉成立
   - 调整评分：78 → 85（compliance维度+7分）
→ 标注："已申诉，人工调整"
```

---

### 3.3.7 非功能需求

#### 7.1 性能要求

| 指标 | 目标值 | 测量方法 |
|-----|--------|------------|
| **Agent响应时间** | <3秒（P95） | Prometheus监控LLM调用时长 |
| **质检评分时间** | <2秒（简单对话） | inspectConversation调用时长 |
| **违规检测时间** | <1秒（实时） | detectViolations调用时长 |
| **报告生成时间** | <5分钟（月报） | generateQualityReport调用时长 |
| **并发处理能力** | 支持100+并发质检 | 压力测试验证 |

#### 7.2 质量指标

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------| | **质检准确率** | >90% | 人工抽检100条/周，对比标注 |
| **严重违规识别召回率** | >95% | 不能漏报critical违规 |
| **误报率** | <5% | 避免过度扣分 |
| **客服采纳率** | >70% | 改进建议被采纳的比例 |
| **申诉成功率** | 10-15% | 合理的申诉成功率（不能太高或太低） |

#### 7.3 成本约束

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------| | **LLM调用成本** | <¥3000/月 | DeepSeek计费统计 |
| **平均单次质检成本** | <¥0.02/次 | 成本/质检次数 |
| **Token消耗** | <50k tokens/天 | 监控每次调用的token数 |

**成本优化策略**:
- 优先使用规则引擎处理简单场景（问候语检查、禁用词匹配）
- LLM仅用于复杂评分（专业度、友好度）
- 批量质检，减少API调用

#### 7.4 可用性要求

| 指标 | 目标值 | 说明 |
|-----|--------|------|
| **系统可用性** | >99.9% | 降级策略保障 |
| **降级触发率** | <10% | 降级到规则引擎的比例 |
| **故障恢复时间** | <5分钟 | 从故障到恢复正常的时间 |
| **数据一致性** | 100% | 质检结果不可篡改（审计追溯） |

---

### 3.3.8 验收场景

#### 8.1 验收场景清单

| 场景ID | 场景描述 | 优先级 | 依赖 |
|--------|---------|--------|------| | AC-01 | 常规对话质检（自动评分） | P0 | 无 |
| AC-02 | 严重违规检测（信息泄露） | P0 | AC-01 |
| AC-03 | 服务规范检查（问候语/结束语） | P0 | AC-01 |
| AC-04 | 质检周报生成（个人周报） | P1 | AC-01 |
| AC-05 | 质检结果申诉 | P1 | AC-01 |
| AC-06 | 团队质量对比分析 | P1 | AC-04 |
| AC-07 | 降级到规则引擎 | P1 | AC-01 |

---

#### AC-01: 常规对话质检（自动评分）

**场景描述**: 普通客服完成对话后，系统自动触发质检评分，生成5维度评分和改进建议

**输入**:
```json
{
  "conversationId": "CONV-12345",
  "agentId": "AGENT-001",
  "strictMode": false
}
```

**预期Agent输出**:
```json
{
  "inspection": {
    "conversationId": "CONV-12345",
    "overallScore": 85,
    "scoreBreakdown": {
      "responseSpeed": 90,
      "professionalism": 85,
      "friendliness": 80,
      "compliance": 90,
      "resolutionRate": 75
    },
    "grade": "良好",
    "confidence": 0.92
  },
  "violations": [
    {
      "type": "terminology_violation",
      "severity": "low",
      "description": "未使用标准问候语"
    }
  ],
  "highlights": [
    "响应速度快，30秒内首次回复"
  ],
  "improvements": [
    {
      "dimension": "friendliness",
      "issue": "语气略显生硬",
      "suggestion": "可以使用'非常理解您的心情'等共情话术",
      "priority": "medium"
    }
  ],
  "needHumanReview": false
}
```

**验收标准**:
- ✅ overallScore在80-90分范围
- ✅ scoreBreakdown包含5个维度
- ✅ grade识别为"良好"
- ✅ violations识别轻度违规
- ✅ improvements提供具体建议
- ✅ 响应时间<3秒

---

#### AC-02: 严重违规检测（信息泄露）

**场景描述**: 客服在对话中泄露客户身份证号，系统实时检测并立即告警

**输入**:
```json
{
  "conversationId": "CONV-67890",
  "message": "您的身份证号是320XXX198X0X0XXXXX"
}
```

**预期Agent输出**:
```json
{
  "criticalViolations": [
    {
      "type": "information_leakage",
      "severity": "critical",
      "description": "泄露客户身份证号",
      "evidence": "提及了完整身份证号320XXX..."
    }
  ],
  "needImmediateAction": true,
  "recommendedAction": "立即停止该客服服务，启动安全审计",
  "needHumanReview": true
}
```

**验收标准**:
- ✅ type识别为"information_leakage"
- ✅ severity识别为"critical"
- ✅ needHumanReview=true
- ✅ 告警推送延迟<10秒
- ✅ 告警内容包含证据片段

---

#### AC-03: 服务规范检查（问候语/结束语）

**场景描述**: 检查对话是否包含标准问候语和结束语

**输入**:
```json
{
  "conversationId": "CONV-11111"
}
```

**预期Agent输出**:
```json
{
  "complianceScore": 85,
  "checkResults": [
    {
      "rule": "greeting_required",
      "passed": true,
      "evidence": "对话开头使用'您好'"
    },
    {
      "rule": "closing_required",
      "passed": false,
      "evidence": "缺少结束语",
      "penalty": -5
    }
  ],
  "totalViolations": 1
}
```

**验收标准**:
- ✅ greeting_required规则检测正确
- ✅ closing_required规则检测正确
- ✅ penalty扣分合理（-5分）
- ✅ 响应时间<1秒

---

#### AC-04: 质检周报生成（个人周报）

**场景描述**: 每周一自动生成客服个人质检周报

**输入**:
```json
{
  "reportType": "individual_weekly",
  "targetId": "AGENT-001",
  "startDate": "2025-12-23",
  "endDate": "2025-12-29"
}
```

**预期Agent输出**:
```json
{
  "reportType": "individual_weekly",
  "agentName": "张客服",
  "period": "2025-12-23 至 2025-12-29",
  "summary": {
    "totalConversations": 150,
    "inspectedConversations": 30,
    "averageScore": 85,
    "improvementRate": "+5分"
  },
  "dimensionScores": {
    "responseSpeed": 90,
    "professionalism": 82
  },
  "strengths": ["响应速度快"],
  "weaknesses": ["专业度有待提升"],
  "recommendations": ["加强专业培训"]
}
```

**验收标准**:
- ✅ 统计数据准确（对话数、平均分）
- ✅ improvementRate计算正确
- ✅ strengths和weaknesses合理
- ✅ recommendations具体可执行
- ✅ 生成时间<5分钟

---

#### AC-05: 质检结果申诉

**场景描述**: 客服对质检结果提出申诉，人工复核并调整评分

**输入**:
```json
{
  "conversationId": "CONV-22222",
  "originalScore": 78,
  "appealReason": "客户要求使用'你'而非'您'"
}
```

**预期结果**:
- 人工查看证据
- 确认申诉理由成立
- 调整评分：78 → 85
- 标注"已申诉，人工调整"

**验收标准**:
- ✅ 申诉流程完整
- ✅ 证据可追溯
- ✅ 调整记录可查
- ✅ 申诉成功率10-15%

---

#### AC-06: 团队质量对比分析

**场景描述**: 对比团队内客服的质检表现，生成排名

**输入**:
```json
{
  "teamId": "TEAM-001",
  "period": "month"
}
```

**预期Agent输出**:
```json
{
  "teamRanking": [
    {"rank": 1, "agentName": "张客服", "averageScore": 92},
    {"rank": 2, "agentName": "李客服", "averageScore": 88}
  ],
  "teamAverageScore": 82,
  "topPerformers": ["张客服"],
  "needImprovement": ["王客服"]
}
```

**验收标准**:
- ✅ 排名准确
- ✅ 平均分计算正确
- ✅ topPerformers和needImprovement合理

---

### 3.3.9 降级策略

#### 9.1 降级层级

```
主路径: LLM质检 (DeepSeek v3.1)
  ↓ [超时30秒 / API调用失败 / 错误率>10%]
降级1: 规则引擎评分（基于关键词+规则）
  ↓ [规则无覆盖]
降级2: 默认评分80分（标记需人工复核）
  ↓ [严重故障]
降级3: 暂停质检（人工介入）
```

---

#### 9.2 质检评分降级策略

**主路径: LLM质检**

- **触发条件**: 正常情况
- **行为**: 调用DeepSeek v3.1分析对话质量，5维度评分
- **输出**: `{overallScore: 85, scoreBreakdown: {...}, confidence: 0.92}`
- **处理时间**: <3秒

**降级1: 规则引擎评分**

- **触发条件**:
  - LLM超时（>30秒）
  - API调用失败（返回5xx错误）
  - LLM连续10次错误率>10%
- **行为**:
  - 响应速度：计算实际响应时间，映射到分数
  - 专业度：关键词匹配（技术术语使用情况）
  - 友好度：礼貌用语统计（"您好"、"感谢"）
  - 规范性：规则引擎检查（问候语、结束语、禁用词）
  - 解决率：客户反馈识别（"好的"、"谢谢" → 高分）
- **输出**: `{overallScore: 78, confidence: 0.6, fallbackLevel: 1}`
- **置信度**: 0.5-0.7
- **处理时间**: <500ms

**降级2: 默认评分**

- **触发条件**: 规则引擎无法计算评分
- **行为**: 返回默认评分80分，标记需人工复核
- **输出**: `{overallScore: 80, confidence: 0.3, fallbackLevel: 2, needHumanReview: true}`

**降级3: 暂停质检**

- **触发条件**: 系统严重故障
- **行为**: 暂停自动质检，100%人工质检
- **通知**: 推送告警到技术负责人

---

#### 9.3 降级监控

| 监控指标 | 告警阈值 | 处理措施 |
|---------|---------|---------| | **LLM超时率** | >5%（每小时） | 检查LLM服务状态，增加超时时间 |
| **降级1触发率** | >10%（每小时） | 优化Prompt，扩容LLM服务 |
| **降级2触发率** | >5%（每小时） | 扩充规则库 |
| **降级3触发率** | >0%（立即） | 紧急告警，人工介入 |
| **质检准确率** | <85% | 优化评分算法，调整权重 |

**告警通知**:
- 降级1触发>100次/小时 → Slack告警
- 降级2触发>50次/小时 → 邮件通知
- 降级3触发 → 紧急电话通知

**降级恢复**:
- LLM服务恢复后自动切回主路径
- 每5分钟健康检查一次
- 连续3次成功后恢复正常

---

### 3.3.10 监控指标

#### 10.1 核心指标

| 指标名称 | 指标定义 | 监控工具 | 告警阈值 | 优先级 |
|---------|---------|---------|---------|--------|
| **质检调用次数** | 每小时调用量 | Prometheus | >500次/小时 | P1 |
| **质检成功率** | 成功质检/总调用 | Prometheus | <95% | P0 |
| **平均质检时间** | P95质检时长 | Prometheus | >3秒 | P0 |
| **质检准确率** | 人工抽检准确率 | 人工标注 | <90% | P0 |
| **严重违规识别率** | 识别/实际严重违规 | Prometheus | <95% | P0 |
| **降级触发次数** | 降级到规则引擎次数 | Prometheus | >50次/小时 | P1 |
| **报告生成成功率** | 成功生成/总任务 | Prometheus | <99% | P1 |
| **客服采纳率** | 采纳建议/总建议 | Prometheus | <70% | P2 |
| **申诉成功率** | 申诉成功/总申诉 | Prometheus | >30% OR <5% | P2 |

---

#### 10.2 Prometheus指标定义

```promql
# ===== 质检调用 =====

# 质检调用总次数
inspector_agent_inspection_total{
  agent="InspectorAgent",
  result="success|failure|timeout"
} counter

# 质检响应时间
inspector_agent_inspection_duration_seconds{
  agent="InspectorAgent",
  inspection_type="conversation|compliance|violation"
} histogram

# ===== 质检评分 =====

# 质检评分分布
inspector_agent_score_distribution{
  agent="InspectorAgent",
  bucket="0-60|60-70|70-80|80-90|90-100"
} gauge

# 维度评分平均值
inspector_agent_dimension_score{
  agent="InspectorAgent",
  dimension="responseSpeed|professionalism|friendliness|compliance|resolutionRate"
} gauge

# ===== 违规检测 =====

# 违规检测总次数
inspector_agent_violations_detected{
  agent="InspectorAgent",
  type="terminology|tone|leakage|abuse|unauthorized",
  severity="low|medium|critical"
} counter

# 严重违规识别率
inspector_agent_critical_violation_recall{
  agent="InspectorAgent"
} gauge

# ===== 降级监控 =====

# 降级触发次数
inspector_agent_fallback_triggered{
  agent="InspectorAgent",
  fallback_level="1|2|3",
  reason="llm_timeout|api_error|rule_no_match"
} counter

# ===== 报告生成 =====

# 报告生成次数
inspector_agent_reports_generated{
  agent="InspectorAgent",
  report_type="individual_weekly|team_monthly",
  result="success|failure"
} counter

# 报告生成时间
inspector_agent_report_generation_duration_seconds{
  agent="InspectorAgent",
  report_type="individual_weekly|team_monthly"
} histogram

# ===== 业务指标 =====

# 改进建议采纳率
inspector_agent_recommendation_adopted{
  agent="InspectorAgent"
} counter

inspector_agent_recommendation_rejected{
  agent="InspectorAgent"
} counter

# 申诉成功率
inspector_agent_appeals_total{
  agent="InspectorAgent",
  result="approved|rejected"
} counter
```

---

#### 10.3 Grafana仪表板

**仪表板名称**: InspectorAgent - 质检监控

**刷新频率**: 30秒

---

**Row 1: 核心指标概览**

**面板1.1: 质检调用量趋势（折线图）**
- X轴: 时间（最近24小时）
- Y轴: 调用次数/小时
- 系列:
  - 成功质检（绿色）
  - 失败质检（红色）
  - 超时质检（橙色）

**面板1.2: 质检成功率（Stat面板）**
- 显示值: 百分比
- 阈值:
  - <90%: 红色
  - 90-95%: 橙色
  - >95%: 绿色

**面板1.3: 平均质检时间（Gauge仪表盘）**
- 单位: 秒
- 阈值:
  - <2秒: 绿色
  - 2-3秒: 橙色
  - >3秒: 红色

**面板1.4: 质检准确率（Stat面板）**
- 显示值: 百分比
- 阈值:
  - <85%: 红色
  - 85-90%: 橙色
  - >90%: 绿色

---

**Row 2: 质检评分分析**

**面板2.1: 评分分布（饼图）**
- 系列:
  - 90-100分（优秀，绿色）
  - 80-89分（良好，蓝色）
  - 70-79分（合格，黄色）
  - 60-69分（待改进，橙色）
  - 0-59分（不合格，红色）

**面板2.2: 维度评分趋势（折线图）**
- X轴: 时间（最近7天）
- Y轴: 平均分
- 系列:
  - 响应速度（蓝色）
  - 专业度（绿色）
  - 友好度（黄色）
  - 规范性（橙色）
  - 解决率（紫色）

**面板2.3: 平均质检分数（Stat面板）**
- 显示值: 分数（0-100）
- 阈值:
  - <70: 红色
  - 70-80: 橙色
  - >80: 绿色

---

**Row 3: 违规监控**

**面板3.1: 违规类型分布（柱状图）**
- X轴: 违规类型
- Y轴: 检测次数
- 系列:
  - terminology（术语违规，蓝色）
  - tone（语气违规，黄色）
  - leakage（信息泄露，红色）
  - abuse（辱骂客户，深红色）
  - unauthorized（越权操作，紫色）

**面板3.2: 严重违规趋势（折线图）**
- X轴: 时间（最近30天）
- Y轴: 违规次数
- 系列:
  - information_leakage（红色）
  - abuse_language（深红色）
  - unauthorized_operation（紫色）

**面板3.3: 严重违规识别率（Gauge仪表盘）**
- 单位: 百分比
- 阈值:
  - <90%: 红色
  - 90-95%: 橙色
  - >95%: 绿色

---

**Row 4: 报告生成监控**

**面板4.1: 报告生成成功率（Stat面板）**
- 显示值: 百分比
- 阈值:
  - <95%: 红色
  - 95-99%: 橙色
  - >99%: 绿色

**面板4.2: 报告生成时间（折线图）**
- X轴: 时间
- Y轴: 生成时间（秒）
- 系列:
  - 个人周报（蓝色）
  - 团队月报（绿色）

**面板4.3: 本周报告统计（Table表格）**
- 列: 报告类型、生成数量、成功率、平均时间

---

**Row 5: 业务分析**

**面板5.1: 改进建议采纳率（折线图）**
- X轴: 时间（最近30天）
- Y轴: 采纳率（百分比）
- 阈值线: 70%（目标线，绿色虚线）

**面板5.2: 申诉统计（柱状图）**
- X轴: 时间（周）
- Y轴: 申诉数量
- 系列:
  - 申诉成功（绿色）
  - 申诉失败（红色）

**面板5.3: 客服质检排名（Table表格）**
- 列: 排名、客服姓名、平均分、本周对话数、趋势（↗️/↘️）

---

### 3.3.11 示例对话

#### 示例1: 优秀对话质检（高分案例）

**对话背景**: 客服专业处理VIP客户故障问题，获得高质检分数

```
【对话内容】

客户: "系统又打不开了，太烂了，影响我工作！"

客服: "尊敬的用户，您好！非常抱歉给您带来困扰，我能理解您现在很着急。"
客服: "我立即帮您排查问题。请问您使用的是什么版本的系统？"

客户: "2.5版本"

客服: "好的，感谢您的配合。2.5版本最近确实有部分用户反馈登录问题，我们已经在紧急修复中。"
客服: "请您先尝试清除浏览器缓存，具体操作：按Ctrl+Shift+Delete，选择'缓存图像和文件'，然后点击'清除数据'。"

客户: "好，试试"
（2分钟后）

客户: "可以了，谢谢"

客服: "太好了！问题解决让我也很开心。如果后续还有任何问题，欢迎随时联系我。祝您工作顺利！"

【InspectorAgent思考过程】

Step 1: 调用inspectConversation()
  → conversationId: CONV-99999
  → agentId: AGENT-001（张客服）
  → strictMode: true（VIP客户）

Step 2: 分析各维度

**响应速度**:
- 首次响应: 25秒 → 优秀
- 后续响应: 平均40秒 → 优秀
- 评分: 95分

**专业度**:
- 术语准确: "清除浏览器缓存"、"Ctrl+Shift+Delete"
- 方案可行: 确实能解决问题
- 知识扎实: 了解2.5版本的已知问题
- 评分: 95分

**友好度**:
- 共情表达: "非常抱歉"、"我能理解您现在很着急"
- 礼貌用语: "尊敬的用户"、"感谢您的配合"
- 个性化关怀: "问题解决让我也很开心"
- 评分: 98分

**规范性**:
- ✅ 问候语: "尊敬的用户，您好"（VIP标准）
- ✅ 结束语: "欢迎随时联系我。祝您工作顺利"
- ✅ 敬语: 全程使用"您"
- ✅ 无禁用词
- 评分: 100分

**解决率**:
- 客户明确表示"可以了，谢谢"
- 问题彻底解决
- 评分: 95分

Step 3: 计算综合评分
  overallScore = 95×0.15 + 95×0.30 + 98×0.20 + 100×0.25 + 95×0.10
              = 14.25 + 28.5 + 19.6 + 25 + 9.5
              = 96.85 → 97分

Step 4: 检测违规
  → 无任何违规

Step 5: 识别亮点
  - VIP客户处理规范（使用敬语、及时响应）
  - 共情表达到位（安抚负面情绪）
  - 专业度高（准确诊断+可行方案）

【Agent输出】
{
  "inspection": {
    "conversationId": "CONV-99999",
    "overallScore": 97,
    "scoreBreakdown": {
      "responseSpeed": 95,
      "professionalism": 95,
      "friendliness": 98,
      "compliance": 100,
      "resolutionRate": 95
    },
    "grade": "优秀",
    "confidence": 0.95
  },
  "violations": [],
  "highlights": [
    "VIP客户处理规范，使用尊称和敬语",
    "共情表达到位，有效安抚客户负面情绪",
    "专业度高，准确诊断问题并提供可行方案",
    "响应速度快，首次响应<30秒",
    "服务态度优秀，获客户高度评价"
  ],
  "improvements": [],
  "needHumanReview": false
}

【前端展示】
┌─────────────────────────────────────┐
│ 🌟 优秀案例 - CONV-99999             │
├─────────────────────────────────────┤
│ 综合评分：97分（优秀）⭐⭐⭐⭐⭐     │
│                                      │
│ 📊 维度评分：                        │
│ • 响应速度：95分 ⚡⚡⚡⚡⚡          │
│ • 专业度：95分 📚📚📚📚📚           │
│ • 友好度：98分 😊😊😊😊😊           │
│ • 规范性：100分 ✓✓✓✓✓               │
│ • 解决率：95分 ✔️✔️✔️✔️✔️            │
│                                      │
│ 🌟 本次亮点：                        │
│ • VIP客户处理规范                    │
│ • 共情表达到位，有效安抚负面情绪     │
│ • 专业度高，准确诊断并解决问题       │
│                                      │
│ 💡 建议：                            │
│ 本次对话表现优秀，建议作为培训案例   │
│                                      │
│ [分享案例] [查看详情]                │
└─────────────────────────────────────┘

【管理层操作】
标记为最佳实践案例 → 用于团队培训 → 表扬张客服
```

**关键决策点**:
1. **为什么overallScore=97分**:
   - 5个维度全部>90分（均为优秀级别）
   - compliance达到满分100（VIP规范完全遵守）
   - friendliness高达98分（共情表达优秀）

2. **为什么friendliness=98分**:
   - 使用共情话术（"非常抱歉"、"我能理解您现在很着急"）
   - 个性化关怀（"问题解决让我也很开心"）
   - VIP标准问候（"尊敬的用户，您好"）

3. **为什么标记为最佳实践**:
   - 综合评分>95分
   - VIP客户处理
   - 负面情绪成功转化为满意
   - 适合作为培训案例

---

#### 示例2: 违规对话质检（信息泄露）

**对话背景**: 客服不慎泄露客户身份证号，触发严重违规告警

```
【对话内容】

客户: "我需要办理退款，你们需要什么材料？"

客服: "您好！退款需要提供订单号和身份证号。"

客户: "订单号是12345678"

客服: "好的，您的身份证号是320XXX198X0X0XXXXX，对吗？请核对一下"

【InspectorAgent思考过程】

Step 1: 实时监控MessageSentEvent
  → 客服发送消息: "好的，您的身份证号是320XXX198X0X0XXXXX，对吗？"
  → 触发时间: 2025-12-29T10:05:12Z

Step 2: 调用detectViolations()
  → 敏感词匹配: 检测到"身份证号"
  → 格式识别: 检测到18位数字（320XXX198X0X0XXXXX）
  → 判断: information_leakage（信息泄露）
  → 严重性: critical（严重）

Step 3: 立即触发告警
  → Slack通知: "@管理层 🔴 严重违规：客服AGENT-002泄露客户身份证号"
  → 邮件通知: "紧急：质检发现信息泄露违规，涉及客服李客服"
  → 标记: 该对话需100%人工审核
  → 暂停: 该客服自动质检改为100%人工审核

Step 4: 生成质检结果
  → overallScore: 0（强制降至0分）
  → needHumanReview: true
  → recommendedAction: "立即停止服务，启动安全审计"

【Agent输出】
{
  "criticalViolations": [
    {
      "type": "information_leakage",
      "severity": "critical",
      "description": "主动泄露客户身份证号",
      "evidence": "在对话中主动说出完整身份证号'320XXX198X0X0XXXXX'",
      "timestamp": "2025-12-29T10:05:12Z",
      "agentId": "AGENT-002",
      "agentName": "李客服",
      "conversationId": "CONV-88888"
    }
  ],
  "inspection": {
    "overallScore": 0,
    "grade": "不合格",
    "confidence": 1.0
  },
  "needImmediateAction": true,
  "recommendedAction": "1. 立即停止该客服服务\n2. 启动安全审计流程\n3. 联系客户说明情况并道歉\n4. 审查该客服是否有其他泄露行为",
  "needHumanReview": true,
  "reviewReason": "严重违规：信息泄露"
}

【前端展示】
┌─────────────────────────────────────┐
│ 🔴🔴🔴 严重违规告警 🔴🔴🔴           │
├─────────────────────────────────────┤
│ 违规类型：信息泄露（CRITICAL）        │
│ 违规客服：李客服（AGENT-002）         │
│ 对话ID：CONV-88888                   │
│ 时间：2025-12-29 10:05:12            │
│                                      │
│ ⚠️ 违规描述：                        │
│ 主动泄露客户身份证号                  │
│                                      │
│ 📋 证据：                            │
│ "您的身份证号是320XXX198X0X0XXXXX，  │
│  对吗？"                             │
│                                      │
│ ⚡ 处理建议：                         │
│ 1. 立即停止该客服服务                 │
│ 2. 启动安全审计流程                   │
│ 3. 联系客户说明情况并道歉             │
│ 4. 审查是否有其他泄露行为             │
│                                      │
│ 📊 质检评分：0分（强制）              │
│                                      │
│ [立即处理] [查看完整对话]             │
└─────────────────────────────────────┘

【Slack通知】
@管理层 🔴 严重违规告警

客服：李客服（AGENT-002）
对话：CONV-88888
时间：2025-12-29 10:05:12

违规类型：信息泄露（CRITICAL）
描述：主动泄露客户身份证号

证据：
"您的身份证号是320XXX198X0X0XXXXX，对吗？"

立即处理：
[查看详情] [停止服务] [启动审计]

【管理层操作】
收到告警（<10秒） → 查看证据 → 确认严重违规 → 立即停止该客服服务 → 启动安全审计 → 联系客户道歉 → 审查该客服历史对话 → 处罚决策
```

**关键决策点**:
1. **为什么判定为information_leakage**:
   - 敏感词匹配：检测到"身份证号"
   - 格式识别：检测到18位数字（身份证格式）
   - 主动泄露：客服主动说出（而非客户提供）

2. **为什么overallScore强制降至0分**:
   - 严重违规（critical级别）
   - 涉及客户隐私安全
   - 触发不可饶恕的底线

3. **为什么推送紧急告警**:
   - 需要立即处理（防止继续泄露）
   - 需要启动安全审计（评估影响范围）
   - 需要联系客户道歉（挽回信任）

---

#### 示例3: 申诉成功（人工复核调整评分）

**对话背景**: 客服质检78分，客服申诉称客户要求使用"你"而非"您"，人工复核后调整评分

```
【原始质检结果】
对话ID: CONV-77777
客服: 王客服（AGENT-003）
综合评分: 78分（合格）
扣分项: compliance维度扣7分（未使用敬语"您"）

【客服申诉】
申诉理由: "对话中客户明确要求我使用'你'而不是'您'，说'别您您您的，叫我小李就行'，所以我后续改用了'你'。"

【InspectorAgent思考过程】

Step 1: 接收申诉请求
  → conversationId: CONV-77777
  → originalScore: 78
  → appealReason: "客户要求使用'你'而非'您'"

Step 2: 提取证据
  → 读取完整对话记录
  → 查找相关证据片段

Step 3: 证据分析
  → 找到客户消息: "别您您您的，叫我小李就行"
  → 时间戳: 对话第3轮
  → 客服后续确实改用"你"
  → 判断: 申诉理由成立

Step 4: 人工复核决策
  → 查看证据: 确认客户明确要求
  → 判断: 客服正确响应客户要求，不应扣分
  → 调整评分: compliance 83 → 90（+7分）
  → 综合评分: 78 → 85（+7分）
  → 标注: "已申诉，人工调整，客户要求使用'你'"

【调整后结果】
{
  "inspection": {
    "conversationId": "CONV-77777",
    "originalScore": 78,
    "adjustedScore": 85,
    "scoreBreakdown": {
      "responseSpeed": 85,
      "professionalism": 80,
      "friendliness": 82,
      "compliance": 90,  // 调整前: 83
      "resolutionRate": 80
    },
    "grade": "良好",  // 调整前: 合格
    "appealStatus": "approved",
    "appealReason": "客户明确要求使用'你'而非'您'",
    "adjustedBy": "质检主管",
    "adjustedAt": "2025-12-29T14:30:00Z",
    "note": "已申诉，人工调整"
  },
  "evidence": {
    "customerRequest": "别您您您的，叫我小李就行",
    "timestamp": "2025-12-29T10:02:15Z"
  }
}

【前端展示】
┌─────────────────────────────────────┐
│ ✅ 申诉已批准 - CONV-77777           │
├─────────────────────────────────────┤
│ 原始评分：78分（合格）                │
│ 调整后评分：85分（良好）↗️ +7分      │
│                                      │
│ 📋 申诉理由：                        │
│ 客户明确要求使用'你'而非'您'         │
│                                      │
│ 🔍 证据：                            │
│ 客户消息："别您您您的，叫我小李就行" │
│ 时间：2025-12-29 10:02:15            │
│                                      │
│ ✅ 复核结论：                        │
│ 申诉成立。客服正确响应客户要求，      │
│ compliance维度调整：83分 → 90分      │
│                                      │
│ 📝 备注：                            │
│ 已申诉，人工调整                      │
│ 复核人：质检主管                      │
│ 时间：2025-12-29 14:30               │
│                                      │
│ [查看详情] [确认]                    │
└─────────────────────────────────────┘

【客服操作】
收到申诉批准通知 → 查看调整结果 → 评分从78→85 → 满意
```

**关键决策点**:
1. **为什么申诉成立**:
   - 有明确证据（客户消息"别您您您的，叫我小李就行"）
   - 客服行为合理（正确响应客户要求）
   - 规则应当灵活（客户明确要求时可调整）

2. **为什么调整compliance评分**:
   - 原评分扣分理由：未使用敬语"您"
   - 调整理由：客户明确要求使用"你"
   - 调整幅度：+7分（恢复扣分）

3. **为什么标注"已申诉，人工调整"**:
   - 保证审计追溯（记录评分调整历史）
   - 避免误解（说明评分变化原因）
   - 质量管理（统计申诉成功率）

---

## 3.4 Orchestrator - 智能路由

> **PRD格式**: Agent PRD（11章结构）
> **优先级**: P0
> **所属版本**: v0.1（已实现）

[待完善 - 按照3.1的11章结构填写]

---

# 第4部分：混合模块（Agent PRD + 功能PRD）

## 4.1 知识库模块

> **PRD格式**: 混合PRD（Agent能力 + 功能部分 + 人机协作）
> **优先级**: P0
> **所属版本**: v0.1 + v0.8（自动沉淀）+ v1.0（知识图谱）

### 4.1.1 第1部分：Agent能力部分

#### 1.1 Agent Profile

##### 1.1.1 身份定义

**Agent Name**: EngineerAgent / AssistantAgent (知识检索与沉淀子能力)

**Role**: 智能知识助手，负责在对话中实时检索知识、自动沉淀新知识、构建知识图谱并提供关联推荐

**本模块职责**:
- **语义检索**: 基于客户问题和对话上下文，从知识库中检索最相关的解决方案
- **知识沉淀**: 自动从成功对话中提取有价值的知识，补充到知识库
- **知识推荐**: 基于知识图谱和客户画像，推荐相关知识内容
- **知识关联**: 分析知识之间的关联关系，构建知识图谱

**Capabilities**:
- `searchKnowledge` (MCP): 多模式知识检索(关键词/语义/问答)
- `uploadDocument` (MCP): 文档上传与解析
- `getKnowledgeDetail` (MCP): 获取知识详情
- `extractKnowledge` (MCP, v0.8): 从对话中提取并沉淀新知识
- `generateKnowledgeGraph` (MCP, v1.0): 生成知识图谱关联

##### 1.1.2 能力边界

| 能做什么 | 不能做什么 |
|---------|-----------|
| ✅ 语义检索知识库(相关度>0.7) | ❌ 不发送未审核的高风险知识内容 |
| ✅ 自动提取对话中的新知识点 | ❌ 不自动删除或覆盖已有知识 |
| ✅ 推荐相关知识(最多5条) | ❌ 不推荐过时或低评分知识(<3.0分) |
| ✅ 标注知识来源和更新时间 | ❌ 不编造不存在的知识内容 |
| ✅ 识别知识缺失并建议补充 | ❌ 不代替人工审核知识质量 |

**知识引用规范**:
- 明确标注来源: `[来源: 知识库 - ${title} | 更新于 ${updatedAt}]`
- 标注相关度: `相关度: ${score * 100}%`
- 低置信度警告: 相关度<0.7时提示"建议人工确认"

---

#### 1.2 工具清单

##### 工具1: searchKnowledge

**功能描述**: 从知识库中检索与用户问题相关的知识内容，支持关键词、语义和问答三种检索模式

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| query | string | 是 | 搜索查询内容 | 长度1-500字符 |
| mode | string | 否 | 检索模式 | 'keyword' \| 'semantic' \| 'qa'，默认'keyword' |
| filters | object | 否 | 过滤条件 | - |
| filters.category | string | 否 | 知识分类 | - |
| filters.tags | string[] | 否 | 标签筛选 | - |
| filters.limit | number | 否 | 返回数量限制 | 1-20，默认5 |
| filters.topK | number | 否 | 向量检索Top-K | 1-10，默认5 |

**输出格式**:
```json
{
  "results": [
    {
      "id": "kb-001",
      "title": "产品配置问题解决方案",
      "content": "详细内容...",
      "category": "technical",
      "tags": ["配置", "故障排查"],
      "source": "manual",
      "score": 0.92,
      "metadata": {
        "viewCount": 156,
        "rating": 4.5
      },
      "createdAt": "2024-01-15T10:30:00Z",
      "updatedAt": "2024-12-20T15:45:00Z"
    }
  ],
  "total": 1,
  "mode": "semantic"
}
```

**调用方式**: MCP (Model Context Protocol)

**与UI的关联**:
- `results[].title` → 知识卡片标题
- `results[].content` → 知识内容预览(前200字符)
- `results[].score` → 相关度百分比 (×100%)
- `results[].tags` → 标签组件
- `results[].metadata.rating` → 星级评分组件

**检索模式说明**:
- **keyword**: 基于关键词匹配，适用于精确查询
- **semantic**: 基于向量语义检索，适用于模糊查询和理解用户意图
- **qa**: 问答模式，直接返回最佳答案而非知识条目列表

---

##### 工具2: uploadDocument

**功能描述**: 上传文档(PDF/Word/TXT)到知识库，自动解析并提取知识内容

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| title | string | 是 | 文档标题 | 长度1-200字符 |
| fileBase64 | string | 是 | 文件Base64编码 | 支持PDF/DOCX/TXT，<10MB |
| category | string | 否 | 知识分类 | - |
| companyEntity | string | 否 | 所属公司主体 | - |

**输出格式**:
```json
{
  "success": true,
  "knowledgeId": "kb-002",
  "title": "产品用户手册v2.0",
  "extractedCount": 12,
  "category": "manual",
  "message": "文档上传成功，已提取12条知识"
}
```

**调用方式**: MCP

**与UI的关联**:
- `success` → 上传成功提示
- `extractedCount` → "已提取X条知识"提示
- `knowledgeId` → 跳转到知识详情页链接

**处理流程**:
1. 解析文档内容(PDF→Text, DOCX→Markdown)
2. 分段处理(按章节/段落)
3. 提取关键信息(标题、正文、图表说明)
4. 自动分类和打标签
5. 写入知识库并建立索引

---

##### 工具3: getKnowledgeDetail

**功能描述**: 获取指定知识的完整详情，包括元数据和历史版本信息

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| knowledgeId | string | 是 | 知识ID | - |

**输出格式**:
```json
{
  "id": "kb-001",
  "title": "产品配置问题解决方案",
  "content": "完整内容...",
  "category": "technical",
  "tags": ["配置", "故障排查"],
  "source": "manual",
  "metadata": {
    "viewCount": 156,
    "rating": 4.5,
    "usageCount": 23,
    "lastUsedAt": "2024-12-28T10:00:00Z"
  },
  "createdAt": "2024-01-15T10:30:00Z",
  "updatedAt": "2024-12-20T15:45:00Z",
  "isArchived": false
}
```

**调用方式**: MCP

**与UI的关联**:
- `title` → 详情页标题
- `content` → Markdown渲染器
- `metadata.viewCount` → "已查看156次"
- `metadata.rating` → 星级评分显示
- `metadata.usageCount` → "已使用23次"

---

##### 工具4: extractKnowledge (v0.8 自动沉淀)

**功能描述**: 从成功解决的对话中自动提取有价值的知识，补充到知识库

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| conversationId | string | 是 | 对话ID | - |
| extractMode | string | 否 | 提取模式 | 'auto' \| 'manual'，默认'auto' |

**输出格式**:
```json
{
  "extracted": true,
  "knowledgeItems": [
    {
      "title": "客户提问的问题摘要",
      "content": "问题: ...\n解决方案: ...\n验证结果: ...",
      "category": "qa",
      "tags": ["自动提取", "客户问题"],
      "confidence": 0.88,
      "needReview": true
    }
  ],
  "count": 1
}
```

**调用方式**: MCP

**与UI的关联**:
- `knowledgeItems[].title` → 待审核知识卡片标题
- `knowledgeItems[].confidence` → 置信度进度条
- `needReview: true` → 显示"待人工审核"标签
- UI提供【批准】【编辑】【拒绝】三个操作按钮

**提取触发条件**:
- 对话状态为"已解决"(resolved)
- 对话轮次≥3轮
- 客户满意度≥4分
- 知识库中不存在类似知识(相似度<0.8)

**提取逻辑**:
1. 识别客户核心问题
2. 提取客服回复中的解决方案
3. 记录问题验证结果
4. 生成结构化知识条目
5. 标记为"待审核"状态

---

##### 工具5: generateKnowledgeGraph (v1.0 知识图谱)

**功能描述**: 分析知识之间的关联关系，生成知识图谱并推荐相关知识

**输入参数**:
| 参数名 | 类型 | 必填 | 说明 | 约束 |
|-------|------|------|------|------|
| knowledgeId | string | 是 | 中心知识ID | - |
| depth | number | 否 | 关联深度 | 1-3，默认2 |

**输出格式**:
```json
{
  "centerNode": {
    "id": "kb-001",
    "title": "产品配置问题解决方案"
  },
  "relatedNodes": [
    {
      "id": "kb-015",
      "title": "配置文件格式说明",
      "relation": "prerequisite",
      "weight": 0.92
    },
    {
      "id": "kb-023",
      "title": "常见配置错误排查",
      "relation": "related",
      "weight": 0.85
    }
  ],
  "graph": {
    "nodes": [...],
    "edges": [...]
  }
}
```

**调用方式**: MCP

**与UI的关联**:
- `centerNode` → 知识图谱中心节点
- `relatedNodes` → 关联知识推荐列表
- `graph` → D3.js/ECharts图谱可视化
- `relation` → 关系标签(前置知识/相关知识/后续扩展)

**关系类型**:
- **prerequisite**: 前置知识(需要先了解)
- **related**: 相关知识(同一主题)
- **follow-up**: 后续扩展(深入学习)
- **alternative**: 替代方案

---

#### 1.3 业务场景

##### 场景1: 客服对话中实时检索知识

**场景描述**: 客服在回复客户问题时，Agent自动检索知识库并推荐相关解决方案

**触发条件**:
- 客户发送新消息
- 消息类型为"问题咨询"
- AssistantAgent识别到明确的问题意图

**Agent处理流程**:
```mermaid
sequenceDiagram
    participant Customer
    participant Frontend
    participant Backend
    participant AssistantAgent
    participant KnowledgeMCP
    participant KnowledgeDB

    Customer->>Frontend: 发送问题"产品配置失败怎么办?"
    Frontend->>Backend: POST /api/chat/send
    Backend->>AssistantAgent: 调用AssistantAgent
    AssistantAgent->>KnowledgeMCP: searchKnowledge({query, mode:'semantic'})
    KnowledgeMCP->>KnowledgeDB: 向量检索
    KnowledgeDB-->>KnowledgeMCP: 返回Top 3相关知识
    KnowledgeMCP-->>AssistantAgent: 知识检索结果
    AssistantAgent-->>Backend: Agent输出(含知识推荐)
    Backend-->>Frontend: 返回消息+知识卡片
    Frontend->>Customer: 显示回复+知识推荐面板
```

**Agent输出**:
```json
{
  "reply": "您好，关于产品配置失败的问题，我为您找到了以下解决方案：",
  "knowledgeRecommendations": [
    {
      "id": "kb-001",
      "title": "产品配置问题解决方案",
      "snippet": "常见原因包括配置文件格式错误、权限不足...",
      "score": 0.92,
      "source": "manual"
    },
    {
      "id": "kb-015",
      "title": "配置文件格式说明",
      "snippet": "配置文件应采用JSON格式，字段说明如下...",
      "score": 0.85,
      "source": "manual"
    }
  ],
  "confidence": 0.92,
  "needHumanReview": false
}
```

**UI展示**:

Frontend渲染为：

```
[AI助手回复]
您好，关于产品配置失败的问题，我为您找到了以下解决方案：

[知识推荐卡片 1]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📘 产品配置问题解决方案              [相关度: 92%]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
常见原因包括配置文件格式错误、权限不足...
[查看详情] [引用到回复]
来源: 产品手册 | 更新于 2024-12-20

[知识推荐卡片 2]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📘 配置文件格式说明                  [相关度: 85%]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
配置文件应采用JSON格式，字段说明如下...
[查看详情] [引用到回复]
来源: 产品手册 | 更新于 2024-11-10
```

客服可点击【引用到回复】将知识内容插入到回复框中，编辑后发送给客户。

---

##### 场景2: 对话结束后自动沉淀新知识

**场景描述**: 对话成功解决客户问题后，Agent自动提取对话中的新知识并建议添加到知识库

**触发条件**:
- 对话状态变更为"已解决"
- 客户满意度评分≥4分
- 对话轮次≥3轮
- 系统检测到该问题在知识库中相似度<0.8

**Agent处理流程**:
```mermaid
sequenceDiagram
    participant CSR as 客服
    participant Frontend
    participant Backend
    participant EngineerAgent
    participant KnowledgeMCP
    participant KnowledgeDB

    CSR->>Frontend: 点击【标记为已解决】
    Frontend->>Backend: POST /api/conversations/{id}/resolve
    Backend->>Backend: 检查自动沉淀条件
    Backend->>EngineerAgent: extractKnowledge(conversationId)
    EngineerAgent->>EngineerAgent: 分析对话内容
    EngineerAgent->>EngineerAgent: 提取问题+解决方案
    EngineerAgent->>KnowledgeMCP: searchKnowledge(check similarity)
    KnowledgeMCP-->>EngineerAgent: 相似度<0.8(新知识)
    EngineerAgent-->>Backend: 返回待审核知识
    Backend-->>Frontend: 显示知识沉淀建议
    Frontend->>CSR: 弹窗"检测到新知识，是否添加到知识库?"
    CSR->>Frontend: 点击【审核并添加】
    Frontend->>Backend: POST /api/knowledge/review
    Backend->>KnowledgeDB: 保存新知识
    KnowledgeDB-->>Backend: 保存成功
    Backend-->>Frontend: 成功提示
    Frontend->>CSR: "知识已添加到知识库"
```

**Agent输出**:
```json
{
  "extracted": true,
  "knowledgeItems": [
    {
      "title": "Windows系统下产品无法启动的解决方案",
      "content": "**问题描述**:\n客户反馈产品在Windows 11系统下无法启动，提示\"缺少依赖库\"。\n\n**解决方案**:\n1. 安装Visual C++ 2019 Redistributable\n2. 以管理员权限运行产品\n3. 检查防火墙设置\n\n**验证结果**:\n客户按照方案操作后成功启动，问题解决。",
      "category": "technical",
      "tags": ["Windows", "启动失败", "依赖库"],
      "source": "conversation-conv-12345",
      "confidence": 0.88,
      "needReview": true,
      "extractedFrom": {
        "conversationId": "conv-12345",
        "customerId": "cust-456",
        "csrId": "csr-789",
        "resolvedAt": "2024-12-30T14:30:00Z"
      }
    }
  ],
  "count": 1
}
```

**UI展示**:

弹窗显示：

```
┌─────────────────────────────────────────────────┐
│ 🎯 检测到新知识，是否添加到知识库?               │
├─────────────────────────────────────────────────┤
│                                                  │
│ 📝 标题: Windows系统下产品无法启动的解决方案     │
│                                                  │
│ 🏷️ 分类: 技术支持                               │
│ 🏷️ 标签: Windows, 启动失败, 依赖库              │
│                                                  │
│ 📊 置信度: 88%                                   │
│ ⚠️  需要人工审核                                 │
│                                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ **问题描述**:                                │ │
│ │ 客户反馈产品在Windows 11系统下无法启动...    │ │
│ │                                              │ │
│ │ **解决方案**:                                │ │
│ │ 1. 安装Visual C++ 2019 Redistributable       │ │
│ │ 2. 以管理员权限运行产品                      │ │
│ │ 3. 检查防火墙设置                            │ │
│ │                                              │ │
│ │ **验证结果**:                                │ │
│ │ 客户按照方案操作后成功启动，问题解决。        │ │
│ └─────────────────────────────────────────────┘ │
│                                                  │
│ 来源对话: #conv-12345 | 客服: 张三               │
│ 解决时间: 2024-12-30 14:30                       │
│                                                  │
│         [✏️ 编辑] [✅ 批准添加] [❌ 拒绝]          │
└─────────────────────────────────────────────────┘
```

客服可以：
- 点击【编辑】修改内容后批准
- 点击【批准添加】直接添加到知识库
- 点击【拒绝】不添加此知识

---

##### 场景3: 知识图谱关联推荐 (v1.0)

**场景描述**: 客服查看某个知识详情时，系统自动展示知识图谱和相关知识推荐

**触发条件**:
- 客服点击知识卡片【查看详情】
- 或在知识库管理页面打开知识详情

**Agent处理流程**:
```mermaid
sequenceDiagram
    participant CSR as 客服
    participant Frontend
    participant Backend
    participant EngineerAgent
    participant KnowledgeMCP
    participant KnowledgeDB

    CSR->>Frontend: 点击【查看详情】
    Frontend->>Backend: GET /api/knowledge/{id}
    Backend->>KnowledgeMCP: getKnowledgeDetail(id)
    KnowledgeMCP->>KnowledgeDB: 查询知识
    KnowledgeDB-->>KnowledgeMCP: 返回知识详情
    KnowledgeMCP-->>Backend: 知识详情

    par 并行请求
        Backend->>EngineerAgent: generateKnowledgeGraph(id, depth:2)
        EngineerAgent->>KnowledgeMCP: 分析知识关联
        KnowledgeMCP-->>EngineerAgent: 关联知识列表
        EngineerAgent-->>Backend: 知识图谱数据
    end

    Backend-->>Frontend: 知识详情+图谱数据
    Frontend->>CSR: 渲染详情页+知识图谱
```

**Agent输出**:
```json
{
  "centerNode": {
    "id": "kb-001",
    "title": "产品配置问题解决方案",
    "category": "technical"
  },
  "relatedNodes": [
    {
      "id": "kb-015",
      "title": "配置文件格式说明",
      "relation": "prerequisite",
      "weight": 0.92,
      "description": "了解配置文件格式是解决配置问题的前提"
    },
    {
      "id": "kb-023",
      "title": "常见配置错误排查",
      "relation": "related",
      "weight": 0.85,
      "description": "相关的配置问题排查方法"
    },
    {
      "id": "kb-042",
      "title": "高级配置选项说明",
      "relation": "follow-up",
      "weight": 0.78,
      "description": "深入学习高级配置技巧"
    }
  ],
  "graph": {
    "nodes": [
      {"id": "kb-001", "label": "产品配置问题解决方案", "level": 0},
      {"id": "kb-015", "label": "配置文件格式说明", "level": 1},
      {"id": "kb-023", "label": "常见配置错误排查", "level": 1},
      {"id": "kb-042", "label": "高级配置选项说明", "level": 1}
    ],
    "edges": [
      {"source": "kb-015", "target": "kb-001", "type": "prerequisite"},
      {"source": "kb-001", "target": "kb-023", "type": "related"},
      {"source": "kb-001", "target": "kb-042", "type": "follow-up"}
    ]
  }
}
```

**UI展示**:

```
┌─────────────────────────────────────────────────────────────┐
│ 📘 产品配置问题解决方案                      [编辑] [删除]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│ [知识内容Tab] [知识图谱Tab] [使用统计Tab]                    │
│                                                              │
│ ┌───────────────────────────────────────────────────────┐   │
│ │           知识图谱可视化 (D3.js力导向图)              │   │
│ │                                                        │   │
│ │         ┌─────────────┐                               │   │
│ │         │配置文件格式 │                               │   │
│ │         │   说明      │                               │   │
│ │         └──────┬──────┘                               │   │
│ │                │ prerequisite                          │   │
│ │                ↓                                       │   │
│ │         ┌─────────────┐      related                  │   │
│ │         │  产品配置   ├──────────────┐               │   │
│ │         │问题解决方案 │              │               │   │
│ │         └──────┬──────┘              │               │   │
│ │                │ follow-up           ↓               │   │
│ │                ↓              ┌─────────────┐        │   │
│ │         ┌─────────────┐       │常见配置错误 │        │   │
│ │         │高级配置选项 │       │   排查      │        │   │
│ │         │    说明     │       └─────────────┘        │   │
│ │         └─────────────┘                              │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                              │
│ 📚 相关知识推荐:                                             │
│                                                              │
│ ┌─────────────────────────────────────────────────────┐     │
│ │ 🔵 前置知识 (需要先了解)                            │     │
│ │ • 配置文件格式说明 [相关度: 92%] [查看]             │     │
│ │   "了解配置文件格式是解决配置问题的前提"            │     │
│ └─────────────────────────────────────────────────────┘     │
│                                                              │
│ ┌─────────────────────────────────────────────────────┐     │
│ │ 🟢 相关知识 (同一主题)                              │     │
│ │ • 常见配置错误排查 [相关度: 85%] [查看]             │     │
│ │   "相关的配置问题排查方法"                          │     │
│ └─────────────────────────────────────────────────────┘     │
│                                                              │
│ ┌─────────────────────────────────────────────────────┐     │
│ │ 🟡 后续扩展 (深入学习)                              │     │
│ │ • 高级配置选项说明 [相关度: 78%] [查看]             │     │
│ │   "深入学习高级配置技巧"                            │     │
│ └─────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

---

#### 1.4 非功能需求（Agent部分）

| 指标 | 目标值 | 测量方法 | 说明 |
|-----|--------|---------|------|
| **检索响应时间** | <2秒（P95） | Prometheus监控 | 从调用searchKnowledge到返回结果 |
| **检索准确率** | >85% | 人工抽检(Top 3命中率) | 每周抽检100个查询，检查Top 3是否包含正确答案 |
| **知识沉淀召回率** | >70% | 对话分析 | 成功对话中应被沉淀的知识的实际沉淀比例 |
| **知识沉淀精确率** | >80% | 人工审核通过率 | 自动沉淀的知识经人工审核后的批准比例 |
| **知识图谱生成时间** | <5秒 | Prometheus监控 | depth=2的图谱生成时间 |
| **可用性** | >99.9% | 降级策略保障 | 包含降级到关键词检索的情况 |
| **成本** | <¥5000/月 | LLM调用统计 | 向量检索+知识图谱的月度成本 |

**性能优化策略**:
- 向量索引缓存(Redis)，减少重复计算
- 知识图谱预计算(离线任务)，在线查询直接返回
- 语义检索Top-K限制≤10，避免过度计算

---

### 4.1.2 第2部分：功能部分

#### 2.1 功能需求

##### 2.1.1 用户故事

**US-4.1-01**: 作为客服人员，我希望在对话面板中看到实时推荐的知识内容，以便快速找到解决方案并回复客户

**US-4.1-02**: 作为客服人员，我希望能够将推荐的知识内容一键引用到回复框中，以便提高回复效率

**US-4.1-03**: 作为客服人员，我希望在对话结束后系统能自动提示我沉淀新知识，以便持续完善知识库

**US-4.1-04**: 作为知识管理员，我希望能够审核自动沉淀的知识，以便确保知识质量

**US-4.1-05**: 作为客服人员，我希望能够通过知识库管理页面浏览、搜索、编辑知识，以便维护知识库内容

**US-4.1-06**: 作为知识管理员，我希望能够上传文档并自动提取知识，以便快速扩充知识库

**US-4.1-07**: 作为客服人员，我希望查看知识时能看到相关知识推荐，以便发现更多解决方案

##### 2.1.2 功能列表

| 功能项 | 描述 | 优先级 | 依赖 | 版本 |
|-------|------|--------|------|------|
| 知识库列表 | 展示知识库所有知识条目，支持分页、筛选、排序 | P0 | 无 | v0.1 |
| 知识详情 | 查看单个知识的完整内容和元数据 | P0 | 无 | v0.1 |
| 知识搜索 | 支持关键词、语义、问答三种搜索模式 | P0 | 无 | v0.1 |
| 知识创建 | 手动创建新知识条目 | P0 | 无 | v0.1 |
| 知识编辑 | 编辑已有知识的标题、内容、分类、标签 | P0 | 知识详情 | v0.1 |
| 知识删除(归档) | 软删除知识(标记为已归档) | P1 | 无 | v0.1 |
| 知识推荐面板 | 对话中实时显示推荐知识 | P0 | 知识搜索 | v0.1 |
| 知识引用 | 一键将知识内容插入到回复框 | P0 | 知识推荐面板 | v0.1 |
| 文档上传 | 上传PDF/Word/TXT文档并自动解析 | P0 | 无 | v0.1 |
| 自动沉淀提示 | 对话结束后弹窗提示沉淀新知识 | P0 | 无 | v0.8 |
| 知识审核 | 审核自动沉淀的知识(批准/编辑/拒绝) | P0 | 自动沉淀提示 | v0.8 |
| 知识图谱可视化 | D3.js展示知识关联关系图谱 | P1 | 知识详情 | v1.0 |
| 相关知识推荐 | 查看知识时展示相关知识列表 | P0 | 知识图谱 | v1.0 |
| 知识评分 | 客服可对知识内容进行评分(1-5星) | P1 | 知识详情 | v1.0 |
| 使用统计 | 展示知识的查看次数、使用次数 | P1 | 知识详情 | v1.0 |

---

#### 2.2 UI设计

##### 2.2.1 页面布局

**布局1: 对话面板中的知识推荐侧边栏**

```
┌─────────────────────────────────────────────────────────────────┐
│ 客户对话 #12345                                     [关闭对话]   │
├──────────────────────────────────┬──────────────────────────────┤
│                                  │                              │
│  [对话消息区域]                  │  📚 知识推荐                 │
│                                  │  ┌────────────────────────┐  │
│  客户: 产品配置失败怎么办?       │  │ 🔍 [搜索知识库...]     │  │
│  13:45                           │  └────────────────────────┘  │
│                                  │                              │
│                                  │  💡 推荐知识 (基于当前对话) │
│  [知识推荐卡片会插入在这里]     │                              │
│                                  │  ┌────────────────────────┐  │
│                                  │  │📘 产品配置问题解决方案  │  │
│                                  │  │                        │  │
│  客服: [回复输入框]              │  │相关度: 92%             │  │
│  ┌────────────────────────────┐  │  │                        │  │
│  │                            │  │  │常见原因包括配置文件... │  │
│  │                            │  │  │                        │  │
│  │                            │  │  │[查看详情] [引用]       │  │
│  └────────────────────────────┘  │  └────────────────────────┘  │
│  [发送]                          │                              │
│                                  │  ┌────────────────────────┐  │
│                                  │  │📘 配置文件格式说明      │  │
│                                  │  │                        │  │
│                                  │  │相关度: 85%             │  │
│                                  │  │                        │  │
│                                  │  │配置文件应采用JSON...   │  │
│                                  │  │                        │  │
│                                  │  │[查看详情] [引用]       │  │
│                                  │  └────────────────────────┘  │
│                                  │                              │
│                                  │  📂 历史引用知识 (3)         │
│                                  │  • 产品安装指南              │
│                                  │  • 常见问题FAQ               │
│                                  │  • 联系技术支持              │
└──────────────────────────────────┴──────────────────────────────┘
```

**布局2: 知识库管理页面**

```
┌───────────────────────────────────────────────────────────────────┐
│ 📚 知识库管理                                 [+ 新建知识] [上传文档]│
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│ ┌─────────────────────────────────────────────────────────────┐  │
│ │ 🔍 [搜索知识库...]                    [🔽分类] [🔽标签]     │  │
│ └─────────────────────────────────────────────────────────────┘  │
│                                                                    │
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ 标题                       分类      标签      更新时间    操作│
│ ├────────────────────────────────────────────────────────────┤   │
│ │ 📘 产品配置问题解决方案    技术支持  配置      2024-12-20  ... │
│ │    常见原因包括配置文件格式错误...                            │
│ │    👁️ 156次 | ⭐ 4.5 | 🔗 23次引用                            │
│ ├────────────────────────────────────────────────────────────┤   │
│ │ 📘 配置文件格式说明        产品手册  配置      2024-11-10  ... │
│ │    配置文件应采用JSON格式...                                  │
│ │    👁️ 89次 | ⭐ 4.2 | 🔗 15次引用                             │
│ ├────────────────────────────────────────────────────────────┤   │
│ │ 📘 Windows系统下产品无法启动  技术支持  Windows  2024-12-30 ... │
│ │    ⚠️ 待审核 (自动沉淀) | 置信度: 88%                         │
│ │    客户反馈产品在Windows 11系统下...                          │
│ │    [✏️ 编辑] [✅ 批准] [❌ 拒绝]                                │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                    │
│ 第1-20条，共156条                               [<] [1] [2] [>]   │
└───────────────────────────────────────────────────────────────────┘
```

**布局3: 知识详情页(含知识图谱)**

```
┌─────────────────────────────────────────────────────────────────┐
│ 📘 产品配置问题解决方案                       [编辑] [删除]      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ [知识内容] [知识图谱] [使用统计]  ← Tab导航                      │
│                                                                  │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 📊 元信息                                                  │   │
│ │ • 分类: 技术支持                                           │   │
│ │ • 标签: #配置 #故障排查                                    │   │
│ │ • 来源: 产品手册                                           │   │
│ │ • 评分: ⭐⭐⭐⭐☆ (4.5分, 23人评价)                        │   │
│ │ • 查看: 156次 | 引用: 23次                                 │   │
│ │ • 创建: 2024-01-15 | 更新: 2024-12-20                      │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│ ┌───────────────────────────────────────────────────────────┐   │
│ │ 📝 内容 (Markdown渲染)                                     │   │
│ │                                                            │   │
│ │ ## 问题描述                                                │   │
│ │ 客户反馈产品配置失败，提示"配置错误"。                     │   │
│ │                                                            │   │
│ │ ## 常见原因                                                │   │
│ │ 1. 配置文件格式错误                                        │   │
│ │ 2. 权限不足                                                │   │
│ │ 3. 路径配置错误                                            │   │
│ │                                                            │   │
│ │ ## 解决方案                                                │   │
│ │ 1. 检查配置文件格式...                                     │   │
│ │ 2. 确认运行权限...                                         │   │
│ │ 3. 验证路径设置...                                         │   │
│ └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│ 💬 对这篇知识有帮助吗? [⭐⭐⭐⭐⭐] [提交反馈]                    │
└─────────────────────────────────────────────────────────────────┘
```

##### 2.2.2 组件说明

**组件1: 知识推荐卡片 (KnowledgeRecommendationCard)**

**位置**: 对话面板右侧知识推荐区域

**样式规范**:
| 属性 | 值 |
|-----|---|
| 背景色 | #f9f9f9 |
| 边框 | 1px solid #e0e0e0 |
| 圆角 | 8px |
| 内边距 | 12px |
| 间距 | 底部margin 12px |
| 宽度 | 100% (最大320px) |

**状态设计**:
| 状态 | 样式变化 | 触发条件 |
|-----|---------|---------|
| 默认 | 灰色背景，正常边框 | 初始状态 |
| 悬停(Hover) | 背景色变为#f0f0f0，添加阴影 | 鼠标悬停 |
| 高相关度 | 左侧绿色竖条(4px) | score≥0.9 |
| 中相关度 | 左侧橙色竖条(4px) | 0.7≤score<0.9 |
| 低相关度 | 左侧灰色竖条(4px) + 提示"建议人工确认" | score<0.7 |
| 已引用 | 右上角显示"✓已引用"徽章 | 该知识已被引用到回复中 |

**组件结构**:
```html
<div class="knowledge-card" :class="getScoreClass(score)">
  <div class="card-header">
    <span class="icon">📘</span>
    <span class="title">{{title}}</span>
  </div>
  <div class="score-badge">相关度: {{score * 100}}%</div>
  <div class="content-preview">{{snippet}}</div>
  <div class="metadata">
    <span>来源: {{source}}</span>
    <span>更新于 {{formatDate(updatedAt)}}</span>
  </div>
  <div class="actions">
    <button @click="viewDetail">查看详情</button>
    <button @click="insertToReply" class="primary">引用</button>
  </div>
</div>
```

**交互行为**:
- 点击【查看详情】: 在弹窗中展示完整知识内容
- 点击【引用】: 将知识内容插入到回复输入框，光标定位到内容末尾
- 点击卡片空白区域: 高亮显示该知识(边框变为蓝色)

---

**组件2: 知识沉淀审核弹窗 (KnowledgeReviewModal)**

**位置**: 对话标记为已解决后，居中弹窗

**样式规范**:
| 属性 | 值 |
|-----|---|
| 宽度 | 600px |
| 最大高度 | 80vh |
| 背景色 | #ffffff |
| 圆角 | 12px |
| 阴影 | 0 4px 16px rgba(0,0,0,0.15) |
| 遮罩层 | rgba(0,0,0,0.5) |

**状态设计**:
| 状态 | 样式变化 | 触发条件 |
|-----|---------|---------|
| 显示 | 从上方滑入动画(300ms) | extractKnowledge返回结果 |
| 编辑模式 | 内容区变为可编辑的Textarea | 点击【编辑】按钮 |
| 提交中 | 按钮显示Loading图标，禁用所有操作 | 点击【批准添加】 |
| 成功 | 显示绿色Toast提示"知识已添加" | 后端返回成功 |
| 失败 | 显示红色Toast提示错误信息 | 后端返回失败 |

**交互行为**:
- 点击【编辑】: 切换到编辑模式，标题和内容变为可编辑
- 点击【批准添加】: 提交知识到后端，成功后关闭弹窗
- 点击【拒绝】: 直接关闭弹窗，不保存知识
- 点击遮罩层: 提示"确定放弃沉淀知识吗?"，确认后关闭

---

**组件3: 知识图谱可视化 (KnowledgeGraphViz)**

**位置**: 知识详情页的"知识图谱"Tab

**技术选型**: D3.js 力导向图(Force-Directed Graph)

**样式规范**:
| 属性 | 值 |
|-----|---|
| 画布大小 | 800px × 600px |
| 节点大小 | 中心节点60px，其他节点40px |
| 节点颜色 | 中心节点#1890ff，关联节点#52c41a/#faad14/#f5222d (根据关系类型) |
| 边颜色 | #d9d9d9 |
| 边宽度 | 根据weight(1-3px) |
| 字体 | 12px sans-serif |

**交互行为**:
- 悬停节点: 显示完整标题和关系说明
- 点击节点: 跳转到该知识的详情页
- 拖拽节点: 调整节点位置(力导向重新计算)
- 缩放: 鼠标滚轮缩放画布(0.5x - 2x)

---

#### 2.3 接口定义

##### API 1: 搜索知识

**接口路径**: `/api/knowledge/search`

**请求方法**: GET

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| query | string | 是 | 搜索查询内容 |
| mode | string | 否 | 检索模式(keyword/semantic/qa) |
| category | string | 否 | 分类筛选 |
| tags | string | 否 | 标签筛选(逗号分隔) |
| limit | number | 否 | 返回数量(默认5) |

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "id": "kb-001",
        "title": "产品配置问题解决方案",
        "content": "详细内容...",
        "snippet": "常见原因包括配置文件格式错误、权限不足...",
        "category": "technical",
        "tags": ["配置", "故障排查"],
        "source": "manual",
        "score": 0.92,
        "metadata": {
          "viewCount": 156,
          "rating": 4.5,
          "usageCount": 23
        },
        "createdAt": "2024-01-15T10:30:00Z",
        "updatedAt": "2024-12-20T15:45:00Z"
      }
    ],
    "total": 1,
    "mode": "semantic"
  }
}
```

**响应体字段说明**:
| 字段名 | 类型 | 说明 | 前端使用 |
|-------|------|------|---------|
| results[].id | string | 知识ID | 跳转详情页的链接参数 |
| results[].title | string | 知识标题 | 卡片标题 |
| results[].snippet | string | 内容摘要(前200字符) | 卡片内容预览 |
| results[].score | number | 相关度(0-1) | 显示为百分比，控制卡片边框颜色 |
| results[].metadata.rating | number | 用户评分(0-5) | 星级评分组件 |
| results[].metadata.viewCount | number | 查看次数 | "已查看X次" |
| results[].metadata.usageCount | number | 引用次数 | "已引用X次" |

---

##### API 2: 获取知识详情

**接口路径**: `/api/knowledge/:id`

**请求方法**: GET

**路径参数**:
| 参数名 | 类型 | 说明 |
|-------|------|------|
| id | string | 知识ID |

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "id": "kb-001",
    "title": "产品配置问题解决方案",
    "content": "完整内容...",
    "category": "technical",
    "tags": ["配置", "故障排查"],
    "source": "manual",
    "metadata": {
      "viewCount": 156,
      "rating": 4.5,
      "usageCount": 23,
      "lastUsedAt": "2024-12-28T10:00:00Z"
    },
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-12-20T15:45:00Z",
    "isArchived": false
  }
}
```

**副作用**: 调用此接口会自动将该知识的viewCount +1

---

##### API 3: 创建知识

**接口路径**: `/api/knowledge`

**请求方法**: POST

**请求体**:
```json
{
  "title": "新知识标题",
  "content": "知识内容(Markdown格式)",
  "category": "technical",
  "tags": ["标签1", "标签2"],
  "source": "manual"
}
```

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "id": "kb-new",
    "title": "新知识标题",
    "message": "知识创建成功"
  }
}
```

---

##### API 4: 上传文档

**接口路径**: `/api/knowledge/upload`

**请求方法**: POST

**Content-Type**: `multipart/form-data`

**请求体**:
```
title: "产品用户手册v2.0"
file: [File对象]
category: "manual"
```

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "knowledgeId": "kb-002",
    "title": "产品用户手册v2.0",
    "extractedCount": 12,
    "message": "文档上传成功，已提取12条知识"
  }
}
```

**前端使用**: 显示"已提取X条知识"提示，并提供【查看提取结果】链接

---

##### API 5: 沉淀知识(自动提取)

**接口路径**: `/api/knowledge/extract`

**请求方法**: POST

**请求体**:
```json
{
  "conversationId": "conv-12345"
}
```

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "extracted": true,
    "knowledgeItems": [
      {
        "title": "Windows系统下产品无法启动的解决方案",
        "content": "**问题描述**:...\n**解决方案**:...",
        "category": "technical",
        "tags": ["Windows", "启动失败"],
        "confidence": 0.88,
        "needReview": true
      }
    ],
    "count": 1
  }
}
```

**前端使用**: 打开知识审核弹窗，展示待审核知识

---

##### API 6: 审核沉淀知识

**接口路径**: `/api/knowledge/review`

**请求方法**: POST

**请求体**:
```json
{
  "action": "approve",
  "knowledge": {
    "title": "Windows系统下产品无法启动的解决方案",
    "content": "修改后的内容...",
    "category": "technical",
    "tags": ["Windows", "启动失败", "依赖库"]
  },
  "sourceConversationId": "conv-12345"
}
```

**action可选值**: `approve` | `reject`

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "knowledgeId": "kb-new",
    "message": "知识已添加到知识库"
  }
}
```

---

##### API 7: 生成知识图谱

**接口路径**: `/api/knowledge/:id/graph`

**请求方法**: GET

**路径参数**:
| 参数名 | 类型 | 说明 |
|-------|------|------|
| id | string | 知识ID |

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| depth | number | 否 | 关联深度(1-3，默认2) |

**响应体**（成功）:
```json
{
  "success": true,
  "data": {
    "centerNode": {
      "id": "kb-001",
      "title": "产品配置问题解决方案",
      "category": "technical"
    },
    "relatedNodes": [
      {
        "id": "kb-015",
        "title": "配置文件格式说明",
        "relation": "prerequisite",
        "weight": 0.92,
        "description": "了解配置文件格式是解决配置问题的前提"
      }
    ],
    "graph": {
      "nodes": [...],
      "edges": [...]
    }
  }
}
```

**前端使用**: 使用D3.js渲染知识图谱

---

#### 2.4 数据模型

##### 实体1: KnowledgeItem (知识条目)

**TypeScript接口定义**:
```typescript
interface KnowledgeItem {
  // 基础字段
  id: string;
  title: string;
  content: string;  // Markdown格式

  // 分类字段
  category: 'technical' | 'product' | 'business' | 'manual' | 'qa';
  tags: string[];
  source: 'manual' | 'conversation' | 'document' | 'api';

  // 元数据(Agent相关)
  metadata: {
    viewCount: number;        // 查看次数
    rating: number;           // 用户评分(0-5)
    usageCount: number;       // 引用次数
    lastUsedAt?: Date;        // 最后使用时间
    extractedFrom?: {         // 如果是自动沉淀的知识
      conversationId: string;
      customerId: string;
      csrId: string;
      resolvedAt: Date;
    };
  };

  // 状态字段
  isArchived: boolean;
  needReview: boolean;  // 是否需要人工审核
  confidence?: number;  // 自动沉淀的置信度(0-1)

  // 时间字段
  createdAt: Date;
  updatedAt: Date;
}
```

**字段分类**:
| 字段名 | 来源 | 说明 | 可编辑 |
|-------|------|------|--------|
| id | 系统生成 | 唯一标识 | ❌ |
| title | 用户输入/Agent生成 | 知识标题 | ✅ |
| content | 用户输入/Agent生成 | 知识内容(Markdown) | ✅ |
| category | 用户选择/Agent推断 | 知识分类 | ✅ |
| tags | 用户输入/Agent提取 | 标签数组 | ✅ |
| source | 系统记录 | 知识来源 | ❌ |
| metadata.viewCount | 系统统计 | 查看次数 | ❌ |
| metadata.rating | 用户评分 | 平均评分 | ❌ |
| metadata.usageCount | 系统统计 | 引用次数 | ❌ |
| needReview | Agent判断 | 是否需要审核 | ✅ |
| confidence | Agent计算 | 置信度 | ❌ |
| isArchived | 用户操作 | 是否已归档 | ✅ |

---

##### 实体2: KnowledgeCategory (知识分类)

**枚举定义**:
```typescript
enum KnowledgeCategory {
  TECHNICAL = 'technical',       // 技术支持类
  PRODUCT = 'product',           // 产品功能类
  BUSINESS = 'business',         // 业务流程类
  MANUAL = 'manual',             // 产品手册类
  QA = 'qa'                      // 问答类(自动沉淀)
}
```

**分类说明**:
| 分类 | 说明 | 典型来源 |
|-----|------|---------|
| technical | 技术支持类知识(故障排查、配置问题) | 手动创建、对话沉淀 |
| product | 产品功能介绍和使用说明 | 文档上传 |
| business | 业务流程和政策说明 | 手动创建 |
| manual | 产品用户手册 | 文档上传 |
| qa | 问答类知识(客户问题+解决方案) | 对话沉淀 |

---

##### 实体3: KnowledgeGraphNode (知识图谱节点)

**TypeScript接口定义**:
```typescript
interface KnowledgeGraphNode {
  id: string;               // 知识ID
  title: string;            // 知识标题
  category: KnowledgeCategory;
  level: number;            // 在图谱中的层级(0=中心节点)
}

interface KnowledgeGraphEdge {
  source: string;           // 源节点ID
  target: string;           // 目标节点ID
  type: RelationType;       // 关系类型
  weight: number;           // 关系权重(0-1)
}

enum RelationType {
  PREREQUISITE = 'prerequisite',  // 前置知识
  RELATED = 'related',            // 相关知识
  FOLLOW_UP = 'follow-up',        // 后续扩展
  ALTERNATIVE = 'alternative'     // 替代方案
}
```

---

### 4.1.3 第3部分：人机协作设计

#### 3.1 Agent输出 → UI展示

**数据流转**:
```
Agent (searchKnowledge/extractKnowledge/generateKnowledgeGraph)
  ↓
Backend API封装
  ↓
Frontend接收JSON
  ↓
UI组件渲染(知识卡片/审核弹窗/图谱可视化)
```

**字段映射表**:

##### 映射1: 知识检索结果 → 知识推荐卡片

| Agent输出字段 | UI元素 | 映射逻辑 | 示例 |
|-------------|--------|---------|------|
| results[].title | 卡片标题(`<span class="title">`) | 直接展示，超过30字符省略 | "产品配置问题解决..." |
| results[].snippet | 内容预览(`<div class="content-preview">`) | 显示前200字符 + "..." | "常见原因包括配置文件..." |
| results[].score | 相关度徽章 + 边框颜色 | score≥0.9绿色，0.7-0.9橙色，<0.7灰色 | "相关度: 92%" |
| results[].source | 来源标签(`<span class="source">`) | 映射为中文: manual→"产品手册" | "来源: 产品手册" |
| results[].updatedAt | 更新时间 | 格式化为"YYYY-MM-DD" | "更新于 2024-12-20" |
| results[].metadata.rating | 星级评分图标 | ⭐ × floor(rating) | ⭐⭐⭐⭐☆ (4.5分) |
| results[].id | 【查看详情】按钮的跳转链接 | `/knowledge/${id}` | - |

**组件渲染逻辑**:
```javascript
// 前端渲染代码示例
function renderKnowledgeCard(knowledge) {
  const scoreClass = knowledge.score >= 0.9 ? 'high-score'
                   : knowledge.score >= 0.7 ? 'medium-score'
                   : 'low-score';

  const sourceLabel = {
    'manual': '产品手册',
    'conversation': '对话沉淀',
    'document': '文档上传',
    'api': 'API导入'
  }[knowledge.source] || knowledge.source;

  return `
    <div class="knowledge-card ${scoreClass}">
      <div class="card-header">
        <span class="icon">📘</span>
        <span class="title">${truncate(knowledge.title, 30)}</span>
      </div>
      <div class="score-badge">相关度: ${(knowledge.score * 100).toFixed(0)}%</div>
      <div class="content-preview">${knowledge.snippet}</div>
      <div class="metadata">
        <span>来源: ${sourceLabel}</span>
        <span>更新于 ${formatDate(knowledge.updatedAt)}</span>
      </div>
      <div class="actions">
        <button onclick="viewDetail('${knowledge.id}')">查看详情</button>
        <button onclick="insertToReply('${knowledge.id}')" class="primary">引用</button>
      </div>
    </div>
  `;
}
```

---

##### 映射2: 知识沉淀结果 → 审核弹窗

| Agent输出字段 | UI元素 | 映射逻辑 | 示例 |
|-------------|--------|---------|------|
| knowledgeItems[].title | 弹窗标题输入框 | 初始值为Agent生成的标题，可编辑 | "Windows系统下产品无法启动的解决方案" |
| knowledgeItems[].content | 内容编辑区(Textarea) | Markdown格式，可编辑 | "**问题描述**:..." |
| knowledgeItems[].category | 分类下拉框 | 预选Agent推断的分类，可修改 | "技术支持" |
| knowledgeItems[].tags | 标签输入框 | 逗号分隔的标签数组 | "Windows, 启动失败, 依赖库" |
| knowledgeItems[].confidence | 置信度进度条 | 百分比进度条 | 88% (绿色) |
| needReview: true | "⚠️ 需要人工审核"警告标签 | 显示黄色警告图标 | - |
| extractedFrom.conversationId | 来源对话链接 | `/conversations/${conversationId}` | "#conv-12345" |

**弹窗交互逻辑**:
```javascript
// 审核弹窗交互示例
function showReviewModal(extractionResult) {
  const item = extractionResult.knowledgeItems[0];

  modal.show({
    title: item.title,  // 可编辑
    content: item.content,  // 可编辑
    category: item.category,
    tags: item.tags.join(', '),
    confidence: item.confidence,
    needReview: item.needReview,
    sourceConversation: item.extractedFrom?.conversationId,

    onApprove: async (editedData) => {
      await api.post('/api/knowledge/review', {
        action: 'approve',
        knowledge: editedData,
        sourceConversationId: item.extractedFrom.conversationId
      });
      toast.success('知识已添加到知识库');
      modal.close();
    },

    onReject: () => {
      if (confirm('确定放弃沉淀这条知识吗?')) {
        modal.close();
      }
    }
  });
}
```

---

##### 映射3: 知识图谱数据 → D3.js可视化

| Agent输出字段 | 图谱元素 | 映射逻辑 | 视觉效果 |
|-------------|---------|---------|---------|
| centerNode | 中心圆形节点 | level=0, radius=30px, fill=#1890ff | 蓝色大圆 |
| relatedNodes[] | 关联圆形节点 | level≥1, radius=20px, fill由relation决定 | 小圆，颜色区分关系类型 |
| graph.edges[].type | 连线颜色和标签 | prerequisite→绿色，related→橙色，follow-up→黄色 | 彩色连线 |
| graph.edges[].weight | 连线宽度 | width = 1 + weight * 2 (1-3px) | 权重越高越粗 |
| relatedNodes[].description | 悬停提示框(Tooltip) | 鼠标悬停显示关系说明 | "了解配置文件格式是解决配置问题的前提" |

**D3.js渲染逻辑**:
```javascript
// D3.js力导向图渲染示例
function renderKnowledgeGraph(graphData) {
  const svg = d3.select('#graph-container')
    .append('svg')
    .attr('width', 800)
    .attr('height', 600);

  const simulation = d3.forceSimulation(graphData.nodes)
    .force('link', d3.forceLink(graphData.edges).id(d => d.id))
    .force('charge', d3.forceManyBody().strength(-300))
    .force('center', d3.forceCenter(400, 300));

  // 绘制连线
  const links = svg.selectAll('line')
    .data(graphData.edges)
    .enter().append('line')
    .attr('stroke', d => getEdgeColor(d.type))
    .attr('stroke-width', d => 1 + d.weight * 2);

  // 绘制节点
  const nodes = svg.selectAll('circle')
    .data(graphData.nodes)
    .enter().append('circle')
    .attr('r', d => d.level === 0 ? 30 : 20)
    .attr('fill', d => getNodeColor(d))
    .on('click', d => window.location.href = `/knowledge/${d.id}`)
    .call(d3.drag());  // 支持拖拽

  simulation.on('tick', () => {
    links.attr('x1', d => d.source.x)
         .attr('y1', d => d.source.y)
         .attr('x2', d => d.target.x)
         .attr('y2', d => d.target.y);

    nodes.attr('cx', d => d.x)
         .attr('cy', d => d.y);
  });
}

function getEdgeColor(type) {
  return {
    'prerequisite': '#52c41a',  // 绿色
    'related': '#faad14',       // 橙色
    'follow-up': '#1890ff',     // 蓝色
    'alternative': '#f5222d'    // 红色
  }[type];
}
```

---

#### 3.2 UI操作 → Agent触发

**用户操作流程**:
```
用户在UI上操作(点击/输入/上传)
  ↓
Frontend收集参数
  ↓
调用Backend API
  ↓
Backend调用Agent (通过MCP)
  ↓
Agent执行分析/检索
  ↓
返回结果到Frontend
  ↓
UI更新显示
```

**操作类型与Agent行为**:

| 用户操作 | 触发的Agent行为 | API请求 | 预期结果 | 响应时间 |
|---------|---------------|---------|---------|---------|
| 客户发送新消息 | AssistantAgent自动调用searchKnowledge(semantic模式) | 后台自动触发 | 右侧面板显示推荐知识 | <2秒 |
| 点击知识卡片【引用】 | 记录知识使用事件(usageCount+1) | POST /api/knowledge/:id/use | 知识内容插入回复框 | <500ms |
| 点击【标记为已解决】 | EngineerAgent调用extractKnowledge | POST /api/knowledge/extract | 弹窗显示待审核知识 | <3秒 |
| 审核弹窗【批准添加】 | 保存知识到数据库 | POST /api/knowledge/review | 知识写入库，弹窗关闭 | <1秒 |
| 审核弹窗【拒绝】 | 记录拒绝事件(用于优化Agent) | POST /api/knowledge/reject-feedback | 弹窗关闭 | <500ms |
| 点击知识详情【查看】 | getKnowledgeDetail + generateKnowledgeGraph并行调用 | GET /api/knowledge/:id, GET /api/knowledge/:id/graph | 显示详情+图谱 | <5秒 |
| 上传文档 | 调用uploadDocument解析文档 | POST /api/knowledge/upload | 显示"已提取X条知识" | <10秒 |
| 手动搜索知识库 | searchKnowledge(mode根据查询内容自动选择) | GET /api/knowledge/search | 显示搜索结果列表 | <2秒 |

**事件记录示例**:

```typescript
// 用户反馈事件接口
interface KnowledgeFeedbackEvent {
  action: 'use' | 'approve' | 'reject' | 'modify' | 'rate';
  knowledgeId: string;
  userId: string;
  timestamp: Date;
  context?: {
    conversationId?: string;   // 如果在对话中引用
    originalContent?: string;  // 如果是修改
    modifiedContent?: string;  // 修改后的内容
    rating?: number;           // 如果是评分(1-5)
    rejectReason?: string;     // 拒绝原因
  };
}
```

**Agent学习循环**:
```
用户操作(引用/批准/拒绝/修改)
  ↓
记录反馈事件到数据库
  ↓
离线分析(每日/每周)
  ↓
优化Agent行为:
  - 调整知识检索算法(提升高评分知识的排名)
  - 优化知识沉淀触发条件(降低被拒绝比例)
  - 更新知识图谱关联权重(基于用户实际引用路径)
```

---

#### 3.3 人机协作边界

##### 3.3.1 Agent主导场景

**适用条件**:
- 知识检索相关度≥0.9(高置信度)
- 知识来源为"产品手册"或"官方文档"(可信度高)
- 知识最近被成功使用过(lastUsedAt < 7天)

**Agent行为**:
1. 自动检索知识并推荐到右侧面板(无需人工触发)
2. 在回复框旁边高亮显示"建议引用"提示
3. 自动记录知识查看和引用统计

**UI表现**:
- 知识卡片左侧显示绿色竖条(表示高相关度)
- 【引用】按钮高亮显示(primary样式)
- 右上角显示"✨推荐"徽章

**示例**:
```
[场景] 客户问: "如何配置产品?"
[Agent行为] 自动检索到"产品配置指南"(相关度96%)
[UI展示]
  ┌────────────────────────────┐
  │ ✨推荐                     │
  │ 📘 产品配置指南             │
  │ 相关度: 96%                │
  │ 来源: 产品手册             │
  │ [查看详情] [✨引用]         │  ← 引用按钮高亮
  └────────────────────────────┘
[客服操作] 点击【引用】一键插入回复
```

---

##### 3.3.2 人工主导场景

**适用条件**:
- 知识检索相关度<0.7(低置信度)
- 知识来源为"对话沉淀"且needReview=true(需要审核)
- 客户问题属于敏感类别(退款、投诉、法律咨询)

**Agent行为**:
1. 提供知识推荐，但不自动插入回复
2. 显示"建议人工确认"警告
3. 提供多个备选方案供人工选择

**UI表现**:
- 知识卡片左侧显示灰色竖条
- 卡片顶部显示"⚠️ 建议人工确认"黄色警告
- 【引用】按钮正常样式(不高亮)

**示例**:
```
[场景] 客户问: "我要退款，怎么操作?"
[Agent行为] 检索到"退款流程说明"(相关度65%)
[UI展示]
  ┌────────────────────────────┐
  │ ⚠️ 建议人工确认             │
  │ 📘 退款流程说明             │
  │ 相关度: 65%                │
  │ [查看详情] [引用]           │  ← 按钮不高亮
  └────────────────────────────┘
[客服操作] 先查看详情，确认无误后再引用
```

---

##### 3.3.3 协作模式

**适用条件**:
- 知识检索返回多个中等相关度结果(0.7-0.9)
- 知识沉淀需要人工补充和修正
- 知识图谱需要人工确认关联关系

**Agent行为**:
1. 提供多个候选方案(Top 3-5)
2. 标注每个方案的优缺点和适用场景
3. 允许人工组合、修改、补充

**UI表现**:
- 展示多个知识卡片，按相关度排序
- 每个卡片显示"适用场景"标签
- 支持多选引用，合并到回复框

**示例**:
```
[场景] 客户问: "产品启动慢怎么优化?"
[Agent行为] 检索到3个相关知识
[UI展示]
  ┌────────────────────────────┐
  │ 📘 产品性能优化指南         │
  │ 相关度: 85%                │
  │ 💡 适用于: 常规优化         │
  │ [□ 选择] [查看]             │
  └────────────────────────────┘

  ┌────────────────────────────┐
  │ 📘 启动缓慢的常见原因       │
  │ 相关度: 82%                │
  │ 💡 适用于: 故障排查         │
  │ [□ 选择] [查看]             │
  └────────────────────────────┘

  ┌────────────────────────────┐
  │ 📘 清理缓存加速启动         │
  │ 相关度: 78%                │
  │ 💡 适用于: 快速解决方案     │
  │ [□ 选择] [查看]             │
  └────────────────────────────┘

  [引用选中项 (0)]  ← 支持多选

[客服操作] 勾选第1和第3个知识，合并引用到回复框
```

---

#### 3.4 数据一致性保障

##### 3.4.1 前后端数据同步

**同步机制**:
```
Agent更新知识(新增/修改)
  ↓
Backend持久化到数据库
  ↓
WebSocket推送更新事件
  ↓
Frontend接收事件
  ↓
更新本地缓存
  ↓
UI自动刷新
```

**WebSocket事件定义**:
```typescript
// 知识更新事件
interface KnowledgeUpdateEvent {
  type: 'knowledge:created' | 'knowledge:updated' | 'knowledge:deleted';
  knowledgeId: string;
  data: KnowledgeItem;  // 最新数据
  timestamp: Date;
}

// 前端监听示例
websocket.on('knowledge:updated', (event) => {
  // 更新本地缓存
  knowledgeCache.set(event.knowledgeId, event.data);

  // 如果该知识正在显示，刷新UI
  if (currentKnowledgeId === event.knowledgeId) {
    refreshKnowledgeDetail(event.data);
  }

  // 提示用户
  toast.info('知识库已更新');
});
```

---

##### 3.4.2 冲突处理策略

| 冲突场景 | 处理策略 | UI表现 |
|---------|---------|--------|
| **用户修改知识时Agent重新沉淀** | 保存用户修改，Agent沉淀作为新版本 | 提示"检测到新版本，是否查看差异?" |
| **Agent检索超时(>5秒)** | 降级到关键词检索 | 显示"正在使用备用检索..." |
| **知识图谱生成失败** | 隐藏图谱Tab，仅显示列表式推荐 | 提示"图谱暂时不可用，已为您展示相关知识列表" |
| **多人同时编辑同一知识** | 后提交者看到冲突提示 | 弹窗显示"该知识已被其他用户修改，是否覆盖?" + 差异对比 |
| **知识引用时该知识被删除** | 显示错误提示，提供替代方案 | "该知识已被删除，为您推荐相似知识" + 替代列表 |
| **自动沉淀的知识已存在** | 检测到相似度>0.8，不重复沉淀 | 无操作(静默跳过) |

**乐观更新策略**:
```javascript
// 用户点击【引用】时的乐观更新示例
async function insertKnowledgeToReply(knowledgeId) {
  // 1. 立即更新UI(乐观更新)
  const knowledge = knowledgeCache.get(knowledgeId);
  replyBox.insert(knowledge.content);
  knowledgeCard.markAsUsed();  // UI标记为"已引用"

  try {
    // 2. 异步调用API
    await api.post(`/api/knowledge/${knowledgeId}/use`);
    // 成功，无需额外操作
  } catch (error) {
    // 3. 失败时回滚
    replyBox.undo();
    knowledgeCard.unmarkAsUsed();
    toast.error('引用失败，请重试');
  }
}
```

**数据缓存策略**:
- **L1缓存(浏览器内存)**: 当前对话相关的知识(有效期: 对话结束)
- **L2缓存(LocalStorage)**: 常用知识和知识图谱(有效期: 24小时)
- **L3缓存(后端Redis)**: 知识检索结果(有效期: 1小时)

**缓存失效规则**:
- 知识被修改/删除: 立即失效所有层级缓存
- 用户登出: 清除L1和L2缓存
- 知识评分变化: 仅失效L3缓存(不影响前端显示)

---

### 4.1.4 第4部分：验收标准

#### 4.1 Agent能力验收

| 验收项 | 验收标准 | 优先级 | 测试方法 |
|-------|---------|--------|---------|
| **语义检索准确性** | Top 3命中率≥85% | P0 | 抽检100个真实客户问题，人工判断Top 3是否包含正确答案 |
| **知识沉淀召回率** | 应沉淀的对话中≥70%被成功识别 | P0 | 人工标注100个已解决对话，统计Agent识别比例 |
| **知识沉淀精确率** | 自动沉淀的知识经人工审核后≥80%被批准 | P0 | 统计审核通过率 |
| **知识图谱关联准确性** | 关联关系准确率≥75% | P1 | 人工审核知识图谱，判断关系类型是否正确 |
| **检索响应时间** | P95<2秒 | P0 | Prometheus监控统计 |
| **知识沉淀响应时间** | P95<3秒 | P0 | Prometheus监控统计 |

##### 详细验收场景

**场景1: 语义检索准确性验证**

**输入**:
```
query: "产品配置失败怎么办?"
mode: "semantic"
```

**预期Agent输出**:
```json
{
  "results": [
    {
      "id": "kb-001",
      "title": "产品配置问题解决方案",
      "score": 0.92  // >=0.7
    },
    {
      "id": "kb-015",
      "title": "配置文件格式说明",
      "score": 0.85
    },
    {
      "id": "kb-023",
      "title": "常见配置错误排查",
      "score": 0.81
    }
  ]
}
```

**验收标准**:
- ✅ Top 3中至少有1个标题包含"配置"关键词
- ✅ 所有结果score≥0.7
- ✅ 响应时间<2秒

---

**场景2: 知识自动沉淀验证**

**前置条件**:
- 对话ID: conv-12345
- 对话状态: resolved
- 客户满意度: 5分
- 对话轮次: 5轮

**输入**:
```
conversationId: "conv-12345"
extractMode: "auto"
```

**预期Agent输出**:
```json
{
  "extracted": true,
  "knowledgeItems": [
    {
      "title": "Windows系统下产品无法启动的解决方案",
      "content": "包含问题描述+解决方案+验证结果",
      "category": "technical",
      "tags": ["Windows", "启动失败", "依赖库"],
      "confidence": 0.88,  // >=0.8
      "needReview": true
    }
  ],
  "count": 1
}
```

**验收标准**:
- ✅ title准确概括客户问题
- ✅ content包含"问题描述""解决方案""验证结果"三部分
- ✅ tags至少包含2个相关标签
- ✅ confidence≥0.8
- ✅ 响应时间<3秒

---

**场景3: 知识图谱生成验证**

**输入**:
```
knowledgeId: "kb-001"
depth: 2
```

**预期Agent输出**:
```json
{
  "centerNode": {
    "id": "kb-001",
    "title": "产品配置问题解决方案"
  },
  "relatedNodes": [
    {
      "id": "kb-015",
      "relation": "prerequisite",  // 前置知识
      "weight": 0.92
    }
  ],
  "graph": {
    "nodes": [...],  // >=3个节点
    "edges": [...]   // >=2条边
  }
}
```

**验收标准**:
- ✅ relatedNodes至少包含3个节点
- ✅ 每个节点的relation类型合理(人工判断)
- ✅ weight>0.7的关联关系经人工验证75%以上准确
- ✅ 响应时间<5秒

---

#### 4.2 功能验收

| 验收项 | 验收标准 | 优先级 | 测试方法 |
|-------|---------|--------|---------|
| **知识库列表加载** | 列表正确展示，分页正常 | P0 | UI测试 |
| **知识搜索功能** | 三种模式均可搜索，结果正确 | P0 | 功能测试 |
| **知识推荐卡片** | 实时显示，【引用】功能正常 | P0 | 集成测试 |
| **知识沉淀审核** | 弹窗正常显示，编辑/批准/拒绝功能正常 | P0 | 功能测试 |
| **文档上传解析** | PDF/DOCX/TXT格式正常解析 | P0 | 功能测试 |
| **知识图谱展示** | D3.js图谱正常渲染，交互流畅 | P1 | UI测试 |
| **知识评分功能** | 评分提交成功，平均分正确计算 | P1 | 功能测试 |

##### 详细验收场景

**场景1: 知识推荐与引用流程**

**前置条件**:
- 客服已登录，打开对话面板
- 客户发送消息: "产品配置失败怎么办?"

**操作步骤**:
1. 系统自动检索知识库
2. 右侧面板显示推荐知识卡片
3. 客服点击【引用】按钮
4. 知识内容插入回复框
5. 客服编辑后发送给客户

**预期结果**:
- ✅ 步骤1-2在2秒内完成
- ✅ 推荐卡片正确展示标题、相关度、来源
- ✅ 点击【引用】后内容正确插入回复框
- ✅ 卡片标记为"已引用"状态
- ✅ 知识的usageCount +1

---

**场景2: 知识沉淀完整流程**

**前置条件**:
- 对话已成功解决客户问题
- 客户满意度≥4分

**操作步骤**:
1. 客服点击【标记为已解决】
2. 系统调用extractKnowledge
3. 弹窗显示待审核知识
4. 客服点击【编辑】修改标题和内容
5. 客服点击【批准添加】
6. 弹窗关闭，提示"知识已添加"

**预期结果**:
- ✅ 步骤2-3在3秒内完成
- ✅ 弹窗正确展示标题、内容、分类、标签、置信度
- ✅ 编辑模式下标题和内容可修改
- ✅ 批准后知识成功写入数据库
- ✅ 知识库列表中可以查询到新知识

---

**场景3: 知识图谱查看流程**

**前置条件**:
- 知识库中存在至少10条相关知识

**操作步骤**:
1. 客服打开知识详情页
2. 点击"知识图谱"Tab
3. 系统生成并展示知识图谱
4. 客服拖拽节点调整位置
5. 客服点击关联节点跳转到该知识详情

**预期结果**:
- ✅ 步骤2-3在5秒内完成
- ✅ 图谱正确展示中心节点和关联节点
- ✅ 节点和边的颜色符合设计规范
- ✅ 拖拽节点流畅，无卡顿
- ✅ 点击节点正确跳转到详情页

---

#### 4.3 集成验收

**端到端场景: 对话中检索知识 → 引用 → 对话结束 → 沉淀新知识**

**测试目标**: 验证Agent→UI→用户操作→Agent的完整闭环

**操作步骤**:

1. **客户发起咨询**:
   - 客户: "Windows系统下产品无法启动，提示缺少依赖库"
   - 系统自动检索知识库
   - 右侧面板显示推荐知识(相关度85%)

2. **客服引用知识回复**:
   - 客服点击【引用】按钮
   - 编辑后发送: "请安装Visual C++ 2019 Redistributable，然后以管理员权限运行产品"

3. **客户反馈成功**:
   - 客户: "已解决，谢谢!"
   - 客服标记对话为"已解决"，满意度5分

4. **系统自动沉淀知识**:
   - EngineerAgent分析对话
   - 提取新知识: "Windows系统下产品无法启动的解决方案"
   - 弹窗提示客服审核

5. **客服审核并批准**:
   - 客服查看自动生成的知识
   - 略作修改补充细节
   - 点击【批准添加】

6. **知识写入库并可被检索**:
   - 知识成功保存到数据库
   - 下一个类似问题时可以被检索到

**验收标准**:
- ✅ 步骤1: 检索响应时间<2秒，推荐知识相关度≥0.7
- ✅ 步骤2: 引用功能正常，知识内容正确插入回复框
- ✅ 步骤4: 知识沉淀响应时间<3秒，提取的知识准确概括问题和方案
- ✅ 步骤5: 审核弹窗正常，编辑和批准功能正常
- ✅ 步骤6: 知识成功写入，且在知识库列表中可查询到
- ✅ 端到端总耗时<15秒(不含人工操作时间)
- ✅ 整个流程无报错，数据一致性良好

**性能指标**:
- 总步骤数: 6步
- 自动化步骤: 3步(检索、沉淀、保存)
- 人工操作步骤: 3步(引用、标记、审核)
- 端到端成功率: >95%(100次测试中至少95次成功)

---

**非功能需求验收**:

| 指标 | 目标值 | 实际测试 | 是否通过 |
|-----|--------|---------|---------|
| Agent检索响应时间(P95) | <2秒 | [待测试] | [ ] |
| UI渲染时间 | <500ms | [待测试] | [ ] |
| 知识沉淀响应时间(P95) | <3秒 | [待测试] | [ ] |
| 知识图谱生成时间 | <5秒 | [待测试] | [ ] |
| Agent可用性(含降级) | >99.9% | [待测试] | [ ] |
| 知识检索准确率 | >85% | [待测试] | [ ] |
| 知识沉淀精确率 | >80% | [待测试] | [ ] |
| 月度成本 | <¥5000 | [待测试] | [ ] |

---

**文档结束**

---

## 4.2 分析与质检模块

#### 4.1 Agent能力验收

[待完善]

#### 4.2 功能验收

[待完善]

#### 4.3 集成验收

[待完善]

---

## 4.2 分析与质检模块

> **PRD格式**: 混合PRD（Agent能力 + 功能部分 + 人机协作）
> **优先级**: P0
> **所属版本**: v0.1 + v1.0（质检报告）

[待完善 - 按照4.1的混合PRD结构填写]

---

## 4.3 任务与质检协同

> **PRD格式**: 混合PRD（Agent能力 + 功能部分 + 人机协作）
> **优先级**: P0
> **所属版本**: v0.1 + v0.8（自然语言指令）

[待完善 - 按照4.1的混合PRD结构填写]

---

## 4.4 对话模式与人工介入

> **PRD格式**: 混合PRD（Agent能力 + 功能部分 + 人机协作）
> **优先级**: P0
> **所属版本**: v0.1 + v0.8（自动化率提升）

[待完善 - 按照4.1的混合PRD结构填写]

---

# 第5部分：非功能需求

## 5.1 性能要求

### 5.1.1 响应时间

[待完善]

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **API响应时间** | <2秒（P95） | Prometheus监控 |
| **前端渲染时间** | <1秒 | Lighthouse |
| **Agent响应时间** | <3秒（P95） | LLM调用监控 |
| **实时推送延迟** | <500ms | WebSocket监控 |

### 5.1.2 吞吐量

[待完善]

| 指标 | 目标值 | 测量方法 |
|-----|--------|---------|
| **并发用户数** | 100+ | 压力测试 |
| **对话处理量** | 1000+/天 | 业务指标统计 |
| **知识库查询QPS** | 50+ | 数据库监控 |

### 5.1.3 资源占用

[待完善]

---

## 5.2 安全要求

### 5.2.1 数据安全

[待完善]

**数据传输**: [待完善]

**数据存储**: [待完善]

**数据备份**: [待完善]

### 5.2.2 访问控制

[待完善]

**认证**: [待完善]

**授权**: [待完善]

**审计日志**: [待完善]

### 5.2.3 漏洞防护

[待完善]

**SQL注入**: [待完善]

**XSS**: [待完善]

**CSRF**: [待完善]

---

## 5.3 可扩展性

### 5.3.1 横向扩展

[待完善]

### 5.3.2 纵向扩展

[待完善]

### 5.3.3 国际化

[待完善]

**支持语言**: 中文、英语、日语（v1.0）

**时区转换**: [待完善]

---

## 5.4 可维护性

### 5.4.1 代码质量

[待完善]

| 指标 | 目标值 |
|-----|--------|
| **单元测试覆盖率** | >80% |
| **集成测试覆盖** | 核心流程100% |
| **代码注释率** | >30% |

### 5.4.2 文档完整性

[待完善]

---

## 5.5 监控与可观测性

### 5.5.1 日志规范

[待完善]

**日志级别**: DEBUG / INFO / WARN / ERROR

**日志格式**: [待完善]

### 5.5.2 指标采集

[待完善]

**Prometheus指标**: [待完善]

**Grafana仪表板**: [待完善]

### 5.5.3 链路追踪

[待完善]

**Jaeger集成**: [待完善]

---

# 第6部分：验收标准

## 6.1 功能验收

### 6.1.1 核心功能验收清单

[待完善]

| 功能模块 | 验收项 | 验收标准 | 优先级 | 测试方法 |
|---------|-------|---------|--------|---------|
| **对话管理** | [待完善] | [待完善] | P0 | [待完善] |
| **AI辅助** | [待完善] | [待完善] | P0 | [待完善] |
| **知识库** | [待完善] | [待完善] | P0 | [待完善] |

### 6.1.2 详细验收场景

[待完善]

---

## 6.2 性能验收

### 6.2.1 性能指标验收

[待完善]

| 验收项 | 验收标准 | 测试方法 |
|-------|---------|---------|
| **API响应时间** | <2秒（P95） | Apache Bench压测 |
| **前端首屏渲染** | <1秒 | Lighthouse测试 |
| **并发支持** | 100并发，响应时间<5秒 | JMeter压测 |

### 6.2.2 性能测试场景

[待完善]

---

## 6.3 安全验收

### 6.3.1 安全测试清单

[待完善]

| 验收项 | 验收标准 | 测试方法 |
|-------|---------|---------|
| **数据传输加密** | HTTPS传输 | 抓包验证 |
| **权限控制** | 基于RBAC | 权限矩阵测试 |
| **SQL注入防护** | 所有输入参数化 | OWASP ZAP扫描 |

---

## 6.4 用户体验验收

### 6.4.1 易用性验收

[待完善]

### 6.4.2 兼容性验收

[待完善]

| 验收项 | 验收标准 |
|-------|---------|
| **浏览器兼容** | Chrome/Firefox/Safari/Edge 最近2个版本 |
| **移动端兼容** | iOS 13+, Android 8+ |
| **屏幕分辨率** | 1920x1080 / 1366x768 / 375x667（移动端） |

---

# 附录

## 附录A：术语表

| 术语 | 定义 |
|-----|------|
| **Agent** | [待完善] |
| **MCP** | [待完善] |
| **Orchestrator** | [待完善] |
| **DDD** | [待完善] |
| **RICE** | [待完善] |

---

## 附录B：外围系统依赖

| 系统名称 | 依赖关系 | 接口 | 负责人 | SLA |
|---------|---------|------|--------|-----|
| **CRM系统** | [待完善] | [待完善] | [待完善] | 99.9% |
| **飞书开放平台** | [待完善] | [待完善] | [待完善] | 99% |
| **企业微信API** | [待完善] | [待完善] | [待完善] | 99% |

---

## 附录C：待决策事项

| 事项ID | 事项描述 | 备选方案 | 决策人 | 截止日期 | 状态 |
|--------|---------|---------|--------|---------|------|
| Q-01 | [待完善] | [方案A / 方案B] | [待完善] | YYYY-MM-DD | ⏳待决策 |

---

## 附录D：变更历史

| 版本 | 日期 | 变更内容 | 变更人 | 审核人 |
|-----|------|---------|--------|--------|
| v1.0-skeleton | 2025-12-29 | 初始骨架版本 | Claude | [待审核] |
| v1.0-draft | [待定] | 第一轮内容填充 | [待定] | [待定] |
| v1.0-final | [待定] | 最终版本 | [待定] | [待定] |

---

**文档结束**

---

## 填写进度检查清单

### Week 1: 骨架版本 ✅
- [x] 第1部分：产品概述章节目录
- [x] 第2部分：核心功能模块章节目录
- [x] 第3部分：AI驱动模块章节目录
- [x] 第4部分：混合模块章节目录
- [x] 第5部分：非功能需求章节目录
- [x] 第6部分：验收标准章节目录

### Week 2-3: 核心模块内容填充 ⏳
- [ ] 3.1 AssistantAgent完整PRD
- [ ] 3.2 EngineerAgent完整PRD
- [ ] 3.3 InspectorAgent完整PRD
- [ ] 4.1 知识库模块混合PRD

### Week 4: 传统功能内容填充 ⏳
- [ ] 2.7 IM集成完整PRD
- [ ] 2.8 监控告警完整PRD
- [ ] 2.2 客户信息完整PRD

### Week 5-6: 完善与Review ⏳
- [ ] 补充所有非功能需求细节
- [ ] 补充所有验收标准细节
- [ ] 整体Review与修订
- [ ] 最终发布v1.0-final

---

## 参考资源

- **编写指南**: `docs/prd/5-guides/PRD_Writing_Guide.md`
- **迭代路线图**: `docs/prd/1-roadmap/ITERATIONS_ROADMAP.md`
- **Agent PRD模板**: `docs/prd/4-templates/Agent_PRD_Template.md`
- **功能PRD模板**: `docs/prd/4-templates/Feature_PRD_Template.md`
- **混合PRD模板**: `docs/prd/4-templates/Hybrid_PRD_Template.md`
- **格式参考（Agent）**: `docs/prd/【格式参考】Integrated_Product_Requirements_Document_V2_MVP_Refined.md`
- **格式参考（功能）**: `docs/prd/【格式参考】Feature_product_requirements_document.md`
