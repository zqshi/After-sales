# IM 链路与时序图（代码对齐）

**版本**：v2.0（拆分版）  
**最后更新**：2026-02-05

## 接口前缀说明

- 业务通用接口：完整前缀 `/api/v1/api`（路由内自带 `/api`）
- IM/质量/客户画像接口：完整前缀 `/api/v1`
- 健康检查/监控/MCP/AgentScope 网关：不加 `/api/v1`（如 `/health`、`/metrics`、`/mcp`、`/agentscope/*`）

## 当前对话入口策略（2026-01-26）

1. 客服主动发送
- 入口：`/api/v1/api/conversations/:id/messages`
- 行为：仅落库与事件记录，不通过 Agent 生成回复

2. 外部 IM 入站消息
- 入口：`/api/v1/im/incoming-message`
- 行为：走 Agent 辅助链路（情绪/意图分析、知识推荐、回复建议等）

## IM 入站核心链路（时序图）

**说明**
- 入口：`/api/v1/im/incoming-message`
- 核心编排：`ImController` → `ConversationTaskCoordinator`
- 数据落库：`conversations/messages` + `domain_events` + `outbox_events`
- AI 联动：情绪分析、回复建议、知识检索

```mermaid
sequenceDiagram
  autonumber
  actor IM as 外部IM/客户
  participant API as Fastify API
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant DE as domain_events
  participant OB as outbox_events
  participant EB as EventBus(内存)
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant AGS as AgentScope /api/chat/message
  participant LLM as LLMClient/外部AI
  participant SKU as SearchKnowledgeUseCase
  participant KB as TaxKB/KnowledgeRepository

  IM->>API: POST /api/v1/im/incoming-message
  API->>IMC: handleIncomingMessage()
  IMC->>CTC: processCustomerMessage()

  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: 查找会话
  alt 新会话
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: 保存 Conversation + Message
    CR->>DE: 写入事件溯源
    CR->>OB: 写入 Outbox
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else 复用会话
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: 保存 Message
    CR->>DE: 写入事件溯源
    CR->>OB: 写入 Outbox
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt 需求成立
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: 保存 Requirement + domain_events
    CRU->>EB: publish(RequirementCreated)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: 保存 Task
    end
  end

  CTC->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  CTC->>AGS: 生成回复建议
  AGS-->>CTC: 回复建议/置信度

  IMC->>AIS: analyzeSentiment(content, last5Messages)
  IMC->>SKU: execute(query)
  SKU->>KB: 查询知识库
  IMC->>TR: findByFilters(conversationId)
  IMC-->>API: 组装响应
  API-->>IM: 返回结果
```

## IM 接口清单（以路由实现为准）

- 会话与消息
  - `GET /api/v1/im/conversations`
  - `GET /api/v1/im/conversations/stats`
  - `GET /api/v1/im/conversations/:id/messages`
  - `POST /api/v1/im/conversations/:id/messages`
  - `GET /api/v1/im/conversations/:id/problems`
  - `PATCH /api/v1/im/conversations/:id/status`
  - `PATCH /api/v1/im/conversations/:id/mode`

- 测试/联调
  - `POST /api/v1/im/wecom/mock/sync`

- AI 与情绪分析
  - `GET /api/v1/im/conversations/:id/ai-analysis`
  - `GET /api/v1/im/conversations/:id/sentiment`

- 质检接口
  - `GET /api/v1/quality/:conversationId`
  - `GET /api/v1/quality/:conversationId/reports`
  - `GET /api/v1/quality/reports`

- 客户画像
  - `GET /api/v1/profiles/:customerId`
  - `GET /api/v1/profiles/:customerId/interactions`

## 权限要求（最小集合）

- IM 读权限：`im.read`
- IM 写权限：`im.write`
- 客户画像权限：`customers.read`
- 质检权限：`tasks.read`
- AI 能力权限：`ai.use`
