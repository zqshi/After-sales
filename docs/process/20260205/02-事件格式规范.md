# 事件格式规范（代码对齐）

**版本**：v2.0（拆分版）  
**最后更新**：2026-02-05

## 统一领域事件结构（内存事件）

**基类**：`backend/src/domain/shared/DomainEvent.ts`

字段定义：
- `eventId`：uuid
- `eventType`：事件类型（字符串）
- `aggregateId`：聚合根 ID
- `occurredAt`：发生时间（Date）
- `version`：事件版本（默认 1）
- `payload`：事件载荷（object）

**示例**：

```json
{
  "eventId": "uuid",
  "eventType": "ConversationClosed",
  "aggregateId": "conv-123",
  "occurredAt": "2026-02-02T10:00:00.000Z",
  "version": 1,
  "payload": {
    "summary": "resolved"
  }
}
```

## domain_events 表字段映射（事件溯源）

**实体**：`backend/src/infrastructure/database/entities/DomainEventEntity.ts`

| 字段 | 说明 | 映射来源 |
|------|------|----------|
| id | 事件ID | eventId |
| aggregate_id | 聚合根ID | aggregateId |
| aggregate_type | 聚合类型 | 由保存逻辑传入 |
| event_type | 事件类型 | eventType |
| event_data | 事件载荷 | payload |
| occurred_at | 发生时间 | occurredAt |
| version | 事件版本 | version |

## outbox_events 表字段映射（Outbox）

**实体**：`backend/src/infrastructure/database/entities/OutboxEventEntity.ts`

| 字段 | 说明 | 映射来源 |
|------|------|----------|
| id | 事件ID | eventId |
| aggregate_id | 聚合根ID | aggregateId |
| aggregate_type | 聚合类型 | 由保存逻辑传入 |
| event_type | 事件类型 | eventType |
| event_data | 事件载荷 | payload |
| version | 事件版本 | version |
| status | pending/published/failed/dead_letter | Outbox 处理状态 |
| retry_count / max_retries | 重试信息 | OutboxProcessor |
| error_message | 错误信息 | OutboxProcessor |
| next_retry_at / published_at | 重试/发布 | OutboxProcessor |
| created_at / updated_at | 记录时间 | 数据库自动 |
| occurred_at | 业务发生时间 | occurredAt |

## AgentScope 事件桥接格式

**Node → Agent**

- 发送路径：Backend `EventBridge` → AgentScope
- 配置：`AGENTSCOPE_NODE_TO_AGENT_PATH`（默认 `/api/events/bridge`）
- 代码：`backend/src/config/agentscope.config.ts`、`backend/src/infrastructure/agentscope/EventBridge.ts`

**请求结构**：

```json
{
  "eventId": "evt-123",
  "eventType": "ConversationClosed",
  "aggregateId": "conv-123",
  "payload": { "summary": "resolved" },
  "occurredAt": "2026-02-02T10:00:00.000Z",
  "version": 1
}
```

**Agent → Node**

- 接收路径：Backend `EventBridge` 反向入口
- 默认路径：`/agentscope/events`
- 必要字段：`eventType`、`aggregateId`

```json
{
  "eventType": "AgentReviewRequested",
  "aggregateId": "review-123",
  "payload": { "reason": "low_confidence" },
  "occurredAt": "2026-02-02T10:00:00.000Z",
  "version": 1
}
```

## MCP 工具调用事件格式（HTTP JSON）

**调用入口**：`POST /mcp`

```json
{
  "method": "tools/call",
  "params": {
    "name": "searchKnowledge",
    "arguments": {
      "query": "退款多久到账",
      "mode": "semantic"
    }
  }
}
```

**工具列表**：

```json
{
  "method": "tools/list"
}
```
