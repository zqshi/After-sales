# After-Sales æŠ€æœ¯æ¶æ„ä¸äº‹ä»¶æ ¼å¼ï¼ˆç»Ÿä¸€ç‰ˆï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**æœ€åæ›´æ–°**ï¼š2026-02-02  
**é€‚ç”¨èŒƒå›´**ï¼šåç«¯/AgentScope/å‰ç«¯æ•´ä½“æ¶æ„ + IM äº‹ä»¶é“¾è·¯ï¼ˆç»Ÿä¸€æ–‡æ¡£ï¼Œé¿å…åˆ†æ•£ç®¡ç†ï¼‰

---

## 0. æ–‡æ¡£åˆå¹¶è¯´æ˜

- æœ¬æ–‡ä»¶å·²åˆå¹¶å¹¶è¦†ç›–ï¼š`docs/TECH_ARCHITECTURE.md` + åŸ `tests/backend/äº‹ä»¶æ ¼å¼.md` çš„äº‹ä»¶é“¾è·¯å†…å®¹ã€‚
- åç»­ä»¥æœ¬æ–‡ä»¶ä¸º**å”¯ä¸€æƒå¨å…¥å£**ï¼Œå…¶ä»–æ–‡æ¡£ä»…ä¿ç•™å¼•ç”¨ä¸ç›®å½•ç´¢å¼•ã€‚

---

## 1. æŠ€æœ¯æ¶æ„æ‘˜è¦ï¼ˆå½“å‰å®ç°ï¼‰

### 1.1 æŠ€æœ¯æ ˆ

- **å‰ç«¯**ï¼šVanilla JSï¼ˆES Modulesï¼‰+ Vite + Chart.js + Vitest/Playwright  
- **åç«¯**ï¼šFastify + TypeScript + TypeORM + PostgreSQL + Redis  
- **AgentScope**ï¼šFastAPI + AgentScope + DeepSeek v3.1  
- **è¿ç»´**ï¼šDocker Compose + Nginx + Prometheus + Grafana

### 1.2 é€»è¾‘æ¶æ„å›¾ï¼ˆASCIIï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend Workbench                   â”‚
â”‚  - å¯¹è¯ä¸­å¿ƒ / ä»»åŠ¡ä¸­å¿ƒ / çŸ¥è¯†åº“ / å®¢æˆ·ç”»åƒ / è´¨æ£€é¢æ¿          â”‚
â”‚  - HTTPï¼ˆSSE: ReviewRequest è®¢é˜…å¯ç”¨ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ HTTP / SSEï¼ˆå¯é€‰ï¼‰
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Backend (Fastify)                     â”‚
â”‚  - Application / Domain / Infrastructure / Presentation       â”‚
â”‚  - EventBus + Outbox + WebSocketï¼ˆæœªæ¥å…¥ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ HTTP
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AgentScope Service (FastAPI)              â”‚
â”‚  OrchestratorAgent + Assistant/Engineer/Inspector Agents       â”‚
â”‚  /api/chat  /api/agents  /api/events/bridge                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LLM Provider                          â”‚
â”‚  DeepSeek v3.1                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 éƒ¨ç½²æ‹“æ‰‘ï¼ˆDocker/Compose è§†è§’ï¼‰

```
[Browser]
    â”‚
    â–¼
[Frontend (Vite build/Static)] ---HTTP---> [Backend: :8080]
                                      â”‚
                                      â”œâ”€â”€HTTP--> [AgentScope: :5000]
                                      â”‚
                                      â”œâ”€â”€TCP--> [PostgreSQL: :5432]
                                      â”‚
                                      â””â”€â”€TCP--> [Redis: :6379]

å¯é€‰ï¼š
  [Prometheus: :9090]  <---scrape---  [Backend Metrics]
  [Grafana: :3001]     <---read-----  [Prometheus]
  [Nginx] ä½œä¸ºç»Ÿä¸€å…¥å£åå‘ä»£ç†
```

### 1.4 ç«¯å£ä¸å¥åº·æ£€æŸ¥

- Backendï¼š`http://localhost:8080`ï¼Œå¥åº·æ£€æŸ¥ `GET /health`  
- AgentScopeï¼š`http://localhost:5000`ï¼Œå¥åº·æ£€æŸ¥ `GET /health`  
- å‰ç«¯æœ¬åœ°ï¼š`http://localhost:5173`ï¼ˆDocker æ˜ å°„ `http://localhost:3002`ï¼‰
- MCPï¼š`POST /mcp`ï¼ˆtools/list, tools/callï¼‰ï¼Œå·¥å…·åˆ—è¡¨ `GET /mcp` æˆ– `GET /mcp/tools`

---

## 2. PRODUCT_ANALYSIS_REPORT å®¡è®¡ï¼ˆçœŸå®æ€§ä¸æ›´æ–°æƒ…å†µï¼‰

**ç»“è®º**ï¼š`docs/_archived/prd/PRODUCT_ANALYSIS_REPORT.md` ä¸º 2026-01-14 çš„å½’æ¡£åˆ†ææŠ¥å‘Šï¼ŒåŒ…å«å¤§é‡â€œè§„åˆ’/å»ºè®®â€å†…å®¹ï¼Œ**ä¸ç­‰åŒå½“å‰å®ç°**ã€‚éœ€è¦æ˜ç¡®åŒºåˆ†â€œå†å²åˆ†æ/è§„åˆ’â€ä¸â€œå½“å‰å®ç°â€ã€‚

### 2.1 æ˜ç¡®éœ€æ ¡æ­£é¡¹ï¼ˆä¸å½“å‰å®ç°ä¸ä¸€è‡´ï¼‰

- **ç‰ˆæœ¬å·**ï¼šæŠ¥å‘Šå†™ `v0.9 Alpha`ï¼Œå½“å‰ä»“åº“æ ‡æ³¨ `v0.1.0`ï¼ˆå¼€å‘é˜¶æ®µï¼‰ã€‚  
- **ç«¯å£æè¿°**ï¼šæŠ¥å‘Šå†™è¿è¡Œç¯å¢ƒ 3000ï¼ˆDocker æ˜ å°„ï¼‰ï¼Œå½“å‰ Docker æ˜ å°„ä¸º **3002**ï¼›æœ¬åœ°å¼€å‘ç«¯å£ä»ä¸º 5173ã€‚  

### 2.2 å¯ç–‘æˆ–ä¸å¯éªŒè¯é¡¹ï¼ˆéœ€æ ‡æ³¨â€œå†å²è¯„ä¼°/éå½“å‰â€ï¼‰

- â€œæ•´ä½“å®Œæˆåº¦ 73% / å‰ç«¯ 90%+ / åç«¯ 54~60%â€ ä¸ºå†å²ä¼°ç®—ï¼Œ**æ— æ³•é€šè¿‡ä»£ç ç›´æ¥éªŒè¯**ã€‚  
- å¤šå¤„â€œè§„åˆ’â€å†…å®¹ï¼ˆReact/React Query/Zustand é‡æ„ã€NestJS è¿ç§»ã€Redis Streams/RabbitMQ ç­‰ï¼‰å±äºè·¯çº¿å»ºè®®ï¼Œéå®ç°ç°çŠ¶ã€‚  

### 2.3 æŠ¥å‘Šå†…ä¸å½“å‰å®ç°ä¸€è‡´çš„ç‚¹ï¼ˆæ— éœ€æ›´æ­£ï¼‰

- æŠ¥å‘Šå·²æ ‡æ³¨â€œå‰ç«¯å½“å‰ä¸º Vanilla JS + Viteï¼ŒReact ä¸ºè§„åˆ’å»ºè®®â€ã€‚  
- æŠ¥å‘Šå·²æ ‡æ³¨â€œåç«¯å½“å‰ä¸º Fastifyï¼ŒNestJS ä¸ºè§„åˆ’å»ºè®®â€ã€‚  
- æŠ¥å‘Šç¤ºä¾‹é…ç½®ä¸­å·²å‡ºç° `deepseek-v3.1`ï¼Œä¸å½“å‰é…ç½®ä¸€è‡´ã€‚  

### 2.4 å·²æ›´æ–°/å·²è¡¥é½çš„é—®é¢˜ï¼ˆä»£ç å·²è½å®ï¼‰

- **MCP å·¥å…·å·²å®ç°å¹¶æœ‰ E2E è¦†ç›–**ï¼š`tests/backend/e2e/mcp.e2e.spec.ts`  
- **MCP å…è®¸å·¥å…·æ³¨å†Œæ—¥å¿—**ï¼š`backend/src/infrastructure/agentscope/MCPServer.ts`  
- **AgentScope ç½‘å…³å¥åº·æ£€æŸ¥/é…ç½®æš´éœ²**ï¼š`/agentscope/health`ã€`/agentscope/status`ã€`/agentscope/config`  
- **é™çº§ç­–ç•¥ä¸å‘Šè­¦**ï¼š`ConversationTaskCoordinator` ä¸ `OutboxProcessor` å‡æœ‰æ—¥å¿—ä¸å‘Šè­¦å…¥å£

**å»ºè®®**ï¼šå°†è¯¥æŠ¥å‘Šè§†ä¸ºå†å²åˆ†æææ–™ï¼Œä»…ç”¨äºâ€œè·¯çº¿å›¾/å»ºè®®â€å‚è€ƒï¼Œé¿å…ä½œä¸ºâ€œå½“å‰å®ç°ä¾æ®â€ã€‚

---

## 3. IM æ¶ˆæ¯è¿›å…¥ç³»ç»Ÿåçš„è”åŠ¨æµç¨‹æ¢³ç†
> æ¥å£å‰ç¼€è¯´æ˜ï¼š  
> - **ä¸šåŠ¡é€šç”¨æ¥å£**ï¼ˆConversation/Task/Requirement/Knowledge/AI ç­‰ï¼‰å®Œæ•´å‰ç¼€ä¸º `/api/v1/api`ï¼ˆè·¯ç”±å†…è‡ªå¸¦ `/api`ï¼‰ã€‚  
> - **IM/è´¨é‡/å®¢æˆ·ç”»åƒæ¥å£**ï¼ˆimRoutes.ts å†…æ³¨å†Œï¼‰å®Œæ•´å‰ç¼€ä¸º `/api/v1`ã€‚  
> - **å¥åº·æ£€æŸ¥/ç›‘æ§/MCP/AgentScope ç½‘å…³**ä¸åŠ  `/api/v1` å‰ç¼€ï¼ˆå¦‚ `/health`ã€`/metrics`ã€`/mcp`ã€`/agentscope/*`ï¼‰ã€‚  
> æ–‡å†…è‹¥æœªå†™å‰ç¼€ï¼Œé»˜è®¤çœç•¥è¿™äº›å‰ç¼€è¯´æ˜ã€‚

---

## 4. äº‹ä»¶æ ¼å¼è§„èŒƒï¼ˆä»£ç å¯¹é½ç‰ˆï¼‰

æœ¬èŠ‚ä»¥å½“å‰ä»£ç ä¸ºå‡†ï¼Œç»™å‡º**ç»Ÿä¸€äº‹ä»¶ç»“æ„**ã€**åº“è¡¨å­—æ®µæ˜ å°„**ä¸**äº‹ä»¶æ¡¥æ¥æ ¼å¼**ï¼Œç”¨äºæµ‹è¯•ã€æ’é”™ä¸è·¨æœåŠ¡è”åŠ¨ã€‚

### 4.1 ç»Ÿä¸€é¢†åŸŸäº‹ä»¶ç»“æ„ï¼ˆå†…å­˜äº‹ä»¶ï¼‰

**é¢†åŸŸäº‹ä»¶åŸºç±»**ï¼š`backend/src/domain/shared/DomainEvent.ts`

å­—æ®µå®šä¹‰ï¼š
- `eventId`ï¼šuuid
- `eventType`ï¼šäº‹ä»¶ç±»å‹ï¼ˆå­—ç¬¦ä¸²ï¼‰
- `aggregateId`ï¼šèšåˆæ ¹ ID
- `occurredAt`ï¼šå‘ç”Ÿæ—¶é—´ï¼ˆDateï¼‰
- `version`ï¼šäº‹ä»¶ç‰ˆæœ¬ï¼ˆé»˜è®¤ 1ï¼‰
- `payload`ï¼šäº‹ä»¶è½½è·ï¼ˆobjectï¼‰

**å†…å­˜äº‹ä»¶ç¤ºä¾‹ï¼ˆä¼ªç»“æ„ï¼‰**ï¼š

```json
{
  "eventId": "uuid",
  "eventType": "ConversationClosed",
  "aggregateId": "conv-123",
  "occurredAt": "2026-02-02T10:00:00.000Z",
  "version": 1,
  "payload": {
    "summary": "resolved"
  }
}
```

### 4.2 domain_events è¡¨å­—æ®µæ˜ å°„ï¼ˆäº‹ä»¶æº¯æºï¼‰

**è¡¨å®ä½“**ï¼š`backend/src/infrastructure/database/entities/DomainEventEntity.ts`

| å­—æ®µ | è¯´æ˜ | æ˜ å°„æ¥æº |
|------|------|----------|
| id | äº‹ä»¶ID | eventId |
| aggregate_id | èšåˆæ ¹ID | aggregateId |
| aggregate_type | èšåˆç±»å‹ | ç”±ä¿å­˜é€»è¾‘ä¼ å…¥ |
| event_type | äº‹ä»¶ç±»å‹ | eventType |
| event_data | äº‹ä»¶è½½è· | payload |
| occurred_at | å‘ç”Ÿæ—¶é—´ | occurredAt |
| version | äº‹ä»¶ç‰ˆæœ¬ | version |

### 4.3 outbox_events è¡¨å­—æ®µæ˜ å°„ï¼ˆOutboxï¼‰

**è¡¨å®ä½“**ï¼š`backend/src/infrastructure/database/entities/OutboxEventEntity.ts`

| å­—æ®µ | è¯´æ˜ | æ˜ å°„æ¥æº |
|------|------|----------|
| id | äº‹ä»¶ID | eventId |
| aggregate_id | èšåˆæ ¹ID | aggregateId |
| aggregate_type | èšåˆç±»å‹ | ç”±ä¿å­˜é€»è¾‘ä¼ å…¥ |
| event_type | äº‹ä»¶ç±»å‹ | eventType |
| event_data | äº‹ä»¶è½½è· | payload |
| version | äº‹ä»¶ç‰ˆæœ¬ | version |
| status | pending/published/failed/dead_letter | Outbox å¤„ç†çŠ¶æ€ |
| retry_count / max_retries | é‡è¯•ä¿¡æ¯ | OutboxProcessor |
| error_message | é”™è¯¯ä¿¡æ¯ | OutboxProcessor |
| next_retry_at / published_at | é‡è¯•/å‘å¸ƒ | OutboxProcessor |
| created_at / updated_at | è®°å½•æ—¶é—´ | æ•°æ®åº“è‡ªåŠ¨ |
| occurred_at | ä¸šåŠ¡å‘ç”Ÿæ—¶é—´ | occurredAt |

### 4.4 AgentScope äº‹ä»¶æ¡¥æ¥æ ¼å¼ï¼ˆNode â†’ Agentï¼‰

**å‘é€è·¯å¾„**ï¼šBackend `EventBridge` â†’ AgentScope

**é…ç½®**ï¼š
- `AGENTSCOPE_NODE_TO_AGENT_PATH`ï¼ˆé»˜è®¤ `/api/events/bridge`ï¼‰
- ä»£ç ä½ç½®ï¼š`backend/src/config/agentscope.config.ts`ã€`backend/src/infrastructure/agentscope/EventBridge.ts`

**è¯·æ±‚ç»“æ„ï¼ˆä¸ AgentScope æ¥æ”¶ä¸€è‡´ï¼‰**ï¼š

```json
{
  "eventId": "evt-123",
  "eventType": "ConversationClosed",
  "aggregateId": "conv-123",
  "payload": { "summary": "resolved" },
  "occurredAt": "2026-02-02T10:00:00.000Z",
  "version": 1
}
```

### 4.5 AgentScope äº‹ä»¶å›æµæ ¼å¼ï¼ˆAgent â†’ Nodeï¼‰

**æ¥æ”¶è·¯å¾„**ï¼šBackend `EventBridge` åå‘å…¥å£  
**é»˜è®¤è·¯å¾„**ï¼š`/agentscope/events`

**å¿…è¦å­—æ®µ**ï¼ˆç¼ºå°‘ä¼šè¿”å› 400ï¼‰ï¼š`eventType`ã€`aggregateId`

```json
{
  "eventType": "AgentReviewRequested",
  "aggregateId": "review-123",
  "payload": { "reason": "low_confidence" },
  "occurredAt": "2026-02-02T10:00:00.000Z",
  "version": 1
}
```

### 4.6 MCP å·¥å…·è°ƒç”¨äº‹ä»¶æ ¼å¼ï¼ˆHTTP JSONï¼‰

**è°ƒç”¨å…¥å£**ï¼š`POST /mcp`

```json
{
  "method": "tools/call",
  "params": {
    "name": "searchKnowledge",
    "arguments": {
      "query": "é€€æ¬¾å¤šä¹…åˆ°è´¦",
      "mode": "semantic"
    }
  }
}
```

**å·¥å…·åˆ—è¡¨**ï¼š

```json
{
  "method": "tools/list"
}
```

## âš ï¸ IMæ¸ é“çš„æœ¬è´¨ç‰¹æ€§ï¼ˆæ ¸å¿ƒè®¾è®¡ç†å¿µï¼‰

**IMå¯¹è¯æ°¸ä¹…å­˜åœ¨ï¼Œä¸æ”¯æŒå…³é—­æ“ä½œ**

è¿™ä¸æ˜¯è®¾è®¡é€‰æ‹©ï¼Œè€Œæ˜¯IMçš„æœ¬è´¨ç‰¹æ€§ï¼š
- **IMå¯¹è¯æ°¸ä¹…å­˜åœ¨**ï¼šå°±åƒå¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰IMå·¥å…·ï¼Œå¯¹è¯æ°¸è¿œå­˜åœ¨ï¼Œä¸ä¼š"å…³é—­"
- **ä¸šåŠ¡æµç¨‹é©±åŠ¨æ–¹å¼**ï¼šé€šè¿‡é—®é¢˜ç”Ÿå‘½å‘¨æœŸç®¡ç†æ¥é©±åŠ¨ä¸šåŠ¡æµç¨‹ï¼ˆé—®é¢˜æå‡º â†’ å¤„ç† â†’ è§£å†³ï¼‰
- **è´¨æ£€è§¦å‘æœºåˆ¶**ï¼šè´¨æ£€ç”± `ProblemResolvedEvent`ï¼ˆé—®é¢˜è§£å†³ï¼‰è§¦å‘ï¼Œè€Œé `ConversationClosedEvent`ï¼ˆä¼šè¯å…³é—­ï¼‰
- **å¤šé—®é¢˜å¹¶è¡Œç®¡ç†**ï¼šä¸€ä¸ªIMå¯¹è¯å†…å¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªé—®é¢˜ï¼Œæ¯ä¸ªé—®é¢˜ç‹¬ç«‹çŠ¶æ€æµè½¬

**ä¸ä¼ ç»Ÿå·¥å•ç³»ç»Ÿçš„åŒºåˆ«**ï¼š
- ä¼ ç»Ÿå·¥å•ï¼šåˆ›å»º â†’ å¤„ç† â†’ å…³é—­ï¼ˆå·¥å•æœ‰æ˜ç¡®çš„å…³é—­çŠ¶æ€ï¼‰
- IMå¯¹è¯ï¼šæ°¸ä¹…å­˜åœ¨ â†’ é—®é¢˜æå‡º â†’ é—®é¢˜è§£å†³ â†’ è´¨æ£€ï¼ˆå¯¹è¯æœ¬èº«ä¸å…³é—­ï¼‰

---

## âœ… é—®é¢˜ resolved è§¦å‘æ¡ä»¶ï¼ˆä»£ç å¯¹é½ï¼‰

**æ ¸å¿ƒå…¥å£**ï¼š`ConversationTaskCoordinator.updateProblemLifecycle()`  
**åˆ¤å®šæ–¹æ³•**ï¼š`AiService.detectProblemResolution()`ï¼ˆLLM + å…³é”®è¯å…œåº•ï¼‰

**è§¦å‘é€»è¾‘ï¼ˆç®€åŒ–ï¼‰**ï¼š
- å½“å­˜åœ¨ `activeProblem` ä¸” `resolution.resolved === true` â†’ æ›´æ–°ä¸º `resolved`
- å½“ä¸å­˜åœ¨ `activeProblem` ä¸”å­˜åœ¨ `latestResolved` ä¸” `resolution.reopened === true` â†’ æ›´æ–°ä¸º `reopened`
- è‹¥æ— æ³•åˆ¤æ–­ï¼ˆresolved/reopened å‡ä¸º falseï¼‰â†’ çŠ¶æ€ä¸å˜

**LLM åˆ¤æ–­è§„åˆ™ï¼ˆæ‘˜è¦ï¼‰**ï¼š
- `resolved=true`ï¼šå·²è§£å†³/æ„Ÿè°¢/ç¡®è®¤é—®é¢˜æ¶ˆå¤±  
- `reopened=true`ï¼šä»æœªè§£å†³/å†æ¬¡å¤å‘/ä»æœ‰é—®é¢˜  
- æ— æ³•åˆ¤æ–­ â†’ å‡ä¸º false

**å…³é”®è¯å…œåº•**ï¼š
- resolvedï¼š`é—®é¢˜.*è§£å†³|è§£å†³.*é—®é¢˜|å·².*è§£å†³|æ„Ÿè°¢.*è§£å†³|å·²æ¢å¤|å·²ä¿®å¤`
- reopenedï¼š`æ²¡è§£å†³|æœªè§£å†³|è¿˜æ˜¯.*é—®é¢˜|ä»ç„¶.*(æŠ¥é”™|é”™è¯¯|å¼‚å¸¸)|ä¾æ—§.*(å¤±è´¥|æ— æ³•)`

**å½±å“é“¾è·¯**ï¼š
- `resolved` â†’ è§¦å‘ `ProblemResolvedEvent` â†’ `ProblemResolvedEventHandler` â†’ è°ƒç”¨ `/api/agents/inspect` ç”Ÿæˆè´¨æ£€æŠ¥å‘Š

**æ³¨æ„**ï¼šåªæœ‰åœ¨â€œé—®é¢˜çŠ¶æ€â€è¢«åˆ¤å®šä¸º resolved æ—¶æ‰ä¼šè§¦å‘è´¨æ£€ï¼Œå› æ­¤â€œå®æ—¶è´¨æ£€â€å¹¶éæ¯æ¡æ¶ˆæ¯éƒ½ä¼šå‘ç”Ÿã€‚

---

## âœ… è´¨æ£€è§¦å‘ä¸è½åº“å¯è§‚æµ‹ç‚¹ï¼ˆä»£ç å¯¹é½ï¼‰

**è§¦å‘å…¥å£ï¼ˆIMï¼‰**ï¼š
- `ProblemResolvedEventHandler` è§¦å‘ `/api/agents/inspect`
  - æ—¥å¿—ï¼š`[ProblemResolvedEventHandler] Triggering quality inspection...`
  - å¤±è´¥æ—¥å¿—ï¼š`[ProblemResolvedEventHandler] Failed to trigger quality inspection...`

**è§¦å‘å…¥å£ï¼ˆéIMï¼‰**ï¼š
- `ConversationTaskCoordinator.handleConversationClosed`
  - æ—¥å¿—ï¼š`[ConversationTaskCoordinator] Triggering quality inspection for non-IM conversation...`
  - å¤±è´¥æ—¥å¿—ï¼š`[ConversationTaskCoordinator] Failed to trigger quality inspection...`

**è½åº“ä½ç½®**ï¼š
- `QualityReportRepository.save(...)`ï¼ˆä¿å­˜åˆ° `quality_reports`ï¼‰
  - ä¸Šæ¸¸ç¡®è®¤ï¼š`result.quality_score` ä¸ `report` ä¼šåœ¨ handler ä¸­å†™å…¥

**æ•°æ®è¯»å–å…¥å£**ï¼š
- `GET /api/v1/quality/:conversationId`ï¼ˆè‹¥æ— æŠ¥å‘Šåˆ™å›é€€ AI åˆ†æï¼‰
- `GET /api/v1/quality/:conversationId/reports`
- `GET /api/v1/quality/reports`

**å»ºè®®æ’æŸ¥é¡ºåº**ï¼š
1. `ProblemResolvedEvent` æ˜¯å¦äº§ç”Ÿï¼ˆåŸŸäº‹ä»¶/Outboxï¼‰
2. Handler æ˜¯å¦è§¦å‘ `/api/agents/inspect`ï¼ˆæ—¥å¿—ï¼‰
3. AgentScope æ˜¯å¦è¿”å› `success`ï¼ˆAPI å“åº”ï¼‰
4. `quality_reports` æ˜¯å¦è½åº“
5. å‰ç«¯æ˜¯å¦æ‹‰å–åˆ°è´¨æ£€æŠ¥å‘Š

---

## âœ… å®æ—¶æ¨é€æ–¹æ¡ˆï¼ˆå½“å‰è·¯å¾„ä¸é™åˆ¶ï¼‰

**å½“å‰å¯ç”¨ï¼šSSEï¼ˆReviewRequestï¼‰**
- `GET /api/v1/im/reviews/stream`ï¼šSSE è®¢é˜…å¤æ ¸äº‹ä»¶
- `GET /api/v1/im/reviews/pending`ï¼šæŸ¥è¯¢å¾…å¤æ ¸åˆ—è¡¨
- `POST /api/v1/im/reviews/submit`ï¼šäººå·¥å¤æ ¸å›å†™

**å½“å‰ä¸å¯ç”¨ï¼šWebSocket**
- `WebSocketService` å­˜åœ¨ä½†æœªæ³¨å†Œåˆ° appï¼ˆæ—  WS æ¨é€ï¼‰
- ç»“è®ºï¼šå®æ—¶æ¨é€ä»…è¦†ç›–â€œå¤æ ¸äº‹ä»¶â€ï¼Œ**è´¨æ£€ç»“æœä¸é€šè¿‡ WS æ¨é€**ï¼Œéœ€å‰ç«¯ä¸»åŠ¨æ‹‰å–

**å½±å“èŒƒå›´**
- â€œå®æ—¶è´¨æ£€å±•ç¤ºâ€ä¾èµ–å‰ç«¯è½®è¯¢æˆ–åˆ·æ–°
- â€œå¤æ ¸é€šçŸ¥â€å¯é€šè¿‡ SSE è¾¾åˆ°å‡†å®æ—¶

---

## âœ… å‰ç«¯è´¨æ£€é¢æ¿åˆ·æ–°æœºåˆ¶ï¼ˆä»£ç å¯¹é½ï¼‰

**æ•°æ®æ¥æº**ï¼š`GET /api/v1/quality/:conversationId`ï¼ˆ`assets/js/api.js` â†’ `fetchQualityProfile`ï¼‰

**è§¦å‘æ—¶æœº**ï¼š
- ä»»åŠ¡ä¾§è´¨æ£€é¢æ¿ï¼šè¿›å…¥é¢æ¿æˆ–åˆ‡æ¢ä¼šè¯æ—¶è§¦å‘åŠ è½½ï¼ˆ`assets/js/tasks/index.js`ï¼‰
- å¯¹è¯ä¾§æ•…éšœæŠ¥å‘Šï¼šæ‰“å¼€é¢æ¿æ—¶å¹¶è¡Œæ‹‰å–è´¨é‡æ•°æ®ä¸ AI åˆ†æï¼ˆ`assets/js/chat/index.js`ï¼‰

**åˆ·æ–°æ–¹å¼**ï¼š
- æ—  WebSocket æ¨é€ï¼›é¡µé¢å†…åªåœ¨â€œæ‰“å¼€/åˆ‡æ¢/æ‰‹åŠ¨æ“ä½œâ€æ—¶è¯·æ±‚
- è‹¥æ— è´¨æ£€æŠ¥å‘Šï¼Œåç«¯ä¼šå›é€€åˆ° AI åˆ†æï¼ˆ`ImController.getConversationQuality`ï¼‰

**å‰ç«¯ä¾èµ–**ï¼š
- ä¾èµ– `API_BASE`ï¼ˆ`public/runtime-config.js` â†’ `apiBaseUrl`ï¼‰
- API æœªå¯ç”¨æ—¶ï¼Œé¢æ¿ä¼šæç¤ºâ€œAPI æœªå¯ç”¨ï¼Œæ— æ³•åŠ è½½è´¨æ£€æ•°æ®â€

---

## âš ï¸ å®ç°çŠ¶æ€è¯´æ˜ï¼ˆ2026-01-26 å®¡è®¡ç»“æœï¼‰

æœ¬æ–‡æ¡£æè¿°çš„æ˜¯**å½“å‰å®é™…å®ç°çŠ¶æ€**ï¼Œè€Œéç†æƒ³è§„åˆ’ã€‚å„åŠŸèƒ½å®ç°çŠ¶æ€å¦‚ä¸‹ï¼š

### âœ… å·²å®Œæ•´å®ç°ï¼ˆ100%ï¼‰
- IM å…¥ç«™æ ¸å¿ƒé“¾è·¯ï¼ˆ`/api/v1/im/incoming-message` â†’ ImController â†’ ConversationTaskCoordinatorï¼‰
- äº‹ä»¶æº¯æºä¸ Outbox æœºåˆ¶ï¼ˆ`domain_events` + `outbox_events` åŒå†™ï¼Œäº‹åŠ¡ä¿è¯ï¼‰
- éœ€æ±‚è¯†åˆ«ä¸ä»»åŠ¡åˆ›å»ºè”åŠ¨ï¼ˆç½®ä¿¡åº¦ > é…ç½®é˜ˆå€¼åˆ›å»ºéœ€æ±‚ï¼Œé«˜ä¼˜å…ˆçº§è‡ªåŠ¨åˆ›å»ºä»»åŠ¡ï¼‰
- AI æƒ…ç»ªåˆ†æï¼ˆä¸¤å¤„ï¼šCoordinator å†…éƒ¨ + Controller ç»„è£…å“åº”ï¼‰
- çŸ¥è¯†åº“æ£€ç´¢ä¸æ¨èï¼ˆæ”¯æŒ LLM æ„å›¾æå–ä¼˜åŒ–æŸ¥è¯¢ï¼‰
- é—®é¢˜ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆLLM é©±åŠ¨çŠ¶æ€æµè½¬ï¼šnew â†’ in_progress â†’ resolved â†’ reopenedï¼‰
- äººå·¥å¤æ ¸é“¾è·¯ï¼ˆReviewRequest åˆ›å»º + SSE è®¢é˜… + äººå·¥å›å†™ï¼‰
- RequirementRepository å’Œ TaskRepository äº‹åŠ¡å¤„ç†ï¼ˆâœ… å·²ä¿®å¤ï¼šå®Œæ•´çš„äº‹åŠ¡å¤„ç†å’Œäº‹ä»¶æŒä¹…åŒ–ï¼‰
- é™çº§é€»è¾‘ç›‘æ§ï¼ˆâœ… å·²æ·»åŠ ï¼šé™çº§è§¦å‘æ—¶è®°å½•è¯¦ç»†æ—¥å¿—å’ŒåŸå› ï¼‰
- æ­»ä¿¡é˜Ÿåˆ—å‘Šè­¦ï¼ˆâœ… å·²é›†æˆï¼šæ”¯æŒ Webhook å‘Šè­¦ï¼Œå¯å¯¹æ¥é’‰é’‰/Slackï¼‰

### âš ï¸ éƒ¨åˆ†å®ç°ï¼ˆ60-90%ï¼‰
- **è´¨æ£€é—­ç¯ï¼ˆ90%ï¼‰**ï¼šç”± `ProblemResolvedEvent` è§¦å‘ï¼Œè´¨æ£€ç»“æœå†™å…¥ `quality_reports` è¡¨ã€‚âœ… æ—¶åºå›¾å·²æ›´æ–°ï¼Œæ­£ç¡®åæ˜ å®é™…è§¦å‘æœºåˆ¶ã€‚
- **AgentScope å›å¤ç”Ÿæˆï¼ˆ80%ï¼‰**ï¼šä¼˜å…ˆè°ƒç”¨ AgentScope `/api/chat/message`ï¼Œå¤±è´¥æ—¶é™çº§åˆ° LLM æˆ–å›ºå®šæ–‡æ¡ˆï¼ˆ`"å·²æ”¶åˆ°æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚å¦‚éœ€åŠ æ€¥ï¼Œè¯·åœ¨æ¶ˆæ¯ä¸­è¯´æ˜ç´§æ€¥äº‹é¡¹ã€‚"`ï¼‰ã€‚**æ³¨æ„**ï¼šæ–‡æ¡£å£°ç§°"å¤±è´¥æ—¶é‡è¯•"ï¼Œä½†ä»£ç å®é™…ä¸º"å¤±è´¥æ—¶é™çº§"ï¼Œæ— è‡ªåŠ¨é‡è¯•é€»è¾‘ã€‚
- **MCP å·¥å…·æ³¨å†Œï¼ˆâœ… å·²å®ç°ï¼‰**ï¼šå·¥å…·æ–‡ä»¶å­˜åœ¨ï¼ˆ`backend/src/infrastructure/agentscope/tools/*.ts`ï¼‰ï¼ŒMCP Server å…¥å£å·²æ¥å…¥ï¼Œå¹¶å·²è¡¥é½è°ƒç”¨æ—¥å¿—ä¸ E2E ç”¨ä¾‹éªŒè¯å¯ç”¨æ€§ã€‚

### âŒ æœªå®ç°ï¼ˆ0-30%ï¼‰
- **æ— **ï¼ˆæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼‰

### ğŸ”§ å¯é€‰èƒ½åŠ› / æœªæ¥å…¥ä¸»é“¾è·¯
- **Workflow/ReAct Loopï¼ˆå¯é€‰èƒ½åŠ›ï¼Œæœªæ¥å…¥ IM ä¸»é“¾è·¯ï¼‰**ï¼šWorkflow å¼•æ“ä¸æ‰§è¡Œå™¨å·²å®ç°ï¼Œ`workflows/*.yaml` ä¹Ÿå·²å­˜åœ¨ï¼›å½“å‰ IM ä¸»é“¾è·¯æœªè°ƒç”¨ `WorkflowEngine.execute(...)`ã€‚é…ç½®é»˜è®¤ `false`ï¼ˆDocker Compose ç¤ºä¾‹å¯å¼€å¯ï¼‰ï¼Œä½†æœªæ¥å…¥ä¸»é“¾è·¯å› æ­¤ä¸å½±å“ä¸»æµç¨‹ã€‚
  - **å¯ç”¨æ–¹æ³•**ï¼šè®¾ç½® `WORKFLOW_ENGINE_ENABLED=true`ï¼Œå¹¶åœ¨ä¸šåŠ¡é“¾è·¯ä¸­æ˜¾å¼è§¦å‘å¯¹åº” workflowã€‚
- **IM å›æ‰§/é€è¾¾çŠ¶æ€**ï¼šå½“å‰ä»£ç æœªæä¾› `/api/v1/im/messages/receipt` è·¯ç”±å®ç°ï¼›å¦‚éœ€æ”¯æŒé€è¾¾/å·²è¯»/è¶…æ—¶ç­‰åœºæ™¯ï¼Œéœ€è¦è¡¥é½æ¥å£ä¸ä¸šåŠ¡é€»è¾‘ã€‚

### ğŸš« ä¸é€‚ç”¨äºIMæ¸ é“çš„åŠŸèƒ½
- **ä¼šè¯å…³é—­ï¼ˆCloseConversationï¼‰**ï¼šIMå¯¹è¯æ°¸ä¹…å­˜åœ¨ï¼Œä¸æ”¯æŒå…³é—­æ“ä½œã€‚è¿™æ˜¯IMçš„æœ¬è´¨ç‰¹æ€§ï¼Œè€Œéè®¾è®¡é€‰æ‹©ã€‚
  - `CloseConversationUseCase` ä¿ç•™ç”¨äºéIMæ¸ é“ï¼ˆå¦‚å·¥å•ç³»ç»Ÿï¼‰
  - MCPå·¥å…· `closeConversation` å·²ä» MCP æ³¨å†Œæ¸…å•ç§»é™¤ï¼ˆé¿å…è¯¯ç”¨å…³é—­é€»è¾‘ï¼‰
  - WorkflowåŠ¨ä½œ `close_conversation` å¯¹IMæ¸ é“è‡ªåŠ¨è·³è¿‡
  - ç¦æ­¢é€šè¿‡ `/api/v1/im/conversations/:id/status` æˆ– `/api/v1/api/conversations/:id/close` å°† IM Conversation ç½®ä¸º `closed`ï¼ˆUI çª—å£å…³é—­ä¸å½±å“ä¸šåŠ¡çŠ¶æ€ï¼‰

### ğŸ”§ é™çº§ç­–ç•¥è¯´æ˜

**å›å¤ç”Ÿæˆé™çº§é“¾è·¯**ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
1. **AgentScope è·¯å¾„**ï¼š`AgentScopeChatClient.sendMessage()` â†’ å¤±è´¥æ—¶è¿›å…¥æ­¥éª¤ 2
2. **LLM è·¯å¾„**ï¼š`LLMClient.generateReply()` â†’ å¤±è´¥æ—¶è¿›å…¥æ­¥éª¤ 3
3. **é™çº§æ–‡æ¡ˆ**ï¼šè¿”å›å›ºå®šæ–‡æ¡ˆ `"å·²æ”¶åˆ°æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚å¦‚éœ€åŠ æ€¥ï¼Œè¯·åœ¨æ¶ˆæ¯ä¸­è¯´æ˜ç´§æ€¥äº‹é¡¹ã€‚"`

**é™çº§è§¦å‘æ¡ä»¶**ï¼š
- AgentScope æœåŠ¡ä¸å¯ç”¨æˆ–è¶…æ—¶ï¼ˆ`config.agentscope.timeout`ï¼‰
- LLM æœåŠ¡ä¸å¯ç”¨æˆ– API è°ƒç”¨å¤±è´¥

**é™çº§å½±å“**ï¼š
- é™çº§åˆ° LLM æˆ–å›ºå®šæ–‡æ¡ˆæ—¶ï¼Œå›å¤ç½®ä¿¡åº¦é™ä½ï¼ˆ0.4-0.6ï¼‰ï¼Œè‡ªåŠ¨è§¦å‘äººå·¥å¤æ ¸
- é™çº§è¿‡ç¨‹ä¸é˜»å¡ä¸»æµç¨‹ï¼Œç”¨æˆ·ä»èƒ½æ”¶åˆ°å“åº”

---

åŸºäºå½“å‰ä»£ç å®ç°ï¼ˆ`ImController` â†’ `ConversationTaskCoordinator` ç­‰ï¼‰ï¼ŒIM æ¶ˆæ¯è¿›å…¥ç³»ç»Ÿåè§¦å‘çš„ä¸»è¦è”åŠ¨åŒ…å«ï¼š
- ä¼šè¯åˆ›å»º/å¤ç”¨ä¸æ¶ˆæ¯è½åº“ï¼ˆConversation + Messageï¼‰ã€‚
- é¢†åŸŸäº‹ä»¶è®°å½•ï¼ˆ`domain_events`ï¼‰ä¸ Outbox äº‹ä»¶æŒä¹…åŒ–ï¼ˆ`outbox_events`ï¼‰ã€‚
- éœ€æ±‚è¯†åˆ« â†’ éœ€æ±‚åˆ›å»º â†’ é«˜ä¼˜å…ˆçº§ä»»åŠ¡åˆ›å»ºã€‚
- AI æƒ…ç»ªåˆ†æï¼ˆä¸¤å¤„ï¼šCoordinator å†…éƒ¨ç”Ÿæˆå›å¤æ—¶ä¸€æ¬¡ï¼›Controller ç»„è£…å“åº”æ—¶ä¸€æ¬¡ï¼‰ã€‚
- çŸ¥è¯†åº“æ£€ç´¢ä¸æ¨èï¼ˆController ä¾§ + Coordinator ç”Ÿæˆå›å¤æ—¶ï¼‰ã€‚
- ä»»åŠ¡å…³è”æŸ¥è¯¢ï¼ˆController ä¾§ï¼‰ã€‚
- è‡ªåŠ¨å›å¤å»ºè®®ç”Ÿæˆä¸äººå·¥å¤æ ¸è§¦å‘ï¼ˆåˆ›å»º ReviewRequestï¼Œæ¨é€æ¸ é“ä¾èµ–å¤–éƒ¨ AgentScope/å‰ç«¯å®ç°ï¼›æœ¬ä»“åº“æœªè§ WebSocket æ¨é€å®ç°ï¼‰ã€‚
- é—®é¢˜è§£å†³äº‹ä»¶è§¦å‘å¼‚æ­¥è´¨æ£€ï¼ˆå½“é—®é¢˜åˆ¤å®šå·²è§£å†³æ—¶ï¼‰ã€‚

---

## IM æ¥å£æ¸…å•ï¼ˆä»¥è·¯ç”±å®ç°ä¸ºå‡†ï¼‰

> è¯´æ˜ï¼šä»¥ä¸‹æ¥å£å‡åœ¨ `imRoutes.ts` ä¸­æ³¨å†Œï¼Œå®Œæ•´å‰ç¼€ä¸º `/api/v1`ã€‚

### 1) IM ä¼šè¯ä¸æ¶ˆæ¯

- `GET /api/v1/im/conversations`ï¼šæŸ¥è¯¢ä¼šè¯åˆ—è¡¨
- `GET /api/v1/im/conversations/stats`ï¼šä¼šè¯ç»Ÿè®¡
- `GET /api/v1/im/conversations/:id/messages`ï¼šæ‹‰å–ä¼šè¯æ¶ˆæ¯
- `POST /api/v1/im/conversations/:id/messages`ï¼šå‘é€æ¶ˆæ¯ï¼ˆäººå·¥/ç³»ç»Ÿï¼‰
- `GET /api/v1/im/conversations/:id/problems`ï¼šä¼šè¯é—®é¢˜åˆ—è¡¨
- `PATCH /api/v1/im/conversations/:id/status`ï¼šæ›´æ–°ä¼šè¯çŠ¶æ€ï¼ˆIM ä¸å…è®¸ closedï¼‰
- `PATCH /api/v1/im/conversations/:id/mode`ï¼šè®¾ç½®ä¼šè¯æ¨¡å¼

### 2) IM æµ‹è¯•/è”è°ƒ

- `POST /api/v1/im/wecom/mock/sync`ï¼šåŒæ­¥ä¼å¾® mock ç¾¤èŠæ•°æ®

### 3) AI ä¸æƒ…ç»ªåˆ†æ

- `GET /api/v1/im/conversations/:id/ai-analysis`ï¼šAI åˆ†æç»“æœ
- `GET /api/v1/im/conversations/:id/sentiment`ï¼šæƒ…ç»ªåˆ†æç»“æœ

### 4) è´¨æ£€æ¥å£ï¼ˆè´¨é‡å‰ç¼€ï¼‰

- `GET /api/v1/quality/:conversationId`ï¼šä¼šè¯è´¨æ£€æ¦‚è§ˆ
- `GET /api/v1/quality/:conversationId/reports`ï¼šä¼šè¯è´¨æ£€æŠ¥å‘Šåˆ—è¡¨
- `GET /api/v1/quality/reports`ï¼šè´¨æ£€æŠ¥å‘ŠæŸ¥è¯¢

### 5) å®¢æˆ·ç”»åƒæ¥å£

- `GET /api/v1/profiles/:customerId`ï¼šå®¢æˆ·ç”»åƒ
- `GET /api/v1/profiles/:customerId/interactions`ï¼šå®¢æˆ·äº’åŠ¨è®°å½•

---

## æƒé™è¦æ±‚ï¼ˆä¸è·¯ç”±æƒé™ä¸€è‡´ï¼‰

> ä»¥ä¸‹ä¸ºæœ€å°æƒé™éœ€æ±‚ï¼ˆ`config.permissions`ï¼‰ï¼Œç¼ºå°‘æƒé™å°†è¿”å› 403ã€‚

- IM è¯»æƒé™ï¼š`im.read`
- IM å†™æƒé™ï¼š`im.write`
- å®¢æˆ·ç”»åƒæƒé™ï¼š`customers.read`
- è´¨æ£€æƒé™ï¼š`tasks.read`
- AI èƒ½åŠ›æƒé™ï¼š`ai.use`

## å¤‡æ³¨ï¼šå½“å‰å¯¹è¯å…¥å£ç­–ç•¥ï¼ˆ2026-01-26ï¼‰

ä¸ºä¿è¯å®¢æœä¾§äº¤äº’ç¨³å®šï¼Œå½“å‰çº¦å®šå¦‚ä¸‹ï¼š

1. **å®¢æœä¸»åŠ¨å‘é€çš„å¯¹è¯**  
   - å…¥å£ï¼š`/api/v1/api/conversations/:id/messages`  
   - è¡Œä¸ºï¼šä»…è½åº“ä¸äº‹ä»¶è®°å½•ï¼Œä¸é€šè¿‡ Agent ç”Ÿæˆå›å¤ï¼ˆä¸èµ° AgentScope è·¯ç”±ï¼‰ã€‚

2. **å¤–éƒ¨ IM å…¥ç«™æ¶ˆæ¯**  
   - å…¥å£ï¼š`/api/v1/im/incoming-message`  
   - è¡Œä¸ºï¼šèµ° Agent è¾…åŠ©é“¾è·¯ï¼ˆæƒ…ç»ª/æ„å›¾åˆ†æã€çŸ¥è¯†æ¨èã€å›å¤å»ºè®®ç­‰ï¼‰ï¼Œç”± `ConversationTaskCoordinator` é©±åŠ¨ã€‚

è¯¥ç­–ç•¥ä»…ç”¨äºé˜¶æ®µæ€§ç¨³å®šæ€§è€ƒè™‘ï¼Œåç»­å¯æŒ‰éœ€å†è°ƒæ•´è°ƒç”¨é“¾è·¯ä¸è‡ªåŠ¨åŒ–ç¨‹åº¦ã€‚

ä»¥ä¸‹ä¸ºå®Œæ•´çš„æ—¶åºå›¾ä¸æœåŠ¡è°ƒç”¨é“¾è·¯å›¾ï¼ˆMermaidï¼‰ã€‚

## æ—¶åºå›¾ï¼ˆIM å…¥ç«™å¤„ç†ï¼‰

**ä¸­æ–‡å¤‡æ³¨**
- å…¥å£ï¼šå¤–éƒ¨ IM æ¶ˆæ¯é€šè¿‡ `/api/v1/im/incoming-message` å…¥ç«™ã€‚
- æ ¸å¿ƒç¼–æ’ï¼š`ImController` è°ƒç”¨ `ConversationTaskCoordinator` å®Œæˆä¼šè¯åˆ›å»º/å¤ç”¨ã€éœ€æ±‚è¯†åˆ«ã€ä»»åŠ¡åˆ›å»ºä¸å›å¤å»ºè®®ç”Ÿæˆã€‚
- æ•°æ®è½åº“ï¼šå¯¹è¯ä¸æ¶ˆæ¯è½åœ¨ `conversations/messages`ï¼Œäº‹ä»¶æº¯æºå†™å…¥ `domain_events`ï¼ŒåŒæ—¶å†™å…¥ `outbox_events` ä¿éšœæœ€ç»ˆä¸€è‡´æ€§ã€‚
- AI è”åŠ¨ï¼šæƒ…ç»ªåˆ†æåœ¨ Coordinator å†…éƒ¨ï¼ˆç”Ÿæˆå›å¤ï¼‰ä¸ Controller ç»„è£…å“åº”å„æ‰§è¡Œä¸€æ¬¡ã€‚
- ç»“æœè¿”å›ï¼šåŒ…å«æƒ…ç»ªã€éœ€æ±‚ã€çŸ¥è¯†æ¨èã€å·¥å•å…³è”ä¸å›å¤å»ºè®®ã€‚
- AgentScope è°ƒç”¨ï¼šå›å¤å»ºè®®é€šè¿‡ `/api/chat/message` è·å–ï¼ˆAgentScope æœåŠ¡å†…å®Œæˆ Orchestrator/Assistant/Engineer æµè½¬ï¼‰ã€‚

```mermaid
sequenceDiagram
  autonumber
  actor IM as å¤–éƒ¨IM/å®¢æˆ·
  participant API as Fastify API (/api/v1/im/incoming-message)
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant AGS as AgentScope Service (Orchestrator/Assistant/Engineer)
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant EB as EventBus(å†…å­˜)
  participant OB as OutboxEventBus
  participant RDS as RequirementDetectorService
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant LLM as LLMClient/å¤–éƒ¨AI
  participant SKU as SearchKnowledgeUseCase
  participant TKB as TaxKB/æœ¬åœ°KnowledgeRepo

  IM->>API: POST /api/v1/im/incoming-message
  API->>IMC: handleIncomingMessage()

  IMC->>CTC: processCustomerMessage()
  CTC->>AGS: /api/chat/message ç”Ÿæˆå›å¤å»ºè®®
  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: æŸ¥è¯¢ Conversation + Messages
  alt æ— æ´»è·ƒä¼šè¯
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: ä¿å­˜ Conversation + Message
    CR->>DB: å†™å…¥ domain_events
    CR->>OB: å†™å…¥ outbox_events
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else æœ‰æ´»è·ƒä¼šè¯
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: ä¿å­˜ Message
    CR->>DB: å†™å…¥ domain_events
    CR->>OB: å†™å…¥ outbox_events
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt éœ€æ±‚ç½®ä¿¡åº¦ > 0.7
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: ä¿å­˜ Requirement + domain_events
    CRU->>EB: publish(RequirementCreated...)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: ä¿å­˜ Task
    else medium/low
      CTC-->>IMC: recommendedTasks (å¾…äººå·¥ç¡®è®¤)
    end
  end

  CTC->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  CTC->>AIS: generateReply(...) (AgentScope æˆ– LLM/ä¸å¯ç”¨æ—¶æç¤ºå®¢æœä¾§å¤„ç†)

  CTC-->>IMC: ProcessingResult(agentSuggestion)

  IMC->>CR: findById(conversationId)
  CR->>DB: æ‹‰å–æœ€è¿‘æ¶ˆæ¯ç”¨äºæƒ…ç»ªåˆ†æ
  IMC->>AIS: analyzeSentiment(content, last5Messages)
  AIS->>LLM: analyzeSentiment()

  IMC->>SKU: execute(query)
  SKU->>TKB: å…³é”®è¯/è¯­ä¹‰/QAæ£€ç´¢

  IMC->>TR: findByFilters(conversationId)
  TR->>DB: æ‹‰å–å…³è” Task

  IMC-->>API: ç»„è£… response (sentiment/requirements/knowledge/tasks/suggestion)
  API-->>IM: 200 OK + åˆ†æç»“æœ
```

## æœåŠ¡è°ƒç”¨é“¾è·¯å›¾ï¼ˆå«äº‹ä»¶ä¸å¼‚æ­¥é“¾è·¯ï¼‰

**ä¸­æ–‡å¤‡æ³¨**
- å±•ç¤º IM å…¥ç«™åçš„æ ¸å¿ƒæœåŠ¡ç¼–æ’ä¸äº‹ä»¶é“¾è·¯ï¼ˆåŒæ­¥ + å¼‚æ­¥ï¼‰ã€‚
- ä¸»é“¾è·¯ï¼šIM â†’ API â†’ Controller â†’ Coordinator â†’ UseCase â†’ Repository â†’ DBã€‚
- äº‹ä»¶é“¾è·¯ï¼šé¢†åŸŸäº‹ä»¶è¿›å…¥ `domain_events`ï¼ŒåŒæ—¶è¿›å…¥ `outbox_events`ï¼Œç”± `OutboxProcessor` å¼‚æ­¥æŠ•é€’ï¼ˆä»… `config.outbox.enabled` ä¸º true æ—¶ï¼‰ã€‚
- å¼‚æ­¥é“¾è·¯ç”¨äºè§¦å‘è´¨æ£€/å‘Šè­¦ç­‰éé˜»å¡æµç¨‹ï¼›ä¸ä¼šè¯æ˜¯å¦å…³é—­æ— å…³ï¼Œå¯ç”±â€œé—®é¢˜è§£å†³äº‹ä»¶â€é©±åŠ¨ã€‚

```mermaid
graph TD
  IM[External IM Customer] --> API[Fastify API incoming message]
  API --> IMC[ImController]
  IMC --> CTC[ConversationTaskCoordinator]
  CTC --> AGS["AgentScope Service (Orchestrator/Assistant/Engineer)"]

  CTC --> CCU[CreateConversationUseCase]
  CTC --> SMU[SendMessageUseCase]
  CCU --> CR[ConversationRepository]
  SMU --> CR
  CR --> DB[PostgreSQL]
  CR --> DE["domain events"]
  CR --> OB["outbox events"]
  CCU --> EB[EventBus]
  SMU --> EB

  CTC --> RDS[RequirementDetectorService]
  CTC --> CRU[CreateRequirementUseCase]
  CRU --> RR[RequirementRepository]
  RR --> DB
  CRU --> EB
  CTC --> CTU[CreateTaskUseCase]
  CTU --> TR[TaskRepository]
  TR --> DB

  AGS --> AIS[AiService]
  AIS --> LLM["LLMClient External AI"]
  IMC --> AIS

  IMC --> SKU[SearchKnowledgeUseCase]
  SKU --> TKB[TaxKB KnowledgeRepository]

  IMC --> TR

  OP[OutboxProcessor] --> EB
  EB --> PRH[ProblemResolvedHandler]
  PRH --> AGSI["AgentScope Inspect API"]
```

## å…³é”®è”åŠ¨ç‚¹è¯´æ˜ï¼ˆä¸ä»£ç å¯¹åº”ï¼‰

1. **æ¶ˆæ¯å…¥ç«™ä¸å¯¹è¯å¤ç”¨/åˆ›å»º**
   - `ImController.handleIncomingMessage` â†’ `ConversationTaskCoordinator.processCustomerMessage`ã€‚
   - `CreateConversationUseCase` / `SendMessageUseCase` ä¼šè°ƒç”¨ `ConversationRepository.save`ï¼ŒåŒæ­¥å†™å…¥ï¼š
     - `conversations` + `messages`ï¼ˆå¯¹è¯ä¸æ¶ˆæ¯ï¼‰  
     - `domain_events`ï¼ˆäº‹ä»¶æº¯æºï¼‰
     - `outbox_events`ï¼ˆOutbox æœ€ç»ˆä¸€è‡´æ€§ï¼‰

2. **éœ€æ±‚è¯†åˆ«ä¸ä»»åŠ¡è”åŠ¨**
   - `RequirementDetectorService.detect` â†’ `CreateRequirementUseCase.execute` â†’ `RequirementRepository.save`
   - é«˜ä¼˜å…ˆçº§éœ€æ±‚è§¦å‘ `CreateTaskUseCase.execute` â†’ `TaskRepository.save`

3. **AI è”åŠ¨ï¼ˆæƒ…ç»ª + å›å¤å»ºè®®ï¼‰**
   - `ConversationTaskCoordinator.generateAgentReply` å†…éƒ¨è°ƒç”¨ `AiService.analyzeSentiment`ï¼Œå›å¤ç”Ÿæˆé‡‡ç”¨å¤šçº§é™çº§ç­–ç•¥ï¼šAgentScope â†’ LLM â†’ é™çº§æ–‡æ¡ˆã€‚**æ³¨æ„**ï¼šå¤±è´¥æ—¶ä¸º"é™çº§"è€Œé"é‡è¯•"ï¼Œæ— è‡ªåŠ¨é‡è¯•é€»è¾‘ï¼›Workflow æœªæ¥å…¥è¯¥é“¾è·¯ã€‚
   - `ImController` åœ¨è¿”å›å‰å†æ¬¡è°ƒç”¨ `AiService.analyzeSentiment` ç”Ÿæˆå“åº”é‡Œçš„æƒ…ç»ªå­—æ®µã€‚
- **é™çº§æ–‡æ¡ˆ**ï¼š`"å·²æ”¶åˆ°æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚å¦‚éœ€åŠ æ€¥ï¼Œè¯·åœ¨æ¶ˆæ¯ä¸­è¯´æ˜ç´§æ€¥äº‹é¡¹ã€‚"`ï¼ˆé»˜è®¤ç½®ä¿¡åº¦ 0.6ï¼›å¼‚å¸¸å…œåº•æ—¶å¯èƒ½ä¸º 0.4ï¼Œè‡ªåŠ¨è§¦å‘äººå·¥å¤æ ¸ï¼‰

4. **çŸ¥è¯†åº“ä¸ä»»åŠ¡å…³è”**
   - `SearchKnowledgeUseCase` ç»„åˆ TaxKB + æœ¬åœ°çŸ¥è¯†åº“æ£€ç´¢ï¼ˆController ä¾§ç”¨äºæ¨èï¼‰ã€‚
   - Coordinator ç”Ÿæˆå›å¤å»ºè®®æ—¶ä¹Ÿä¼šæŸ¥è¯¢çŸ¥è¯†åº“ï¼ˆç”¨äºå›å¤æ„é€ ï¼‰ã€‚
   - `TaskRepository.findByFilters` å…³è”å½“å‰å¯¹è¯çš„ä»»åŠ¡åˆ—è¡¨ã€‚

5. **äº‹ä»¶ä¸å¼‚æ­¥é“¾è·¯**
   - â€œé—®é¢˜è§£å†³äº‹ä»¶â€ç”± Problem çŠ¶æ€æ›´æ–°è§¦å‘ï¼ˆ`ProblemResolved` é¢†åŸŸäº‹ä»¶ï¼‰ã€‚
   - OutboxProcessor ä»…åœ¨ `config.outbox.enabled` å¼€å¯æ—¶å¯åŠ¨ï¼Œè´Ÿè´£è½®è¯¢å¹¶æŠ•é€’äº‹ä»¶åˆ°å†…å­˜ EventBusã€‚
   - å¤„ç†å™¨é€šè¿‡ `AgentScope /api/agents/inspect` è§¦å‘è´¨æ£€ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰ã€‚

---

## AgentScope æ”¯æŒèƒ½åŠ›è¡¥å……ï¼ˆå…¨é‡æ›´æ–°ï¼ŒåŸºäºç°æœ‰ä»£ç ï¼‰

**âš ï¸ å®ç°çŠ¶æ€è¯´æ˜**
- ä¸‹è¿°èƒ½åŠ›ä»¥"å½“å‰ä»£ç æ˜¯å¦å¯ç”¨/æ˜¯å¦é»˜è®¤å¯ç”¨/æ˜¯å¦ç¼ºå£"ä¸ºåŸºå‡†æ±‡æ€»ï¼Œè¦†ç›– AgentScopeï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰ä¸æœ¬ä»“åº“ MCP æ¥å…¥æƒ…å†µã€‚
- å¯åŠ¨æ–¹å¼ç»Ÿä¸€ä¸º Docker Composeï¼Œé»˜è®¤å¯ç”¨ MCP è‡ªåŠ¨æ³¨å†Œï¼ˆè§ä¸‹æ–¹"é»˜è®¤å¯ç”¨çŠ¶æ€"ï¼‰ã€‚
- **âš ï¸ Workflow æœªæ¥å…¥ä¸»é“¾è·¯**ï¼šWorkflow è§„åˆ’èƒ½åŠ›ä»£ç å®Œæ•´ï¼Œ`workflows/*.yaml` å·²å­˜åœ¨ï¼Œä½†å½“å‰ IM ä¸»é“¾è·¯æœªè°ƒç”¨ Workflowï¼›é…ç½®é»˜è®¤ `false`ï¼ˆDocker Compose ç¤ºä¾‹å¯å¼€å¯ï¼‰ã€‚
- é»˜è®¤é“¾è·¯ï¼š`ConversationTaskCoordinator -> AgentScope(/api/chat/message) -> LLM/é™çº§`ã€‚
- MCP Server åœ¨åç«¯å¯åŠ¨æ—¶é»˜è®¤æ³¨å†Œï¼ˆ`AgentScopeGateway.initialize()`ï¼‰ï¼Œæ— å¼€å…³ï¼›æ˜¯å¦è°ƒç”¨å–å†³äº AgentScope ä¾§ç¼–æ’ã€‚
- **âœ… MCP å·¥å…·å¯ç”¨æ€§å·²è¡¥é½**ï¼šå·²å¢åŠ å·¥å…·è°ƒç”¨æ—¥å¿—ä¸E2Eå†’çƒŸæµ‹è¯•ï¼Œç”¨äºéªŒè¯æ ¸å¿ƒå·¥å…·å¯ç”¨æ€§ä¸ç¨³å®šæ€§ã€‚

**èƒ½åŠ›å¯¹ç…§è¡¨ï¼ˆä¸­æ–‡ï¼‰**

| Agent | å·²å®ç°èƒ½åŠ›ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ | è§„åˆ’èƒ½åŠ›ï¼ˆä»£ç å­˜åœ¨/å¯ç”¨ï¼Œéœ€åœ¨Workflow/Agentä¾§ç¼–æ’å¯ç”¨ï¼‰ |
|---|---|---|
| Orchestrator Agent | è§„åˆ™/å¯å‘å¼è·¯ç”±å†³ç­–ï¼›æ‰§è¡Œæ¨¡å¼é€‰æ‹©ï¼›äººå·¥ä»‹å…¥è§¦å‘ï¼›å¯è°ƒç”¨ MCP å·¥å…·ï¼ˆ`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`ï¼‰ | è§„åˆ’èƒ½åŠ›ä¸»è¦åœ¨ AgentScope ä¾§ï¼ˆå¦‚æ„å›¾/è·¯ç”±/å‡çº§äººå·¥ï¼‰ï¼Œåç«¯ä»…æä¾›å¯è¢«è°ƒç”¨çš„ MCP å·¥å…· |
| AssistantAgent | æƒ…ç»ª/æ„å›¾åˆ†æã€çŸ¥è¯†æ¨èã€å›å¤å»ºè®®ï¼ˆAgentScope ä¾§å®Œæˆï¼›æœ¬ä»“åº“æ¥æ”¶ç»“æœï¼‰ | æ¨ç†å‹èƒ½åŠ›ç”± AgentScope æ¨¡å‹ä¾§å®Œæˆï¼Œä¸å•ç‹¬æš´éœ² MCP å·¥å…· |
| EngineerAgent | çŸ¥è¯†æ£€ç´¢ã€å·¥å•åˆ›å»ºï¼ˆ`searchKnowledge` / `createTask` / `searchTickets` / `getSystemStatus`ï¼‰ | å¤æ‚è¯Šæ–­/æ–¹æ¡ˆç”Ÿæˆç”± AgentScope æ¨¡å‹ä¾§å®Œæˆï¼Œä¸å•ç‹¬æš´éœ² MCP å·¥å…· |
| InspectorAgent | è´¨æ£€è¯„åˆ†ã€æ”¹è¿›å»ºè®®è¾“å‡ºï¼ˆAgentScope ä¾§ç”Ÿæˆï¼‰ï¼Œå¹¶é€šè¿‡ `saveQualityReport` / `createSurvey` è½åº“ | è´¨æ£€æŠ¥å‘Šç”Ÿæˆç”± `inspectConversation` / `generateQualityReport` æ”¯æ’‘ |

**AgentScope MCP å·¥å…·æ¸…å•ï¼ˆæœ¬ä»“åº“æä¾›ç»™ AgentScopeï¼ŒåŸºäºå½“å‰ Agent å®é™…è°ƒç”¨åšäº†ç²¾ç®€ï¼‰**
- Conversationï¼š`getConversationHistory`
- Customerï¼š`getCustomerProfile` / `getCustomerHistory`
- Knowledgeï¼š`searchKnowledge`
- Taskï¼š`createTask` / `searchTickets`
- AIï¼š`analyzeConversation` / `saveQualityReport` / `createSurvey` / `getSystemStatus` / `inspectConversation` / `generateQualityReport`
- MCP æ¥å£ï¼š`/mcp`ï¼ˆtools/list, tools/callï¼‰ï¼Œ`/mcp/tools`ï¼ˆå·¥å…·åˆ—è¡¨ï¼‰
- å·¥å…·å®ç°æ–‡ä»¶ï¼š
  - Conversationï¼š`backend/src/infrastructure/agentscope/tools/ConversationTools.ts`
  - Customerï¼š`backend/src/infrastructure/agentscope/tools/CustomerTools.ts`
  - Knowledgeï¼š`backend/src/infrastructure/agentscope/tools/KnowledgeTools.ts`
  - Requirementï¼š`backend/src/infrastructure/agentscope/tools/RequirementTools.ts`ï¼ˆå½“å‰æœªåœ¨ MCP allowlist ä¸­å¼€æ”¾ï¼‰
  - Taskï¼š`backend/src/infrastructure/agentscope/tools/TaskTools.ts`
  - AIï¼š`backend/src/infrastructure/agentscope/tools/AITools.ts`
- æ³¨å†Œå…¥å£ï¼š`backend/src/infrastructure/agentscope/MCPServer.ts`ã€`backend/src/infrastructure/agentscope/AgentScopeGateway.ts`
- å‚è€ƒï¼šReAct/Workflow å…¥å£ï¼ˆç”¨äºè§„åˆ’èƒ½åŠ›çš„ä»£ç è½ç‚¹ï¼‰
  - AgentScope ReAct Agentsï¼š`agentscope-service/src/agents/assistant_agent.py`ã€`agentscope-service/src/agents/engineer_agent.py`ã€`agentscope-service/src/agents/inspector_agent.py`
  - Orchestrator è·¯ç”±ä¸æ¨¡å¼ï¼š`agentscope-service/src/router/orchestrator_agent.py`
  - Workflow å…¥å£ï¼ˆå¯æ¥å…¥ç‚¹ï¼‰ï¼š`backend/src/application/services/ConversationTaskCoordinator.ts`
  - Workflow æ‰§è¡Œå™¨ï¼ˆä¿ç•™ä½†æœªä½¿ç”¨ï¼‰ï¼š`backend/src/infrastructure/workflow/executors/ActionStepExecutor.ts`
- Workflow å®šä¹‰ï¼š`workflows/*.yaml` å·²å­˜åœ¨ï¼›æ˜¯å¦å¯ç”¨ç”± `WORKFLOW_ENGINE_ENABLED` æ§åˆ¶ï¼ˆä¸»é“¾è·¯æœªè°ƒç”¨ï¼Œå¯ç”¨ä¹Ÿä¸å½±å“ IM ä¸»æµç¨‹ï¼‰

**é»˜è®¤å¯ç”¨çŠ¶æ€ï¼ˆå…³é”®é…ç½®ä¸å½±å“ï¼‰**
- Workflow è§„åˆ’èƒ½åŠ›é»˜è®¤å…³é—­ï¼ˆé…ç½®é»˜è®¤ `false`ï¼›Docker Compose ç¤ºä¾‹ä¸­å¯å¼€å¯ï¼‰ï¼šWorkflow ä»…ä¿ç•™ä¸ºå¯é€‰èƒ½åŠ›ï¼Œé¿å…å½±å“ä¸»é“¾è·¯ç¨³å®šæ€§ã€‚å¦‚éœ€å¯ç”¨ï¼Œéœ€æ˜¾å¼æ‰“å¼€é…ç½®å¹¶æ¥é€šä¸»é“¾è·¯ã€‚
- Workflow åŠ¨ä½œèƒ½åŠ›ï¼ˆä¿ç•™ä½†æœªä½¿ç”¨ï¼‰ï¼šå†…ç½®åŠ¨ä½œå·²è¦†ç›–æ„å›¾è¯†åˆ«ã€ä¸Šä¸‹æ–‡è·å–ã€å‡çº§äººå·¥ã€æ•…éšœè¯Šæ–­ã€è´¨æ£€ç­‰ï¼ˆè¯¦è§ `ActionStepExecutor`ï¼‰ï¼Œå¯æŒ‰éœ€æ‰©å±•è‡ªå®šä¹‰åŠ¨ä½œã€‚
- MCP Server åœ¨åç«¯å¯åŠ¨æ—¶é»˜è®¤æ³¨å†Œï¼ˆæ— æ˜¾å¼å¼€å…³ï¼‰ï¼›æ˜¯å¦è¢« AgentScope è°ƒç”¨å–å†³äº AgentScope ä¾§ç¼–æ’ä¸æç¤ºè¯/ç­–ç•¥ã€‚

**æ¨¡å‹/LLM ç»Ÿä¸€é…ç½®ï¼ˆDeepSeekï¼‰**
- æ‰€æœ‰ä¾èµ–å¤§æ¨¡å‹çš„è°ƒç”¨ç»Ÿä¸€ä½¿ç”¨ DeepSeekï¼Œé…ç½®ç”±ç¯å¢ƒå˜é‡æ³¨å…¥ï¼š
  - åç«¯ï¼š`AI_SERVICE_PROVIDER=deepseek`ã€`AI_SERVICE_URL`ã€`AI_SERVICE_API_KEY`ã€`AI_MODEL=deepseek-v3.1`
  - AgentScopeï¼šè¯»å– `AI_SERVICE_URL` / `AI_SERVICE_API_KEY`ï¼Œå¹¶ä½¿ç”¨ `deepseek-v3.1`
- Docker Compose å·²ä¸ºåç«¯ä¸ AgentScope æ³¨å…¥ä¸Šè¿°å˜é‡ï¼Œé»˜è®¤å³èµ° DeepSeekã€‚

**MCP å·¥å…·è¯´æ˜ï¼ˆå®šä¹‰ä¸è°ƒç”¨åœºæ™¯ï¼‰**

| å·¥å…· | å®šä¹‰ | è°ƒç”¨åœºæ™¯ |
|---|---|---|
| getConversationHistory | è·å–å¯¹è¯å†å²æ¶ˆæ¯ | è´¨æ£€/Agent éœ€è¦å®Œæ•´å¯¹è¯ä¸Šä¸‹æ–‡ |
| getCustomerProfile | è·å–å®¢æˆ·ç”»åƒ | è·¯ç”±/é£é™©è¯„ä¼°/ä¸ªæ€§åŒ–å›å¤ |
| getCustomerHistory | è·å–å®¢æˆ·å†å²å¯¹è¯åˆ—è¡¨ | é£é™©è¯„ä¼°/èƒŒæ™¯è¡¥å…¨ |
| searchKnowledge | çŸ¥è¯†åº“æ£€ç´¢ | å›å¤å»ºè®®/æ•…éšœæ’æŸ¥ |
| createTask | åˆ›å»ºä»»åŠ¡/å·¥å• | é«˜ä¼˜å…ˆçº§éœ€æ±‚æˆ–æ•…éšœéœ€å»ºå• |
| searchTickets | æ£€ç´¢å†å²å·¥å• | EngineerAgent æ•…éšœè¯Šæ–­å‚è€ƒ |
| analyzeConversation | æƒ…ç»ª/è´¨é‡åˆ†æ | æƒ…ç»ªã€è´¨æ£€æˆ–é£é™©è¯„ä¼° |
| inspectConversation | ä¼šè¯è´¨æ£€ | InspectorAgent è´¨æ£€è¯„ä¼° |
| generateQualityReport | ç”Ÿæˆè´¨æ£€æŠ¥å‘Š | è´¨æ£€æŠ¥å‘Šç”Ÿæˆï¼ˆä¸è½åº“ï¼‰ |
| saveQualityReport | ä¿å­˜è´¨æ£€æŠ¥å‘Š | InspectorAgent è´¨æ£€è¾“å‡ºè½åº“ |
| createSurvey | åˆ›å»ºå›è®¿é—®å· | è´¨æ£€å»ºè®®å›è®¿æ—¶è§¦å‘ |
| getSystemStatus | è·å–ç³»ç»ŸçŠ¶æ€ä¸æœåŠ¡å¯ç”¨æ€§ | è¯Šæ–­/è‡ªæ£€/å‘Šè­¦ |

**MCP è°ƒç”¨ç¤ºä¾‹ï¼ˆtools/list / tools/callï¼‰**

```json
POST /mcp
{
  "method": "tools/list"
}
```

```json
POST /mcp
{
  "method": "tools/call",
  "params": {
    "name": "searchKnowledge",
    "arguments": {
      "query": "é€€æ¬¾å¤šä¹…åˆ°è´¦",
      "mode": "semantic"
    }
  }
}
```

**å…³é”®å·¥å…·å‚æ•°æ‘˜è¦ï¼ˆä»…åˆ—å¿…å¡«/å…³é”®é¡¹ï¼‰**

| å·¥å…· | å¿…å¡«å‚æ•° | å…³é”®è¯´æ˜ |
|---|---|---|
| getConversationHistory | conversationId | includeMetadata/limit å¯é€‰ |
| getCustomerProfile | customerId | è¯»å–ç”»åƒ |
| getCustomerHistory | customerId | limit/page å¯é€‰ |
| searchKnowledge | query | mode/filters å¯é€‰ |
| createTask | title | conversationId/requirementId å¯é€‰ |
| searchTickets | query | limit/offset å¯é€‰ |
| analyzeConversation | conversationId | includeHistory å¯é€‰ |
| inspectConversation | conversationId | è´¨æ£€åˆ†æï¼ˆå«å†å²ï¼‰ |
| generateQualityReport | conversationId | ä¸è½åº“ |
| saveQualityReport | conversationId, report | qualityScore/problemId å¯é€‰ |
| createSurvey | customerId, questions | conversationId/metadata å¯é€‰ |
| getSystemStatus |  | includeStats å¯é€‰ |

---

**MCP å¯ç”¨æ€§æ£€æŸ¥æ¸…å•ï¼ˆå»ºè®®å†’çƒŸé¡¹ï¼‰**
- `GET /mcp/tools` è¿”å›å·¥å…·åˆ—è¡¨
- `tools/call: getSystemStatus` è¿”å› status ä¸ components
- `tools/call: searchKnowledge` è¿”å›æ•°ç»„
- `tools/call: getConversationHistory` è¿”å›å†å²æ¶ˆæ¯åˆ—è¡¨

---

**MCP é”™è¯¯ä¸å¼‚å¸¸ï¼ˆæ¥å£çº§ï¼‰**

| åœºæ™¯ | HTTP | è¯´æ˜ |
|---|---|---|
| ç¼ºå°‘ method | 200 | è¿”å›å·¥å…·åˆ—è¡¨ï¼ˆå…¼å®¹æ¢æµ‹è¯·æ±‚ï¼‰ |
| method éæ³• | 400 | `unsupported method` |
| tools/call ç¼ºå°‘ name | 400 | `tool name is required` |
| å·¥å…·ä¸å­˜åœ¨ | 404 | `tool {name} not found` |
| å·¥å…·æ‰§è¡Œå¼‚å¸¸ | 500 | `tool execution failed` æˆ–é”™è¯¯æ¶ˆæ¯ |

---

**AgentScope ç½‘å…³è‡ªæ£€æ¥å£**

- `GET /agentscope/status`ï¼šè¿”å›æœåŠ¡çŠ¶æ€ä¸å½“å‰ `serviceUrl`
- `GET /agentscope/config`ï¼šè¿”å›å½“å‰ AgentScope é…ç½®
- `GET /agentscope/health`ï¼šè¿”å›å¥åº·çŠ¶æ€ä¸ç†”æ–­å™¨ç»Ÿè®¡

**å·¥å…·ç¼ºå£æ¸…å•**
- MCP å·¥å…·æ¸…å•ä»¥æœ¬æ–‡ä»¶ä¸ºå‡†ï¼›æ˜¯å¦å®é™…è¢«è°ƒç”¨å–å†³äº AgentScope ä¾§ç¼–æ’ä¸è¿è¡Œç­–ç•¥

**å·¥å…·è½åœ°ä½ç½®ï¼ˆå·²å®ç°ï¼‰**
- Conversation å†å²ï¼š`backend/src/infrastructure/agentscope/tools/ConversationTools.ts`
- Customer å†å²ï¼š`backend/src/infrastructure/agentscope/tools/CustomerTools.ts`
- è´¨æ£€æŠ¥å‘Š/å›è®¿ï¼š`backend/src/infrastructure/agentscope/tools/AITools.ts`
- å·¥å•æ£€ç´¢/ç³»ç»ŸçŠ¶æ€ï¼š`backend/src/infrastructure/agentscope/tools/TaskTools.ts`ã€`backend/src/infrastructure/agentscope/tools/AITools.ts`
- æ³¨å†Œå…¥å£ï¼š`backend/src/infrastructure/agentscope/MCPServer.ts`

1. **Orchestrator Agentï¼ˆè·¯ç”±ç¼–æ’ï¼‰**
   - å½“å‰å®ç°ä½ç½®ï¼š`agentscope-service/src/router/orchestrator_agent.py`
   - ä½œç”¨ï¼šåŸºäºè§„åˆ™/å¯å‘å¼è¿›è¡Œæ‰§è¡Œæ¨¡å¼ä¸è·¯ç”±å†³ç­–ï¼ˆ`simple/parallel/agent_supervised/human_first`ï¼‰ã€‚
   - å·²æ¥å…¥å·¥å…·ï¼š`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`ï¼ˆAgent å†…æ‰‹å·¥è°ƒç”¨ MCPï¼‰ã€‚
   - ä¸æœ¬é“¾è·¯å…³ç³»ï¼šä½äº AgentScope å¤–éƒ¨æœåŠ¡ä¸­ï¼Œæœ¬ä»“åº“é€šè¿‡ `/api/chat/message` è°ƒç”¨è§¦å‘ã€‚
   - è§„åˆ’èƒ½åŠ›å¤‡æ³¨ï¼ˆä¸­æ–‡è¯´æ˜ï¼‰ï¼š`classifyIntent/getConversationContext/escalateToHuman` åœ¨ Workflow æ‰§è¡Œå™¨ä¸­æœ‰åŠ¨ä½œå®šä¹‰ï¼Œä½† Workflow æœªæ¥å…¥ä¸»é“¾è·¯ï¼Œä¸”ç›¸å…³ MCP å·¥å…·æœªæ³¨å†Œã€‚

2. **AssistantAgentï¼ˆå¯¹è¯è¾…åŠ©ï¼‰**
   - å½“å‰å®ç°ä½ç½®ï¼š`agentscope-service/src/agents/assistant_agent.py`
   - å·²æ¥å…¥å·¥å…·ï¼š`analyzeConversation` / `getCustomerProfile` / `searchKnowledge`ï¼ˆæ‰‹å·¥è°ƒç”¨ MCPï¼‰ã€‚
   - ä¸æœ¬é“¾è·¯å…³ç³»ï¼šä½äº AgentScope å¤–éƒ¨æœåŠ¡ä¸­ï¼Œæœ¬ä»“åº“ä»…æ¥æ”¶å›å¤å»ºè®®ç»“æœã€‚
   - è§„åˆ’èƒ½åŠ›å¤‡æ³¨ï¼ˆä¸­æ–‡è¯´æ˜ï¼‰ï¼š`extractRequirement/assessRisk/recommendNextAction` ä¸å†æ³¨å†Œä¸º MCP å·¥å…·ï¼Œç”± AgentScope æ¨¡å‹ä¾§æ¨ç†å®Œæˆã€‚

3. **EngineerAgentï¼ˆæ•…éšœè¯Šæ–­ï¼‰**
   - å½“å‰å®ç°ä½ç½®ï¼š`agentscope-service/src/agents/engineer_agent.py`
   - å·²æ¥å…¥å·¥å…·ï¼š`searchKnowledge` / `createTask` / `searchTickets`ï¼ˆæ‰‹å·¥è°ƒç”¨ MCPï¼‰ã€‚
   - ä¸æœ¬é“¾è·¯å…³ç³»ï¼šä½äº AgentScope å¤–éƒ¨æœåŠ¡ä¸­ï¼Œæœ¬ä»“åº“æœªç›´æ¥å®ç°è¯Šæ–­æµç¨‹ã€‚
   - è§„åˆ’èƒ½åŠ›å¤‡æ³¨ï¼ˆä¸­æ–‡è¯´æ˜ï¼‰ï¼š`classifyIssue/analyzeLogs/recommendSolution/estimateResolutionTime/createTechnicalTicket` ä¸å†æ³¨å†Œä¸º MCP å·¥å…·ï¼Œç”± AgentScope æ¨¡å‹ä¾§æ¨ç†å®Œæˆï¼›`getSystemStatus` ä¿ç•™ä¾›å¥åº·é¢„æ£€ä½¿ç”¨ã€‚

4. **InspectorAgentï¼ˆè´¨æ£€è¯„åˆ†ï¼‰**
   - å½“å‰å®ç°ä½ç½®ï¼š`agentscope-service/src/agents/inspector_agent.py`
   - å·²å®ç°èƒ½åŠ›ï¼šåŸºäºå¯¹è¯æ–‡æœ¬è¾“å‡ºè´¨æ£€è¯„åˆ†ä¸æ”¹è¿›å»ºè®®ï¼ˆæ”¯æŒ `saveQualityReport` / `createSurvey`ï¼‰ã€‚
   - ä¸æœ¬é“¾è·¯å…³ç³»ï¼šç”±â€œé—®é¢˜è§£å†³äº‹ä»¶â€å¼‚æ­¥è§¦å‘è´¨æ£€ï¼Œä¸ä¾èµ–ä¼šè¯å…³é—­ã€‚
   - è§„åˆ’èƒ½åŠ›å¤‡æ³¨ï¼ˆä¸­æ–‡è¯´æ˜ï¼‰ï¼š`checkCompliance/detectViolations/compareTeamPerformance` ä¸å†æ³¨å†Œä¸º MCP å·¥å…·ï¼Œç”± AgentScope æ¨¡å‹ä¾§æ¨ç†å®Œæˆã€‚

**å®Œå¤‡æ€§æ£€æŸ¥**
- MCP å·¥å…·å·²æ³¨å†Œï¼›æ˜¯å¦ç”Ÿæ•ˆå–å†³äº AgentScope ä¾§ç¼–æ’è°ƒç”¨ã€‚Workflow æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

---

## Agent äº¤äº’é“¾è·¯ï¼ˆç³»ç»Ÿè§†è§’ï¼‰

**äº¤äº’é“¾è·¯æ¦‚è¦**
- IM å…¥ç«™ â†’ `ImController` â†’ `ConversationTaskCoordinator`
- Coordinator è°ƒç”¨ AgentScope `/api/chat/message` è·å–å›å¤å»ºè®®ï¼ˆä¼˜å…ˆï¼‰
- AgentScope å†…éƒ¨ Orchestrator è·¯ç”± â†’ Assistant/Engineer/Inspectorï¼ˆæŒ‰éœ€ï¼‰
- AgentScope é€šè¿‡ MCP è°ƒç”¨æœ¬ä»“åº“ `/mcp` å·¥å…·ï¼ˆçŸ¥è¯†æ£€ç´¢/å·¥å•/å®¢æˆ·ç”»åƒ/é£æ§ç­‰ï¼‰
- æœ¬ä»“åº“è¿”å›å·¥å…·ç»“æœ â†’ AgentScope èšåˆ â†’ Coordinator å½¢æˆ `agentSuggestion`
- éœ€è¦äººå·¥å¤æ ¸ï¼šåˆ›å»º `ReviewRequest` â†’ é¢†åŸŸäº‹ä»¶ `AgentReviewRequested` â†’ Outbox â†’ EventBus â†’ `ReviewRequestStream` â†’ SSE æ¨é€
- è´¨æ£€é“¾è·¯ï¼š`ProblemResolvedEvent` â†’ AgentScope `/api/agents/inspect` â†’ `quality_reports`

**ä¸­æ–‡è¯´æ˜ï¼ˆå¯¹åº”æ—¶åºå›¾ï¼‰**
- å…¥å£ï¼šå®¢æˆ·æ¶ˆæ¯é€šè¿‡ `/api/v1/im/incoming-message` è¿›å…¥ç³»ç»Ÿï¼ŒController äº¤ç»™ Coordinator ç¼–æ’ã€‚
- AgentScope ä¸»é“¾è·¯ï¼šCoordinator è°ƒç”¨ `/api/chat/message`ï¼Œç”± Orchestrator è·¯ç”±åˆ° Assistant/Engineerï¼Œå¿…è¦æ—¶é€šè¿‡ MCP å·¥å…·å–æ•°/å»ºå•ã€‚
- MCP å›å†™ï¼šå·¥å…·è°ƒç”¨è½åœ¨æœ¬ä»“åº“ï¼Œç”±åç«¯è®¿é—® DB/çŸ¥è¯†åº“ç­‰èµ„æºåè¿”å›ç»“æœã€‚
- ç»“æœæ±‡æ€»ï¼šAgentScope äº§å‡ºå›å¤å»ºè®® + ç½®ä¿¡åº¦ï¼ŒCoordinator ç”Ÿæˆ `agentSuggestion`ã€‚
- äººå·¥å¤æ ¸ï¼šå½“éœ€è¦å®¡æ ¸æ—¶åˆ›å»º ReviewRequestï¼Œé€šè¿‡ Outbox/EventBus æ¨é€åˆ° SSEï¼ˆ`/api/v1/im/reviews/stream`ï¼‰ï¼›ä¾èµ– `OutboxProcessor` å¯åŠ¨ã€‚
- è´¨æ£€é“¾è·¯ï¼šé—®é¢˜è§£å†³äº‹ä»¶è§¦å‘ `/api/agents/inspect`ï¼Œç»“æœå†™å…¥ `quality_reports`ï¼Œä¸â€œä¼šè¯å…³é—­â€æ— å…³ã€‚

```mermaid
sequenceDiagram
  autonumber
  actor IM as å¤–éƒ¨IM/å®¢æˆ·
  participant API as Fastify API (/api/v1/im/incoming-message)
  participant CTC as ConversationTaskCoordinator
  participant AGS as AgentScope Service
  participant ORC as OrchestratorAgent
  participant AST as AssistantAgent
  participant ENG as EngineerAgent
  participant MCP as Backend MCP Server (/mcp)
  participant DB as PostgreSQL
  participant RR as ReviewRequest
  participant EB as EventBus
  participant SSE as /api/v1/im/reviews/stream

  IM->>API: POST /api/v1/im/incoming-message
  API->>CTC: processCustomerMessage()
  CTC->>AGS: /api/chat/message
  AGS->>ORC: route & mode select
  ORC->>AST: reply draft
  ORC->>ENG: optional tools
  AST->>MCP: tools/call (searchKnowledge/getCustomerProfile/...)
  ENG->>MCP: tools/call (createTask/searchTickets/...)
  MCP->>DB: query/command
  DB-->>MCP: data
  MCP-->>AGS: tool results
  AGS-->>CTC: suggestion + confidence
  CTC->>RR: create review request (if needed)
  RR-->>EB: AgentReviewRequested
  EB-->>SSE: push review event
```

---

ä»¥ä¸‹ä¸ºâ€œä¸šåŠ¡æ—¶åºå›¾ / æŠ€æœ¯æ—¶åºå›¾â€çš„æ‹†åˆ†ç‰ˆæœ¬ï¼Œå·²æŒ‰å½“å‰å®ç°è¡¥å……å…³é”®æ¥å£ä¸é…ç½®è¯´æ˜ã€‚

---

# ä¸šåŠ¡æ—¶åºå›¾ï¼ˆé¢å‘äº§å“/æµç¨‹ï¼ŒIM æ–¹å¼ï¼‰

**è¯´æ˜**
- ä»¥ IM å¯¹è¯ä¸ºè½½ä½“ï¼Œä¸å­˜åœ¨â€œå…³é—­ä¼šè¯â€çš„ä¸šåŠ¡é€»è¾‘ã€‚
- é‡‡ç”¨äººæœºååŒï¼šAgent è¾…åŠ©å”®åå·¥ç¨‹å¸ˆæœåŠ¡å®¢æˆ·ï¼Œä¸æ¶‰åŠä¼ ç»Ÿåå¸­/è½¬æ¥é€»è¾‘ã€‚
- ä»¥â€œé—®é¢˜å‘ç° â†’ å·¥å•é©±åŠ¨ â†’ å·¥å•ç»“æŸè§†ä¸ºé—®é¢˜è§£å†³â€çš„æ–¹å¼é—­ç¯ã€‚
- ä¸€ä¸ª IM å¯¹è¯å†…å¯å¹¶è¡Œå¤„ç†å¤šä¸ªé—®é¢˜ï¼ˆå¤šä¸ªå·¥å•ï¼‰ï¼Œå¹¶æ”¯æŒå„è‡ªçŠ¶æ€æµè½¬ã€‚

```mermaid
sequenceDiagram
  autonumber
  actor U as å®¢æˆ·
  participant IM as å¤–éƒ¨IMæ¸ é“
  participant API as åç«¯API
  participant AGS as AgentScope Service (Orchestrator/Assistant/Engineer)
  participant KB as çŸ¥è¯†åº“
  participant CS as å”®åå·¥ç¨‹å¸ˆ
  participant TS as å·¥å•ç³»ç»Ÿ

  U->>IM: å‘é€æ¶ˆæ¯(å¯èƒ½åŒ…å«å¤šä¸ªé—®é¢˜)
  IM->>API: IMæ¶ˆæ¯å…¥ç«™
  API->>AGS: è°ƒç”¨å¤–éƒ¨ AgentScope ç”Ÿæˆå»ºè®®
  AGS->>KB: æ£€ç´¢çŸ¥è¯†æ¨è(å¤–éƒ¨æœåŠ¡å†…éƒ¨)
  AGS-->>CS: éœ€è¦äººå·¥å¤æ ¸(å¯é€‰)

  AGS->>TS: åˆ›å»ºå·¥å•(å¿…è¦æ—¶/å¹¶è¡Œ)

  CS-->>IM: å”®åç­”å¤(åŸºäºå»ºè®®/çŸ¥è¯†)
  IM-->>U: å®¢æˆ·æ”¶åˆ°å›å¤

  loop å·¥å•é©±åŠ¨å¤„ç†
    CS->>TS: æ›´æ–°å·¥å•çŠ¶æ€(å¤„ç†ä¸­/å¾…å®¢æˆ·/å·²è§£å†³)
    TS-->>CS: çŠ¶æ€å˜æ›´å›æ‰§
  end

  Note over TS,IM: å·¥å•ç»“æŸè§†ä¸ºè¯¥é—®é¢˜è§£å†³
  Note over IM,API: åŒä¸€å¯¹è¯ä¸­å¯å¹¶è¡Œå¤„ç†å¤šä¸ªé—®é¢˜\næ¯ä¸ªé—®é¢˜å¯¹åº”ç‹¬ç«‹å·¥å•ä¸çŠ¶æ€æµè½¬
```

# æŠ€æœ¯æ—¶åºå›¾ï¼ˆç³»ç»Ÿå®ç°ç»†èŠ‚ï¼‰

**è¯´æ˜**
- å…³æ³¨çœŸå®ä»£ç è·¯å¾„ï¼šController â†’ Coordinator â†’ UseCase â†’ Repositoryã€‚
- ä½“ç°äº‹ä»¶æº¯æºä¸ Outbox çš„â€œåŒå†™â€æœºåˆ¶ï¼Œä¾¿äºæ’æŸ¥ä¸€è‡´æ€§é—®é¢˜ã€‚
- å±•ç¤º AI/çŸ¥è¯†åº“/ä»»åŠ¡ç­‰å¤–éƒ¨/å†…éƒ¨ä¾èµ–çš„è°ƒç”¨é¡ºåºã€‚

## æŠ€æœ¯æ—¶åºå›¾ Aï¼šæ¶ˆæ¯å…¥ç«™æ ¸å¿ƒé“¾è·¯

**ä¸­æ–‡å¤‡æ³¨**
- è¯¥é“¾è·¯å±•ç¤ºâ€œå…¥ç«™æ¶ˆæ¯ â†’ ä¼šè¯åˆ›å»º/å¤ç”¨ â†’ è°ƒç”¨ AgentScope ç”Ÿæˆå»ºè®® â†’ å“åº”è¿”å›â€ã€‚
- `ConversationRepository.save` åŒæ­¥å†™å…¥ `domain_events` ä¸ `outbox_events`ï¼Œç¡®ä¿äº‹ä»¶å¯è¿½æº¯ä¸æœ€ç»ˆä¸€è‡´æ€§ã€‚
- AI æƒ…ç»ªåˆ†æä¸å›å¤å»ºè®®ç”± Coordinator è§¦å‘ï¼ˆä¼˜å…ˆ AgentScopeï¼Œå¤±è´¥æ—¶æç¤ºå®¢æœä¾§å¤„ç†å¹¶é‡è¯•ï¼‰ï¼ŒController ä¾§è¡¥å……å“åº”å­—æ®µã€‚
- å…³é”®æ¥å£ï¼š`/api/v1/im/incoming-message`ï¼ˆå…¥ç«™ï¼‰ã€`/api/chat/message`ï¼ˆAgentScopeï¼‰ã€`/api/agents/inspect`ï¼ˆè´¨æ£€ï¼‰ã€‚
- å…³é”®é…ç½®ï¼š`config.agentscope.serviceUrl`ã€`config.agentscope.timeout`ã€`config.outbox.enabled`ã€‚
- æºç å…¥å£ï¼ˆæœ¬ä»“åº“ï¼‰ï¼š`backend/src/presentation/http/routes/imRoutes.ts`ã€`backend/src/presentation/http/controllers/ImController.ts`ã€`backend/src/application/services/ConversationTaskCoordinator.ts`ã€`backend/src/application/use-cases/CreateConversationUseCase.ts`ã€`backend/src/application/use-cases/SendMessageUseCase.ts`ã€`backend/src/application/use-cases/requirement/CreateRequirementUseCase.ts`ã€`backend/src/application/use-cases/task/CreateTaskUseCase.ts`ã€`backend/src/application/use-cases/knowledge/SearchKnowledgeUseCase.ts`ã€`backend/src/infrastructure/repositories/ConversationRepository.ts`

```mermaid
sequenceDiagram
  autonumber
  actor IM as å¤–éƒ¨IM/å®¢æˆ·
  participant API as Fastify API
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant CCU as CreateConversationUseCase
  participant SMU as SendMessageUseCase
  participant CR as ConversationRepository
  participant DB as PostgreSQL
  participant DE as domain_events
  participant OB as outbox_events
  participant EB as EventBus(å†…å­˜)
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository
  participant AIS as AiService
  participant AGS as AgentScope /api/chat/message
  participant LLM as LLMClient/å¤–éƒ¨AI
  participant SKU as SearchKnowledgeUseCase
  participant KB as TaxKB/KnowledgeRepository

  IM->>API: POST /api/v1/im/incoming-message
  API->>IMC: handleIncomingMessage()
  IMC->>CTC: processCustomerMessage()

  CTC->>CR: findByFilters(customerId,status=open)
  CR->>DB: æŸ¥æ‰¾ä¼šè¯
  alt æ–°ä¼šè¯
    CTC->>CCU: execute(CreateConversation)
    CCU->>CR: save(conversation)
    CR->>DB: ä¿å­˜ Conversation + Message
    CR->>DE: å†™å…¥äº‹ä»¶æº¯æº
    CR->>OB: å†™å…¥ Outbox
    CCU->>EB: publishAll(ConversationCreated, MessageSent)
  else å¤ç”¨ä¼šè¯
    CTC->>SMU: execute(SendMessage)
    SMU->>CR: findById + save
    CR->>DB: ä¿å­˜ Message
    CR->>DE: å†™å…¥äº‹ä»¶æº¯æº
    CR->>OB: å†™å…¥ Outbox
    SMU->>EB: publish(MessageSent)
  end

  CTC->>RDS: detect(content)
  alt éœ€æ±‚æˆç«‹
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: ä¿å­˜ Requirement + domain_events
    CRU->>EB: publish(RequirementCreated...)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: ä¿å­˜ Task
    end
  end

  CTC->>AIS: analyzeSentiment(userMessage, history)
  AIS->>LLM: analyzeSentiment()
  CTC->>AGS: ç”Ÿæˆå›å¤å»ºè®®
  AGS-->>CTC: å›å¤å»ºè®®/ç½®ä¿¡åº¦

  IMC->>AIS: analyzeSentiment(content, last5Messages)
  IMC->>SKU: execute(query)
  SKU->>KB: æŸ¥è¯¢çŸ¥è¯†åº“
  IMC->>TR: findByFilters(conversationId)
  IMC-->>API: ç»„è£…å“åº”
  API-->>IM: è¿”å›ç»“æœ
```

**è¯´æ˜**
- è¦†ç›–â€œæ¶ˆæ¯å…¥ç«™åˆ°å“åº”â€çš„ä¸»é“¾è·¯ï¼Œé‡ç‚¹åœ¨ï¼šå¯¹è¯åˆ›å»º/å¤ç”¨ã€æ¶ˆæ¯æŒä¹…åŒ–ã€äº‹ä»¶å‘å¸ƒã€AI/çŸ¥è¯†åº“/ä»»åŠ¡è”åŠ¨ã€‚
- é€‚åˆå®šä½ IM å…¥ç«™é—®é¢˜ï¼ˆå¦‚æ¶ˆæ¯æœªè½åº“ã€ä»»åŠ¡æœªåˆ›å»ºã€çŸ¥è¯†æœªæ¨èç­‰ï¼‰ã€‚

## æŠ€æœ¯æ—¶åºå›¾ Bï¼šIM å¯¹è¯å†…"é—®é¢˜ç”Ÿå‘½å‘¨æœŸ + è´¨æ£€"é“¾è·¯ï¼ˆå¼‚æ­¥ï¼‰

**âš ï¸ IMæ¸ é“çš„æœ¬è´¨ç‰¹æ€§**
- **IMå¯¹è¯æ°¸ä¹…å­˜åœ¨**ï¼šä¸æ”¯æŒå…³é—­æ“ä½œï¼Œè¿™æ˜¯IMçš„æœ¬è´¨ç‰¹æ€§ï¼ˆå¦‚å¾®ä¿¡ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ï¼‰
- **è´¨æ£€è§¦å‘æœºåˆ¶**ï¼šè´¨æ£€ç”± `ProblemResolvedEvent`ï¼ˆé—®é¢˜è§£å†³ï¼‰è§¦å‘ï¼Œè€Œé `ConversationClosedEvent`ï¼ˆä¼šè¯å…³é—­ï¼‰
- **ä»£ç ä½ç½®**ï¼š`ProblemResolvedEventHandler.handle()` (backend/src/application/event-handlers/ProblemResolvedEventHandler.ts:8)
- **å¤šé—®é¢˜å¹¶è¡Œ**ï¼šä¸€ä¸ªIMå¯¹è¯å¯èƒ½æœ‰å¤šä¸ªé—®é¢˜ï¼Œæ¯ä¸ªé—®é¢˜è§£å†³æ—¶éƒ½ä¼šè§¦å‘ä¸€æ¬¡è´¨æ£€

**ä¸­æ–‡å¤‡æ³¨**
- IMå¯¹è¯æ°¸ä¹…å­˜åœ¨ï¼Œæ‰€æœ‰é—®é¢˜åœ¨åŒä¸€å¯¹è¯å†…æµè½¬
- å¤§æ¨¡å‹åˆ¤æ–­"é—®é¢˜æå‡º/å·²è§£å†³"ï¼Œé©±åŠ¨é—®é¢˜çŠ¶æ€ç®¡ç†ä¸è´¨æ£€è§¦å‘
- è´¨æ£€ä¸ºå¼‚æ­¥ï¼Œä¸é˜»å¡é—®é¢˜å¤„ç†æˆ–å·¥å•æµè½¬
- è´¨æ£€å…¥å£ï¼š`/api/agents/inspect`ï¼Œç”± `ProblemResolved` äº‹ä»¶è§¦å‘
- æºç å…¥å£ï¼ˆæœ¬ä»“åº“ï¼‰ï¼š`backend/src/application/services/ConversationTaskCoordinator.ts`ã€`backend/src/application/use-cases/problem/CreateProblemUseCase.ts`ã€`backend/src/application/use-cases/problem/UpdateProblemStatusUseCase.ts`ã€`backend/src/infrastructure/repositories/ProblemRepository.ts`ã€`backend/src/infrastructure/events/OutboxProcessor.ts`ã€`backend/src/application/event-handlers/ProblemResolvedEventHandler.ts`

```mermaid
sequenceDiagram
  autonumber
  participant IMC as ImController
  participant CTC as ConversationTaskCoordinator
  participant AIS as AiService/LLMClient
  participant CPU as CreateProblemUseCase
  participant UPS as UpdateProblemStatusUseCase
  participant PR as ProblemRepository
  participant DE as domain_events
  participant OB as outbox_events
  participant OP as OutboxProcessor
  participant EB as EventBus(å†…å­˜)
  participant PRH as ProblemResolvedEventHandler
  participant AGS as AgentScope /api/agents/inspect

  IMC->>CTC: processCustomerMessage()
  CTC->>AIS: LLM åˆ¤æ–­â€œæ˜¯å¦æå‡ºé—®é¢˜â€
  alt åˆ¤æ–­ä¸ºæ–°é—®é¢˜
    CTC->>CPU: execute(CreateProblem)
    CPU->>PR: save(problem)
    PR->>DE: å†™å…¥ Problem äº‹ä»¶
    PR->>OB: å†™å…¥ Outbox
  else éé—®é¢˜/é—²èŠ
    CTC-->>IMC: ä¸åˆ›å»ºé—®é¢˜
  end

  CTC->>AIS: LLM åˆ¤æ–­â€œæ˜¯å¦å·²è§£å†³â€
  alt åˆ¤æ–­ä¸ºå·²è§£å†³
    CTC->>UPS: execute(UpdateProblemStatus resolved)
    UPS->>PR: save(problem)
    PR->>DE: å†™å…¥ ProblemResolved
    PR->>OB: å†™å…¥ Outbox
    OP->>OB: è½®è¯¢å¾…æŠ•é€’äº‹ä»¶
    OP->>EB: publish(ProblemResolved)
    EB->>PRH: handle(ProblemResolved)
    PRH->>AGS: è§¦å‘è´¨æ£€ /api/agents/inspect
  else æœªè§£å†³
    CTC-->>IMC: é—®é¢˜çŠ¶æ€ä¿æŒå¤„ç†ä¸­/å¾…å®¢æˆ·
  end
```

**è¯´æ˜**
- IM å¯¹è¯å†…â€œé—®é¢˜çŠ¶æ€â€ä¸â€œå·¥å•çŠ¶æ€â€ä¿æŒä¸€è‡´ï¼Œç”¨äºå¹¶è¡Œé—®é¢˜ç®¡ç†ã€‚
- LLM è´Ÿè´£åˆ¤å®šâ€œæ–°é—®é¢˜/å·²è§£å†³â€ï¼Œå”®åå·¥ç¨‹å¸ˆå¯è¾…åŠ©ç¡®è®¤ä¸ä¿®æ­£ã€‚
- è´¨æ£€åœ¨é—®é¢˜è§£å†³åè§¦å‘ï¼Œé¿å…å½±å“ IM å¯¹è¯çš„å®æ—¶å“åº”ã€‚

---

# é—®é¢˜çŠ¶æ€æœºï¼ˆIM å¯¹è¯å†…ï¼‰

**çŠ¶æ€è¯´æ˜**
- `new`: å¤§æ¨¡å‹è¯†åˆ«åˆ°æ–°é—®é¢˜ï¼Œå¾…ç¡®è®¤/å¾…åˆ›å»ºå·¥å•
- `in_progress`: å·²åˆ›å»ºå·¥å•ï¼Œå¤„ç†ä¸­
- `waiting_customer`: ç­‰å¾…å®¢æˆ·è¡¥å……ä¿¡æ¯
- `resolved`: å¤§æ¨¡å‹åˆ¤å®šå·²è§£å†³ï¼Œå¾…è´¨æ£€
- `reopened`: å®¢æˆ·åé¦ˆæœªè§£å†³æˆ–æ–°é—®é¢˜å¤å¼€

```mermaid
stateDiagram-v2
  [*] --> new: LLMè¯†åˆ«æ–°é—®é¢˜
  new --> in_progress: å”®åå·¥ç¨‹å¸ˆç¡®è®¤/åˆ›å»ºå·¥å•
  in_progress --> waiting_customer: è¯·æ±‚å®¢æˆ·è¡¥å……
  waiting_customer --> in_progress: å®¢æˆ·è¡¥å……åç»§ç»­å¤„ç†
  in_progress --> resolved: LLMåˆ¤å®šå·²è§£å†³/å·¥å•å®Œæˆ
  resolved --> reopened: å®¢æˆ·åé¦ˆæœªè§£å†³
  reopened --> in_progress: é‡æ–°å¤„ç†/è¡¥å……å·¥å•
```

**ä¸­æ–‡å¤‡æ³¨**
- çŠ¶æ€ä¸å·¥å•ä¿æŒä¸€è‡´ï¼Œä¾¿äºåœ¨åŒä¸€ IM å¯¹è¯ä¸­å¹¶è¡Œç®¡ç†å¤šä¸ªé—®é¢˜ã€‚
- â€œå·²è§£å†³â€å¹¶ä¸å…³é—­ä¼šè¯ï¼Œä»…ç”¨äºæ ‡è®°é—®é¢˜ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚

---

# é—®é¢˜å¹¶è¡Œç®¡ç†ç¤ºæ„å›¾ï¼ˆåŒä¸€ IM å¯¹è¯ï¼‰

**è¯´æ˜**
- IMå¯¹è¯æ°¸ä¹…å­˜åœ¨ï¼Œæ‰€æœ‰é—®é¢˜åœ¨åŒä¸€å¯¹è¯å†…æµè½¬
- IMå¯¹è¯æ˜¯"æ‰¿è½½å®¹å™¨"ï¼Œé—®é¢˜ä¸å·¥å•æ˜¯"å¹¶è¡Œå•å…ƒ"
- LLM è´Ÿè´£åˆ¤å®š"æ–°é—®é¢˜/å·²è§£å†³"ï¼Œå”®åå·¥ç¨‹å¸ˆå¯ä¿®æ­£ä¸å¤å¼€

```mermaid
flowchart TD
  IM[IM å¯¹è¯] --> P1[é—®é¢˜ A<br/>çŠ¶æ€: in_progress]
  IM --> P2[é—®é¢˜ B<br/>çŠ¶æ€: waiting_customer]
  IM --> P3[é—®é¢˜ C<br/>çŠ¶æ€: resolved]

  P1 --> T1[å·¥å• A]
  P2 --> T2[å·¥å• B]
  P3 --> T3[å·¥å• C]
```

**ä¸­æ–‡å¤‡æ³¨**
- IMå¯¹è¯æ°¸ä¹…å­˜åœ¨ï¼Œæ¯ä¸ªé—®é¢˜ä¸å·¥å•ä¸€ä¸€å¯¹åº”ï¼ŒçŠ¶æ€åŒæ­¥
- é—®é¢˜è§£å†³ä¸å½±å“å¯¹è¯æŒç»­ï¼ˆå¯¹è¯æ°¸è¿œå­˜åœ¨ï¼‰
- LLM è´Ÿè´£åˆ¤å®š"æ–°é—®é¢˜/å·²è§£å†³"ï¼Œå”®åå·¥ç¨‹å¸ˆå¯ä¿®æ­£ä¸å¤å¼€

# WebSocket è”åŠ¨ï¼ˆæœªæ¥å…¥ï¼‰ä¸ IM å›æ‰§ï¼ˆæœªå®ç°ï¼‰

**âœ… å®ç°çŠ¶æ€**
- **WebSocket æ¨é€ï¼ˆæœªæ¥å…¥ï¼‰**ï¼š`backend/src/infrastructure/websocket/WebSocketService.ts` å­˜åœ¨ï¼Œä½†æœªåœ¨ `app` ä¸­æ³¨å†Œï¼Œå½“å‰ä¸å¯ç”¨ã€‚
- **å½“å‰åŠŸèƒ½**ï¼šäººå·¥å¤æ ¸é€šçŸ¥ä»…é€šè¿‡ SSE è®¢é˜…ï¼ˆ`/api/v1/im/reviews/stream`ï¼‰æ¨é€ï¼Œæœªæ¥å…¥ WebSocketã€‚
- **IM å›æ‰§æ¥å£ï¼ˆæœªå®ç°ï¼‰**ï¼šå½“å‰ä»£ç æœªæä¾› `/api/v1/im/messages/receipt` è·¯ç”±ï¼›å¦‚éœ€é€è¾¾/å·²è¯»/è¶…æ—¶ç­‰èƒ½åŠ›ï¼Œéœ€è¦è¡¥é½æ¥å£ä¸ä¸šåŠ¡é€»è¾‘ã€‚

**è§„åˆ’è¯´æ˜**
- WebSocket æ¨é€æœªæ¥å…¥ï¼Œéœ€å®ç°æœåŠ¡æ³¨å†Œä¸å‰ç«¯è®¢é˜…
- ç›¸å…³é…ç½®ï¼š`config.agentscope.events`ï¼ˆäº‹ä»¶æ¡¥æ¥è·¯å¾„ä¸è¶…æ—¶ï¼‰
- å‘Šè­¦é…ç½®ï¼š`DEAD_LETTER_ALERT_WEBHOOK_URL`ï¼ˆæ­»ä¿¡é˜Ÿåˆ— Webhook å‘Šè­¦ï¼‰
- è´¨æ£€é…ç½®ï¼š`QUALITY_LOW_SCORE_THRESHOLD`ï¼ˆè´¨æ£€ä½åˆ†é˜ˆå€¼ï¼Œé»˜è®¤ 70ï¼‰
- éœ€æ±‚é…ç½®ï¼š`REQUIREMENT_CONFIDENCE_THRESHOLD`ï¼ˆéœ€æ±‚ç½®ä¿¡åº¦é˜ˆå€¼ï¼Œé»˜è®¤ 0.7ï¼‰
- Outbox é…ç½®ï¼š`OUTBOX_PROCESSOR_CONCURRENCY`ï¼ˆé…ç½®é¡¹å­˜åœ¨ï¼Œä½†å½“å‰å¤„ç†å¹¶å‘åœ¨ `OutboxProcessor` å†…ç¡¬ç¼–ç ä¸º 10ï¼Œå°šæœªæ¥å…¥è¯¥é…ç½®ï¼‰

**ä¸­æ–‡å¤‡æ³¨**
- ä¸‹æ–¹æ—¶åºå›¾ä¸º"è§„åˆ’ç¤ºæ„"ï¼Œéå½“å‰å®ç°ã€‚
- å¤æ ¸å®¡æ ¸ç»“æœå›å†™åå¯è§¦å‘å·¥å•åˆ›å»ºä¸çŠ¶æ€åˆ·æ–°ï¼ˆéœ€å¤–éƒ¨æœåŠ¡/å‰ç«¯è”åŠ¨ï¼‰ã€‚

```mermaid
sequenceDiagram
  autonumber
  participant FE as å”®åå·¥ä½œå°
  participant WS as WebSocket/é€šçŸ¥æœåŠ¡
  participant API as Fastify API
  participant CTC as ConversationTaskCoordinator

  Note over CTC,WS: âš ï¸ è¯¥é“¾è·¯ä¸ºè§„åˆ’ç¤ºæ„ï¼Œå½“å‰ä»“åº“æœªå®ç° WebSocket æ¨é€
  Note over CTC,WS: å®é™…ä½¿ç”¨ SSE è®¢é˜…ï¼ˆ/api/v1/im/reviews/streamï¼‰æˆ–å‰ç«¯è½®è¯¢
  CTC-->>WS: emit("agent:review_request", suggestion)
  WS-->>FE: æ¨é€å¤æ ¸ä»»åŠ¡
  FE->>API: äººå·¥å®¡æ ¸/ç¡®è®¤åˆ›å»ºä»»åŠ¡
  API-->>FE: æ›´æ–°ä¼šè¯çŠ¶æ€/ä»»åŠ¡åˆ—è¡¨

  Note over API,FE: å¦‚æ¥å…¥IMå›æ‰§/é€è¾¾çŠ¶æ€
  FE->>API: å›æ‰§çŠ¶æ€æ›´æ–°(é€è¾¾/å·²è¯»)
  API-->>FE: æ›´æ–°æ¶ˆæ¯çŠ¶æ€
```

# å¤–éƒ¨ä¾èµ–ä¸é…ç½®å¼€å…³æ ‡æ³¨

1. **LLM/AI èƒ½åŠ›**
   - å…¥å£ï¼š`AiService` -> `LLMClient`
   - å¼€å…³ï¼š`LLMClient.isEnabled()`ï¼›å¤–éƒ¨ AI æœåŠ¡é€šè¿‡ `config.ai.serviceUrl`ã€‚
   - å½±å“è·¯å¾„ï¼šæƒ…ç»ªåˆ†æã€å›å¤å»ºè®®ç”Ÿæˆã€å¯¹è¯æ€»ç»“ã€‚

2. **çŸ¥è¯†åº“æ£€ç´¢**
   - å…¥å£ï¼š`SearchKnowledgeUseCase`
   - å¼€å…³ï¼š`TaxKBAdapter.isEnabled()`ï¼ˆé»˜è®¤ trueï¼‰
   - å½±å“è·¯å¾„ï¼šIM å…¥ç«™åçš„çŸ¥è¯†æ¨èã€‚

3. **AgentScope è´¨æ£€**
   - å…¥å£ï¼šé—®é¢˜è§£å†³äº‹ä»¶å¤„ç†å™¨ï¼ˆProblemResolvedEventHandlerï¼‰
   - é…ç½®ï¼š`config.agentscope.serviceUrl` + `config.agentscope.timeout`
   - è§¦å‘ï¼šé—®é¢˜åˆ¤å®šå·²è§£å†³åå¼‚æ­¥è°ƒç”¨ `/api/agents/inspect`
   - æŒä¹…åŒ–ï¼šè´¨æ£€ç»“æœå†™å…¥ `quality_reports`ï¼ˆconversationId/problemId/score/reportï¼‰
   - æŸ¥è¯¢ï¼š`GET /api/v1/quality/:conversationId` ä¼˜å…ˆè¯»å– `quality_reports`
   - åˆ—è¡¨ï¼š`GET /api/v1/quality/:conversationId/reports`ï¼ˆä¼šè¯å†…å†å²ï¼‰
   - å…¨é‡ï¼š`GET /api/v1/quality/reports`ï¼ˆæœ€è¿‘è´¨æ£€è®°å½•ï¼‰

4. **Outbox å¼‚æ­¥æŠ•é€’**
   - å…¥å£ï¼š`ConversationRepository.save` -> `OutboxEventBus.publishInTransaction`
   - å¤„ç†å™¨ï¼š`OutboxProcessor`ï¼ˆå®šæ—¶è½®è¯¢ outbox_eventsï¼Œä»… `config.outbox.enabled` ä¸º true æ—¶å¯åŠ¨ï¼‰
   - è§¦å‘é“¾è·¯ï¼šEventBus -> è®¢é˜…è€…ï¼ˆç”¨äºâ€œé—®é¢˜è§£å†³äº‹ä»¶â€è§¦å‘è´¨æ£€ï¼‰

5. **AgentScope MCP å·¥å…·**
   - å…¥å£ï¼š`/mcp`ï¼ˆtools/list, tools/callï¼‰ã€`/mcp/tools`ï¼ˆå·¥å…·åˆ—è¡¨ï¼‰
   - ä¾èµ–ï¼š`AgentScopeGateway` + `MCPServer` æ³¨å†Œå·¥å…·é›†
  - å½±å“è·¯å¾„ï¼šAgentScope è°ƒç”¨æœ¬ä»“åº“çš„ Conversation/Customer/Knowledge/Task/AI å·¥å…·ï¼ˆRequirement å·¥å…·å½“å‰æœªåœ¨ MCP allowlist ä¸­å¼€æ”¾ï¼‰

6. **AgentScope äº‹ä»¶æ¡¥æ¥**
   - å…¥å£ï¼š`EventBridge`ï¼ˆå°†å†…å­˜ EventBus äº‹ä»¶è½¬å‘è‡³ AgentScopeï¼‰
   - é…ç½®ï¼š`config.agentscope.events.nodeToAgentPath`ã€`config.agentscope.events.agentToNodePath`ã€`config.agentscope.events.outboundTimeoutMs`
   - å½±å“è·¯å¾„ï¼šOutbox â†’ EventBus â†’ AgentScopeï¼ˆäº‹ä»¶ä¸ŠæŠ¥/å›æµï¼‰

7. **Workflow/ReAct Loopï¼ˆå¯é€‰èƒ½åŠ›ï¼Œæœªæ¥å…¥ä¸»é“¾è·¯ï¼‰**
   - å…¥å£ï¼š`WorkflowEngine` + `ActionStepExecutor`
   - é…ç½®ï¼š`config.workflow.*`ï¼ˆenabled/mode/workflowsDir/timeout/parallel/loggingï¼‰
   - å½±å“è·¯å¾„ï¼šå½“å‰ IM ä¸»é“¾è·¯æœªè§¦å‘ Workflowï¼›å¦‚éœ€ä½¿ç”¨éœ€æ˜¾å¼æ¥å…¥ `WorkflowEngine.execute(...)`
   - è¯´æ˜ï¼š`workflows/*.yaml` å·²å­˜åœ¨ï¼Œä½†é»˜è®¤ä¸å¼€å¯ï¼›å¦‚å¯ç”¨å¯è¾“å‡ºå¯è§£é‡Šçš„ action/trace ä¿¡æ¯

---

# AgentScope äº‹ä»¶æ¡¥æ¥å­é“¾è·¯ï¼ˆæŠ€æœ¯ç»†åˆ†ï¼‰

**è¯´æ˜**
- å±•ç¤º EventBus äº‹ä»¶å‘ AgentScope ä¸ŠæŠ¥ä¸å›æµçš„æ¡¥æ¥è¿‡ç¨‹ã€‚
- å…¥å£ç”± `EventBridge` æ³¨å†Œï¼Œè·¯å¾„ç”± `config.agentscope.events` æ§åˆ¶ã€‚

```mermaid
sequenceDiagram
  autonumber
  participant EB as EventBus(å†…å­˜)
  participant BR as EventBridge
  participant AGS as AgentScope Service
  participant API as Fastify API (agentscope/events)

  EB->>BR: publish(domainEvent)
  BR->>AGS: POST nodeToAgentPath (event payload)

  AGS-->>API: POST agentToNodePath (event inbound)
  API->>BR: publishInboundEvent()
  BR->>EB: publish(bridge event)
```

# éœ€æ±‚è¯†åˆ«å­é“¾è·¯ï¼ˆæŠ€æœ¯ç»†åˆ†ï¼‰

**è¯´æ˜**
- èšç„¦â€œæ–‡æœ¬ â†’ éœ€æ±‚ â†’ ä»»åŠ¡â€çš„è”åŠ¨ï¼Œé€‚åˆæ’æŸ¥éœ€æ±‚è¯†åˆ«ä¸è‡ªåŠ¨å»ºå•é—®é¢˜ã€‚
- ä½ç½®ä¿¡åº¦æˆ–éç´§æ€¥éœ€æ±‚åªä¼šæ¨èï¼Œä¸ä¼šè‡ªåŠ¨åˆ›å»ºä»»åŠ¡ã€‚

**ä¸­æ–‡å¤‡æ³¨**
- éœ€æ±‚è¯†åˆ«ä¸ºâ€œå¹¶è¡Œé—®é¢˜ç®¡ç†â€çš„å…¥å£ï¼Œå»ºè®®åœ¨æ­¤å¤„æ‰“ç‚¹ç»Ÿè®¡è¯†åˆ«å‡†ç¡®ç‡ä¸è¯¯æŠ¥ç‡ã€‚
- é«˜ä¼˜å…ˆçº§ä»»åŠ¡è‡ªåŠ¨åˆ›å»ºï¼›ä¸­ä½ä¼˜å…ˆçº§å»ºè®®ç”±å”®åå·¥ç¨‹å¸ˆç¡®è®¤ã€‚

```mermaid
sequenceDiagram
  autonumber
  participant CTC as ConversationTaskCoordinator
  participant RDS as RequirementDetectorService
  participant CRU as CreateRequirementUseCase
  participant RR as RequirementRepository
  participant DB as PostgreSQL
  participant EB as EventBus
  participant CTU as CreateTaskUseCase
  participant TR as TaskRepository

  CTC->>RDS: detect(content)
  alt éœ€æ±‚æˆç«‹(ç½®ä¿¡åº¦>0.7)
    CTC->>CRU: execute(CreateRequirement)
    CRU->>RR: save(requirement)
    RR->>DB: ä¿å­˜ Requirement + domain_events
    CRU->>EB: publish(RequirementCreated)
    alt high/urgent
      CTC->>CTU: execute(CreateTask)
      CTU->>TR: save(task)
      TR->>DB: ä¿å­˜ Task
    else medium/low
      CTC-->>CTC: recommendedTasks(äººå·¥ç¡®è®¤)
    end
  else æ— éœ€æ±‚
    CTC-->>CTC: è·³è¿‡å»ºå•
  end
```

# çŸ¥è¯†åº“æ£€ç´¢å­é“¾è·¯ï¼ˆæŠ€æœ¯ç»†åˆ†ï¼‰

**è¯´æ˜**
- èšç„¦â€œå…³é”®è¯/æ„å›¾ â†’ çŸ¥è¯†æ£€ç´¢ â†’ æ¨èåˆ—è¡¨â€ã€‚
- TaxKB å¯å…³é—­ï¼›æœ¬åœ°çŸ¥è¯†åº“ä½œä¸ºå”¯ä¸€æ¥æºï¼Œè‹¥çŸ¥è¯†åº“ä¸å¯ç”¨éœ€æç¤ºå®¢æœä¾§å¤„ç†ã€‚

**ä¸­æ–‡å¤‡æ³¨**
- è‹¥æœªå¯ç”¨ TaxKBï¼Œè¿”å›ç»“æœæ¥è‡ªæœ¬åœ°çŸ¥è¯†åº“ã€‚
- æ¨èåˆ—è¡¨ä¼šåšç›¸å…³æ€§ç­›é€‰ä¸æ’åºï¼Œé¿å…ä½ç›¸å…³å†…å®¹å¹²æ‰°å›å¤ã€‚

```mermaid
sequenceDiagram
  autonumber
  participant IMC as ImController
  participant AIS as AiService/LLMClient
  participant SKU as SearchKnowledgeUseCase
  participant TKB as TaxKB/KnowledgeRepository

  IMC->>AIS: extractIntent(content) (å¯é€‰)
  IMC->>SKU: execute(query)
  SKU->>TKB: keyword/semantic/qa æœç´¢
  TKB-->>SKU: è¿”å›å€™é€‰çŸ¥è¯†
  SKU-->>IMC: åˆå¹¶å»é‡+æ’åº
  IMC-->>IMC: è¿‡æ»¤ä½ç›¸å…³æ€§
```

# äººå·¥å¤æ ¸å­é“¾è·¯ï¼ˆæŠ€æœ¯ç»†åˆ†ï¼Œå¾…æ¥å…¥ï¼‰

**è¯´æ˜**
- å½“å‰ä»“åº“å·²åˆ›å»º ReviewRequestï¼ˆç”± `ConversationTaskCoordinator` è§¦å‘ï¼‰ï¼Œå¹¶å¯é€šè¿‡ `/api/v1/im/reviews/submit` å›å†™ä»¥ç»§ç»­æµç¨‹ã€‚
- æä¾› SSE è®¢é˜…ï¼š`/api/v1/im/reviews/stream`ï¼ˆäº‹ä»¶ç±»å‹ reviewï¼‰ï¼ŒæŸ¥è¯¢æ¥å£ï¼š`/api/v1/im/reviews/pending`ã€‚
- æœªæ¥å…¥ WebSocket æ¨é€ä¸å‰ç«¯é€šçŸ¥ã€‚
- å¤æ ¸æäº¤åè‡ªåŠ¨åˆ›å»ºä»»åŠ¡/å›å†™çŠ¶æ€éœ€ç”±å‰ç«¯æˆ–å¤–éƒ¨æœåŠ¡è”åŠ¨å®Œæˆã€‚

**ä¸­æ–‡å¤‡æ³¨**
- è¯¥é“¾è·¯ä¸ºâ€œäººæœºååŒå…³é”®ç‚¹â€ï¼Œå½“å‰ä»¥ ReviewRequest + äººå·¥å›å†™ä¸ºä¸»ã€‚
- å¤æ ¸åŠ¨ä½œéœ€é…åˆå¤–éƒ¨æœåŠ¡/å‰ç«¯æ‰èƒ½å›å†™ä»»åŠ¡çŠ¶æ€ä¸å»ºè®®å¤„ç†ç»“æœã€‚

```mermaid
sequenceDiagram
  autonumber
  participant CTC as ConversationTaskCoordinator
  participant WS as WebSocket/é€šçŸ¥æœåŠ¡
  participant FE as å”®åå‰ç«¯
  participant API as Fastify API

  Note over CTC,WS: âš ï¸ è¯¥é“¾è·¯ä¸ºè§„åˆ’ç¤ºæ„ï¼Œå½“å‰ä»“åº“æœªå®ç° WebSocket æ¨é€
  Note over CTC,WS: å®é™…ä½¿ç”¨ SSE è®¢é˜…ï¼ˆ/api/v1/im/reviews/streamï¼‰æˆ–å‰ç«¯è½®è¯¢
  CTC-->>WS: emit("agent:review_request", suggestion)
  WS-->>FE: æ¨é€å¤æ ¸ä»»åŠ¡
  FE->>API: ç¡®è®¤/é©³å›å»ºè®®ï¼Œåˆ›å»ºä»»åŠ¡
  API-->>FE: è¿”å›æœ€æ–°ä»»åŠ¡/çŠ¶æ€
```

---

# æŠ•äº§è½åœ°è®¡åˆ’ï¼ˆReAct Loop / Workflow å¯é€‰ï¼‰

**âš ï¸ å½“å‰çŠ¶æ€è¯´æ˜**
- **Workflow æœªæ¥å…¥ä¸»é“¾è·¯**ï¼šWorkflow å¼•æ“ä¸ YAML å·²å­˜åœ¨ï¼Œä½†å½“å‰ IM ä¸»é“¾è·¯æœªè§¦å‘ Workflowã€‚
- **å½“å‰å®ç°è·¯å¾„**ï¼šAgentScope ReActAgent â†’ LLM â†’ é™çº§æ–‡æ¡ˆ
- **ä»¥ä¸‹è®¡åˆ’ä¸ºå¯é€‰æ–¹æ¡ˆ**ï¼šå¦‚æœªæ¥éœ€è¦ç¡®å®šæ€§æµç¨‹æ§åˆ¶ï¼Œå¯å‚è€ƒæ­¤è®¡åˆ’æ¥å…¥ Workflowã€‚

**ç›®æ ‡**
- ä»¥ ReAct Loop å®ç°"å¯è§£é‡Šã€å¯å›æº¯ã€å¯æ§"çš„ Agent è¾…åŠ©èƒ½åŠ›ï¼ŒæœåŠ¡äºäººå·¥å®¢æœåœºæ™¯ã€‚
- ä¿éšœå…¥ç«™é“¾è·¯ç¨³å®šã€å¯è§‚æµ‹ã€å¯å›é€€ï¼Œå¹¶å…·å¤‡ç°åº¦ä¸é™çº§ç­–ç•¥ã€‚

**é˜¶æ®µä¸éªŒæ”¶**
1. **é˜¶æ®µ 0ï¼šæ–‡æ¡£ä¸é“¾è·¯ä¸€è‡´åŒ–**
   - å†…å®¹ï¼šæ ¡å‡†æ–‡æ¡£ä¸å½“å‰å®ç°ï¼Œæ˜ç¡®"å·²å®ç°/å¾…æ¥å…¥"ä¸çœŸå®é“¾è·¯ã€‚
   - éªŒæ”¶ï¼šæ–‡æ¡£ä¸ä»£ç ä¸€è‡´ï¼Œå…³é”®é“¾è·¯éƒ½æœ‰å‡†ç¡®æè¿°ã€‚

2. **é˜¶æ®µ 1ï¼šWorkflowEngine æ¥å…¥ä¸»é“¾è·¯ï¼ˆå¯é€‰ï¼‰**
   - å†…å®¹ï¼šIM å…¥ç«™è§¦å‘ `customer_service_workflow`ï¼›æä¾›è§¦å‘æ•°æ®ï¼ˆmessageã€conversationã€historyã€profileï¼‰ã€‚
   - éªŒæ”¶ï¼š`/api/v1/im/incoming-message` è§¦å‘ workflow ä¸”èƒ½äº§å‡ºç»“æ„åŒ–ç»“æœï¼ˆå»ºè®®/ç½®ä¿¡åº¦/é£é™©/ä¸‹ä¸€æ­¥åŠ¨ä½œï¼‰ã€‚
   - å¤‡æ³¨ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

3. **é˜¶æ®µ 2ï¼šActionStepExecutor å®é™…åŒ–ï¼ˆå¯é€‰ï¼‰**
   - å†…å®¹ï¼š`classify/send_message/create_task/create_requirement/close_conversation` å¯¹æ¥çœŸå® UseCase æˆ–æœåŠ¡ã€‚
   - éªŒæ”¶ï¼šworkflow æ‰§è¡Œå¯è½åº“å¹¶è§¦å‘ EventBus/Outboxï¼›äººå·¥å¤æ ¸å†™å…¥ ReviewRequestã€‚
   - å¤‡æ³¨ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

4. **é˜¶æ®µ 3ï¼šParallelStepExecutor çœŸæ‰§è¡Œï¼ˆå¯é€‰ï¼‰**
   - å†…å®¹ï¼šå¹¶è¡Œå­æ­¥éª¤èµ°çœŸå®æ‰§è¡Œè·¯å¾„ä¸é”™è¯¯ç­–ç•¥ï¼›è¾“å‡ºå¯ç”¨äºå›å¤å»ºè®®ã€‚
   - éªŒæ”¶ï¼šå¹¶è¡Œæ­¥éª¤å¯è¾“å‡ºæœ‰æ•ˆç»“æœï¼Œä¸”å¤±è´¥ä¸é˜»æ–­ä¸»é“¾è·¯ï¼ˆå¯é…ç½®ï¼‰ã€‚
   - å¤‡æ³¨ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

5. **é˜¶æ®µ 4ï¼šReAct Loopï¼ˆè§„åˆ’èƒ½åŠ›è¡¥é½ï¼‰**
   - å†…å®¹ï¼šOrchestrator/Assistant/Engineer ReAct Loopï¼›è¾“å‡º"å»ºè®®/ç½®ä¿¡åº¦/é£é™©/è¡ŒåŠ¨é¡¹"ï¼ˆAgentScope ReActAgent å·²å®ç°ï¼‰ã€‚
   - éªŒæ”¶ï¼šä½ç½®ä¿¡åº¦è§¦å‘äººå·¥å¤æ ¸ï¼›å»ºè®®å¯è§£é‡Šã€å¯å›æº¯ã€‚ä»éœ€è¡¥é½å·¥å…·ä¸é…ç½®ã€‚

6. **é˜¶æ®µ 5ï¼šäººå·¥å¤æ ¸é—­ç¯**
   - å†…å®¹ï¼šReviewRequest â†’ é€šçŸ¥ â†’ å†³ç­–å›å†™ï¼›æ”¯æŒä¿®æ”¹å»ºè®®ä¸åˆ›å»ºä»»åŠ¡ã€‚
   - éªŒæ”¶ï¼šå¤æ ¸å…¨é“¾è·¯å¯è·‘é€šï¼›è¶…æ—¶ç­–ç•¥å¯æ§ï¼ˆauto_approveï¼‰ã€‚

7. **é˜¶æ®µ 6ï¼šè´¨æ£€é—­ç¯**
   - å†…å®¹ï¼šProblemResolved â†’ è´¨æ£€ â†’ è´¨æ£€ç»“æœè½åº“ä¸å¯è§†åŒ–ã€‚
   - éªŒæ”¶ï¼šè´¨æ£€ç»“æœå¯è¿½è¸ªå¹¶å…³è”å¯¹è¯/ä»»åŠ¡ã€‚

**ç°åº¦ä¸é™çº§**
- å½“å‰é™çº§é“¾è·¯ï¼šAgentScope â†’ LLM â†’ é™çº§æ–‡æ¡ˆ
- è‹¥æ¥å…¥ Workflowï¼šå¯åœ¨ Workflow å¤±è´¥æ—¶é™çº§å› Coordinator/AgentScope/LLM
- åˆ†é˜¶æ®µå¯ç”¨ï¼šå…ˆåªè¯»å»ºè®®ï¼Œå†é€æ­¥æ”¾å¼€è‡ªåŠ¨åŠ¨ä½œï¼ˆå»ºå•/å›å¤ï¼‰ã€‚

---

# æµç¨‹é˜¶æ®µä¸æœåŠ¡å¯ç”¨æ€§ç®¡æ§ï¼ˆè½åœ°æ¸…å•ï¼‰

**ç›®æ ‡**
- ç¡®ä¿å„é˜¶æ®µå…³é”®æœåŠ¡â€œå¯ç”¨å³ç”¨ã€ä¸å¯ç”¨å¯é™çº§ã€ç¼ºå£æœ‰è¡¥é½è·¯å¾„â€ã€‚
- å°†â€œé˜¶æ®µ â†’ ä¾èµ–æœåŠ¡ â†’ å¯ç”¨æ€§æ£€æŸ¥ â†’ é™çº§ç­–ç•¥ â†’ è¡¥é½é¡¹â€é—­ç¯åŒ–ã€‚

## é˜¶æ®µæ¸…å•ä¸æœåŠ¡ä¾èµ–

1. **é˜¶æ®µ 0ï¼šæ–‡æ¡£ä¸é“¾è·¯ä¸€è‡´åŒ–**
   - ä¾èµ–æœåŠ¡ï¼šæ— ï¼ˆæ–‡æ¡£ä¸€è‡´æ€§ï¼‰
   - å¯ç”¨æ€§æ£€æŸ¥ï¼šå…³é”®é“¾è·¯æè¿°ä¸çœŸå®å®ç°ä¸€è‡´ï¼›è§„åˆ’èƒ½åŠ›ç°çŠ¶æ ‡æ³¨ä¸ºâ€œå·²æœ‰é›å½¢/é»˜è®¤æœªå¯ç”¨/å·¥å…·ç¼ºå£â€
   - é™çº§ç­–ç•¥ï¼šä¸é€‚ç”¨
   - è¡¥é½é¡¹ï¼šè¡¥é½è§„åˆ’èƒ½åŠ›è½ç‚¹ä¸å·¥å…·ç¼ºå£ï¼ˆæœ¬æ–‡ä»¶å·²è¡¥å……ï¼‰

2. **é˜¶æ®µ 1ï¼šWorkflowEngine æ¥å…¥ä¸»é“¾è·¯ï¼ˆå¯é€‰ï¼‰**
   - ä¾èµ–æœåŠ¡ï¼šWorkflowEngineï¼ˆ`WORKFLOW_ENGINE_ENABLED=true`ï¼‰ã€workflows YAML
   - å¯ç”¨æ€§æ£€æŸ¥ï¼š`customer_service_workflow` èƒ½æ‰§è¡Œå¹¶è¾“å‡º `suggested_reply`
   - é™çº§ç­–ç•¥ï¼šWorkflow å¤±è´¥è‡ªåŠ¨é™çº§åˆ° Coordinator/AgentScope/LLM
   - è¡¥é½é¡¹ï¼šå®Œå–„ workflow æ‰§è¡Œå™¨å¯¹å…³é”® action çš„çœŸå®è½åœ°ï¼ˆé dry-runï¼‰
   - å¤‡æ³¨ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

3. **é˜¶æ®µ 2ï¼šActionStepExecutor å®é™…åŒ–ï¼ˆå¯é€‰ï¼‰**
   - ä¾èµ–æœåŠ¡ï¼šUseCase/Repositoryï¼ˆConversation/Requirement/Task/AIï¼‰
   - å¯ç”¨æ€§æ£€æŸ¥ï¼š`create_requirement`/`send_message` ç­‰åŠ¨ä½œå¯è½åº“ä¸å›å†™
   - é™çº§ç­–ç•¥ï¼šç¼ºä¾èµ–æ—¶è¿”å› dry-run å¹¶è®°å½• trace
   - è¡¥é½é¡¹ï¼šè¡¥é½ MCP å·¥å…·ç¼ºå£ä¸åŠ¨ä½œæ‰§è¡Œè·¯å¾„
   - å¤‡æ³¨ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

4. **é˜¶æ®µ 3ï¼šParallelStepExecutor çœŸæ‰§è¡Œï¼ˆå¯é€‰ï¼‰**
   - ä¾èµ–æœåŠ¡ï¼šå¹¶è¡Œæ­¥éª¤æ‰§è¡Œå™¨ã€è¶…æ—¶/é”™è¯¯ç­–ç•¥
   - å¯ç”¨æ€§æ£€æŸ¥ï¼šå¹¶è¡Œæ­¥éª¤å¯è¿”å›æœ‰æ•ˆç»“æœä¸”å¯è§‚æµ‹
   - é™çº§ç­–ç•¥ï¼šå•æ­¥å¤±è´¥ä¸é˜»æ–­ä¸»é“¾è·¯
   - è¡¥é½é¡¹ï¼šå®Œå–„é”™è¯¯å½’å› ä¸æŒ‡æ ‡åŸ‹ç‚¹
   - å¤‡æ³¨ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ã€‚

5. **é˜¶æ®µ 4ï¼šReAct Loopï¼ˆè§„åˆ’èƒ½åŠ›è¡¥é½ï¼‰**
   - ä¾èµ–æœåŠ¡ï¼šAgentScope ReActAgent + MCP å·¥å…·
   - å¯ç”¨æ€§æ£€æŸ¥ï¼šç»“æ„åŒ–è¾“å‡ºå¯ç”¨ã€ä½ç½®ä¿¡åº¦å¯è§¦å‘äººå·¥å¤æ ¸
   - é™çº§ç­–ç•¥ï¼šAgentScope ä¸å¯ç”¨ â†’ LLM â†’ é™çº§æ–‡æ¡ˆ
   - è¡¥é½é¡¹ï¼šMCP å·¥å…·èƒ½åŠ›å…¨é‡æ¥é€š

6. **é˜¶æ®µ 5ï¼šäººå·¥å¤æ ¸é—­ç¯**
   - ä¾èµ–æœåŠ¡ï¼šReviewRequest/SSE/å›å†™æ¥å£
   - å¯ç”¨æ€§æ£€æŸ¥ï¼šReviewRequest å¯åˆ›å»º/æŸ¥è¯¢/å›å†™
   - é™çº§ç­–ç•¥ï¼šè¶…æ—¶ auto_approve æˆ–äººå·¥ä¼˜å…ˆ
   - è¡¥é½é¡¹ï¼šé€šçŸ¥ä¾§ï¼ˆWebSocket/å‰ç«¯ï¼‰è½åœ°

7. **é˜¶æ®µ 6ï¼šè´¨æ£€é—­ç¯**
   - ä¾èµ–æœåŠ¡ï¼šè´¨æ£€æŠ¥å‘Šå­˜å‚¨ã€è´¨æ£€è§¦å‘å™¨ã€å›è®¿/æ”¹è¿›ä»»åŠ¡
   - å¯ç”¨æ€§æ£€æŸ¥ï¼š`ProblemResolved` å¯è§¦å‘è´¨æ£€å¹¶è½åº“
   - é™çº§ç­–ç•¥ï¼šè´¨æ£€å¤±è´¥ä¸é˜»å¡ä¸»é“¾è·¯
   - è¡¥é½é¡¹ï¼šè´¨æ£€æŠ¥å‘Š/å›è®¿å·¥å…·å®Œå–„ä¸å¯è§†åŒ–

## æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥ï¼ˆå»ºè®®æœ€å°ä¿éšœé¡¹ï¼‰

- **æ ¸å¿ƒ API**ï¼š`/api/v1/im/incoming-message` å…¥ç«™å¯å¤„ç†ï¼›å“åº”åŒ…å«å»ºè®®/æƒ…ç»ª/ä»»åŠ¡ç­‰å­—æ®µ
- **DB ä¸äº‹ä»¶**ï¼š`conversations/messages/domain_events/outbox_events` å¯å†™ï¼›OutboxProcessor å¯è·‘é€š
- **AgentScope**ï¼š`/api/chat/message` å¯è¿”å›å»ºè®®ï¼›ä¸å¯ç”¨æ—¶æç¤ºå®¢æœä¾§å¤„ç†å¹¶è®°å½•å¤±è´¥åŸå› 
- **Workflowï¼ˆå¯é€‰ï¼‰**ï¼šå½“å‰æœªæ¥å…¥ä¸»é“¾è·¯ï¼›å¦‚æ¥å…¥åˆ™éœ€æ£€æŸ¥ `WorkflowEngine.execute(...)` å¯ç”¨æ€§
- **AI æœåŠ¡**ï¼šæƒ…ç»ªåˆ†æä¸å›å¤ç”Ÿæˆå¯ç”¨ï¼›ä¸å¯ç”¨æ—¶æç¤ºå®¢æœä¾§å¤„ç†å¹¶åœ¨å‰ç«¯æ ‡è®°å¼‚å¸¸
- **çŸ¥è¯†åº“**ï¼š`searchKnowledge` å¯è¿”å›ç»“æœï¼›ä¸å¯ç”¨æ—¶æç¤ºå®¢æœä¾§å¤„ç†
- **Review**ï¼šReviewRequest åˆ›å»º/å›å†™å¯ç”¨ï¼›ä¸å¯ç”¨æ—¶èµ° auto_approve
- **è´¨æ£€**ï¼šè´¨é‡æŠ¥å‘Šå¯è½åº“ï¼›ä¸å¯ç”¨æ—¶è®°å½•å¤±è´¥å¹¶é‡è¯•

## ä¸å¯ç”¨æœåŠ¡å®Œå–„ï¼ˆå·²è¡¥é½æ–¹å‘ï¼‰

- MCP å·¥å…·ç¼ºå£å·²è¡¥é½å¹¶æ³¨å†Œåˆ° MCP Serverï¼ˆå¯¹è¯å†å²/å®¢æˆ·å†å²/è´¨æ£€æŠ¥å‘Š/å›è®¿/å·¥å•æ£€ç´¢/ç³»ç»ŸçŠ¶æ€ï¼‰ã€‚
- è´¨æ£€å›è®¿æ”¯æŒå·²è½åœ°åˆ° `surveys` è¡¨ï¼ˆæ–°å¢ SurveyRepository ä¸è¿ç§»ï¼‰ã€‚

---

# å¤±è´¥æç¤ºè§„èŒƒï¼ˆé¢å‘ç”¨æˆ·ä½“æ„Ÿï¼‰

**åŸåˆ™**
- ä¸è¿”å›å…œåº•æ¨¡æ¿ã€ç¤ºæ„æ–‡æœ¬æˆ–è™šå‡æ•°æ®ã€‚
- å¤±è´¥æ—¶ç»™å‡ºæ˜ç¡®ã€ç¤¼è²Œã€å¯æ‰§è¡Œçš„æç¤ºï¼Œå¹¶èµ°äººå·¥/é‡è¯•è·¯å¾„ã€‚

**å»ºè®®æç¤ºæ–‡æ¡ˆï¼ˆç¤ºä¾‹ï¼Œé¢å‘å®¢æœä¾§ï¼‰**
- AI åˆ†æ/å›å¤ä¸å¯ç”¨ï¼š
  "æ™ºèƒ½åˆ†æä¸å¯ç”¨ï¼Œè¯·äººå·¥å¤„ç†å½“å‰ä¼šè¯å¹¶è®°å½•å¼‚å¸¸ã€‚"
- AgentScope æœåŠ¡ä¸å¯ç”¨ï¼š
  "Agent æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·äººå·¥å¤„ç†å¹¶ç¨åé‡è¯•ã€‚"
- çŸ¥è¯†åº“æ£€ç´¢ä¸å¯ç”¨ï¼š
  "çŸ¥è¯†åº“æ£€ç´¢ä¸å¯ç”¨ï¼Œè¯·äººå·¥è¡¥å……ç­”å¤ã€‚"
- Workflow æ‰§è¡Œå¤±è´¥ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚æ¥å…¥ Workflowï¼Œéœ€è¦æä¾›æ¸…æ™°çš„å¤±è´¥æç¤ºä¸é™çº§è·¯å¾„

**ç”¨æˆ·ä¾§æç¤ºåŸåˆ™ï¼ˆå¯¹å¤–è¯æœ¯ï¼‰**
- ç”¨æˆ·ä¾§ä¸æš´éœ²ç³»ç»Ÿ/æ¨¡å‹å¼‚å¸¸ï¼Œä¸å‡ºç°"æ™ºèƒ½/æ¨¡å‹/æœåŠ¡ä¸å¯ç”¨"ç­‰è¡¨è¿°ã€‚
- ç»Ÿä¸€ä½¿ç”¨ä¸šåŠ¡å‹æç¤ºï¼Œä¾‹å¦‚ï¼š
  "å·²æ”¶åˆ°æ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚"
  "é—®é¢˜å·²è®°å½•ï¼Œç¨åç»™æ‚¨åé¦ˆã€‚"

---

# å·²çŸ¥é—®é¢˜ä¸æ”¹è¿›å»ºè®®ï¼ˆ2026-02-02 æ›´æ–°ï¼‰

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜

æš‚æ— ï¼ˆæˆªè‡³ 2026-02-02 å·²è¡¥é½ MCP å·¥å…·å¯ç”¨æ€§éªŒè¯ä¸ AgentScope å¥åº·æ£€æŸ¥/ç†”æ–­ï¼‰

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜

### 1. WebSocket æ¨é€æœªæ¥å…¥
**é—®é¢˜æè¿°**ï¼š`WebSocketService` å­˜åœ¨ï¼Œä½†æœªåœ¨ `app` ä¸­æ³¨å†Œï¼Œå®é™…é“¾è·¯ä¸å¯ç”¨ã€‚
**å½±å“èŒƒå›´**ï¼šäººå·¥å¤æ ¸é€šçŸ¥ä¾èµ– SSE è®¢é˜…æˆ–å‰ç«¯è½®è¯¢ï¼Œå®æ—¶æ€§è¾ƒå·®ã€‚
**æ”¹è¿›å»ºè®®**ï¼š
- æ˜ç¡® WebSocket æ¨é€çš„ä¼˜å…ˆçº§å’Œå®ç°è®¡åˆ’
- å¦‚çŸ­æœŸä¸å®ç°ï¼Œåœ¨æ–‡æ¡£ä¸­æ˜ç¡®æ ‡æ³¨"æœªå®ç°"å¹¶è¯´æ˜æ›¿ä»£æ–¹æ¡ˆï¼ˆSSE è®¢é˜…ï¼‰
- å¦‚éœ€å®ç°ï¼Œè¡¥å…… WebSocket æœåŠ¡å™¨å®ç°å’Œå‰ç«¯é›†æˆæ–¹æ¡ˆ

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜

### 2. æ–‡æ¡£è¿‡åº¦æ‰¿è¯º
**é—®é¢˜æè¿°**ï¼šæ–‡æ¡£æè¿°çš„æ˜¯"ç†æƒ³çŠ¶æ€"è€Œé"å½“å‰å®é™…çŠ¶æ€"ï¼Œå®¹æ˜“è¯¯å¯¼å¼€å‘äººå‘˜ã€‚
**å½±å“èŒƒå›´**ï¼šå¼€å‘äººå‘˜å¯èƒ½åŸºäºæ–‡æ¡£åšå‡ºé”™è¯¯å‡è®¾ï¼Œå¯¼è‡´åŠŸèƒ½å®ç°åå·®ã€‚
**æ”¹è¿›å»ºè®®**ï¼š
- âœ… å·²ä¿®æ­£ï¼šåœ¨æ–‡æ¡£å¼€å¤´æ·»åŠ "å®ç°çŠ¶æ€è¯´æ˜"ç« èŠ‚ï¼Œæ˜ç¡®æ ‡æ³¨å„åŠŸèƒ½çš„å®ç°çŠ¶æ€
- å®šæœŸå®¡è®¡æ–‡æ¡£ä¸ä»£ç çš„ä¸€è‡´æ€§ï¼Œç¡®ä¿æ–‡æ¡£æè¿°çš„æ˜¯"å½“å‰å®é™…çŠ¶æ€"
- å¯¹äºè§„åˆ’ä¸­çš„åŠŸèƒ½ï¼Œæ˜ç¡®æ ‡æ³¨"è§„åˆ’ç¤ºæ„"æˆ–"å¾…å®ç°"

### 3. æµ‹è¯•è¦†ç›–ç‡ä¸è¶³
**é—®é¢˜æè¿°**ï¼šç¼ºå°‘ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹éªŒè¯å…³é”®æµç¨‹ï¼ˆå¦‚ IM å…¥ç«™ â†’ éœ€æ±‚è¯†åˆ« â†’ ä»»åŠ¡åˆ›å»º â†’ è´¨æ£€ï¼‰ã€‚
**å½±å“èŒƒå›´**ï¼šæ— æ³•ä¿è¯å…³é”®æµç¨‹çš„ç¨³å®šæ€§ï¼Œå›å½’æµ‹è¯•æˆæœ¬é«˜ã€‚
**æ”¹è¿›å»ºè®®**ï¼š
- è¡¥å……ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ ¸å¿ƒæµç¨‹ï¼ˆIM å…¥ç«™ã€éœ€æ±‚è¯†åˆ«ã€ä»»åŠ¡åˆ›å»ºã€è´¨æ£€ï¼‰
- è¡¥å……é™çº§è·¯å¾„æµ‹è¯•ç”¨ä¾‹ï¼ˆå¦‚ AgentScope ä¸å¯ç”¨æ—¶çš„é™çº§è¡Œä¸ºï¼‰
- è¡¥å……è¾¹ç•Œæ¡ä»¶æµ‹è¯•ç”¨ä¾‹ï¼ˆå¦‚"ä¸€ä¸ªä¼šè¯å¤šä¸ªé—®é¢˜"ã€"é—®é¢˜è§£å†³åé‡æ–°æ‰“å¼€"ï¼‰

### 4. Outbox å¹¶å‘é…ç½®æœªç”Ÿæ•ˆ
**é—®é¢˜æè¿°**ï¼š`OUTBOX_PROCESSOR_CONCURRENCY` é…ç½®é¡¹å­˜åœ¨ï¼Œä½† `OutboxProcessor` å†…éƒ¨å¹¶å‘ä»ç¡¬ç¼–ç ä¸º 10ã€‚
**å½±å“èŒƒå›´**ï¼šé…ç½®è°ƒæ•´æ— æ³•ç”Ÿæ•ˆï¼Œæ€§èƒ½è°ƒä¼˜ä¾èµ–æ”¹ä»£ç ã€‚
**æ”¹è¿›å»ºè®®**ï¼š
- è¯»å– `config.outbox.concurrency` å¹¶æ›¿æ¢ç¡¬ç¼–ç å€¼
- ä¸ºé«˜å¹¶å‘åœºæ™¯æ·»åŠ è´Ÿè½½æµ‹è¯•ä¸ç›‘æ§æŒ‡æ ‡

### 5. IM å›æ‰§æœªå®ç°
**é—®é¢˜æè¿°**ï¼šæœªæä¾› `/api/v1/im/messages/receipt` è·¯ç”±ä¸ä¸šåŠ¡é€»è¾‘ã€‚
**å½±å“èŒƒå›´**ï¼šæ— æ³•è®°å½•é€è¾¾/å·²è¯»/è¶…æ—¶ç­‰æ¶ˆæ¯çŠ¶æ€ã€‚
**æ”¹è¿›å»ºè®®**ï¼š
- æ˜ç¡®ä¸šåŠ¡åœºæ™¯ä¸éœ€æ±‚ä¼˜å…ˆçº§
- è¡¥é½è·¯ç”±ã€æ•°æ®ç»“æ„ä¸çŠ¶æ€æµè½¬é€»è¾‘

## âœ… å·²ç¡®è®¤å®ç°ï¼ˆéé—®é¢˜ï¼‰

### IM æ¸ é“æœ¬è´¨ç‰¹æ€§å·²æ­£ç¡®å®ç°
**è¯´æ˜**ï¼šIM å¯¹è¯æ°¸ä¹…å­˜åœ¨ï¼Œä¸æ”¯æŒå…³é—­æ“ä½œã€‚è¿™æ˜¯ IM çš„æœ¬è´¨ç‰¹æ€§ï¼Œä»£ç å·²æ­£ç¡®å®ç°ã€‚
**å®ç°ä½ç½®**ï¼š
- `ConversationTaskCoordinator.completeConversation()` ä¸å…³é—­ IM å¯¹è¯
- MCP å·¥å…· `closeConversation` å·²ä» MCP æ³¨å†Œæ¸…å•ç§»é™¤ï¼ˆé¿å…è¯¯ç”¨å…³é—­é€»è¾‘ï¼‰
- Workflow åŠ¨ä½œ `close_conversation` å¯¹ IM æ¸ é“è‡ªåŠ¨è·³è¿‡
**è´¨æ£€è§¦å‘**ï¼šè´¨æ£€ç”± `ProblemResolvedEvent` è§¦å‘ï¼Œè€Œé `ConversationClosedEvent`

### MCP å·¥å…·å¯ç”¨æ€§å·²éªŒè¯
**è¯´æ˜**ï¼šå·²è¡¥é½ MCP å·¥å…·ç«¯åˆ°ç«¯è°ƒç”¨æµ‹è¯•ä¸è°ƒç”¨æ—¥å¿—ï¼›å¯åŠ¨æ—¶ä¼šæç¤ºç¼ºå¤±çš„å…è®¸å·¥å…·ã€‚
**å®ç°ä½ç½®**ï¼š
- `tests/backend/e2e/mcp.e2e.spec.ts` è¦†ç›–å…¨éƒ¨å…è®¸å·¥å…·
- `backend/src/infrastructure/agentscope/MCPServer.ts` è®°å½•è°ƒç”¨æ—¥å¿—å¹¶æ ¡éªŒå…è®¸å·¥å…·æ³¨å†Œæƒ…å†µ

### AgentScope æœåŠ¡å¥åº·æ£€æŸ¥ä¸ç†”æ–­å·²å®ç°
**è¯´æ˜**ï¼šæä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¸ç†”æ–­å™¨ï¼Œé¿å…æœåŠ¡ä¸å¯ç”¨å¯¼è‡´çš„é›ªå´©ã€‚
**å®ç°ä½ç½®**ï¼š
- å¥åº·æ£€æŸ¥ï¼š`/agentscope/health`ï¼ˆ`AgentScopeGateway`ï¼‰
- ç†”æ–­å™¨ï¼š`AgentScopeChatClient`ï¼ˆå¤±è´¥é˜ˆå€¼ä¸æ¢å¤æ—¶é—´ç”±é…ç½®æ§åˆ¶ï¼‰

---

## ğŸ“‹ æ”¹è¿›ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“ | æ”¹è¿›å»ºè®® |
|--------|------|------|----------|
| ğŸŸ¡ ä¸­ | WebSocket æ¨é€æœªæ¥å…¥ | å®æ—¶æ€§è¾ƒå·® | è¡¥å……æœåŠ¡æ³¨å†Œä¸å‰ç«¯è®¢é˜… |
| ğŸŸ¢ ä½ | æ–‡æ¡£è¿‡åº¦æ‰¿è¯º | è¯¯å¯¼å®ç°ä¸æ²Ÿé€š | æŒç»­å®¡è®¡ä¸æ ‡æ³¨è§„åˆ’ |
| ğŸŸ¢ ä½ | æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ | å›å½’æµ‹è¯•æˆæœ¬é«˜ | è¡¥å……ç«¯åˆ°ç«¯æµ‹è¯•ç”¨ä¾‹ |
| ğŸŸ¢ ä½ | Outbox å¹¶å‘é…ç½®æœªç”Ÿæ•ˆ | æ€§èƒ½è°ƒä¼˜å—é™ | è¯»å–é…ç½®å¹¶æ›¿æ¢ç¡¬ç¼–ç  |
| ğŸŸ¢ ä½ | IM å›æ‰§æœªå®ç° | åŠŸèƒ½ç¼ºå£ | å¦‚éœ€æ”¯æŒè¡¥é½è·¯ç”±ä¸ä¸šåŠ¡é€»è¾‘ |
| âœ… å·²å¤„ç† | RequirementRepository äº‹åŠ¡å¤„ç† | æ•°æ®ä¸€è‡´æ€§é£é™© | âœ… å·²ä¿®å¤ï¼šå®Œæ•´çš„äº‹åŠ¡å¤„ç†å’Œäº‹ä»¶æŒä¹…åŒ– |
| âœ… å·²å¤„ç† | TaskRepository äº‹åŠ¡å¤„ç† | æ•°æ®ä¸€è‡´æ€§é£é™© | âœ… å·²ä¿®å¤ï¼šå®Œæ•´çš„äº‹åŠ¡å¤„ç†å’Œäº‹ä»¶æŒä¹…åŒ– |
| âœ… å·²å¤„ç† | é™çº§é€»è¾‘ç¼ºå°‘ç›‘æ§ | æ— æ³•åŠæ—¶å‘ç°æœåŠ¡å¼‚å¸¸ | âœ… å·²æ·»åŠ ï¼šé™çº§è§¦å‘æ—¶è®°å½•è¯¦ç»†æ—¥å¿—å’ŒåŸå›  |
| âœ… å·²å¤„ç† | æ­»ä¿¡é˜Ÿåˆ—å‘Šè­¦ç¼ºå¤± | äº‹ä»¶å¤„ç†å¤±è´¥æ— æ³•åŠæ—¶å‘ç° | âœ… å·²é›†æˆï¼šæ”¯æŒ Webhook å‘Šè­¦ |
| âœ… å·²å¤„ç† | ç¡¬ç¼–ç å‚æ•° | é…ç½®ç®¡ç†ä¸çµæ´» | âœ… å·²é…ç½®åŒ–ï¼šè´¨æ£€é˜ˆå€¼ã€éœ€æ±‚ç½®ä¿¡åº¦ã€å¹¶å‘æ•°ç­‰ |
| âœ… å·²å¤„ç† | Workflow æœªæ¥å…¥ä¸»é“¾è·¯ | æ— å½±å“ï¼ˆé»˜è®¤æœªå¯ç”¨ï¼‰ | âœ… æ–‡æ¡£å·²æ ‡æ³¨ä¸ºå¯é€‰èƒ½åŠ› |
| âœ… å·²å¤„ç† | MCP å·¥å…·å¯ç”¨æ€§æœªéªŒè¯ | AgentScope è§„åˆ’èƒ½åŠ›é£é™© | âœ… å·²è¡¥é½ MCP å·¥å…· E2E + è°ƒç”¨æ—¥å¿— |
| âœ… å·²å¤„ç† | AgentScope å¯ç”¨æ€§é£é™© | æœåŠ¡ä¸å¯ç”¨å½±å“ç¨³å®šæ€§ | âœ… å·²å®ç°å¥åº·æ£€æŸ¥ + ç†”æ–­æœºåˆ¶ |

---

**æ–‡æ¡£ä¿®è®¢è®°å½•**
- 2026-01-26ï¼ˆåˆç‰ˆï¼‰ï¼š
  - æ·»åŠ "IMæ¸ é“çš„æœ¬è´¨ç‰¹æ€§"ç« èŠ‚ï¼Œæ˜ç¡® IM å¯¹è¯æ°¸ä¹…å­˜åœ¨çš„æœ¬è´¨ç‰¹æ€§
  - æ·»åŠ "å®ç°çŠ¶æ€è¯´æ˜"ç« èŠ‚ï¼Œä¿®æ­£è´¨æ£€è§¦å‘æœºåˆ¶æè¿°ï¼ˆç”± ProblemResolvedEvent è§¦å‘ï¼‰
  - è¡¥å……é™çº§é€»è¾‘è¯´æ˜ï¼Œæ ‡æ³¨æœªå®ç°åŠŸèƒ½
  - æ·»åŠ "å·²çŸ¥é—®é¢˜ä¸æ”¹è¿›å»ºè®®"ç« èŠ‚
  - æ ‡æ³¨ Workflow/ReAct Loop ä¸ºå¯é€‰èƒ½åŠ›ï¼ˆå·¥ä½œæµ YAML å·²å­˜åœ¨ï¼Œä½†æœªæ¥å…¥ä¸»é“¾è·¯ï¼‰
  - æ ‡æ³¨ IM å›æ‰§/é€è¾¾çŠ¶æ€æœªå®ç°ï¼ˆç¼ºå°‘è·¯ç”±ä¸ä¸šåŠ¡é€»è¾‘ï¼‰
  - æ›´æ–°é™çº§ç­–ç•¥è¯´æ˜ï¼Œåæ˜ å®é™…æ‰§è¡Œè·¯å¾„ï¼ˆAgentScope â†’ LLM â†’ é™çº§æ–‡æ¡ˆï¼‰
  - æ›´æ–°æ‰€æœ‰æ–‡æ¡£ç« èŠ‚ï¼Œç¡®ä¿ Workflow ä¸ IM å›æ‰§çŠ¶æ€æè¿°å‡†ç¡®
  - ä¿®æ­£"æŠ•äº§è½åœ°è®¡åˆ’"ç« èŠ‚ï¼Œæ ‡æ³¨ Workflow ä¸ºå¯é€‰é˜¶æ®µ
  - æ›´æ–°"æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥"å’Œ"å¤±è´¥æç¤ºè§„èŒƒ"ï¼Œè¡¥å…… Workflow å¯é€‰æ£€æŸ¥é¡¹
- 2026-01-26ï¼ˆä¿®å¤ç‰ˆï¼‰ï¼š
  - âœ… ä¿®å¤ RequirementRepository äº‹åŠ¡å¤„ç†å’Œäº‹ä»¶æŒä¹…åŒ–
  - âœ… ä¿®å¤ TaskRepository äº‹åŠ¡å¤„ç†å’Œäº‹ä»¶æŒä¹…åŒ–
  - âœ… æ·»åŠ é™çº§ç›‘æ§å’Œæ—¥å¿—è®°å½•ï¼ˆAgentScope/LLM é™çº§æ—¶è®°å½•è¯¦ç»†åŸå› ï¼‰
  - âœ… é›†æˆæ­»ä¿¡é˜Ÿåˆ—å‘Šè­¦ç³»ç»Ÿï¼ˆæ”¯æŒ Webhook å‘Šè­¦ï¼Œå¯å¯¹æ¥é’‰é’‰/Slackï¼‰
  - âœ… é…ç½®åŒ–ç¡¬ç¼–ç å‚æ•°ï¼ˆè´¨æ£€é˜ˆå€¼ã€éœ€æ±‚ç½®ä¿¡åº¦ã€å¹¶å‘æ•°ç­‰ï¼‰
  - ä¿®æ­£ WebSocket æ¨é€çŠ¶æ€ä¸º"æœªæ¥å…¥"
  - âœ… æ›´æ–°æ”¹è¿›ä¼˜å…ˆçº§æ€»ç»“ï¼Œæ ‡æ³¨å·²å¤„ç†é—®é¢˜
- 2026-01-30ï¼ˆæ›´æ–°ï¼‰ï¼š
  - âœ… è¡¥é½ MCP å·¥å…· E2E è¦†ç›–ä¸è°ƒç”¨æ—¥å¿—è¯´æ˜
  - âœ… å¢è¡¥ MCP å…è®¸å·¥å…·æ³¨å†Œç¼ºå¤±æç¤º
  - âœ… æ ‡æ³¨ AgentScope å¥åº·æ£€æŸ¥ä¸ç†”æ–­æœºåˆ¶å·²å®ç°
  - æ›´æ–°â€œå·²çŸ¥é—®é¢˜ä¸æ”¹è¿›å»ºè®®â€æ’åºä¸çŠ¶æ€
- 2026-02-02ï¼ˆæ›´æ–°ï¼‰ï¼š
  - æ›´æ–°â€œå·²çŸ¥é—®é¢˜ä¸æ”¹è¿›å»ºè®®â€æ—¥æœŸä¸å†…å®¹
  - æ–°å¢ Outbox å¹¶å‘é…ç½®æœªç”Ÿæ•ˆçš„ä½ä¼˜å…ˆçº§é—®é¢˜
  - å°† IM å›æ‰§æœªå®ç°è°ƒæ•´ä¸ºä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆä¸å†æ ‡ä¸ºå·²å¤„ç†ï¼‰
