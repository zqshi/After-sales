# æ•…éšœå¤„ç†å·¥ä½œæµ
# å®Œæ•´æµç¨‹ï¼šæ•…éšœæŠ¥å‘Š â†’ ä¸¥é‡æ€§è¯„ä¼° â†’ çŸ¥è¯†åº“æœç´¢ â†’ è¯Šæ–­åˆ†æ â†’ åˆ›å»ºå·¥å• â†’ é€šçŸ¥å®¢æˆ·

name: fault_handling_workflow
description: æ•…éšœå¤„ç†å®Œæ•´æµç¨‹ï¼ˆP0-P4åˆ†çº§ï¼‰
version: "1.0"

trigger:
  type: im_message
  channel: feishu

steps:
    # Step 1: æå–æ•…éšœä¿¡æ¯
    - name: extract_fault_info
      agent: fault_agent
      action: classify
      input: $message
      output: fault_info
      timeout: 5000

    # Step 2: æ£€æŸ¥ä¿¡æ¯å®Œæ•´æ€§
    - name: check_completeness
      agent: fault_agent
      action: classify
      input: $fault_info
      output: completeness_check
      timeout: 3000

    # Step 3: å¦‚æœä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯¢é—®è¡¥å……ï¼ˆäººå·¥å¹²é¢„ï¼‰
    - name: request_more_info
      type: human_in_loop
      condition: $completeness_check.is_complete == false
      timeout: 600000  # 10åˆ†é’Ÿ
      fallback: proceed_with_partial
      input:
        missing_fields: $completeness_check.missing_fields
        questions: $completeness_check.questions

    # Step 4: è¯„ä¼°ä¸¥é‡æ€§
    - name: assess_severity
      agent: fault_agent
      action: classify
      input:
        fault_info: $fault_info
        additional_info: $request_more_info.data
      output: severity_assessment
      timeout: 5000

    # Step 5: å¹¶è¡Œæ“ä½œï¼ˆçŸ¥è¯†åº“æœç´¢ + ç›¸ä¼¼æ¡ˆä¾‹æŸ¥æ‰¾ï¼‰
    - name: parallel_search
      type: parallel
      steps:
        # 5.1 çŸ¥è¯†åº“æœç´¢
        - name: knowledge_search
          agent: knowledge_manager
          action: classify
          input:
            query: $fault_info.error_message
            fault_type: $fault_info.fault_type
          output: knowledge_results
          timeout: 5000

        # 5.2 ç›¸ä¼¼æ¡ˆä¾‹æŸ¥æ‰¾
        - name: similar_cases
          agent: knowledge_manager
          action: classify
          input:
            fault_signature: $fault_info.signature
          output: similar_cases
          timeout: 5000

    # Step 6: è¯Šæ–­åˆ†æ
    - name: diagnose
      agent: fault_agent
      action: classify
      input:
        fault_info: $fault_info
        severity: $severity_assessment.severity
        knowledge: $parallel_search.knowledge_search
        similar_cases: $parallel_search.similar_cases
      output: diagnosis
      timeout: 8000

    # Step 7: ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
    - name: generate_solution
      agent: fault_agent
      action: classify
      input:
        diagnosis: $diagnosis
        fault_info: $fault_info
      output: solution
      timeout: 8000

    # Step 8: äººå·¥å®¡æ ¸ï¼ˆP0/P1æ•…éšœå¿…é¡»å®¡æ ¸ï¼‰
    - name: human_review_solution
      type: human_in_loop
      condition: $severity_assessment.severity == 'P0' || $severity_assessment.severity == 'P1'
      timeout: 180000  # 3åˆ†é’Ÿï¼ˆç´§æ€¥ï¼‰
      fallback: auto_approve
      input:
        fault_info: $fault_info
        diagnosis: $diagnosis
        solution: $solution
        severity: $severity_assessment.severity

    # Step 9: åˆ›å»ºTask
    - name: create_task
      action: create_task
      condition: $severity_assessment.should_create_task == true
      input:
        title: "æ•…éšœå¤„ç†: $fault_info.title"
        priority: $severity_assessment.priority
        conversationId: $conversation.id
        description: $diagnosis.summary
      timeout: 3000

    # Step 10: å‘é€å›å¤ç»™å®¢æˆ·
    - name: send_reply
      action: send_message
      channel: $trigger.channel
      content: $solution.customer_reply
      timeout: 3000

    # Step 11: å¦‚æœæ˜¯P0/P1ï¼Œå‘é€å‘Šè­¦é€šçŸ¥
    - name: send_alert
      action: send_message
      channel: internal_alert
      condition: $severity_assessment.severity == 'P0' || $severity_assessment.severity == 'P1'
      content: |
        ğŸš¨ $severity_assessment.severity æ•…éšœå‘Šè­¦

        æ•…éšœæ ‡é¢˜: $fault_info.title
        å½±å“èŒƒå›´: $fault_info.impact_scope
        å®¢æˆ·: $conversation.customerId
        è¯Šæ–­: $diagnosis.summary

        å·²åˆ›å»ºå·¥å•: $create_task.taskId
      timeout: 3000

# é”™è¯¯å¤„ç†
onError:
  - name: error_notification
    action: send_message
    channel: internal_alert
    content: "æ•…éšœå¤„ç†å·¥ä½œæµå¼‚å¸¸: $conversation.id"

# å®Œæˆåæ“ä½œ
onComplete:
  - name: record_metrics
    action: log
    content: |
      Fault handling completed:
      - Severity: $severity_assessment.severity
      - Task created: $create_task.taskId
      - Duration: $workflow.duration ms
