# éœ€æ±‚ç®¡ç†å·¥ä½œæµ
# å®Œæ•´æµç¨‹ï¼šéœ€æ±‚åˆ›å»º â†’ ä¼˜å…ˆçº§è¯„ä¼° â†’ å¯è¡Œæ€§åˆ†æ â†’ ä»»åŠ¡æ‹†åˆ† â†’ åˆ†é…

name: requirement_management_workflow
description: éœ€æ±‚ç®¡ç†å®Œæ•´æµç¨‹
version: "1.0"

trigger:
  type: manual
  event: RequirementCreated

steps:
    # Step 1: è·å–éœ€æ±‚è¯¦æƒ…
    - name: get_requirement
      action: log
      input: $trigger.requirement
      output: requirement
      timeout: 1000

    # Step 2: ä¼˜å…ˆçº§æ™ºèƒ½è¯„ä¼°
    - name: assess_priority
      agent: requirement_agent
      action: classify
      input:
        requirement: $requirement
        customer_profile: $trigger.customer
      output: priority_assessment
      timeout: 5000

    # Step 3: å¯è¡Œæ€§åˆ†æï¼ˆéœ€è¦æŠ€æœ¯è¯„ä¼°æ—¶ï¼‰
    - name: feasibility_analysis
      agent: requirement_agent
      action: classify
      condition: $requirement.category == 'product' || $requirement.category == 'technical'
      input:
        requirement: $requirement
        priority: $priority_assessment
      output: feasibility
      timeout: 8000

    # Step 4: äººå·¥ç¡®è®¤ï¼ˆé«˜ä¼˜å…ˆçº§æˆ–ä¸å¯è¡Œæ—¶ï¼‰
    - name: human_confirmation
      type: human_in_loop
      condition: $priority_assessment.priority == 'urgent' || $feasibility.is_feasible == false
      timeout: 86400000  # 24å°æ—¶
      fallback: auto_approve
      input:
        requirement: $requirement
        priority_assessment: $priority_assessment
        feasibility: $feasibility

    # Step 5: ä»»åŠ¡æ‹†åˆ†ï¼ˆéœ€æ±‚è¢«æ‰¹å‡†åï¼‰
    - name: task_breakdown
      agent: requirement_agent
      action: classify
      condition: $human_confirmation.approved == true || $priority_assessment.priority != 'urgent'
      input:
        requirement: $requirement
        feasibility: $feasibility
      output: tasks
      timeout: 10000

    # Step 6: æ‰¹é‡åˆ›å»ºTask
    - name: create_tasks
      action: create_task
      loop: $tasks.task_list
      condition: $tasks.task_list.length > 0
      input:
        title: $item.title
        priority: $item.priority
        requirementId: $requirement.id
        conversationId: $requirement.conversationId
        description: $item.description
        estimatedHours: $item.estimatedHours
      timeout: 3000

    # Step 7: æ™ºèƒ½åˆ†é…ï¼ˆæ ¹æ®å·¥ç¨‹å¸ˆæŠ€èƒ½å’Œè´Ÿè½½ï¼‰
    - name: smart_assignment
      agent: requirement_agent
      action: classify
      input:
        tasks: $create_tasks
        requirement: $requirement
      output: assignments
      timeout: 5000

    # Step 8: é€šçŸ¥ç›¸å…³äººå‘˜
    - name: notify_stakeholders
      action: send_message
      channel: internal
      content: |
        ğŸ“‹ æ–°éœ€æ±‚å·²æ‹†åˆ†ä¸º $tasks.task_list.length ä¸ªä»»åŠ¡

        éœ€æ±‚: $requirement.title
        ä¼˜å…ˆçº§: $priority_assessment.priority
        ä»»åŠ¡: $create_tasks

        è¯·åŠæ—¶è®¤é¢†æˆ–åˆ†é…ã€‚
      timeout: 3000

    # Step 9: å¦‚æœæœ‰å¯¹è¯ï¼Œé€šçŸ¥å®¢æˆ·
    - name: notify_customer
      action: send_message
      channel: $trigger.channel
      condition: $requirement.conversationId != null
      content: |
        æ‚¨çš„éœ€æ±‚å·²æ”¶åˆ°ï¼

        éœ€æ±‚: $requirement.title
        è¯„ä¼°ä¼˜å…ˆçº§: $priority_assessment.priority
        é¢„è®¡ä»»åŠ¡æ•°: $tasks.task_list.length

        æˆ‘ä»¬ä¼šå°½å¿«å¤„ç†å¹¶åé¦ˆè¿›åº¦ã€‚
      timeout: 3000

# é”™è¯¯å¤„ç†
onError:
  - name: error_notification
    action: send_message
    channel: internal_alert
    content: "éœ€æ±‚ç®¡ç†å·¥ä½œæµå¼‚å¸¸: $requirement.id"

# å®Œæˆåæ“ä½œ
onComplete:
  - name: record_completion
    action: log
    content: |
      Requirement workflow completed:
      - Requirement ID: $requirement.id
      - Tasks created: $create_tasks.length
      - Duration: $workflow.duration ms
